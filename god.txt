REPO STRUCTURE
grin/
├── .github
│   └── workflows
│       ├── build.yml
│       ├── lint.yml
│       ├── release.yml
│       └── test.yml
├── .idea
│   ├── .gitignore
│   ├── caches
│   │   └── deviceStreaming.xml
│   ├── grin.iml
│   ├── markdown.xml
│   ├── misc.xml
│   ├── modules.xml
│   └── workspace.xml
├── .vscode
│   └── settings.json
├── ARCHITECTURE.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE
├── Makefile
├── NOTICE
├── README.md
├── SECURITY.md
├── agents.txt
├── android
│   ├── build.gradle.kts
│   ├── demo
│   │   ├── build.gradle.kts
│   │   └── src
│   │       └── main
│   │           ├── AndroidManifest.xml
│   │           ├── assets
│   │           │   └── samples
│   │           │       └── minimal.grin
│   │           ├── kotlin
│   │           │   └── io
│   │           │       └── grin
│   │           │           └── demo
│   │           │               ├── CaptureBuffer.kt
│   │           │               ├── CaptureReviewActivity.kt
│   │           │               ├── ChannelLabels.kt
│   │           │               ├── EditorActivity.kt
│   │           │               ├── GalleryActivity.kt
│   │           │               ├── GalleryAdapter.kt
│   │           │               ├── GridCameraActivity.kt
│   │           │               ├── GridOverlayView.kt
│   │           │               ├── GifEncoder.kt
│   │           │               ├── GrinAssetModels.kt
│   │           │               ├── GrinAssetStore.kt
│   │           │               ├── GrinPreviewRenderer.kt
│   │           │               ├── MainActivity.kt
│   │           │               ├── NavigationConstants.kt
│   │           │               ├── PosterizedCameraAnalyzer.kt
│   │           │               └── PosterizedPalette.kt
│   │           └── res
│   │               ├── drawable
│   │               │   └── ic_launcher_foreground.xml
│   │               ├── layout
│   │               │   ├── activity_capture_review.xml
│   │               │   ├── activity_editor.xml
│   │               │   ├── activity_gallery.xml
│   │               │   ├── activity_grid_camera.xml
│   │               │   ├── activity_main.xml
│   │               │   └── item_gallery_asset.xml
│   │               ├── mipmap-anydpi-v26
│   │               │   ├── ic_launcher.xml
│   │               │   └── ic_launcher_round.xml
│   │               └── values
│   │                   ├── colors.xml
│   │                   ├── ic_launcher_background.xml
│   │                   ├── strings.xml
│   │                   └── themes.xml
│   ├── gradle
│   │   └── wrapper
│   │       ├── gradle-wrapper.jar
│   │       └── gradle-wrapper.properties
│   ├── gradle.properties
│   ├── gradlew
│   ├── gradlew.bat
│   ├── lib
│   │   ├── build.gradle.kts
│   │   ├── consumer-rules.pro
│   │   ├── proguard-rules.pro
│   │   └── src
│   │       ├── androidTest
│   │       │   └── kotlin
│   │       │       └── io
│   │       │           └── grin
│   │       │               └── lib
│   │       │                   └── GrinBenchmarkTest.kt
│   │       ├── main
│   │       │   ├── AndroidManifest.xml
│   │       │   └── kotlin
│   │       │       └── io
│   │       │           └── grin
│   │       │               └── lib
│   │       │                   ├── AndroidTickScheduler.kt
│   │       │                   ├── BaseOpcodes.kt
│   │       │                   ├── ChoreographerTickScheduler.kt
│   │       │                   ├── DisplayBuffer.kt
│   │       │                   ├── GrinBinaryIO.kt
│   │       │                   ├── GrinBitmapRenderer.kt
│   │       │                   ├── GrinContentProvider.kt
│   │       │                   ├── GrinEndianness.kt
│   │       │                   ├── GrinFile.kt
│   │       │                   ├── GrinFormat.kt
│   │       │                   ├── GrinHeader.kt
│   │       │                   ├── GrinImage.kt
│   │       │                   ├── GrinInputStream.kt
│   │       │                   ├── GrinOutputStream.kt
│   │       │                   ├── GrinPixel.kt
│   │       │                   ├── GrinPlayer.kt
│   │       │                   ├── GrinRule.kt
│   │       │                   ├── GrinUriLoader.kt
│   │       │                   ├── GrinValidation.kt
│   │       │                   ├── GrinValidationSuite.kt
│   │       │                   ├── GrinView.kt
│   │       │                   ├── Opcode.kt
│   │       │                   ├── OpcodeRegistry.kt
│   │       │                   ├── Opcodes.kt
│   │       │                   ├── PlaybackState.kt
│   │       │                   ├── RuleEngine.kt
│   │       │                   ├── TestTickScheduler.kt
│   │       │                   ├── TickScheduler.kt
│   │       │                   └── TimingInterpreter.kt
│   │       └── test
│   │           └── kotlin
│   │               └── io
│   │                   └── grin
│   │                       └── lib
│   │                           ├── GrinEndiannessTest.kt
│   │                           ├── GrinReferenceTest.kt
│   │                           └── OpcodesTest.kt
│   ├── local.properties
│   ├── scripts
│   │   └── gradle-run.sh
│   └── settings.gradle.kts
├── benchmarks
│   ├── README.md
│   ├── baseline.json
│   └── bench.js
├── docs
│   ├── android-grid-camera-ux.md
│   ├── README.md
│   ├── compatibility.md
│   ├── api-quickstart.md
│   ├── ui-ux-audit.md
│   ├── format-diagram.md
│   ├── migration-gif-apng.md
│   ├── opcodes.md
│   ├── playback-guide-android.md
│   ├── playback-guide-web.md
│   ├── release-preparation.md
│   ├── security-audit-checklist.md
│   ├── security-model.md
│   ├── timing.md
│   ├── tutorial-first-file.md
│   └── tutorial-grin-groups.md
├── grin_technical_specification.md
├── grin_technical_specification_v_2.md
├── immediatetodo.txt
├── shortlist.Txt
├── package-lock.json
├── plugins
│   ├── gimp
│   │   ├── README.md
│   │   └── grin_gimp_plugin.py
│   ├── illustrator
│   │   ├── README.md
│   │   ├── manifest.json
│   │   ├── package.json
│   │   └── src
│   │       ├── index.html
│   │       ├── main.js
│   │       └── styles.css
│   └── photoshop
│       ├── README.md
│       ├── manifest.json
│       ├── package.json
│       └── src
│           ├── index.html
│           ├── main.js
│           └── styles.css
├── samples
│   ├── README.md
│   ├── all_opcodes.grin
│   ├── color_shift.grin
│   ├── fade_gradient.grin
│   ├── groups_demo.grin
│   ├── invalid_header_size.grin
│   ├── invalid_magic.grin
│   ├── invalid_opcode.grin
│   ├── locking_demo.grin
│   ├── max_rules.grin
│   ├── max_size.grin
│   ├── minimal.grin
│   ├── minimal_locked.grin
│   ├── pulse_red.grin
│   ├── timing_demo.grin
│   └── truncated.grin
├── scripts
│   ├── generate-samples.mjs
│   └── generate-test-files.js
├── spec
│   └── grin_technical_specification_v_2.md
├── tchspecdraft.txt
├── tests
│   └── fixtures
│       ├── README.md
│       ├── generated
│       │   └── .gitkeep
│       └── grin-fixtures.json
├── todo.md
├── tools
│   ├── bin
│   │   ├── grin-decode.js
│   │   ├── grin-encode.js
│   │   ├── grin-inspect.js
│   │   └── grin-validate.js
│   ├── lib
│   │   ├── endianness.js
│   │   ├── format.js
│   │   ├── gif.js
│   │   ├── grin.js
│   │   ├── opcodes.js
│   │   ├── png.js
│   │   ├── render.js
│   │   ├── timing.js
│   │   └── validation.js
│   ├── package-lock.json
│   └── package.json
└── web
    ├── demo
    │   ├── demo.js
    │   ├── index.html
    │   ├── samples
    │   │   ├── minimal.grin
    │   │   └── samples.json
    │   └── styles.css
    ├── lib
    │   ├── display-buffer.ts
    │   ├── endianness.ts
    │   ├── format.ts
    │   ├── grin-canvas.ts
    │   ├── grin-element.ts
    │   ├── grin-file.ts
    │   ├── grin-header.ts
    │   ├── grin-image.ts
    │   ├── grin-io.ts
    │   ├── grin-loader.ts
    │   ├── grin-pixel.ts
    │   ├── grin-player.ts
    │   ├── grin-reader.ts
    │   ├── grin-rule.ts
    │   ├── grin-writer.ts
    │   ├── index.ts
    │   ├── opcode-registry.ts
    │   ├── opcodes.ts
    │   ├── playback-state.ts
    │   ├── player.ts
    │   ├── rule-engine.ts
    │   ├── tick-scheduler.ts
    │   ├── timing.ts
    │   └── validation.ts
    ├── package-lock.json
    ├── package.json
    ├── README.md
    ├── rollup.config.mjs
    ├── tests
    │   ├── endianness.test.ts
    │   ├── format-roundtrip.test.ts
    │   ├── fuzz.test.ts
    │   ├── integration.test.ts
    │   ├── opcodes.test.ts
    │   ├── playback.test.ts
    │   ├── reference.test.ts
    │   ├── timing.test.ts
    │   ├── validation-boundaries.test.ts
    │   └── validation.test.ts
    ├── tsconfig.json
    ├── typedoc.json
    └── vitest.config.ts

#####/.github/workflows/build.yml#####
name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  web-build:
    name: Web Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web/dist/
          retention-days: 7

  android-build:
    name: Android Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build library
        run: ./gradlew :lib:assembleRelease
      - name: Build demo app
        run: ./gradlew :demo:assembleDebug
      - name: Upload library AAR
        uses: actions/upload-artifact@v4
        with:
          name: android-lib
          path: android/lib/build/outputs/aar/
          retention-days: 7
      - name: Upload demo APK
        uses: actions/upload-artifact@v4
        with:
          name: android-demo
          path: android/demo/build/outputs/apk/debug/
          retention-days: 7

  cli-build:
    name: CLI Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          if [ -f tools/package.json ]; then
            cd tools
            npm ci
          else
            echo "No tools/package.json yet"
          fi

  release:
    name: Release Artifacts
    needs: [web-build, android-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download build artifacts
        uses: actions/download-artifact@v4
      - name: Create release notes
        run: |
          echo "## GRIN Release" > RELEASE_NOTES.md
          echo "Build: ${{ github.sha }}" >> RELEASE_NOTES.md
          echo "Date: $(date -u)" >> RELEASE_NOTES.md

#####/.github/workflows/lint.yml#####
name: Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  web-lint:
    name: Web Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Type check
        run: npm run typecheck

#####/.github/workflows/release.yml#####
name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository at the tagged commit.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Use Node.js for building the web distribution bundle.
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install web dependencies
        working-directory: web
        run: npm ci

      - name: Build web package
        working-directory: web
        run: npm run build

      # Build the Android AAR for release publishing.
      - name: Set up Java for Android build
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Build Android AAR
        working-directory: android
        run: ./gradlew :lib:assembleRelease

      # Surface Central Publisher Portal credentials without failing the release build.
      - name: Central Portal preflight
        env:
          CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          # Report missing Central Publisher Portal credentials without failing the job.
          if [[ -z "${CENTRAL_USERNAME}" || -z "${CENTRAL_PASSWORD}" ]]; then
            echo "Central Publisher Portal credentials are not set; publishing must be handled separately."
          else
            echo "Central Publisher Portal credentials detected."
          fi
          # Report missing signing material without failing the job.
          if [[ -z "${SIGNING_KEY}" || -z "${SIGNING_PASSWORD}" ]]; then
            echo "In-memory PGP signing material is not set; Android publishing requires signing keys."
          else
            echo "In-memory PGP signing material detected."
          fi

      # Package artifacts for the GitHub release.
      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts
          tar -czf release-artifacts/grin-web-dist.tar.gz -C web dist
          tar -czf release-artifacts/grin-tools.tar.gz -C tools bin lib package.json package-lock.json
          cp android/lib/build/outputs/aar/lib-release.aar release-artifacts/grin-android.aar

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-artifacts/*

#####/.github/workflows/test.yml#####
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  web-test:
    name: Web Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test

  android-test:
    name: Android Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Run unit tests
        run: ./gradlew :lib:testReleaseUnitTest

  cli-test:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Run CLI tests
        run: |
          if [ -f tools/package.json ]; then
            cd tools
            npm ci
            npm test
          else
            echo "No tools/package.json yet"
          fi

#####/.idea/.gitignore#####
# Default ignored files
/shelf/
/workspace.xml

#####/.idea/caches/deviceStreaming.xml#####
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="DeviceStreaming">
    <option name="deviceSelectionList">
      <list>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="Sony" />
          <option name="codename" value="A402SO" />
          <option name="id" value="A402SO" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Sony" />
          <option name="name" value="Xperia 10" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2520" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="27" />
          <option name="brand" value="DOCOMO" />
          <option name="codename" value="F01L" />
          <option name="id" value="F01L" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="FUJITSU" />
          <option name="name" value="F-01L" />
          <option name="screenDensity" value="360" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1280" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="OnePlus" />
          <option name="codename" value="OP535DL1" />
          <option name="id" value="OP535DL1" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="OnePlus" />
          <option name="name" value="CPH2409" />
          <option name="screenDensity" value="401" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2412" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="OnePlus" />
          <option name="codename" value="OP5552L1" />
          <option name="id" value="OP5552L1" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="OnePlus" />
          <option name="name" value="CPH2415" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2412" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="OnePlus" />
          <option name="codename" value="OP5552L1" />
          <option name="id" value="OP5552L1" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="OnePlus" />
          <option name="name" value="CPH2415" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2412" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="OPPO" />
          <option name="codename" value="OP573DL1" />
          <option name="id" value="OP573DL1" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="OPPO" />
          <option name="name" value="CPH2557" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="28" />
          <option name="brand" value="DOCOMO" />
          <option name="codename" value="SH-01L" />
          <option name="id" value="SH-01L" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="SHARP" />
          <option name="name" value="AQUOS sense2 SH-01L" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2160" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="Lenovo" />
          <option name="codename" value="TB330FU" />
          <option name="formFactor" value="Tablet" />
          <option name="id" value="TB330FU" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Lenovo" />
          <option name="name" value="Tab M11" />
          <option name="screenDensity" value="240" />
          <option name="screenX" value="1200" />
          <option name="screenY" value="1920" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a03su" />
          <option name="id" value="a03su" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy A03s" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1600" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a05s" />
          <option name="id" value="a05s" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="A05s" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a06" />
          <option name="id" value="a06" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy A06" />
          <option name="screenDensity" value="300" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1600" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a14m" />
          <option name="id" value="a14m" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-A145R" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2408" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a15" />
          <option name="id" value="a15" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="A15" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a15x" />
          <option name="id" value="a15x" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="A15 5G" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a16" />
          <option name="id" value="a16" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-A165M" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a16x" />
          <option name="id" value="a16x" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="A16 5G" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a26x" />
          <option name="id" value="a26x" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-A266B" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a34x" />
          <option name="id" value="a34x" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-A346N" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a35x" />
          <option name="id" value="a35x" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="A35" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a35x" />
          <option name="id" value="a35x" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="A35" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a35x" />
          <option name="id" value="a35x" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="A35" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a36xq" />
          <option name="id" value="a36xq" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-A366E" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a36xq" />
          <option name="id" value="a36xq" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-A366E" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="a56x" />
          <option name="id" value="a56x" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-A566E" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="google" />
          <option name="codename" value="akita" />
          <option name="id" value="akita" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 8a" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="google" />
          <option name="codename" value="akita" />
          <option name="id" value="akita" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 8a" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="motorola" />
          <option name="codename" value="arcfox" />
          <option name="id" value="arcfox" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="razr plus 2024" />
          <option name="screenDensity" value="360" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="1272" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="motorola" />
          <option name="codename" value="austin" />
          <option name="id" value="austin" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="moto g 5G (2022)" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1600" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="samsung" />
          <option name="codename" value="b0q" />
          <option name="id" value="b0q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S22 Ultra" />
          <option name="screenDensity" value="600" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="3088" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="b6q" />
          <option name="id" value="b6q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy Z Flip 6" />
          <option name="screenDensity" value="340" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2640" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="google" />
          <option name="codename" value="blazer" />
          <option name="id" value="blazer" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 10 Pro" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2410" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="32" />
          <option name="brand" value="google" />
          <option name="codename" value="bluejay" />
          <option name="id" value="bluejay" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 6a" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="google" />
          <option name="codename" value="caiman" />
          <option name="id" value="caiman" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9 Pro" />
          <option name="screenDensity" value="360" />
          <option name="screenX" value="960" />
          <option name="screenY" value="2142" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="google" />
          <option name="codename" value="caiman" />
          <option name="id" value="caiman" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9 Pro" />
          <option name="screenDensity" value="360" />
          <option name="screenX" value="960" />
          <option name="screenY" value="2142" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="google" />
          <option name="codename" value="comet" />
          <option name="default" value="true" />
          <option name="id" value="comet" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9 Pro Fold" />
          <option name="screenDensity" value="390" />
          <option name="screenX" value="2076" />
          <option name="screenY" value="2152" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="google" />
          <option name="codename" value="comet" />
          <option name="default" value="true" />
          <option name="id" value="comet" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9 Pro Fold" />
          <option name="screenDensity" value="390" />
          <option name="screenX" value="2076" />
          <option name="screenY" value="2152" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="29" />
          <option name="brand" value="samsung" />
          <option name="codename" value="crownqlteue" />
          <option name="id" value="crownqlteue" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy Note9" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="2220" />
          <option name="screenY" value="1080" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="dm1q" />
          <option name="id" value="dm1q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="S23" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="dm2q" />
          <option name="id" value="dm2q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="S23 Plus" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="dm3q" />
          <option name="id" value="dm3q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S23 Ultra" />
          <option name="screenDensity" value="600" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="3088" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="motorola" />
          <option name="codename" value="dubai" />
          <option name="id" value="dubai" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="edge 30" />
          <option name="screenDensity" value="405" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="e1q" />
          <option name="default" value="true" />
          <option name="id" value="e1q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S24" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="e1q" />
          <option name="default" value="true" />
          <option name="id" value="e1q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S24" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="e3q" />
          <option name="id" value="e3q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S24 Ultra" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="3120" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="e3q" />
          <option name="id" value="e3q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S24 Ultra" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="3120" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="e3qksx" />
          <option name="id" value="e3qksx" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S24 Ultra" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="3120" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="google" />
          <option name="codename" value="eos" />
          <option name="id" value="eos" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Eos" />
          <option name="screenDensity" value="320" />
          <option name="screenX" value="384" />
          <option name="screenY" value="384" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="google" />
          <option name="codename" value="felix" />
          <option name="id" value="felix" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel Fold" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="2208" />
          <option name="screenY" value="1840" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="google" />
          <option name="codename" value="felix" />
          <option name="id" value="felix" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel Fold" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="2208" />
          <option name="screenY" value="1840" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="google" />
          <option name="codename" value="felix_camera" />
          <option name="id" value="felix_camera" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel Fold (Camera-enabled)" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="2208" />
          <option name="screenY" value="1840" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="motorola" />
          <option name="codename" value="fogona" />
          <option name="id" value="fogona" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="moto g play - 2024" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1600" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="motorola" />
          <option name="codename" value="fogos" />
          <option name="id" value="fogos" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="moto g34 5G" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1600" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="google" />
          <option name="codename" value="frankel" />
          <option name="id" value="frankel" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 10" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2424" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="g0q" />
          <option name="id" value="g0q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-S906U1" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="g0q" />
          <option name="id" value="g0q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-S906U1" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="gta9pwifi" />
          <option name="id" value="gta9pwifi" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-X210" />
          <option name="screenDensity" value="240" />
          <option name="screenX" value="1200" />
          <option name="screenY" value="1920" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="samsung" />
          <option name="codename" value="gts7lwifi" />
          <option name="id" value="gts7lwifi" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-T870" />
          <option name="screenDensity" value="340" />
          <option name="screenX" value="1600" />
          <option name="screenY" value="2560" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="gts7xllite" />
          <option name="id" value="gts7xllite" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-T738U" />
          <option name="screenDensity" value="340" />
          <option name="screenX" value="1600" />
          <option name="screenY" value="2560" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="samsung" />
          <option name="codename" value="gts8uwifi" />
          <option name="formFactor" value="Tablet" />
          <option name="id" value="gts8uwifi" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy Tab S8 Ultra" />
          <option name="screenDensity" value="320" />
          <option name="screenX" value="1848" />
          <option name="screenY" value="2960" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="gts8wifi" />
          <option name="formFactor" value="Tablet" />
          <option name="id" value="gts8wifi" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy Tab S8" />
          <option name="screenDensity" value="274" />
          <option name="screenX" value="1600" />
          <option name="screenY" value="2560" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="gts9fe" />
          <option name="id" value="gts9fe" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy Tab S9 FE 5G" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="2304" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="gts9wifi" />
          <option name="id" value="gts9wifi" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-X710" />
          <option name="screenDensity" value="340" />
          <option name="screenX" value="1600" />
          <option name="screenY" value="2560" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="google" />
          <option name="codename" value="husky" />
          <option name="id" value="husky" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 8 Pro" />
          <option name="screenDensity" value="390" />
          <option name="screenX" value="1008" />
          <option name="screenY" value="2244" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="google" />
          <option name="codename" value="husky" />
          <option name="id" value="husky" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 8 Pro" />
          <option name="screenDensity" value="390" />
          <option name="screenX" value="1008" />
          <option name="screenY" value="2244" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="30" />
          <option name="brand" value="motorola" />
          <option name="codename" value="java" />
          <option name="id" value="java" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="G20" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1600" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="motorola" />
          <option name="codename" value="kansas" />
          <option name="id" value="kansas" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="moto g - 2025" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1604" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="google" />
          <option name="codename" value="komodo" />
          <option name="id" value="komodo" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9 Pro XL" />
          <option name="screenDensity" value="360" />
          <option name="screenX" value="1008" />
          <option name="screenY" value="2244" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="google" />
          <option name="codename" value="komodo" />
          <option name="id" value="komodo" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9 Pro XL" />
          <option name="screenDensity" value="360" />
          <option name="screenX" value="1008" />
          <option name="screenY" value="2244" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="motorola" />
          <option name="codename" value="lamul" />
          <option name="id" value="lamul" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="moto g05" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1604" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="motorola" />
          <option name="codename" value="lion" />
          <option name="id" value="lion" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="moto g04" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1612" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="google" />
          <option name="codename" value="lynx" />
          <option name="id" value="lynx" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 7a" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="motorola" />
          <option name="codename" value="lyriq" />
          <option name="id" value="lyriq" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="edge 40" />
          <option name="screenDensity" value="400" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="motorola" />
          <option name="codename" value="manaus" />
          <option name="id" value="manaus" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="edge 40 neo" />
          <option name="screenDensity" value="400" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="motorola" />
          <option name="codename" value="maui" />
          <option name="id" value="maui" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Motorola" />
          <option name="name" value="moto g play - 2023" />
          <option name="screenDensity" value="280" />
          <option name="screenX" value="720" />
          <option name="screenY" value="1600" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="google" />
          <option name="codename" value="mustang" />
          <option name="id" value="mustang" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 10 Pro XL" />
          <option name="screenDensity" value="390" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2404" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="o1q" />
          <option name="id" value="o1q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S21" />
          <option name="screenDensity" value="421" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="o1q" />
          <option name="id" value="o1q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S21" />
          <option name="screenDensity" value="421" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="31" />
          <option name="brand" value="google" />
          <option name="codename" value="oriole" />
          <option name="id" value="oriole" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 6" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="p3q" />
          <option name="id" value="p3q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S21 Ultra" />
          <option name="screenDensity" value="600" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="3200" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="pa2q" />
          <option name="id" value="pa2q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="S25+" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="pa3q" />
          <option name="id" value="pa3q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S25 Ultra" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="pa3q" />
          <option name="id" value="pa3q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S25 Ultra" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="google" />
          <option name="codename" value="panther" />
          <option name="id" value="panther" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 7" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="psq" />
          <option name="id" value="psq" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S25 Edge" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="3120" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="q5q" />
          <option name="id" value="q5q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy Z Fold5" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1812" />
          <option name="screenY" value="2176" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="q6q" />
          <option name="id" value="q6q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy Z Fold6" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1856" />
          <option name="screenY" value="2160" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="30" />
          <option name="brand" value="google" />
          <option name="codename" value="r11" />
          <option name="formFactor" value="Wear OS" />
          <option name="id" value="r11" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel Watch" />
          <option name="screenDensity" value="320" />
          <option name="screenX" value="384" />
          <option name="screenY" value="384" />
          <option name="type" value="WEAR_OS" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="r11q" />
          <option name="id" value="r11q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-S711U" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="r11s" />
          <option name="id" value="r11s" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-S711N" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="r9q" />
          <option name="id" value="r9q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S21 FE 5G" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="samsung" />
          <option name="codename" value="r9q-SM-G990U" />
          <option name="id" value="r9q-SM-G990U" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S21 FE 5G" />
          <option name="screenDensity" value="480" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="google" />
          <option name="codename" value="rango" />
          <option name="id" value="rango" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 10 Pro Fold" />
          <option name="screenDensity" value="390" />
          <option name="screenX" value="2076" />
          <option name="screenY" value="2152" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="30" />
          <option name="brand" value="google" />
          <option name="codename" value="redfin" />
          <option name="id" value="redfin" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 5" />
          <option name="screenDensity" value="440" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2340" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="google" />
          <option name="codename" value="shiba" />
          <option name="id" value="shiba" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 8" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="t2q" />
          <option name="id" value="t2q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S21 Plus" />
          <option name="screenDensity" value="394" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="samsung" />
          <option name="codename" value="t2q" />
          <option name="id" value="t2q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="Galaxy S21 Plus" />
          <option name="screenDensity" value="394" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2400" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="google" />
          <option name="codename" value="tangorpro" />
          <option name="formFactor" value="Tablet" />
          <option name="id" value="tangorpro" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel Tablet" />
          <option name="screenDensity" value="320" />
          <option name="screenX" value="1600" />
          <option name="screenY" value="2560" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="google" />
          <option name="codename" value="tegu" />
          <option name="id" value="tegu" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9a" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2424" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="google" />
          <option name="codename" value="tokay" />
          <option name="default" value="true" />
          <option name="id" value="tokay" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2424" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="35" />
          <option name="brand" value="google" />
          <option name="codename" value="tokay" />
          <option name="default" value="true" />
          <option name="id" value="tokay" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2424" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="36" />
          <option name="brand" value="google" />
          <option name="codename" value="tokay" />
          <option name="default" value="true" />
          <option name="id" value="tokay" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Google" />
          <option name="name" value="Pixel 9" />
          <option name="screenDensity" value="420" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2424" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="34" />
          <option name="brand" value="samsung" />
          <option name="codename" value="xcover7" />
          <option name="id" value="xcover7" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="SM-G556B" />
          <option name="screenDensity" value="450" />
          <option name="screenX" value="1080" />
          <option name="screenY" value="2408" />
        </PersistentDeviceSelectionData>
        <PersistentDeviceSelectionData>
          <option name="api" value="33" />
          <option name="brand" value="samsung" />
          <option name="codename" value="y2q" />
          <option name="id" value="y2q" />
          <option name="labId" value="google" />
          <option name="manufacturer" value="Samsung" />
          <option name="name" value="S20 Plus 5G" />
          <option name="screenDensity" value="600" />
          <option name="screenX" value="1440" />
          <option name="screenY" value="3200" />
        </PersistentDeviceSelectionData>
      </list>
    </option>
  </component>
</project>

#####/.idea/grin.iml#####
<?xml version="1.0" encoding="UTF-8"?>
<module type="JAVA_MODULE" version="4">
  <component name="NewModuleRootManager" inherit-compiler-output="true">
    <exclude-output />
    <content url="file://$MODULE_DIR$" />
    <orderEntry type="inheritedJdk" />
    <orderEntry type="sourceFolder" forTests="false" />
  </component>
</module>

#####/.idea/markdown.xml#####
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="MarkdownSettings">
    <option name="previewPanelProviderInfo">
      <ProviderInfo name="Compose (experimental)" className="com.intellij.markdown.compose.preview.ComposePanelProvider" />
    </option>
  </component>
</project>

#####/.idea/misc.xml#####
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ProjectRootManager">
    <output url="file://$PROJECT_DIR$/out" />
  </component>
</project>

#####/.idea/modules.xml#####
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ProjectModuleManager">
    <modules>
      <module fileurl="file://$PROJECT_DIR$/.idea/grin.iml" filepath="$PROJECT_DIR$/.idea/grin.iml" />
    </modules>
  </component>
</project>

#####/.idea/workspace.xml#####
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="AutoImportSettings">
    <option name="autoReloadType" value="NONE" />
  </component>
  <component name="ChangeListManager">
    <list default="true" id="fa8f93fb-929c-40ad-ac24-04ccdbbb4104" name="Changes" comment="" />
    <option name="SHOW_DIALOG" value="false" />
    <option name="HIGHLIGHT_CONFLICTS" value="true" />
    <option name="HIGHLIGHT_NON_ACTIVE_CHANGELIST" value="false" />
    <option name="LAST_RESOLUTION" value="IGNORE" />
  </component>
  <component name="ClangdSettings">
    <option name="formatViaClangd" value="false" />
  </component>
  <component name="ProjectColorInfo"><![CDATA[{
  "associatedIndex": 6
}]]></component>
  <component name="ProjectId" id="384sgNp2sYd4rY5I7hfKV44bzNg" />
  <component name="ProjectViewState">
    <option name="hideEmptyMiddlePackages" value="true" />
    <option name="showLibraryContents" value="true" />
  </component>
  <component name="PropertiesComponent"><![CDATA[{
  "keyToString": {
    "ModuleVcsDetector.initialDetectionPerformed": "true",
    "RunOnceActivity.ShowReadmeOnStart": "true",
    "RunOnceActivity.cidr.known.project.marker": "true",
    "RunOnceActivity.readMode.enableVisualFormatting": "true",
    "cf.first.check.clang-format": "false",
    "cidr.known.project.marker": "true",
    "kotlin-language-version-configured": "true",
    "last_opened_file_path": "/home/amber/Documents/grin"
  }
}]]></component>
  <component name="TaskManager">
    <task active="true" id="Default" summary="Default task">
      <changelist id="fa8f93fb-929c-40ad-ac24-04ccdbbb4104" name="Changes" comment="" />
      <created>1768070315590</created>
      <option name="number" value="Default" />
      <option name="presentableId" value="Default" />
      <updated>1768070315590</updated>
    </task>
    <servers />
  </component>
</project>

#####/.vscode/settings.json#####
{
    "java.configuration.updateBuildConfiguration": "interactive"
}

#####/ARCHITECTURE.md#####
# GRIN Architecture

## Overview

GRIN (Graphic Readdressable Indexed Nodes) is a deterministic image container format designed for simplicity, security, and wide compatibility. This document describes the system architecture and design decisions.

## Design Principles

### 1. Constrained by Design

GRIN intentionally limits expressiveness to ensure:
- **Predictable behavior**: Every GRIN file behaves identically on all platforms
- **Bounded resources**: Memory and CPU usage are calculable from header alone
- **Security by construction**: No executable code, no external resources

### 2. Low Bar for Entry

Rendering a .grin file to screen requires minimal code:
- **~200 lines** for a basic reader (any language)
- **~100 additional lines** for playback
- **Zero dependencies** beyond standard library

### 3. Self-Contained Logic

The GRIN format embeds all animation logic:
- Rules stored in fixed 64-byte header block
- Opcodes are simple, stateless transformations
- External code only provides tick scheduling and display

---

## System Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           GRIN Ecosystem                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │   Encoder    │     │   .grin      │     │   Decoder    │            │
│  │   (Tool)     │────>│   File       │────>│   (Tool)     │            │
│  └──────────────┘     └──────────────┘     └──────────────┘            │
│                              │                                          │
│                              │ Load                                     │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      GRIN Core Library                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │
│  │  │   Reader    │  │  Validator  │  │   Opcodes   │               │  │
│  │  │  (Binary)   │  │  (Rules)    │  │  (Effects)  │               │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘               │  │
│  │         │                │                │                       │  │
│  │         ▼                ▼                ▼                       │  │
│  │  ┌───────────────────────────────────────────────────────────┐   │  │
│  │  │                   Playback Engine                          │   │  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │  │
│  │  │  │  Tick    │  │  Rule    │  │  Pixel   │  │ Display  │  │   │  │
│  │  │  │ Scheduler│─>│  Engine  │─>│ Pipeline │─>│  Buffer  │  │   │  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │  │
│  │  └───────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│              ┌───────────────┼───────────────┐                         │
│              ▼               ▼               ▼                         │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐              │
│  │   Android    │   │     Web      │   │     CLI      │              │
│  │  (Bitmap)    │   │  (Canvas)    │   │   (PNG out)  │              │
│  └──────────────┘   └──────────────┘   └──────────────┘              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## File Format Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         GRIN File (128 + N bytes)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  HEADER (128 bytes, fixed)                                              │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ Offset │ Size │ Field            │ Description                     │ │
│  ├────────┼──────┼──────────────────┼─────────────────────────────────┤ │
│  │ 0      │ 4    │ Magic            │ "GRIN" (0x47 0x52 0x49 0x4E)    │ │
│  │ 4      │ 1    │ VersionMajor     │ Format version (0)              │ │
│  │ 5      │ 1    │ VersionMinor     │ Format version (0)              │ │
│  │ 6      │ 2    │ HeaderSize       │ Must be 128                     │ │
│  │ 8      │ 4    │ Width            │ Image width in pixels           │ │
│  │ 12     │ 4    │ Height           │ Image height in pixels          │ │
│  │ 16     │ 4    │ TickMicros       │ Playback tick duration (µs)     │ │
│  │ 20     │ 1    │ RuleCount        │ Number of active rules (0-16)   │ │
│  │ 21     │ 1    │ OpcodeSetId      │ Opcode set identifier           │ │
│  │ 22     │ 2    │ Flags            │ Reserved (0)                    │ │
│  │ 24     │ 8    │ PixelDataLength  │ Width × Height × 5              │ │
│  │ 32     │ 8    │ FileLength       │ Total file size (optional)      │ │
│  │ 40     │ 8    │ PixelDataOffset  │ Must be 128                     │ │
│  │ 48     │ 16   │ Reserved         │ Must be 0                       │ │
│  │ 64     │ 64   │ RulesBlock       │ 16 × 4-byte rule entries        │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  PIXEL DATA (Width × Height × 5 bytes)                                  │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ For each pixel (5 bytes):                                          │ │
│  │   Byte 0: Red   (0-255)                                            │ │
│  │   Byte 1: Green (0-255)                                            │ │
│  │   Byte 2: Blue  (0-255)                                            │ │
│  │   Byte 3: Alpha (0-255)                                            │ │
│  │   Byte 4: Control                                                  │ │
│  │           ├─ Bits 0-3: Group ID (0-15)                             │ │
│  │           ├─ Bits 4-6: Reserved (0)                                │ │
│  │           └─ Bit 7:    Lock bit                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Component Details

### Binary Reader

The reader is intentionally simple:

```
read_grin(file):
    header = read_bytes(128)
    validate_magic(header[0:4])       # "GRIN"
    validate_header_size(header[6:8]) # Must be 128
    
    width  = read_uint32_le(header, 8)
    height = read_uint32_le(header, 12)
    
    pixels = read_bytes(width * height * 5)
    return GrinImage(header, pixels)
```

### Validation Engine

Validation is strict and fail-fast:

1. **Magic Check**: First 4 bytes must be "GRIN"
2. **Header Size**: Bytes 6-7 must equal 128
3. **Dimension Check**: Width × Height × 5 = PixelDataLength
4. **Rule Count**: Must be 0-16
5. **Offset Check**: PixelDataOffset must be 128
6. **Reserved Fields**: Should be zero (warning if not)

### Opcode System

Opcodes are stateless functions:

```
opcode(pixel, tick, timing) -> modified_pixel

Properties:
  - No side effects
  - No state accumulation
  - O(1) time complexity
  - Deterministic output
```

Base Opcode Set (ID = 0):

| Code | Name        | Effect                          |
|------|-------------|---------------------------------|
| 0x00 | NOP         | No operation                    |
| 0x01 | FADE_IN     | Increase alpha                  |
| 0x02 | FADE_OUT    | Decrease alpha                  |
| 0x03 | PULSE       | Oscillate alpha                 |
| 0x04 | SHIFT_R     | Shift red channel               |
| 0x05 | SHIFT_G     | Shift green channel             |
| 0x06 | SHIFT_B     | Shift blue channel              |
| 0x07 | SHIFT_A     | Shift alpha channel             |
| 0x08 | INVERT      | Invert RGB                      |
| 0x09 | ROTATE_HUE  | Rotate in HSL space             |
| 0x0A | LOCK        | Set lock bit                    |
| 0x0B | UNLOCK      | Clear lock bit                  |
| 0x0C | TOGGLE_LOCK | Toggle lock bit                 |

### Playback Engine

Per-tick processing:

```
process_tick(image, tick):
    active_rules = evaluate_timing(image.rules, tick)
    
    for i, pixel in image.pixels:
        if pixel.is_locked():
            output[i] = pixel.rgba
            continue
        
        working = copy(pixel)
        for rule in active_rules:
            if rule.targets(pixel.group_id):
                opcode = get_opcode(rule.opcode)
                working = opcode(working, tick, rule.timing)
        
        output[i] = working.rgba
    
    return output
```

---

## Platform Implementations

### Android (Kotlin/Java)

```
Core Components:
├── GrinFile.kt         - File loading and parsing
├── GrinHeader.kt       - Header structure
├── GrinPixel.kt        - Pixel with control byte
├── GrinRule.kt         - Rule definition
├── GrinImage.kt        - Image container
├── GrinValidator.kt    - Validation logic
├── GrinOpcodes.kt      - Opcode implementations
├── GrinPlayer.kt       - Playback controller
├── GrinView.kt         - Android View component
└── GrinBitmap.kt       - Bitmap rendering

Dependencies:
- androidx.annotation (annotations only)
- No third-party libraries
```

### Web (TypeScript/JavaScript)

```
Core Components:
├── grin-file.ts        - File loading (ArrayBuffer)
├── grin-header.ts      - Header structure
├── grin-pixel.ts       - Pixel with control byte
├── grin-rule.ts        - Rule definition
├── grin-image.ts       - Image container
├── grin-validator.ts   - Validation logic
├── grin-opcodes.ts     - Opcode implementations
├── grin-player.ts      - Playback controller
├── grin-element.ts     - Web Component <grin-player>
└── grin-canvas.ts      - Canvas rendering

Dependencies:
- None (zero runtime dependencies)
- TypeScript for development only
```

---

## Data Flow

### Loading

```
File → Binary Reader → Header Validation → Pixel Parsing → GrinImage
```

### Playback

```
GrinImage → Tick Scheduler → Rule Engine → Pixel Pipeline → Display Buffer → Screen
           (platform)       (core)        (core)           (core)           (platform)
```

### Memory Model

```
Source Pixels (immutable during playback)
    │
    ▼
Working Copy (per-tick, temporary)
    │
    ▼
Display Buffer (RGBA only, 4 bytes/pixel)
    │
    ▼
Platform Render (Bitmap/Canvas)
```

---

## Security Model

### Threat Mitigations

| Threat                    | Mitigation                                |
|---------------------------|-------------------------------------------|
| Code execution            | No executable code in format              |
| Memory exhaustion         | Size calculable from header               |
| CPU exhaustion            | O(1) opcodes, bounded rules               |
| External resource access  | No URLs, no file references               |
| Hidden complexity         | All rules inspectable in header           |
| Malformed input           | Strict validation before processing       |

### Validation Invariants

1. File MUST start with "GRIN" magic bytes
2. Header size MUST be exactly 128 bytes
3. PixelDataLength MUST equal Width × Height × 5
4. RuleCount MUST be 0-16
5. All opcodes MUST be valid for OpcodeSetId
6. Reserved fields SHOULD be zero

---

## Extension Points

### Custom Opcode Sets

Future OpcodeSetId values can define new opcodes while maintaining backward compatibility. Readers that don't recognize an OpcodeSetId should:
1. Warn the user
2. Treat unknown opcodes as NOP
3. Still display the static image

### Reserved Fields

Reserved header fields and control byte bits are for future use:
- MUST be written as zero
- MUST be ignored by current readers
- MAY have meaning in future versions

---

## Performance Characteristics

### Memory

```
Header:         128 bytes (constant)
Source Pixels:  W × H × 5 bytes
Display Buffer: W × H × 4 bytes
Working Memory: O(1) per tick
Total:          ~9 bytes per pixel + 128 bytes
```

### CPU

```
Per-tick:
  - Rule evaluation: O(R) where R ≤ 16
  - Pixel processing: O(W × H × R)
  - Each opcode: O(1)
  
Worst case: O(W × H × 16) per tick
```

### I/O

```
File read: Single sequential read (no seeking required)
Header: 128 bytes
Pixels: W × H × 5 bytes
Total: 128 + (W × H × 5) bytes
```

---

## Glossary

| Term          | Definition                                        |
|---------------|---------------------------------------------------|
| Control Byte  | 5th byte of pixel containing group ID and lock    |
| Group         | One of 16 addressable pixel categories            |
| Lock Bit      | Flag preventing pixel modification during play    |
| Opcode        | Stateless pixel transformation function           |
| Rule          | GroupMask + Opcode + Timing (4 bytes)             |
| Tick          | Single playback time unit                         |
| Timing        | Oscillator parameter for rule scheduling          |

---

## References

- [GRIN Technical Specification v2](spec/grin_technical_specification_v_2.md)
- [Build Plan](todo.md)
- [Agent Contract](agents.txt)

#####/CONTRIBUTING.md#####
# Contributing to GRIN

Thank you for your interest in contributing to GRIN (Graphic Readdressable Indexed Nodes). This document provides guidelines and instructions for contributing.

## Table of Contents

- [Code of Conduct](#code-of-conduct)
- [Getting Started](#getting-started)
- [Development Setup](#development-setup)
- [Project Structure](#project-structure)
- [Making Changes](#making-changes)
- [Testing](#testing)
- [Submitting Changes](#submitting-changes)
- [Style Guidelines](#style-guidelines)

---

## Code of Conduct

Be respectful, inclusive, and constructive. We're building a technical standard—focus on the work, not personalities.

---

## Getting Started

### Prerequisites

**For Web Development:**
- Node.js 18+ (LTS recommended)
- npm 9+
- Modern browser with ES6+ support (for demos)

**For Android Development:**
- JDK 17+
- Android Studio (latest stable) or command-line tools
- Android SDK (API 21-34)

**For CLI Tools:**
- Node.js 18+

### Quick Start

```bash
# Clone the repository
git clone https://github.com/grin-format/grin.git
cd grin

# Web development
cd web
npm install
npm run build
npm test

# Android development
cd android
./gradlew build

# CLI tools
cd tools
npm install
```

---

## Development Setup

### Web Implementation

```bash
cd web
npm install

# Development commands
npm run build         # Build library
npm run build:watch   # Build with watch mode
npm run test          # Run tests
npm run test:watch    # Run tests in watch mode
npm run lint          # Run linter
npm run typecheck     # TypeScript type checking
```

### Android Implementation

```bash
cd android

# Build library
./gradlew :lib:assembleRelease

# Run tests
./gradlew :lib:testReleaseUnitTest

# Build demo app
./gradlew :demo:assembleDebug

# Install demo on connected device
./gradlew :demo:installDebug
```

### IDE Setup

**VS Code (Web):**
- Install ESLint extension
- Install TypeScript extension
- Workspace settings are pre-configured

**Android Studio:**
- Open the `android/` directory as a project
- Sync Gradle files when prompted
- Use the built-in code formatter

---

## Project Structure

```
grin/
├── spec/                    # Specification documents
│   └── grin_technical_specification_v_2.md
├── core/                    # Core reference implementation
│   ├── src/                 # Source files
│   └── tests/               # Core tests
├── android/                 # Android implementation
│   ├── lib/                 # Library module
│   └── demo/                # Demo application
├── web/                     # JavaScript implementation
│   ├── lib/                 # Library source
│   ├── demo/                # Demo web app
│   └── tests/               # JavaScript tests
├── tools/                   # CLI utilities
│   ├── encoder/             # PNG → GRIN encoder
│   ├── decoder/             # GRIN → PNG decoder
│   └── validator/           # File validator
├── samples/                 # Sample .grin files
├── docs/                    # Documentation
├── todo.md                  # Build plan
├── agents.txt               # Agentic contract
└── README.md                # Project overview
```

---

## Making Changes

### Branch Naming

- `feature/description` - New features
- `fix/description` - Bug fixes
- `docs/description` - Documentation changes
- `refactor/description` - Code refactoring

### Commit Messages

Follow this format:

```
[PHASE.SECTION] Brief description (max 72 chars)

Longer description if needed.

- Bullet points for multiple changes
- Reference spec section if applicable

Refs: #issue-number (if applicable)
```

Example:

```
[1.2] Implement header byte layout structure

- Define all 128 header bytes per spec section 7.3
- Add endianness handling for multi-byte fields
- Include reserved field zero-initialization

Refs: spec section 7.2, 7.3
```

### Checklist Before Committing

- [ ] Code compiles without errors
- [ ] All tests pass
- [ ] New code has tests
- [ ] Documentation is updated
- [ ] Commit message follows format
- [ ] No spec violations introduced

---

## Testing

### Test Requirements

- **Unit tests**: Required for all new functions/methods
- **Coverage**: Aim for >80% coverage
- **Edge cases**: Test boundary values and error conditions

### Running Tests

```bash
# Web
cd web && npm test

# Android
cd android && ./gradlew test

# CLI tools
cd tools && npm test
```

### Test File Naming

- Web: `*.test.ts` or `*.test.js`
- Android: `*Test.kt` in `src/test/`
- Integration: `*.integration.test.*`

---

## Submitting Changes

### Pull Request Process

1. **Create a branch** from `develop`
2. **Make your changes** following the guidelines
3. **Write/update tests**
4. **Update documentation**
5. **Submit PR** against `develop`
6. **Address review feedback**
7. **Merge** (maintainers only)

### PR Description Template

```markdown
## Summary
Brief description of changes.

## Changes
- Change 1
- Change 2

## Testing
- [ ] Unit tests added/updated
- [ ] Manual testing performed
- [ ] All tests passing

## Spec Compliance
- References spec section(s): X.Y
- No spec violations: Yes/No

## Breaking Changes
None / Description of breaking changes
```

---

## Style Guidelines

### TypeScript/JavaScript

- Use TypeScript for all new code
- Strict mode enabled
- No `any` types (use `unknown` if needed)
- Prefer `const` over `let`
- Use explicit return types

```typescript
// Good
function getGroupId(controlByte: number): number {
  return controlByte & 0x0F;
}

// Avoid
function getGroupId(c) {
  return c & 0x0F;
}
```

### Kotlin/Java

- Kotlin preferred for new Android code
- Use `val` over `var` where possible
- Null safety: Use nullable types explicitly
- Follow Android coding standards

```kotlin
// Good
fun getGroupId(controlByte: Int): Int = controlByte and 0x0F

// Avoid
fun getGroupId(controlByte: Int): Int {
    return controlByte.and(0x0F)
}
```

### Documentation

- All public APIs must have documentation comments
- Use JSDoc for TypeScript, KDoc for Kotlin
- Include parameter descriptions and return values
- Add examples for complex functions

---

## Security Considerations

GRIN is designed to be secure by construction. When contributing:

1. **No executable code** in GRIN files
2. **Bounded resource consumption** always
3. **Validate all input** before processing
4. **No external resource access** during playback
5. **Fail safely** with clear error messages

Report security issues privately to the maintainers.

---

## Questions?

- Open an issue for questions
- Check existing issues before creating new ones
- Reference the specification for format questions

Thank you for contributing to GRIN!

#####/Makefile#####
.PHONY: help web-install web-build web-test web-lint web-typecheck android-build android-test clean

help:
	@echo "GRIN build helpers"
	@echo "  make web-install   Install web dependencies"
	@echo "  make web-build     Build web library"
	@echo "  make web-test      Run web tests"
	@echo "  make web-lint      Lint web code"
	@echo "  make web-typecheck Typecheck web code"
	@echo "  make android-build Build Android library"
	@echo "  make android-test  Run Android unit tests"
	@echo "  make clean         Clean build outputs"

web-install:
	cd web && npm install

web-build:
	cd web && npm run build

web-test:
	cd web && npm test

web-lint:
	cd web && npm run lint

web-typecheck:
	cd web && npm run typecheck

android-build:
	cd android && ./gradlew :lib:assembleRelease

android-test:
	cd android && ./gradlew :lib:testReleaseUnitTest

clean:
	cd web && npm run clean
	cd android && ./gradlew clean

#####/README.md#####
# GRIN (Graphic Readdressable Indexed Nodes)

GRIN is a deterministic image container format designed as an upgrade to traditional
images and GIFs. Instead of storing static frames or frame sequences, GRIN treats an
image as a programmable field of pixels that can be dynamically grouped, addressed,
and modulated over time.

## Core concept

- A `.grin` file is not a loop of frames.
- Nearly all animation logic lives in the file header.
- Narrow, bounded scripts operate on pixel groups and can shift colors, animate values,
  loop or diverge, and run once or indefinitely.
- Because logic is embedded, a `.grin` file can branch, repeat, or evolve without
  duplicating image data.
- Rendering requires only minimal runtime code. For web playback, a small amount of
  JavaScript is sufficient.
- GRIN is designed to be artist-friendly, portable, and low-infrastructure, while
  remaining fully deterministic.

## Technical summary

- Deterministic image container format
- 5-byte pixels: RGBA + control byte
- Fixed 128-byte header
- Bounded rules block (no unbounded metadata)
- 16 addressable groups per pixel
- Lock bit per pixel
- Opcode-driven modulation
- No frame storage required

This repository includes working implementations, tools, tests, and sample files.

## Implementations included

- Web TypeScript library with Canvas renderer
- `<grin-player>` web component
- Android Kotlin library with demo app
- CLI tools for validation, inspection, encoding, and decoding
- Tests and benchmarks for web and Android

## Repository layout

- `web/` - TypeScript implementation, web component, demo, tests
- `android/` - Kotlin implementation and demo app
- `tools/` - Node.js CLI utilities
- `samples/` - Reference `.grin` files (valid and invalid)
- `benchmarks/` - Performance harness
- `tests/` - Shared fixtures and generators
- `core/` - Reserved for a future cross-platform reference core

## CLI quick start (Node >= 18)

```bash
node tools/bin/grin-validate.js samples/minimal.grin
node tools/bin/grin-inspect.js samples/pulse_red.grin --header --rules
node tools/bin/grin-encode.js input.png output.grin
node tools/bin/grin-decode.js samples/pulse_red.grin output.png --frame 0
```

## Web library

```bash
cd web
npm install
npm test
npm run build
```

The demo lives in `web/demo/`. Build first so `web/demo/demo.js` can load `web/dist`.

## Minimal web embed (load a `.grin` URL)

A minimal embed uses the tiny loader in `web/embed/grin-embed.js`. It finds elements
with `data-grin-src`, loads `grin-player`, and mounts playback for you.

```html
<div data-grin-src="https://example.com/art/minimal.grin"></div>
<script type="module" src="web/embed/grin-embed.js"></script>
```

Optional attributes:

- `data-grin-autoplay` - set to `true` to auto-start playback.
- `data-grin-playbackrate` - numeric speed multiplier (for example `0.5` or `2`).
- `data-grin-lib` (on the script tag) - overrides the `grin-player` bundle URL.

Example using a custom `grin-player` bundle:

```html
<div data-grin-src="/media/pulse_red.grin" data-grin-autoplay="true"></div>
<script
  type="module"
  src="web/embed/grin-embed.js"
  data-grin-lib="/web/dist/grin-player.js"
></script>
```

## Android library and demo

```bash
cd android
./gradlew :demo:assembleDebug
```

The demo app loads sample files from `android/demo/src/main/assets/samples`.

## Samples

Regenerate sample files with:

```bash
node scripts/generate-samples.mjs
```

## Documentation

- Format specification: `grin_technical_specification_v_2.md`
- Architecture: `ARCHITECTURE.md`
- Contributing: `CONTRIBUTING.md`
- Security: `SECURITY.md`
- Samples: `samples/README.md`
- Docs index: `docs/README.md`

## Planned work

- Photoshop, Illustrator, and GIMP plugins
- Translation of `.grin` files to real DMX stage control
- Compatibility with large video walls and LED arrays

## Licensing status

THIS REPOSITORY IS CURRENTLY UNLICENSED.

You may build, experiment, and explore this code for personal and research purposes.

You may not redistribute the code, incorporate it into unrelated projects, or use the
code or its outputs for commercial purposes without explicit consent.

For commercial use, redistribution, or related project releases, contact:

quantumbraid@gmail.com

This standard is intentionally constrained for security reasons and to encourage
thoughtful, novel usage.

#####/SECURITY.md#####
# Security Policy

## Supported Versions

GRIN is currently pre-1.0. Security fixes are applied to the `main` branch only.

## Reporting a Vulnerability

Please report security issues via a private GitHub Security Advisory for this
repository. If you cannot use GitHub advisories, open an issue and request a
private contact channel.

## Disclosure Process

We will acknowledge reports within 7 days and provide an estimated timeline
for a fix once the issue is confirmed.

#####/agents.txt#####
================================================================================
                    GRIN PROJECT — AGENTIC CONTRACT v1.0
          Graphic Readdressable Indexed Nodes (.grin / .grn)
================================================================================

DOCUMENT PURPOSE
================================================================================

This contract defines the operational parameters, responsibilities, interfaces,
constraints, and coordination protocols for agentic AI systems working on the
GRIN project. All agents operating within this project MUST adhere to this
contract to ensure consistency, safety, and correctness.

================================================================================
SECTION 1: PROJECT IDENTITY
================================================================================

1.1 PROJECT NAME
    Full Name: Graphic Readdressable Indexed Nodes
    Short Name: GRIN
    File Extensions: .grin (primary), .grn (abbreviated)

1.2 PROJECT CLASSIFICATION
    Type: Binary Image Container Format + Playback Substrate
    Category: Deterministic Media Format
    Security Model: No Executable Code (Inspection-Safe)

1.3 CANONICAL REFERENCES
    Specification: grin_technical_specification_v_2.md
    Build Plan: todo.md
    Agent Contract: agents.txt (this document)

1.4 TARGET PLATFORMS
    Primary:
      - Android (Java/Kotlin, API 21+)
      - Web Browsers (JavaScript ES6+, Canvas API)
    Secondary:
      - Node.js (CLI tools)
      - Reference implementations (optional C/Rust)

================================================================================
SECTION 2: AGENT ROLES AND RESPONSIBILITIES
================================================================================

2.1 ROLE: SPECIFICATION_AGENT
--------------------------------------------------------------------------------
    Purpose: Maintain and interpret the GRIN technical specification
    
    Responsibilities:
      - Ensure all implementation decisions align with specification
      - Resolve ambiguities in spec by requesting clarification
      - Validate that code changes do not violate spec constraints
      - Track spec version and flag incompatible changes
    
    Authority:
      - MAY reject implementation that violates spec
      - MAY NOT modify specification without human approval
      - MUST flag any spec ambiguity before implementing
    
    Inputs:
      - grin_technical_specification_v_2.md
      - Implementation code under review
    
    Outputs:
      - Specification compliance reports
      - Clarification requests
      - Spec violation alerts

2.2 ROLE: BINARY_FORMAT_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement and validate binary file format handling
    
    Responsibilities:
      - Implement header serialization/deserialization
      - Implement pixel data read/write operations
      - Implement rules block encoding/decoding
      - Ensure little-endian byte ordering compliance
      - Validate all binary I/O against spec constraints
    
    Authority:
      - OWNS: core/src/binary/*, core/src/io/*
      - MAY define internal helper functions
      - MUST NOT change header size (fixed at 128 bytes)
      - MUST NOT change pixel size (fixed at 5 bytes)
    
    Constraints:
      - All multi-byte integers MUST be little-endian
      - Reserved fields MUST be written as zero
      - Reserved fields MUST be ignored on read (with optional warning)
    
    Validation Checkpoints:
      - Magic bytes: 0x47 0x52 0x49 0x4E ("GRIN")
      - Header size: exactly 128 bytes
      - Pixel data length: width × height × 5
      - Rule count: 0-16 inclusive
      - PixelDataOffset64: exactly 128

2.3 ROLE: DATA_STRUCTURE_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement core data structures for GRIN representation
    
    Responsibilities:
      - Implement GrinHeader class/struct
      - Implement GrinPixel class/struct
      - Implement GrinRule class/struct
      - Implement GrinImage container class
      - Implement GrinFile wrapper class
    
    Authority:
      - OWNS: core/src/model/*, core/src/types/*
      - MAY add convenience methods
      - MUST NOT add fields beyond spec definition
    
    Data Structure Invariants:
      GrinPixel:
        - R, G, B, A: uint8 (0-255)
        - C (control byte): uint8
          - Bits 0-3: Group ID (0-15)
          - Bits 4-6: Reserved (must be 0)
          - Bit 7: Lock bit (0=unlocked, 1=locked)
      
      GrinRule:
        - GroupMask: uint16 (bit i = group i targeted)
        - Opcode: uint8 (must be valid for OpcodeSetId)
        - Timing: uint8 (oscillator parameter)
      
      GrinHeader:
        - Fixed 128 bytes total
        - All fields per spec section 7.3

2.4 ROLE: VALIDATION_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement comprehensive validation for GRIN files
    
    Responsibilities:
      - Implement header validation suite
      - Implement pixel validation suite
      - Implement rule validation suite
      - Implement full-file validation orchestration
      - Generate detailed validation reports
    
    Authority:
      - OWNS: core/src/validation/*
      - MAY define validation severity levels (error, warning, info)
      - MUST implement both strict and permissive modes
    
    Validation Rules (MUST reject if violated):
      - Magic != "GRIN"
      - HeaderSize != 128
      - RuleCount > 16
      - PixelDataOffset64 != 128
      - PixelDataLength != width × height × 5
      - FileLength non-zero AND FileLength < 128 + PixelDataLength
    
    Validation Rules (SHOULD warn if violated):
      - Reserved fields non-zero
      - Control byte bits 4-6 non-zero
      - Unknown OpcodeSetId (future-proofing)

2.5 ROLE: OPCODE_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement the opcode system and opcode registry
    
    Responsibilities:
      - Define opcode enumeration (OpcodeSetId = 0)
      - Implement each opcode's apply() function
      - Implement timing parameter interpretation
      - Implement opcode registry for lookup
      - Ensure opcode statelessness
    
    Authority:
      - OWNS: core/src/opcode/*, core/src/timing/*
      - MAY NOT add opcodes beyond defined set without spec update
      - MUST ensure all opcodes have predictable worst-case cost
    
    Opcode Set 0 (Base Set):
      0x00: NOP         - No operation
      0x01: FADE_IN     - Increase alpha over time
      0x02: FADE_OUT    - Decrease alpha over time
      0x03: PULSE       - Oscillate alpha
      0x04: SHIFT_R     - Shift red channel
      0x05: SHIFT_G     - Shift green channel
      0x06: SHIFT_B     - Shift blue channel
      0x07: SHIFT_A     - Shift alpha channel
      0x08: INVERT      - Invert RGB channels
      0x09: ROTATE_HUE  - Rotate hue in HSL space
      0x0A: LOCK        - Set lock bit
      0x0B: UNLOCK      - Clear lock bit
      0x0C: TOGGLE_LOCK - Toggle lock bit
      0x0D-0x0F: Reserved
    
    Timing Byte Interpretation:
      Bits 0-3: Period (0-15, tick multiplier)
      Bits 4-5: Waveform (0=square, 1=triangle, 2=sine, 3=sawtooth)
      Bits 6-7: Phase offset (0-3, quarter-phase increments)
    
    Opcode Constraints:
      - MUST NOT accumulate state between ticks
      - MUST NOT allocate dynamic memory
      - MUST have O(1) time complexity per pixel
      - MUST NOT access external resources

2.6 ROLE: PLAYBACK_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement the playback engine and tick scheduling
    
    Responsibilities:
      - Implement PlaybackState management
      - Implement TickScheduler interface and implementations
      - Implement RuleEngine for rule evaluation
      - Implement pixel processing pipeline
      - Implement DisplayBuffer management
      - Implement GrinPlayer controller
    
    Authority:
      - OWNS: core/src/playback/*, core/src/engine/*
      - MAY optimize pixel processing (SIMD hints)
      - MUST NOT mutate source GrinImage pixels
    
    Playback Invariants:
      - Display buffer is SEPARATE from source pixels
      - Source pixels are NEVER modified during playback
      - Locked pixels are ALWAYS skipped
      - Tick counter MUST handle overflow gracefully
    
    Per-Tick Processing Loop (pseudocode):
      ```
      for each pixel in source:
          if pixel.isLocked():
              displayBuffer[i] = pixel.RGBA
              continue
          
          workingPixel = copy(pixel)
          for each activeRule:
              if activeRule.targetsGroup(pixel.groupId):
                  opcode = registry.get(activeRule.opcode)
                  opcode.apply(workingPixel, tick, activeRule.timing)
          
          displayBuffer[i] = workingPixel.RGBA
      ```

2.7 ROLE: ANDROID_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement Android/Java platform-specific components
    
    Responsibilities:
      - Implement Android module setup (Gradle)
      - Implement Java binary I/O (signed byte handling)
      - Implement Bitmap rendering integration
      - Implement GrinView Android component
      - Implement Choreographer-based tick scheduling
      - Implement ContentProvider support
      - Build demo application
    
    Authority:
      - OWNS: android/*
      - MAY use Android-specific APIs (Choreographer, Bitmap)
      - MUST maintain API 21+ compatibility
      - MUST handle lifecycle events (pause/resume)
    
    Android-Specific Concerns:
      - Java bytes are signed; use (& 0xFF) for unsigned
      - Use ByteBuffer for efficient binary parsing
      - Use Choreographer.postFrameCallback for vsync
      - Handle Bitmap recycling to prevent memory leaks
      - Use ContentResolver for URI-based loading

2.8 ROLE: WEB_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement Web/JavaScript platform-specific components
    
    Responsibilities:
      - Implement npm package setup
      - Implement JavaScript binary I/O (ArrayBuffer, DataView)
      - Implement Canvas rendering integration
      - Implement <grin-player> Web Component
      - Implement requestAnimationFrame tick scheduling
      - Implement Fetch/File API integration
      - Build demo web application
    
    Authority:
      - OWNS: web/*
      - MAY use browser APIs (Canvas, RAF, CustomElements)
      - MUST support ES6+ environments
      - MUST handle tab visibility changes
    
    JavaScript-Specific Concerns:
      - Use DataView for little-endian reads/writes
      - Be aware of Number.MAX_SAFE_INTEGER limits
      - Use requestAnimationFrame for smooth playback
      - Handle document.hidden for background tabs
      - Support both ESM and UMD module formats

2.9 ROLE: CLI_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement command-line tools for GRIN manipulation
    
    Responsibilities:
      - Implement grin-validate tool
      - Implement grin-inspect tool
      - Implement grin-encode tool
      - Implement grin-decode tool
    
    Authority:
      - OWNS: tools/*
      - MAY use Node.js-specific APIs
      - MUST support JSON output format
      - MUST return appropriate exit codes
    
    CLI Tool Specifications:
      grin-validate <file.grin> [--strict] [--json]
        Exit 0: Valid file
        Exit 1: Invalid file (errors)
        Exit 2: Warnings only (strict mode)
      
      grin-inspect <file.grin> [--header] [--rules] [--groups] [--pixels]
        Output: Human-readable or JSON file information
      
      grin-encode <input.png> <output.grin> [--groups <mask.png>] [--rules <rules.json>]
        Input: Standard image format (PNG/JPEG)
        Output: Valid .grin file
      
      grin-decode <input.grin> <output.png> [--frame <tick>] [--groups]
        Input: .grin file
        Output: PNG frame at specified tick

2.10 ROLE: TEST_AGENT
--------------------------------------------------------------------------------
    Purpose: Implement and maintain comprehensive test suites
    
    Responsibilities:
      - Set up test infrastructure (JUnit, Jest)
      - Implement unit tests for all modules
      - Implement integration tests
      - Implement fuzz testing
      - Implement performance benchmarks
      - Maintain test fixtures
    
    Authority:
      - OWNS: */tests/*, core/tests/*
      - MAY generate test fixtures programmatically
      - MUST achieve >80% code coverage
      - MUST include edge case tests
    
    Test Categories:
      - Binary Format: Round-trip serialization
      - Validation: Valid/invalid file handling
      - Opcode: Individual opcode behavior
      - Playback: Tick processing correctness
      - Integration: Full pipeline tests
      - Fuzz: Randomized invalid input handling
      - Performance: Timing benchmarks

2.11 ROLE: DOCUMENTATION_AGENT
--------------------------------------------------------------------------------
    Purpose: Create and maintain project documentation
    
    Responsibilities:
      - Generate API documentation (JavaDoc, JSDoc)
      - Write tutorial documentation
      - Maintain specification documentation
      - Write security documentation
      - Create visual diagrams
    
    Authority:
      - OWNS: docs/*
      - MAY create supplementary documentation
      - MUST keep docs in sync with implementation
    
    Documentation Requirements:
      - API docs: Generated from source code comments
      - Tutorials: Step-by-step guides with examples
      - Spec docs: Formal technical reference
      - Security docs: Threat model and mitigations

================================================================================
SECTION 3: INTER-AGENT COMMUNICATION PROTOCOL
================================================================================

3.1 MESSAGE FORMAT
--------------------------------------------------------------------------------
    All inter-agent communications MUST use the following format:
    
    ```
    [AGENT_ROLE] -> [TARGET_ROLE]
    Subject: <brief description>
    Type: REQUEST | RESPONSE | NOTIFICATION | QUERY
    Priority: CRITICAL | HIGH | NORMAL | LOW
    
    Body:
    <message content>
    
    Attachments:
    - <file references if any>
    ```

3.2 COORDINATION EVENTS
--------------------------------------------------------------------------------
    Agents MUST emit notifications for the following events:
    
    SPEC_VIOLATION_DETECTED:
      Emitter: Any agent
      Receiver: SPECIFICATION_AGENT
      Action: Block merge, request review
    
    INTERFACE_CHANGE_PROPOSED:
      Emitter: Any agent owning interface
      Receiver: All dependent agents
      Action: Review and approve before implementation
    
    TEST_FAILURE_DETECTED:
      Emitter: TEST_AGENT
      Receiver: Owning agent for failed code
      Action: Investigate and fix
    
    PHASE_COMPLETE:
      Emitter: Lead agent for phase
      Receiver: All agents
      Action: Begin next phase tasks

3.3 DEPENDENCY RESOLUTION
--------------------------------------------------------------------------------
    When an agent requires work from another agent:
    
    1. Check if dependency is already satisfied
    2. If not, emit DEPENDENCY_REQUEST message
    3. Wait for DEPENDENCY_SATISFIED response
    4. Do NOT proceed with dependent work until satisfied
    
    Dependency Chain (from todo.md):
    ```
    Phase 1 -> Phase 2 -> Phase 3 -> [Phase 4, 5, 6] -> [Phase 7, 8, 9]
    ```

================================================================================
SECTION 4: CODE OWNERSHIP AND MODIFICATION RULES
================================================================================

4.1 OWNERSHIP MATRIX
--------------------------------------------------------------------------------
    Path                          | Primary Owner        | Secondary
    ------------------------------|----------------------|-------------------
    grin_technical_specification* | SPECIFICATION_AGENT  | (human only)
    core/src/binary/*             | BINARY_FORMAT_AGENT  | VALIDATION_AGENT
    core/src/model/*              | DATA_STRUCTURE_AGENT | BINARY_FORMAT_AGENT
    core/src/validation/*         | VALIDATION_AGENT     | SPECIFICATION_AGENT
    core/src/opcode/*             | OPCODE_AGENT         | PLAYBACK_AGENT
    core/src/playback/*           | PLAYBACK_AGENT       | OPCODE_AGENT
    android/*                     | ANDROID_AGENT        | PLAYBACK_AGENT
    web/*                         | WEB_AGENT            | PLAYBACK_AGENT
    tools/*                       | CLI_AGENT            | VALIDATION_AGENT
    */tests/*                     | TEST_AGENT           | (all)
    docs/*                        | DOCUMENTATION_AGENT  | (all)

4.2 MODIFICATION RULES
--------------------------------------------------------------------------------
    PRIMARY OWNER:
      - MAY modify owned files without approval
      - MUST notify secondary owners of interface changes
      - MUST update tests for all changes
    
    SECONDARY OWNER:
      - MAY propose changes via pull request
      - MUST obtain primary owner approval
      - MAY make emergency fixes (with post-hoc review)
    
    NON-OWNER:
      - MUST NOT modify files without explicit permission
      - MAY propose changes via issue/discussion
      - MUST obtain both primary and secondary approval

4.3 IMMUTABLE ARTIFACTS
--------------------------------------------------------------------------------
    The following MUST NOT be modified by any agent without human approval:
    
    - grin_technical_specification_v_2.md (spec document)
    - agents.txt (this contract)
    - Header byte layout (128 bytes fixed)
    - Pixel byte layout (5 bytes fixed)
    - Control byte bit assignments
    - Opcode IDs for base set (0x00-0x0C)

================================================================================
SECTION 5: SAFETY AND SECURITY CONSTRAINTS
================================================================================

5.1 SECURITY INVARIANTS (MUST NEVER BE VIOLATED)
--------------------------------------------------------------------------------
    S1: GRIN files MUST NOT contain executable code
    S2: Parsing MUST NOT require unbounded memory allocation
    S3: Parsing MUST NOT require unbounded CPU time
    S4: All file offsets MUST be statically determinable
    S5: All rule effects MUST be statically inspectable
    S6: Playback MUST NOT access external resources
    S7: Playback MUST NOT mutate source data
    S8: All integer operations MUST be bounds-checked
    S9: All file reads MUST validate expected lengths
    S10: Malformed input MUST result in clear error (no crash)

5.2 RESOURCE BOUNDS
--------------------------------------------------------------------------------
    Maximum Values (implementation-defined, but bounded):
      MAX_WIDTH:  65535 pixels (uint16 practical limit)
      MAX_HEIGHT: 65535 pixels (uint16 practical limit)
      MAX_RULES:  16 (spec-mandated)
      MAX_GROUPS: 16 (spec-mandated, 4-bit group ID)
      HEADER_SIZE: 128 bytes (spec-mandated, fixed)
      PIXEL_SIZE: 5 bytes (spec-mandated, fixed)
    
    Memory Budget (per image):
      Header: 128 bytes (constant)
      Pixels: width × height × 5 bytes
      Display Buffer: width × height × 4 bytes
      Working Memory: O(1) per tick (no accumulation)

5.3 INPUT VALIDATION REQUIREMENTS
--------------------------------------------------------------------------------
    All agents processing external input MUST:
    
    1. Validate magic bytes before any other parsing
    2. Validate header size before reading header
    3. Validate all offsets before seeking
    4. Validate all lengths before allocating
    5. Reject files that exceed resource bounds
    6. Handle truncated files gracefully
    7. Handle corrupted data gracefully
    8. Never trust file-internal length fields without validation

================================================================================
SECTION 6: QUALITY STANDARDS
================================================================================

6.1 CODE QUALITY REQUIREMENTS
--------------------------------------------------------------------------------
    All code MUST:
      - Pass static analysis (linting)
      - Have >80% test coverage
      - Include documentation comments
      - Follow language-specific style guides
      - Be reviewed before merge
    
    All code SHOULD:
      - Have >90% test coverage for critical paths
      - Include example usage in comments
      - Be optimized for readability over cleverness

6.2 COMMIT STANDARDS
--------------------------------------------------------------------------------
    Commit Message Format:
    ```
    [PHASE.SECTION] Brief description (max 72 chars)
    
    Longer description if needed.
    
    - Bullet points for multiple changes
    - Reference spec section if applicable
    
    Refs: #issue-number (if applicable)
    Agent: AGENT_ROLE_NAME
    ```
    
    Example:
    ```
    [1.2] Implement header byte layout structure
    
    - Define all 128 header bytes per spec section 7.3
    - Add endianness handling for multi-byte fields
    - Include reserved field zero-initialization
    
    Refs: spec section 7.2, 7.3
    Agent: BINARY_FORMAT_AGENT
    ```

6.3 TESTING STANDARDS
--------------------------------------------------------------------------------
    Unit Tests:
      - One test file per source file
      - Test happy path and error paths
      - Test boundary values
      - Test with minimal and maximal inputs
    
    Integration Tests:
      - Test complete workflows
      - Test cross-component interactions
      - Test platform-specific behavior
    
    Fuzz Tests:
      - Random invalid headers
      - Truncated files
      - Corrupted pixel data
      - Invalid opcodes/rules

================================================================================
SECTION 7: TASK EXECUTION PROTOCOL
================================================================================

7.1 TASK LIFECYCLE
--------------------------------------------------------------------------------
    1. CLAIM: Agent announces intent to work on task
    2. EXECUTE: Agent performs work
    3. TEST: Agent verifies work with tests
    4. DOCUMENT: Agent updates relevant documentation
    5. REVIEW: Work is reviewed (self or peer)
    6. MERGE: Work is integrated into main branch
    7. NOTIFY: Agent emits TASK_COMPLETE notification

7.2 PARALLEL EXECUTION RULES
--------------------------------------------------------------------------------
    Tasks marked with *** in todo.md MAY be executed in parallel.
    
    Parallel Execution Requirements:
      - No shared mutable state between parallel tasks
      - Each task operates on distinct file set
      - Merge conflicts resolved by first-to-merge
      - Coordination required for interface definitions
    
    Sequential Execution Requirements:
      - Tasks without *** MUST wait for predecessors
      - Phase N generally requires Phase N-1 completion
      - Exception: Testing may run continuously

7.3 BLOCKING CONDITIONS
--------------------------------------------------------------------------------
    An agent MUST block and request assistance if:
    
    - Specification is ambiguous for current task
    - Required dependency is not yet implemented
    - Test failures cannot be resolved
    - Security constraint may be violated
    - Resource bounds may be exceeded
    - Human decision is required

================================================================================
SECTION 8: ERROR HANDLING PROTOCOL
================================================================================

8.1 ERROR CLASSIFICATION
--------------------------------------------------------------------------------
    FATAL: Cannot continue, immediate stop required
      - Examples: Spec violation, security breach, corruption
      - Action: Stop work, notify all agents, request human review
    
    ERROR: Task cannot complete, but project continues
      - Examples: Test failure, build error, validation error
      - Action: Retry with fix, or escalate if unfixable
    
    WARNING: Suboptimal but acceptable
      - Examples: Performance regression, code smell, deprecated API
      - Action: Log warning, continue, fix in follow-up
    
    INFO: Informational, no action required
      - Examples: Progress update, metric report
      - Action: Log, continue

8.2 ERROR RECOVERY
--------------------------------------------------------------------------------
    On FATAL error:
      1. Halt all related work immediately
      2. Preserve error state for diagnosis
      3. Emit FATAL_ERROR notification
      4. Await human intervention
    
    On ERROR:
      1. Attempt automatic fix (max 3 retries)
      2. If fix succeeds, continue with notification
      3. If fix fails, emit ERROR notification
      4. Await dependent agent or human assistance
    
    On WARNING:
      1. Log warning with context
      2. Continue execution
      3. Aggregate warnings in summary report

================================================================================
SECTION 9: DELIVERABLES CHECKLIST
================================================================================

9.1 CORE DELIVERABLES
--------------------------------------------------------------------------------
    [ ] grin_technical_specification_v_2.md (provided)
    [ ] todo.md (created)
    [ ] agents.txt (this document)
    
    [ ] core/ - Reference implementation
        [ ] Binary format handling
        [ ] Data structures
        [ ] Validation engine
        [ ] Opcode system
        [ ] Playback engine
    
    [ ] android/ - Android implementation
        [ ] Library module
        [ ] Demo application
    
    [ ] web/ - JavaScript implementation
        [ ] npm package
        [ ] Web component
        [ ] Demo application
    
    [ ] tools/ - CLI utilities
        [ ] grin-validate
        [ ] grin-inspect
        [ ] grin-encode
        [ ] grin-decode
    
    [ ] samples/ - Sample .grin files
        [ ] Minimal valid files
        [ ] Animation demos
        [ ] Edge case files
        [ ] Invalid files (for testing)
    
    [ ] docs/ - Documentation
        [ ] API reference
        [ ] Tutorials
        [ ] Security guide

9.2 QUALITY GATES
--------------------------------------------------------------------------------
    Before Phase N+1 may begin, Phase N must satisfy:
    
    [ ] All tasks completed (per todo.md)
    [ ] All tests passing
    [ ] Code coverage >80%
    [ ] Documentation updated
    [ ] No FATAL or ERROR issues outstanding
    [ ] Peer review completed (or self-review for solo work)

================================================================================
SECTION 10: GLOSSARY
================================================================================

    Term            | Definition
    ----------------|------------------------------------------------------------
    GRIN            | Graphic Readdressable Indexed Nodes (the format)
    Control Byte    | 5th byte of pixel, contains group ID and lock bit
    Group           | One of 16 addressable pixel categories (0-15)
    Group ID        | 4-bit identifier in control byte bits 0-3
    Lock Bit        | Bit 7 of control byte; locked pixels ignore rules
    GroupMask       | 16-bit mask where bit i targets group i
    Opcode          | Instruction code for pixel modulation (0x00-0x0F)
    OpcodeSetId     | Identifier for which opcode set is in use
    Timing          | 8-bit oscillator parameter for rule scheduling
    Tick            | One playback time unit (TickMicros microseconds)
    TickMicros      | Microseconds per tick (playback speed)
    Rule            | 4-byte entry: GroupMask (2) + Opcode (1) + Timing (1)
    RulesBlock      | Fixed 64-byte region containing up to 16 rules
    DisplayBuffer   | Output RGBA buffer (no control byte), separate from source
    Modulation      | Runtime effect on display (not stored data)

================================================================================
SECTION 11: REVISION HISTORY
================================================================================

    Version | Date       | Author         | Changes
    --------|------------|----------------|------------------------------------
    1.0     | 2026-01-10 | Initial Agent  | Initial contract creation

================================================================================
                              END OF CONTRACT
================================================================================

#####/android/build.gradle.kts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
// GRIN Android Library - Root Build Configuration
// Graphic Readdressable Indexed Nodes - Android/Kotlin Implementation

plugins {
    id("com.android.library") version "8.2.0" apply false
    id("com.android.application") version "8.2.0" apply false
    kotlin("android") version "1.9.21" apply false
    id("de.mannodermaus.android-junit5") version "1.10.0.0" apply false
    id("org.jetbrains.dokka") version "1.9.20" apply false
}

allprojects {
    group = "io.grin"
    version = "0.1.0"
}

tasks.register("clean", Delete::class) {
    delete(rootProject.layout.buildDirectory)
}

#####/android/demo/build.gradle.kts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
// GRIN Android Demo Application
// Demonstrates GRIN file loading, validation, and playback

plugins {
    id("com.android.application")
    kotlin("android")
}

android {
    namespace = "io.grin.demo"
    compileSdk = 34

    defaultConfig {
        applicationId = "io.grin.demo"
        minSdk = 21  // Match library minimum
        targetSdk = 34
        versionCode = 1
        versionName = "0.1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = true
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
        debug {
            isDebuggable = true
        }
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = "1.8"
    }

    buildFeatures {
        viewBinding = true
    }
}

dependencies {
    // GRIN library
    implementation(project(":lib"))
    
    // AndroidX core - stable, minimal
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("androidx.activity:activity-ktx:1.8.2")
    
    // Material Design for demo UI
    implementation("com.google.android.material:material:1.11.0")
    
    // ConstraintLayout for demo layouts
    implementation("androidx.constraintlayout:constraintlayout:2.1.4")
    
    // Lifecycle for demo
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.7.0")

    // CameraX for grid camera preview
    implementation("androidx.camera:camera-core:1.3.2")
    implementation("androidx.camera:camera-camera2:1.3.2")
    implementation("androidx.camera:camera-lifecycle:1.3.2")
    
    // Testing
    testImplementation("junit:junit:4.13.2")
    androidTestImplementation("androidx.test.ext:junit:1.1.5")
    androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
}
#####/android/demo/src/main/AndroidManifest.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<!--
  GRIN Demo Application Manifest
  Demonstrates .grin file loading and playback
-->
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <!-- Camera permission required for the grid preview pipeline. -->
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-feature android:name="android.hardware.camera" android:required="false" />

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.GrinDemo">

        <provider
            android:name="io.grin.lib.GrinContentProvider"
            android:authorities="${applicationId}.grin"
            android:exported="false"
            android:grantUriPermissions="true" />
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="@string/app_name"
            android:theme="@style/Theme.GrinDemo">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
            
            <!-- Handle .grin and .grn file opens -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:mimeType="application/octet-stream" />
                <data android:pathPattern=".*\\.grin" />
                <data android:pathPattern=".*\\.grn" />
            </intent-filter>
        </activity>

        <activity
            android:name=".GridCameraActivity"
            android:exported="false"
            android:label="@string/grid_camera_title"
            android:theme="@style/Theme.GrinDemo" />
    </application>

</manifest>
#####/android/demo/src/main/kotlin/io/grin/demo/MainActivity.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.SeekBar
import android.widget.Toast
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AppCompatActivity
import io.grin.demo.databinding.ActivityMainBinding
import io.grin.lib.GrinFile
import io.grin.lib.GrinUriLoader

class MainActivity : AppCompatActivity() {
    private lateinit var binding: ActivityMainBinding

    private val filePicker =
        registerForActivityResult(ActivityResultContracts.OpenDocument()) { uri ->
            if (uri != null) {
                contentResolver.takePersistableUriPermission(
                    uri,
                    Intent.FLAG_GRANT_READ_URI_PERMISSION
                )
                loadUri(uri)
            }
        }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        binding.loadButton.setOnClickListener {
            filePicker.launch(arrayOf("application/octet-stream"))
        }
        binding.cameraButton.setOnClickListener {
            // Launch the grid camera preview workflow.
            startActivity(Intent(this, GridCameraActivity::class.java))
        }
        binding.playButton.setOnClickListener { binding.grinView.play() }
        binding.pauseButton.setOnClickListener { binding.grinView.pause() }
        binding.stopButton.setOnClickListener { binding.grinView.stop() }

        binding.seekBar.setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
            override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                if (fromUser) {
                    binding.grinView.seek(progress.toLong())
                }
            }

            override fun onStartTrackingTouch(seekBar: SeekBar?) {}
            override fun onStopTrackingTouch(seekBar: SeekBar?) {}
        })

        setupSampleList()

        intent?.data?.let { loadUri(it) }
    }

    override fun onNewIntent(intent: Intent?) {
        super.onNewIntent(intent)
        intent?.data?.let { loadUri(it) }
    }

    private fun setupSampleList() {
        val samples = assets.list("samples")?.sorted() ?: emptyList()
        if (samples.isEmpty()) {
            binding.samplesTitle.text = getString(R.string.no_samples)
            return
        }
        val adapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, samples)
        binding.samplesList.adapter = adapter
        binding.samplesList.setOnItemClickListener { _, _, position, _ ->
            val assetName = samples[position]
            val file = GrinUriLoader.fromAsset(this, "samples/$assetName")
            loadFile(file)
        }
    }

    private fun loadUri(uri: Uri) {
        try {
            val file = GrinUriLoader.load(this, uri)
            loadFile(file)
        } catch (exception: Exception) {
            Toast.makeText(this, getString(R.string.error_loading), Toast.LENGTH_LONG).show()
        }
    }

    private fun loadFile(file: GrinFile) {
        binding.grinView.load(file)
        binding.metadataText.text = buildMetadata(file)
    }

    private fun buildMetadata(file: GrinFile): String {
        val header = file.header
        val dimensions = getString(R.string.dimensions_format, header.width.toInt(), header.height.toInt())
        val rules = getString(R.string.rule_count_format, header.ruleCount)
        val tickRate = getString(R.string.tick_rate_format, header.tickMicros.toInt())
        return listOf(dimensions, rules, tickRate).joinToString(separator = "\n")
    }
}
#####/android/demo/src/main/res/drawable/ic_launcher_foreground.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path
        android:fillColor="#5AC8FA"
        android:pathData="M18,18h72v72h-72z" />
    <path
        android:fillColor="#FFFFFF"
        android:pathData="M36,36h36v36h-36z" />
</vector>

#####/android/demo/src/main/res/layout/activity_main.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/root"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <io.grin.lib.GrinView
        android:id="@+id/grinView"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:background="#000000" />

    <TextView
        android:id="@+id/metadataText"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:paddingTop="8dp"
        android:text="@string/file_info_title" />

    <SeekBar
        android:id="@+id/seekBar"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:max="1000" />

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:gravity="center_horizontal"
        android:orientation="horizontal">

        <Button
            android:id="@+id/loadButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/load_file" />

        <Button
            android:id="@+id/cameraButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/open_camera" />

        <Button
            android:id="@+id/playButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/play" />

        <Button
            android:id="@+id/pauseButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/pause" />

        <Button
            android:id="@+id/stopButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/stop" />
    </LinearLayout>

    <TextView
        android:id="@+id/samplesTitle"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="12dp"
        android:text="@string/samples_title"
        android:textStyle="bold" />

    <ListView
        android:id="@+id/samplesList"
        android:layout_width="match_parent"
        android:layout_height="120dp"
        android:layout_marginTop="4dp"
        android:dividerHeight="1dp" />
</LinearLayout>
#####/android/demo/src/main/res/mipmap-anydpi-v26/ic_launcher.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background" />
    <foreground android:drawable="@drawable/ic_launcher_foreground" />
</adaptive-icon>

#####/android/demo/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background" />
    <foreground android:drawable="@drawable/ic_launcher_foreground" />
</adaptive-icon>

#####/android/demo/src/main/res/values/colors.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<resources>
    <!-- GRIN Brand Colors -->
    <color name="grin_primary">#4CAF50</color>
    <color name="grin_primary_dark">#388E3C</color>
    <color name="grin_primary_light">#C8E6C9</color>
    
    <color name="grin_secondary">#2196F3</color>
    <color name="grin_secondary_dark">#1976D2</color>
    <color name="grin_secondary_light">#BBDEFB</color>
    
    <!-- Semantic Colors -->
    <color name="grin_error">#F44336</color>
    <color name="grin_warning">#FF9800</color>
    <color name="grin_success">#4CAF50</color>
    
    <!-- Group Visualization Colors (for debugging/demo) -->
    <color name="group_0">#F44336</color>
    <color name="group_1">#E91E63</color>
    <color name="group_2">#9C27B0</color>
    <color name="group_3">#673AB7</color>
    <color name="group_4">#3F51B5</color>
    <color name="group_5">#2196F3</color>
    <color name="group_6">#03A9F4</color>
    <color name="group_7">#00BCD4</color>
    <color name="group_8">#009688</color>
    <color name="group_9">#4CAF50</color>
    <color name="group_10">#8BC34A</color>
    <color name="group_11">#CDDC39</color>
    <color name="group_12">#FFEB3B</color>
    <color name="group_13">#FFC107</color>
    <color name="group_14">#FF9800</color>
    <color name="group_15">#FF5722</color>
</resources>

#####/android/demo/src/main/res/values/ic_launcher_background.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<resources>
    <color name="ic_launcher_background">#202124</color>
</resources>

#####/android/demo/src/main/res/values/strings.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<resources>
    <string name="app_name">GRIN Demo</string>
    <string name="description">Graphic Readdressable Indexed Nodes - Demo</string>
    
    <!-- UI Strings -->
    <string name="load_file">Load .grin File</string>
    <string name="open_camera">Open Grid Camera</string>
    <string name="play">Play</string>
    <string name="pause">Pause</string>
    <string name="stop">Stop</string>
    <string name="samples_title">Sample Files</string>
    <string name="no_samples">No samples found</string>
    
    <!-- File info -->
    <string name="file_info_title">File Information</string>
    <string name="dimensions_format">Dimensions: %1$d × %2$d</string>
    <string name="rule_count_format">Rules: %1$d</string>
    <string name="tick_rate_format">Tick Rate: %1$d µs</string>

    <!-- Grid camera -->
    <string name="grid_camera_title">Grid Camera Preview</string>
    <string name="camera_performance_default">Grid: -- × -- · Palette: --</string>
    <string name="camera_performance_format">Grid: %1$d × %2$d · Palette: %3$d</string>
    <string name="close">Close</string>
    
    <!-- Errors -->
    <string name="error_invalid_file">Invalid GRIN file</string>
    <string name="error_file_not_found">File not found</string>
    <string name="error_loading">Error loading file</string>
    <string name="camera_permission_denied">Camera permission denied.</string>
    <string name="camera_start_failed">Unable to start camera preview.</string>
</resources>
#####/android/demo/src/main/res/values/themes.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<resources>
    <!-- Base application theme using Material 3 -->
    <style name="Theme.GrinDemo" parent="Theme.Material3.DayNight">
        <!-- Primary brand color -->
        <item name="colorPrimary">@color/grin_primary</item>
        <item name="colorPrimaryVariant">@color/grin_primary_dark</item>
        <item name="colorOnPrimary">@android:color/white</item>
        
        <!-- Secondary brand color -->
        <item name="colorSecondary">@color/grin_secondary</item>
        <item name="colorSecondaryVariant">@color/grin_secondary_dark</item>
        <item name="colorOnSecondary">@android:color/white</item>
        
        <!-- Status bar color -->
        <item name="android:statusBarColor">@color/grin_primary_dark</item>
    </style>
</resources>

#####/android/gradle/wrapper/gradle-wrapper.properties#####
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists

#####/android/gradle.properties#####
android.useAndroidX=true

#####/android/gradlew#####
#!/bin/sh

#
# Copyright © 2015-2021 the original authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

##############################################################################
#
#   Gradle start up script for POSIX generated by Gradle.
#
#   Important for running:
#
#   (1) You need a POSIX-compliant shell to run this script. If your /bin/sh is
#       noncompliant, but you have some other compliant shell such as ksh or
#       bash, then to run this script, type that shell name before the whole
#       command line, like:
#
#           ksh Gradle
#
#       Busybox and similar reduced shells will NOT work, because this script
#       requires all of these POSIX shell features:
#         * functions;
#         * expansions «$var», «${var}», «${var:-default}», «${var+SET}»,
#           «${var#prefix}», «${var%suffix}», and «$( cmd )»;
#         * compound commands having a testable exit status, especially «case»;
#         * various built-in commands including «command», «set», and «ulimit».
#
#   Important for patching:
#
#   (2) This script targets any POSIX shell, so it avoids extensions provided
#       by Bash, Ksh, etc; in particular arrays are avoided.
#
#       The "traditional" practice of packing multiple parameters into a
#       space-separated string is a well documented source of bugs and security
#       problems, so this is (mostly) avoided, by progressively accumulating
#       options in "$@", and eventually passing that to Java.
#
#       Where the inherited environment variables (DEFAULT_JVM_OPTS, JAVA_OPTS,
#       and GRADLE_OPTS) rely on word-splitting, this is performed explicitly;
#       see the in-line comments for details.
#
#       There are tweaks for specific operating systems such as AIX, CygWin,
#       Darwin, MinGW, and NonStop.
#
#   (3) This script is generated from the Groovy template
#       https://github.com/gradle/gradle/blob/HEAD/subprojects/plugins/src/main/resources/org/gradle/api/internal/plugins/unixStartScript.txt
#       within the Gradle project.
#
#       You can find Gradle at https://github.com/gradle/gradle/.
#
##############################################################################

# Attempt to set APP_HOME

# Resolve links: $0 may be a link
app_path=$0

# Need this for daisy-chained symlinks.
while
    APP_HOME=${app_path%"${app_path##*/}"}  # leaves a trailing /; empty if no leading path
    [ -h "$app_path" ]
do
    ls=$( ls -ld "$app_path" )
    link=${ls#*' -> '}
    case $link in             #(
      /*)   app_path=$link ;; #(
      *)    app_path=$APP_HOME$link ;;
    esac
done

# This is normally unused
# shellcheck disable=SC2034
APP_BASE_NAME=${0##*/}
# Discard cd standard output in case $CDPATH is set (https://github.com/gradle/gradle/issues/25036)
APP_HOME=$( cd "${APP_HOME:-./}" > /dev/null && pwd -P ) || exit

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD=maximum

warn () {
    echo "$*"
} >&2

die () {
    echo
    echo "$*"
    echo
    exit 1
} >&2

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "$( uname )" in                #(
  CYGWIN* )         cygwin=true  ;; #(
  Darwin* )         darwin=true  ;; #(
  MSYS* | MINGW* )  msys=true    ;; #(
  NONSTOP* )        nonstop=true ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar


# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD=$JAVA_HOME/jre/sh/java
    else
        JAVACMD=$JAVA_HOME/bin/java
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD=java
    if ! command -v java >/dev/null 2>&1
    then
        die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
fi

# Increase the maximum file descriptors if we can.
if ! "$cygwin" && ! "$darwin" && ! "$nonstop" ; then
    case $MAX_FD in #(
      max*)
        # In POSIX sh, ulimit -H is undefined. That's why the result is checked to see if it worked.
        # shellcheck disable=SC2039,SC3045
        MAX_FD=$( ulimit -H -n ) ||
            warn "Could not query maximum file descriptor limit"
    esac
    case $MAX_FD in  #(
      '' | soft) :;; #(
      *)
        # In POSIX sh, ulimit -n is undefined. That's why the result is checked to see if it worked.
        # shellcheck disable=SC2039,SC3045
        ulimit -n "$MAX_FD" ||
            warn "Could not set maximum file descriptor limit to $MAX_FD"
    esac
fi

# Collect all arguments for the java command, stacking in reverse order:
#   * args from the command line
#   * the main class name
#   * -classpath
#   * -D...appname settings
#   * --module-path (only if needed)
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, and GRADLE_OPTS environment variables.

# For Cygwin or MSYS, switch paths to Windows format before running java
if "$cygwin" || "$msys" ; then
    APP_HOME=$( cygpath --path --mixed "$APP_HOME" )
    CLASSPATH=$( cygpath --path --mixed "$CLASSPATH" )

    JAVACMD=$( cygpath --unix "$JAVACMD" )

    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    for arg do
        if
            case $arg in                                #(
              -*)   false ;;                            # don't mess with options #(
              /?*)  t=${arg#/} t=/${t%%/*}              # looks like a POSIX filepath
                    [ -e "$t" ] ;;                      #(
              *)    false ;;
            esac
        then
            arg=$( cygpath --path --ignore --mixed "$arg" )
        fi
        # Roll the args list around exactly as many times as the number of
        # args, so each arg winds up back in the position where it started, but
        # possibly modified.
        #
        # NB: a `for` loop captures its iteration list before it begins, so
        # changing the positional parameters here affects neither the number of
        # iterations, nor the values presented in `arg`.
        shift                   # remove old arg
        set -- "$@" "$arg"      # push replacement arg
    done
fi


# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'

# Collect all arguments for the java command:
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, JAVA_OPTS, and optsEnvironmentVar are not allowed to contain shell fragments,
#     and any embedded shellness will be escaped.
#   * For example: A user cannot expect ${Hostname} to be expanded, as it is an environment variable and will be
#     treated as '${Hostname}' itself on the command line.

set -- \
        "-Dorg.gradle.appname=$APP_BASE_NAME" \
        -classpath "$CLASSPATH" \
        org.gradle.wrapper.GradleWrapperMain \
        "$@"

# Stop when "xargs" is not available.
if ! command -v xargs >/dev/null 2>&1
then
    die "xargs is not available"
fi

# Use "xargs" to parse quoted args.
#
# With -n1 it outputs one arg per line, with the quotes and backslashes removed.
#
# In Bash we could simply go:
#
#   readarray ARGS < <( xargs -n1 <<<"$var" ) &&
#   set -- "${ARGS[@]}" "$@"
#
# but POSIX shell has neither arrays nor command substitution, so instead we
# post-process each arg (as a line of input to sed) to backslash-escape any
# character that might be a shell metacharacter, then use eval to reverse
# that process (while maintaining the separation between arguments), and wrap
# the whole thing up as a single "set" statement.
#
# This will of course break if any of these variables contains a newline or
# an unmatched quote.
#

eval "set -- $(
        printf '%s\n' "$DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS" |
        xargs -n1 |
        sed ' s~[^-[:alnum:]+,./:=@_]~\\&~g; ' |
        tr '\n' ' '
    )" '"$@"'

exec "$JAVACMD" "$@"

#####/android/gradlew.bat#####
@rem
@rem Copyright 2015 the original author or authors.
@rem
@rem Licensed under the Apache License, Version 2.0 (the "License");
@rem you may not use this file except in compliance with the License.
@rem You may obtain a copy of the License at
@rem
@rem      https://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem

@if "%DEBUG%"=="" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

set DIRNAME=%~dp0
if "%DIRNAME%"=="" set DIRNAME=.
@rem This is normally unused
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Resolve any "." and ".." in APP_HOME to make it shorter.
for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if %ERRORLEVEL% equ 0 goto execute

echo.
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto execute

echo.
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar


@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*

:end
@rem End local scope for the variables with windows NT shell
if %ERRORLEVEL% equ 0 goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
set EXIT_CODE=%ERRORLEVEL%
if %EXIT_CODE% equ 0 set EXIT_CODE=1
if not ""=="%GRADLE_EXIT_CONSOLE%" exit %EXIT_CODE%
exit /b %EXIT_CODE%

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega

#####/android/lib/build.gradle.kts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
// GRIN Android Library Module
// Zero-dependency core library for rendering .grin files on Android

plugins {
    id("com.android.library")
    kotlin("android")
    id("de.mannodermaus.android-junit5")
    id("org.jetbrains.dokka")
    id("maven-publish")
    id("signing")
}

android {
    namespace = "io.grin.lib"
    compileSdk = 34

    defaultConfig {
        minSdk = 21  // Android 5.0 Lollipop - minimum supported
        
        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
        consumerProguardFiles("consumer-rules.pro")
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = "1.8"
    }

    buildFeatures {
        buildConfig = true
    }

    testOptions {
        unitTests.all {
            it.useJUnitPlatform()
        }
    }

    publishing {
        singleVariant("release") {
            withSourcesJar()
            withJavadocJar()
        }
    }
}

afterEvaluate {
    publishing {
        publications {
            create<MavenPublication>("release") {
                // Publish the Android release variant to Maven-compatible repositories.
                from(components["release"])
                groupId = project.group.toString()
                artifactId = "grin-android"
                version = project.version.toString()

                pom {
                    name.set("GRIN Android Library")
                    description.set("GRIN (Graphic Readdressable Indexed Nodes) Android/Kotlin implementation.")
                    url.set("https://github.com/grin-format/grin")

                    licenses {
                        license {
                            name.set("MIT License")
                            url.set("https://opensource.org/licenses/MIT")
                            distribution.set("repo")
                        }
                    }

                    developers {
                        developer {
                            id.set("grin-contributors")
                            name.set("GRIN Project Contributors")
                            url.set("https://github.com/grin-format/grin")
                        }
                    }

                    scm {
                        connection.set("scm:git:https://github.com/grin-format/grin.git")
                        developerConnection.set("scm:git:ssh://git@github.com:grin-format/grin.git")
                        url.set("https://github.com/grin-format/grin")
                    }
                }
            }
        }

        repositories {
            maven {
                // Central Publisher Portal endpoint for Maven Central deployments.
                name = "central"
                url = uri("https://central.sonatype.com/api/v1/publisher")
                credentials {
                    // Use Central Portal token credentials from Gradle properties or env vars.
                    username = findProperty("centralUsername") as String?
                        ?: System.getenv("CENTRAL_USERNAME")
                    password = findProperty("centralPassword") as String?
                        ?: System.getenv("CENTRAL_PASSWORD")
                }
            }
        }
    }
}

signing {
    // Only require signing when PGP credentials are provided.
    val signingKey = findProperty("signingKey") as String? ?: System.getenv("SIGNING_KEY")
    val signingPassword = findProperty("signingPassword") as String?
        ?: System.getenv("SIGNING_PASSWORD")
    if (!signingKey.isNullOrBlank() && !signingPassword.isNullOrBlank()) {
        // Keep PGP keys in memory for Central Publisher Portal-compatible signing.
        useInMemoryPgpKeys(signingKey, signingPassword)
        sign(publishing.publications["release"])
    }
}

tasks.dokkaHtml {
    outputDirectory.set(rootProject.file("../docs/api/android"))
    dokkaSourceSets.configureEach {
        jdkVersion.set(8)
        reportUndocumented.set(false)
        skipDeprecated.set(false)
    }
}

dependencies {
    // Core AndroidX - minimal dependencies for stability
    implementation("androidx.annotation:annotation:1.7.1")
    
    // Unit testing
    testImplementation("junit:junit:4.13.2")
    testImplementation("org.jetbrains.kotlin:kotlin-test:1.9.21")
    testImplementation("org.junit.jupiter:junit-jupiter:5.10.2")
    testRuntimeOnly("org.junit.vintage:junit-vintage-engine:5.10.2")
    
    // Instrumented testing
    androidTestImplementation("androidx.test.ext:junit:1.1.5")
    androidTestImplementation("androidx.test:runner:1.5.2")
    androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
}

#####/android/lib/consumer-rules.pro#####
# GRIN library consumer ProGuard/R8 rules
# Consumers generally do not need additional keep rules.

#####/android/lib/proguard-rules.pro#####
# GRIN library ProGuard/R8 rules
# No additional rules required; keep default shrinker behavior.

#####/android/lib/src/androidTest/kotlin/io/grin/lib/GrinBenchmarkTest.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import android.graphics.Bitmap
import android.graphics.Canvas
import android.util.Log
import androidx.test.ext.junit.runners.AndroidJUnit4
import org.junit.Assert.assertTrue
import org.junit.Test
import org.junit.runner.RunWith

@RunWith(AndroidJUnit4::class)
class GrinBenchmarkTest {
    @Test
    fun benchmarkBitmapRenderer() {
        val width = 128
        val height = 128
        val buffer = DisplayBuffer(width, height)
        var index = 0
        while (index < buffer.rgbaData.size) {
            buffer.rgbaData[index] = 0x20
            buffer.rgbaData[index + 1] = 0x40
            buffer.rgbaData[index + 2] = 0x60
            buffer.rgbaData[index + 3] = 0xFF.toByte()
            index += 4
        }

        val renderer = GrinBitmapRenderer()
        var bitmap: Bitmap? = null
        val start = System.nanoTime()
        repeat(30) {
            bitmap = renderer.render(buffer, bitmap)
        }
        val elapsedMs = (System.nanoTime() - start) / 1_000_000
        Log.i("GrinBenchmark", "Bitmap render x30: ${elapsedMs}ms")
        assertTrue(elapsedMs >= 0)
    }

    @Test
    fun benchmarkCanvasDraw() {
        val width = 256
        val height = 256
        val bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888)
        val canvas = Canvas(bitmap)
        val start = System.nanoTime()
        repeat(60) {
            canvas.drawBitmap(bitmap, 0f, 0f, null)
        }
        val elapsedMs = (System.nanoTime() - start) / 1_000_000
        Log.i("GrinBenchmark", "Canvas draw x60: ${elapsedMs}ms")
        assertTrue(elapsedMs >= 0)
    }
}

#####/android/lib/src/main/AndroidManifest.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<!--
  GRIN Android Library Manifest
  Graphic Readdressable Indexed Nodes
  
  This library requires no special permissions.
  All GRIN file parsing is done in-memory with bounded resource consumption.
-->
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- No permissions required - GRIN is a self-contained format -->
</manifest>

#####/android/lib/src/main/kotlin/io/grin/lib/AndroidTickScheduler.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import android.view.Choreographer

open class AndroidTickScheduler(private val tickMicros: Long) : TickScheduler {
    private var tickCallback: TickCallback? = null
    private var currentTick: Long = 0
    private var accumulatorMicros: Long = 0
    private var lastFrameNanos: Long = 0
    private var running = false

    private val frameCallback: Choreographer.FrameCallback =
        object : Choreographer.FrameCallback {
            override fun doFrame(frameTimeNanos: Long) {
                if (!running) {
                    return
                }
                if (lastFrameNanos == 0L) {
                    lastFrameNanos = frameTimeNanos
                }
                val deltaMicros = (frameTimeNanos - lastFrameNanos) / 1000
                lastFrameNanos = frameTimeNanos
                accumulatorMicros += deltaMicros

                val step = if (tickMicros <= 0) 1L else tickMicros
                while (accumulatorMicros >= step) {
                    accumulatorMicros -= step
                    currentTick = nextTick(currentTick)
                    tickCallback?.invoke(currentTick)
                }

                Choreographer.getInstance().postFrameCallback(this)
            }
        }

    override fun start() {
        if (running) {
            return
        }
        running = true
        lastFrameNanos = 0
        accumulatorMicros = 0
        Choreographer.getInstance().postFrameCallback(frameCallback)
    }

    override fun stop() {
        if (!running) {
            return
        }
        running = false
        Choreographer.getInstance().removeFrameCallback(frameCallback)
    }

    override fun setTickCallback(cb: TickCallback) {
        tickCallback = cb
    }

    override fun getCurrentTick(): Long = currentTick
}

private fun nextTick(currentTick: Long): Long {
    return if (currentTick == Long.MAX_VALUE) 0L else currentTick + 1
}

#####/android/lib/src/main/kotlin/io/grin/lib/BaseOpcodes.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

object BaseOpcodes {
    const val NOP = 0x00
    const val FADE_IN = 0x01
    const val FADE_OUT = 0x02
    const val PULSE = 0x03
    const val SHIFT_R = 0x04
    const val SHIFT_G = 0x05
    const val SHIFT_B = 0x06
    const val SHIFT_A = 0x07
    const val INVERT = 0x08
    const val ROTATE_HUE = 0x09
    const val LOCK = 0x0A
    const val UNLOCK = 0x0B
    const val TOGGLE_LOCK = 0x0C
}

#####/android/lib/src/main/kotlin/io/grin/lib/ChoreographerTickScheduler.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

class ChoreographerTickScheduler(tickMicros: Long) : AndroidTickScheduler(tickMicros)

#####/android/lib/src/main/kotlin/io/grin/lib/DisplayBuffer.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import android.graphics.Bitmap

class DisplayBuffer(val width: Int, val height: Int) {
    val rgbaData: ByteArray = ByteArray(width * height * 4)

    init {
        require(width > 0 && height > 0) { "DisplayBuffer dimensions must be positive" }
    }

    fun clear() {
        rgbaData.fill(0)
    }

    fun setPixel(x: Int, y: Int, r: Int, g: Int, b: Int, a: Int) {
        require(x >= 0 && y >= 0 && x < width && y < height) { "Pixel coordinates out of bounds" }
        val offset = (y * width + x) * 4
        rgbaData[offset] = r.toByte()
        rgbaData[offset + 1] = g.toByte()
        rgbaData[offset + 2] = b.toByte()
        rgbaData[offset + 3] = a.toByte()
    }

    fun toBitmap(): Bitmap {
        val pixels = IntArray(width * height)
        var index = 0
        var pixelIndex = 0
        while (index < rgbaData.size) {
            val r = rgbaData[index].toInt() and 0xFF
            val g = rgbaData[index + 1].toInt() and 0xFF
            val b = rgbaData[index + 2].toInt() and 0xFF
            val a = rgbaData[index + 3].toInt() and 0xFF
            pixels[pixelIndex] = (a shl 24) or (r shl 16) or (g shl 8) or b
            index += 4
            pixelIndex += 1
        }
        return Bitmap.createBitmap(pixels, width, height, Bitmap.Config.ARGB_8888)
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import java.io.InputStream
import java.io.OutputStream

data class GrinHeaderReadResult(
    val header: GrinHeader,
    val warnings: List<String>
)

data class GrinPixelReadResult(
    val pixels: List<GrinPixel>,
    val warnings: List<String>
)

data class GrinRulesReadResult(
    val rules: List<GrinRule>,
    val warnings: List<String>
)

fun readHeader(input: InputStream): GrinHeaderReadResult {
    val headerBytes = ByteArray(GrinFormat.HEADER_SIZE_BYTES)
    readFully(input, headerBytes)
    val header = GrinHeader.deserialize(headerBytes)
    val validation = header.validate()
    require(validation.ok) { "Invalid GRIN header: ${validation.errors.joinToString("; ")}" }
    return GrinHeaderReadResult(header, validation.warnings)
}

fun writeHeader(header: GrinHeader, output: OutputStream) {
    val pixelDataLength = safeMultiply(
        header.width,
        header.height
    )?.let { safeMultiply(it, GrinFormat.PIXEL_SIZE_BYTES.toLong()) }
        ?: throw IllegalArgumentException("PixelDataLength overflow for width/height")

    val fileLength = if (header.fileLength != 0L) {
        header.fileLength
    } else {
        GrinFormat.HEADER_SIZE_BYTES.toLong() + pixelDataLength
    }

    val normalized = header.copy(
        headerSize = GrinFormat.HEADER_SIZE_BYTES,
        pixelDataLength = pixelDataLength,
        fileLength = fileLength,
        pixelDataOffset = GrinFormat.HEADER_SIZE_BYTES.toLong(),
        flags = 0,
        reservedA = 0L,
        reservedB = 0L
    )

    output.write(normalized.serialize())
}

fun readPixelData(input: InputStream, width: Long, height: Long): GrinPixelReadResult {
    val pixelCount = safeMultiply(width, height)
        ?: throw IllegalArgumentException("Pixel count overflow for width/height")
    require(pixelCount <= Int.MAX_VALUE.toLong()) { "Pixel count exceeds Int range" }

    val pixels = ArrayList<GrinPixel>(pixelCount.toInt())
    var reservedCount = 0
    val buffer = ByteArray(GrinFormat.PIXEL_SIZE_BYTES)
    var index = 0L
    while (index < pixelCount) {
        readFully(input, buffer)
        val pixel = GrinPixel.fromBytes(buffer)
        if ((pixel.c and GrinControlByte.RESERVED_MASK) != 0) {
            reservedCount += 1
        }
        pixels.add(pixel)
        index += 1
    }

    val warnings = mutableListOf<String>()
    if (reservedCount > 0) {
        warnings.add("Control byte reserved bits set on $reservedCount pixels")
    }
    return GrinPixelReadResult(pixels, warnings)
}

fun writePixelData(pixels: List<GrinPixel>, output: OutputStream) {
    val buffer = ByteArray(GrinFormat.PIXEL_SIZE_BYTES)
    for (pixel in pixels) {
        buffer[0] = pixel.r.toByte()
        buffer[1] = pixel.g.toByte()
        buffer[2] = pixel.b.toByte()
        buffer[3] = pixel.a.toByte()
        val control = pixel.c and 0xFF
        val sanitized = control and GrinControlByte.RESERVED_MASK.inv() and 0xFF
        buffer[4] = sanitized.toByte()
        output.write(buffer)
    }
}

fun readRulesBlock(
    bytes: ByteArray,
    ruleCount: Int,
    opcodeSetId: Int
): GrinRulesReadResult {
    require(bytes.size == GrinFormat.RULES_BLOCK_SIZE) { "Rules block must be 64 bytes" }
    require(ruleCount <= GrinFormat.MAX_RULE_COUNT) { "RuleCount exceeds ${GrinFormat.MAX_RULE_COUNT}" }

    val rules = mutableListOf<GrinRule>()
    var index = 0
    while (index < ruleCount) {
        val offset = index * GrinFormat.RULE_ENTRY_SIZE
        val slice = bytes.copyOfRange(offset, offset + GrinFormat.RULE_ENTRY_SIZE)
        val rule = GrinRule.deserialize(slice)
        require(isValidOpcode(opcodeSetId, rule.opcode)) {
            "Unknown opcode ${rule.opcode} for opcode set $opcodeSetId"
        }
        rules.add(rule)
        index += 1
    }

    val warnings = mutableListOf<String>()
    var i = ruleCount * GrinFormat.RULE_ENTRY_SIZE
    while (i < bytes.size) {
        if (bytes[i] != 0.toByte()) {
            warnings.add("Unused rules block entries are non-zero")
            break
        }
        i += 1
    }

    return GrinRulesReadResult(rules, warnings)
}

fun writeRulesBlock(rules: List<GrinRule>, ruleCount: Int): ByteArray {
    require(ruleCount <= GrinFormat.MAX_RULE_COUNT) { "RuleCount exceeds ${GrinFormat.MAX_RULE_COUNT}" }
    require(rules.size >= ruleCount) { "Rule list is shorter than ruleCount" }

    val block = ByteArray(GrinFormat.RULES_BLOCK_SIZE)
    var index = 0
    while (index < ruleCount) {
        val rule = rules[index]
        require(rule.groupMask in 0..0xFFFF) { "GroupMask must fit in 16 bits" }
        val offset = index * GrinFormat.RULE_ENTRY_SIZE
        val ruleBytes = rule.serialize()
        System.arraycopy(ruleBytes, 0, block, offset, ruleBytes.size)
        index += 1
    }
    return block
}

private fun readFully(input: InputStream, buffer: ByteArray) {
    var offset = 0
    while (offset < buffer.size) {
        val read = input.read(buffer, offset, buffer.size - offset)
        if (read == -1) {
            throw IllegalArgumentException("Unexpected end of stream")
        }
        offset += read
    }
}

private fun safeMultiply(a: Long, b: Long): Long? {
    if (a < 0L || b < 0L) {
        return null
    }
    if (a == 0L || b == 0L) {
        return 0L
    }
    val result = a * b
    if (result / a != b) {
        return null
    }
    return result
}

private fun isValidOpcode(opcodeSetId: Int, opcode: Int): Boolean {
    if (opcodeSetId != 0) {
        return false
    }
    return opcode in 0x00..0x0C
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinBitmapRenderer.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import android.graphics.Bitmap

class GrinBitmapRenderer {
    private var argbBuffer: ByteArray = ByteArray(0)

    fun render(buffer: DisplayBuffer, reuse: Bitmap? = null): Bitmap {
        val bitmap = if (reuse != null && reuse.width == buffer.width && reuse.height == buffer.height) {
            reuse
        } else {
            Bitmap.createBitmap(buffer.width, buffer.height, Bitmap.Config.ARGB_8888)
        }

        val required = buffer.width * buffer.height * 4
        if (argbBuffer.size != required) {
            argbBuffer = ByteArray(required)
        }

        var srcIndex = 0
        var dstIndex = 0
        while (srcIndex < buffer.rgbaData.size) {
            val r = buffer.rgbaData[srcIndex].toInt() and 0xFF
            val g = buffer.rgbaData[srcIndex + 1].toInt() and 0xFF
            val b = buffer.rgbaData[srcIndex + 2].toInt() and 0xFF
            val a = buffer.rgbaData[srcIndex + 3].toInt() and 0xFF

            argbBuffer[dstIndex] = a.toByte()
            argbBuffer[dstIndex + 1] = r.toByte()
            argbBuffer[dstIndex + 2] = g.toByte()
            argbBuffer[dstIndex + 3] = b.toByte()

            srcIndex += 4
            dstIndex += 4
        }

        bitmap.copyPixelsFromBuffer(java.nio.ByteBuffer.wrap(argbBuffer))
        return bitmap
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinContentProvider.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import android.content.ContentProvider
import android.content.ContentValues
import android.database.Cursor
import android.net.Uri
import android.os.ParcelFileDescriptor
import java.io.File
import java.io.FileNotFoundException
import java.io.InputStream
import java.io.OutputStream
import kotlin.concurrent.thread

class GrinContentProvider : ContentProvider() {
    override fun onCreate(): Boolean = true

    override fun getType(uri: Uri): String = "application/octet-stream"

    override fun query(
        uri: Uri,
        projection: Array<out String>?,
        selection: String?,
        selectionArgs: Array<out String>?,
        sortOrder: String?
    ): Cursor? = null

    override fun insert(uri: Uri, values: ContentValues?): Uri? {
        throw UnsupportedOperationException("Insert not supported")
    }

    override fun delete(uri: Uri, selection: String?, selectionArgs: Array<out String>?): Int {
        throw UnsupportedOperationException("Delete not supported")
    }

    override fun update(
        uri: Uri,
        values: ContentValues?,
        selection: String?,
        selectionArgs: Array<out String>?
    ): Int {
        throw UnsupportedOperationException("Update not supported")
    }

    override fun openFile(uri: Uri, mode: String): ParcelFileDescriptor {
        if (mode.contains("w")) {
            throw FileNotFoundException("Write mode not supported")
        }
        val ctx = context ?: throw FileNotFoundException("Context unavailable")
        val path = uri.path?.trimStart('/') ?: throw FileNotFoundException("Missing path")

        return when {
            path.startsWith("asset/") -> {
                val assetPath = path.removePrefix("asset/")
                openPipe(ctx.assets.open(assetPath))
            }
            path.startsWith("raw/") -> {
                val resName = path.removePrefix("raw/")
                val resId = ctx.resources.getIdentifier(resName, "raw", ctx.packageName)
                if (resId == 0) {
                    throw FileNotFoundException("Resource not found: $resName")
                }
                openPipe(ctx.resources.openRawResource(resId))
            }
            else -> {
                val file = File(path)
                if (!file.exists()) {
                    throw FileNotFoundException("File not found: $path")
                }
                ParcelFileDescriptor.open(file, ParcelFileDescriptor.MODE_READ_ONLY)
            }
        }
    }

    private fun openPipe(input: InputStream): ParcelFileDescriptor {
        val pipe = ParcelFileDescriptor.createPipe()
        val output = ParcelFileDescriptor.AutoCloseOutputStream(pipe[1])
        thread(name = "grin-content-provider") {
            input.use { source ->
                output.use { target ->
                    source.copyTo(target)
                }
            }
        }
        return pipe[0]
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinEndianness.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

fun writeUint16LE(value: Int): ByteArray {
    return byteArrayOf(
        (value and 0xFF).toByte(),
        ((value ushr 8) and 0xFF).toByte()
    )
}

fun writeUint32LE(value: Long): ByteArray {
    return byteArrayOf(
        (value and 0xFF).toByte(),
        ((value ushr 8) and 0xFF).toByte(),
        ((value ushr 16) and 0xFF).toByte(),
        ((value ushr 24) and 0xFF).toByte()
    )
}

fun writeUint64LE(value: Long): ByteArray {
    return byteArrayOf(
        (value and 0xFF).toByte(),
        ((value ushr 8) and 0xFF).toByte(),
        ((value ushr 16) and 0xFF).toByte(),
        ((value ushr 24) and 0xFF).toByte(),
        ((value ushr 32) and 0xFF).toByte(),
        ((value ushr 40) and 0xFF).toByte(),
        ((value ushr 48) and 0xFF).toByte(),
        ((value ushr 56) and 0xFF).toByte()
    )
}

fun readUint16LE(bytes: ByteArray, offset: Int): Int {
    require(offset >= 0 && offset + 2 <= bytes.size) { "readUint16LE out of range" }
    val b0 = bytes[offset].toInt() and 0xFF
    val b1 = bytes[offset + 1].toInt() and 0xFF
    return b0 or (b1 shl 8)
}

fun readUint32LE(bytes: ByteArray, offset: Int): Long {
    require(offset >= 0 && offset + 4 <= bytes.size) { "readUint32LE out of range" }
    val b0 = bytes[offset].toLong() and 0xFF
    val b1 = bytes[offset + 1].toLong() and 0xFF
    val b2 = bytes[offset + 2].toLong() and 0xFF
    val b3 = bytes[offset + 3].toLong() and 0xFF
    return b0 or (b1 shl 8) or (b2 shl 16) or (b3 shl 24)
}

fun readUint64LE(bytes: ByteArray, offset: Int): Long {
    require(offset >= 0 && offset + 8 <= bytes.size) { "readUint64LE out of range" }
    var result = 0L
    var shift = 0
    var index = 0
    while (index < 8) {
        result = result or ((bytes[offset + index].toLong() and 0xFF) shl shift)
        shift += 8
        index += 1
    }
    return result
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinFile.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import java.io.File
import java.io.FileInputStream
import java.io.InputStream

class GrinFile(
    val header: GrinHeader,
    val pixels: List<GrinPixel>,
    val rules: List<GrinRule>
) {
    fun toBytes(): ByteArray {
        val rulesBlock = buildRulesBlock(rules)
        val pixelDataLength = safeMultiply(
            pixels.size.toLong(),
            GrinFormat.PIXEL_SIZE_BYTES.toLong(),
            "PixelDataLength"
        )
        val updatedHeader = header.copy(
            ruleCount = rules.size,
            rulesBlock = rulesBlock,
            pixelDataLength = pixelDataLength,
            pixelDataOffset = GrinFormat.HEADER_SIZE_BYTES.toLong()
        )

        val totalLength = safeInt(
            GrinFormat.HEADER_SIZE_BYTES.toLong() + pixelDataLength,
            "Total file length"
        )
        val output = ByteArray(totalLength)
        val headerBytes = updatedHeader.serialize()
        System.arraycopy(headerBytes, 0, output, 0, headerBytes.size)

        var offset = GrinFormat.HEADER_SIZE_BYTES
        for (pixel in pixels) {
            output[offset] = pixel.r.toByte()
            output[offset + 1] = pixel.g.toByte()
            output[offset + 2] = pixel.b.toByte()
            output[offset + 3] = pixel.a.toByte()
            val control = pixel.c and 0xFF
            val sanitized = control and GrinControlByte.RESERVED_MASK.inv() and 0xFF
            output[offset + 4] = sanitized.toByte()
            offset += GrinFormat.PIXEL_SIZE_BYTES
        }
        return output
    }

    fun save(path: String) {
        File(path).outputStream().use { output ->
            output.write(toBytes())
        }
    }

    companion object {
        fun load(path: String): GrinFile {
            FileInputStream(File(path)).use { input ->
                return load(input)
            }
        }

        fun load(inputStream: InputStream): GrinFile {
            val bytes = inputStream.readBytes()
            return load(bytes)
        }

        fun load(bytes: ByteArray): GrinFile {
            require(bytes.size >= GrinFormat.HEADER_SIZE_BYTES) {
                "Buffer too small for GRIN header"
            }
            val headerBytes = bytes.copyOfRange(0, GrinFormat.HEADER_SIZE_BYTES)
            val header = GrinHeader.deserialize(headerBytes)
            val validation = header.validate()
            require(validation.ok) { "Invalid GRIN header: ${validation.errors.joinToString("; ")}" }

            val rules = parseRules(header.rulesBlock, header.ruleCount)
            val pixelOffset = safeInt(header.pixelDataOffset, "PixelDataOffset64")
            val pixelLength = safeInt(header.pixelDataLength, "PixelDataLength")
            require(bytes.size >= pixelOffset + pixelLength) {
                "Buffer does not contain full pixel data"
            }

            val pixelBytes = bytes.copyOfRange(pixelOffset, pixelOffset + pixelLength)
            val pixels = parsePixels(pixelBytes, header.width, header.height)
            val image = GrinImage(header, pixels, rules)
            return GrinFile(image.header, image.pixels, image.rules)
        }
    }
}

private fun parseRules(rulesBlock: ByteArray, ruleCount: Int): List<GrinRule> {
    require(ruleCount <= GrinFormat.MAX_RULE_COUNT) {
        "RuleCount exceeds ${GrinFormat.MAX_RULE_COUNT}"
    }
    val rules = mutableListOf<GrinRule>()
    var index = 0
    while (index < ruleCount) {
        val offset = index * GrinFormat.RULE_ENTRY_SIZE
        val slice = rulesBlock.copyOfRange(offset, offset + GrinFormat.RULE_ENTRY_SIZE)
        rules.add(GrinRule.deserialize(slice))
        index += 1
    }
    return rules
}

private fun parsePixels(pixelBytes: ByteArray, width: Long, height: Long): MutableList<GrinPixel> {
    require(width >= 0L && height >= 0L) { "Image dimensions must be non-negative" }
    val pixelCount = safeMultiply(width, height, "Pixel count")
    val expectedLength = safeMultiply(pixelCount, GrinFormat.PIXEL_SIZE_BYTES.toLong(), "Pixel data length")
    val expectedInt = safeInt(expectedLength, "Pixel data length")
    require(pixelBytes.size == expectedInt) {
        "Pixel data length does not match header dimensions"
    }

    val pixels = mutableListOf<GrinPixel>()
    var offset = 0
    while (offset < pixelBytes.size) {
        val slice = pixelBytes.copyOfRange(offset, offset + GrinFormat.PIXEL_SIZE_BYTES)
        pixels.add(GrinPixel.fromBytes(slice))
        offset += GrinFormat.PIXEL_SIZE_BYTES
    }
    return pixels
}

private fun buildRulesBlock(rules: List<GrinRule>): ByteArray {
    require(rules.size <= GrinFormat.MAX_RULE_COUNT) {
        "Rule count exceeds ${GrinFormat.MAX_RULE_COUNT}"
    }
    val rulesBlock = ByteArray(GrinFormat.RULES_BLOCK_SIZE)
    var index = 0
    while (index < rules.size) {
        val offset = index * GrinFormat.RULE_ENTRY_SIZE
        val ruleBytes = rules[index].serialize()
        System.arraycopy(ruleBytes, 0, rulesBlock, offset, ruleBytes.size)
        index += 1
    }
    return rulesBlock
}

private fun safeInt(value: Long, label: String): Int {
    require(value >= 0L) { "$label must be non-negative" }
    require(value <= Int.MAX_VALUE.toLong()) { "$label exceeds Int range" }
    return value.toInt()
}

private fun safeLong(value: Long, label: String): Long {
    require(value >= 0L) { "$label must be non-negative" }
    return value
}

private fun safeMultiply(a: Long, b: Long, label: String): Long {
    if (a == 0L || b == 0L) {
        return 0L
    }
    val result = a * b
    require(result / a == b) { "$label exceeds Long range" }
    return result
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

// Spec references: §§4, 4.1, 7.2-7.4 (grin_technical_specification_v_2.md)
object GrinFormat {
    val MAGIC_BYTES: ByteArray = byteArrayOf(
        0x47.toByte(),
        0x52.toByte(),
        0x49.toByte(),
        0x4E.toByte()
    )
    const val VERSION_MAJOR: Int = 0x00
    const val VERSION_MINOR: Int = 0x00
    const val HEADER_SIZE_BYTES: Int = 128
    const val PIXEL_SIZE_BYTES: Int = 5
    const val MAX_RULE_COUNT: Int = 16
    const val RULES_BLOCK_SIZE: Int = 64
    const val RULE_ENTRY_SIZE: Int = 4
    const val TIMING_SEMANTICS: String = "reader-defined oscillator control"
}

object GrinHeaderLayout {
    const val MAGIC_OFFSET: Int = 0
    const val MAGIC_SIZE: Int = 4
    const val VERSION_MAJOR_OFFSET: Int = 4
    const val VERSION_MAJOR_SIZE: Int = 1
    const val VERSION_MINOR_OFFSET: Int = 5
    const val VERSION_MINOR_SIZE: Int = 1
    const val HEADER_SIZE_OFFSET: Int = 6
    const val HEADER_SIZE_SIZE: Int = 2
    const val WIDTH_OFFSET: Int = 8
    const val WIDTH_SIZE: Int = 4
    const val HEIGHT_OFFSET: Int = 12
    const val HEIGHT_SIZE: Int = 4
    const val TICK_MICROS_OFFSET: Int = 16
    const val TICK_MICROS_SIZE: Int = 4
    const val RULE_COUNT_OFFSET: Int = 20
    const val RULE_COUNT_SIZE: Int = 1
    const val OPCODE_SET_ID_OFFSET: Int = 21
    const val OPCODE_SET_ID_SIZE: Int = 1
    const val FLAGS_OFFSET: Int = 22
    const val FLAGS_SIZE: Int = 2
    const val PIXEL_DATA_LENGTH_OFFSET: Int = 24
    const val PIXEL_DATA_LENGTH_SIZE: Int = 8
    const val FILE_LENGTH_OFFSET: Int = 32
    const val FILE_LENGTH_SIZE: Int = 8
    const val PIXEL_DATA_OFFSET_OFFSET: Int = 40
    const val PIXEL_DATA_OFFSET_SIZE: Int = 8
    const val RESERVED_A_OFFSET: Int = 48
    const val RESERVED_A_SIZE: Int = 8
    const val RESERVED_B_OFFSET: Int = 56
    const val RESERVED_B_SIZE: Int = 8
    const val RULES_BLOCK_OFFSET: Int = 64
    const val RULES_BLOCK_SIZE: Int = GrinFormat.RULES_BLOCK_SIZE
}

object GrinRuleLayout {
    const val GROUP_MASK_OFFSET: Int = 0
    const val GROUP_MASK_SIZE: Int = 2
    const val OPCODE_OFFSET: Int = 2
    const val OPCODE_SIZE: Int = 1
    const val TIMING_OFFSET: Int = 3
    const val TIMING_SIZE: Int = 1

    fun groupMaskTargetsGroup(groupMask: Int, groupId: Int): Boolean {
        val shift = groupId and 0x0F
        return (groupMask and (1 shl shift)) != 0
    }
}

object GrinPixelLayout {
    const val R_OFFSET: Int = 0
    const val G_OFFSET: Int = 1
    const val B_OFFSET: Int = 2
    const val A_OFFSET: Int = 3
    const val C_OFFSET: Int = 4
}

object GrinControlByte {
    const val GROUP_ID_MASK: Int = 0x0F
    const val RESERVED_MASK: Int = 0x70
    const val LOCK_MASK: Int = 0x80

    fun getGroupId(controlByte: Int): Int = controlByte and GROUP_ID_MASK

    fun isLocked(controlByte: Int): Boolean = (controlByte and LOCK_MASK) != 0

    fun setGroupId(controlByte: Int, groupId: Int): Int {
        val cleared = controlByte and GROUP_ID_MASK.inv()
        return cleared or (groupId and GROUP_ID_MASK)
    }

    fun setLocked(controlByte: Int, locked: Boolean): Int {
        return if (locked) {
            controlByte or LOCK_MASK
        } else {
            controlByte and LOCK_MASK.inv()
        }
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import java.nio.ByteBuffer
import java.nio.ByteOrder

class GrinHeader(
    magic: ByteArray,
    val versionMajor: Int,
    val versionMinor: Int,
    val headerSize: Int,
    val width: Long,
    val height: Long,
    val tickMicros: Long,
    val ruleCount: Int,
    val opcodeSetId: Int,
    val flags: Int,
    val pixelDataLength: Long,
    val fileLength: Long,
    val pixelDataOffset: Long,
    val reservedA: Long,
    val reservedB: Long,
    rulesBlock: ByteArray
) {
    val magic: ByteArray = magic.copyOf()
    val rulesBlock: ByteArray = rulesBlock.copyOf()

    init {
        require(this.magic.size == GrinHeaderLayout.MAGIC_SIZE) {
            "Magic bytes must be ${GrinHeaderLayout.MAGIC_SIZE} bytes"
        }
        require(this.rulesBlock.size == GrinFormat.RULES_BLOCK_SIZE) {
            "RulesBlock must be ${GrinFormat.RULES_BLOCK_SIZE} bytes"
        }
    }

    fun serialize(): ByteArray {
        val buffer = ByteBuffer.allocate(GrinFormat.HEADER_SIZE_BYTES).order(ByteOrder.LITTLE_ENDIAN)
        putBytes(buffer, GrinHeaderLayout.MAGIC_OFFSET, magic)
        putUInt8(buffer, GrinHeaderLayout.VERSION_MAJOR_OFFSET, versionMajor)
        putUInt8(buffer, GrinHeaderLayout.VERSION_MINOR_OFFSET, versionMinor)
        putUInt16(buffer, GrinHeaderLayout.HEADER_SIZE_OFFSET, headerSize)
        putUInt32(buffer, GrinHeaderLayout.WIDTH_OFFSET, width)
        putUInt32(buffer, GrinHeaderLayout.HEIGHT_OFFSET, height)
        putUInt32(buffer, GrinHeaderLayout.TICK_MICROS_OFFSET, tickMicros)
        putUInt8(buffer, GrinHeaderLayout.RULE_COUNT_OFFSET, ruleCount)
        putUInt8(buffer, GrinHeaderLayout.OPCODE_SET_ID_OFFSET, opcodeSetId)
        putUInt16(buffer, GrinHeaderLayout.FLAGS_OFFSET, flags)
        putUInt64(buffer, GrinHeaderLayout.PIXEL_DATA_LENGTH_OFFSET, pixelDataLength)
        putUInt64(buffer, GrinHeaderLayout.FILE_LENGTH_OFFSET, fileLength)
        putUInt64(buffer, GrinHeaderLayout.PIXEL_DATA_OFFSET_OFFSET, pixelDataOffset)
        putUInt64(buffer, GrinHeaderLayout.RESERVED_A_OFFSET, reservedA)
        putUInt64(buffer, GrinHeaderLayout.RESERVED_B_OFFSET, reservedB)
        putBytes(buffer, GrinHeaderLayout.RULES_BLOCK_OFFSET, rulesBlock)
        return buffer.array()
    }

    fun validate(): GrinValidationResult {
        val errors = mutableListOf<String>()
        val warnings = mutableListOf<String>()

        if (!magic.contentEquals(GrinFormat.MAGIC_BYTES)) {
            errors.add("Magic bytes do not match GRIN")
        }
        if (headerSize != GrinFormat.HEADER_SIZE_BYTES) {
            errors.add("HeaderSize must be ${GrinFormat.HEADER_SIZE_BYTES}")
        }
        if (ruleCount > GrinFormat.MAX_RULE_COUNT) {
            errors.add("RuleCount exceeds ${GrinFormat.MAX_RULE_COUNT}")
        }
        if (pixelDataOffset != GrinFormat.HEADER_SIZE_BYTES.toLong()) {
            errors.add("PixelDataOffset64 must be 128")
        }

        val expectedPixelLength = expectedPixelLength(width, height)
        if (expectedPixelLength == null) {
            errors.add("PixelDataLength overflow for width/height")
        } else if (pixelDataLength != expectedPixelLength) {
            errors.add("PixelDataLength does not match width * height * 5")
        }

        val minFileLength = GrinFormat.HEADER_SIZE_BYTES.toLong() + pixelDataLength
        if (fileLength != 0L && fileLength < minFileLength) {
            errors.add("FileLength is smaller than header + pixel data")
        }

        if (flags != 0) {
            warnings.add("Flags field is non-zero")
        }
        if (reservedA != 0L || reservedB != 0L) {
            warnings.add("Reserved header fields are non-zero")
        }
        if (versionMajor != GrinFormat.VERSION_MAJOR || versionMinor != GrinFormat.VERSION_MINOR) {
            warnings.add("Unexpected GRIN version")
        }

        return GrinValidationResult(errors.isEmpty(), errors, warnings)
    }

    fun copy(
        magic: ByteArray = this.magic,
        versionMajor: Int = this.versionMajor,
        versionMinor: Int = this.versionMinor,
        headerSize: Int = this.headerSize,
        width: Long = this.width,
        height: Long = this.height,
        tickMicros: Long = this.tickMicros,
        ruleCount: Int = this.ruleCount,
        opcodeSetId: Int = this.opcodeSetId,
        flags: Int = this.flags,
        pixelDataLength: Long = this.pixelDataLength,
        fileLength: Long = this.fileLength,
        pixelDataOffset: Long = this.pixelDataOffset,
        reservedA: Long = this.reservedA,
        reservedB: Long = this.reservedB,
        rulesBlock: ByteArray = this.rulesBlock
    ): GrinHeader {
        return GrinHeader(
            magic = magic,
            versionMajor = versionMajor,
            versionMinor = versionMinor,
            headerSize = headerSize,
            width = width,
            height = height,
            tickMicros = tickMicros,
            ruleCount = ruleCount,
            opcodeSetId = opcodeSetId,
            flags = flags,
            pixelDataLength = pixelDataLength,
            fileLength = fileLength,
            pixelDataOffset = pixelDataOffset,
            reservedA = reservedA,
            reservedB = reservedB,
            rulesBlock = rulesBlock
        )
    }

    companion object {
        fun deserialize(bytes: ByteArray): GrinHeader {
            require(bytes.size >= GrinFormat.HEADER_SIZE_BYTES) {
                "Header requires ${GrinFormat.HEADER_SIZE_BYTES} bytes"
            }
            val buffer = ByteBuffer.wrap(bytes).order(ByteOrder.LITTLE_ENDIAN)

            val magic = bytes.copyOfRange(
                GrinHeaderLayout.MAGIC_OFFSET,
                GrinHeaderLayout.MAGIC_OFFSET + GrinHeaderLayout.MAGIC_SIZE
            )
            val versionMajor = readUInt8(buffer, GrinHeaderLayout.VERSION_MAJOR_OFFSET)
            val versionMinor = readUInt8(buffer, GrinHeaderLayout.VERSION_MINOR_OFFSET)
            val headerSize = readUInt16(buffer, GrinHeaderLayout.HEADER_SIZE_OFFSET)
            val width = readUInt32(buffer, GrinHeaderLayout.WIDTH_OFFSET)
            val height = readUInt32(buffer, GrinHeaderLayout.HEIGHT_OFFSET)
            val tickMicros = readUInt32(buffer, GrinHeaderLayout.TICK_MICROS_OFFSET)
            val ruleCount = readUInt8(buffer, GrinHeaderLayout.RULE_COUNT_OFFSET)
            val opcodeSetId = readUInt8(buffer, GrinHeaderLayout.OPCODE_SET_ID_OFFSET)
            val flags = readUInt16(buffer, GrinHeaderLayout.FLAGS_OFFSET)
            val pixelDataLength = readUInt64(buffer, GrinHeaderLayout.PIXEL_DATA_LENGTH_OFFSET)
            val fileLength = readUInt64(buffer, GrinHeaderLayout.FILE_LENGTH_OFFSET)
            val pixelDataOffset = readUInt64(buffer, GrinHeaderLayout.PIXEL_DATA_OFFSET_OFFSET)
            val reservedA = readUInt64(buffer, GrinHeaderLayout.RESERVED_A_OFFSET)
            val reservedB = readUInt64(buffer, GrinHeaderLayout.RESERVED_B_OFFSET)
            val rulesBlock = bytes.copyOfRange(
                GrinHeaderLayout.RULES_BLOCK_OFFSET,
                GrinHeaderLayout.RULES_BLOCK_OFFSET + GrinFormat.RULES_BLOCK_SIZE
            )

            return GrinHeader(
                magic = magic,
                versionMajor = versionMajor,
                versionMinor = versionMinor,
                headerSize = headerSize,
                width = width,
                height = height,
                tickMicros = tickMicros,
                ruleCount = ruleCount,
                opcodeSetId = opcodeSetId,
                flags = flags,
                pixelDataLength = pixelDataLength,
                fileLength = fileLength,
                pixelDataOffset = pixelDataOffset,
                reservedA = reservedA,
                reservedB = reservedB,
                rulesBlock = rulesBlock
            )
        }
    }
}

private fun expectedPixelLength(width: Long, height: Long): Long? {
    if (width < 0L || height < 0L) {
        return null
    }
    val pixelCount = width * height
    if (width != 0L && pixelCount / width != height) {
        return null
    }
    val pixelLength = pixelCount * GrinFormat.PIXEL_SIZE_BYTES.toLong()
    if (pixelCount != 0L && pixelLength / pixelCount != GrinFormat.PIXEL_SIZE_BYTES.toLong()) {
        return null
    }
    return pixelLength
}

private fun readUInt8(buffer: ByteBuffer, offset: Int): Int {
    return buffer.get(offset).toInt() and 0xFF
}

private fun readUInt16(buffer: ByteBuffer, offset: Int): Int {
    return buffer.getShort(offset).toInt() and 0xFFFF
}

private fun readUInt32(buffer: ByteBuffer, offset: Int): Long {
    return buffer.getInt(offset).toLong() and 0xFFFFFFFFL
}

private fun readUInt64(buffer: ByteBuffer, offset: Int): Long {
    return buffer.getLong(offset)
}

private fun putUInt8(buffer: ByteBuffer, offset: Int, value: Int) {
    buffer.put(offset, (value and 0xFF).toByte())
}

private fun putUInt16(buffer: ByteBuffer, offset: Int, value: Int) {
    buffer.putShort(offset, (value and 0xFFFF).toShort())
}

private fun putUInt32(buffer: ByteBuffer, offset: Int, value: Long) {
    buffer.putInt(offset, (value and 0xFFFFFFFFL).toInt())
}

private fun putUInt64(buffer: ByteBuffer, offset: Int, value: Long) {
    buffer.putLong(offset, value)
}

private fun putBytes(buffer: ByteBuffer, offset: Int, bytes: ByteArray) {
    var index = 0
    while (index < bytes.size) {
        buffer.put(offset + index, bytes[index])
        index += 1
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinImage.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

class GrinImage(
    val header: GrinHeader,
    val pixels: MutableList<GrinPixel>,
    val rules: List<GrinRule>
) {
    init {
        val expectedPixelCount = safePixelCount(header.width, header.height)
        require(expectedPixelCount != null) { "Pixel count exceeds safe integer range" }
        require(pixels.size == expectedPixelCount) {
            "Pixel array length does not match header dimensions"
        }
        require(rules.size == header.ruleCount) {
            "Rule array length does not match header ruleCount"
        }
    }

    fun getPixel(x: Int, y: Int): GrinPixel {
        val index = indexFor(x, y)
        return pixels[index]
    }

    fun setPixel(x: Int, y: Int, pixel: GrinPixel) {
        val index = indexFor(x, y)
        pixels[index] = pixel
    }

    fun getPixelsByGroup(groupId: Int): List<GrinPixel> {
        val target = groupId and 0x0F
        return pixels.filter { it.getGroupId() == target }
    }

    fun getLockedPixels(): List<GrinPixel> {
        return pixels.filter { it.isLocked() }
    }

    fun getUnlockedPixels(): List<GrinPixel> {
        return pixels.filter { !it.isLocked() }
    }

    private fun indexFor(x: Int, y: Int): Int {
        require(x >= 0 && y >= 0) { "Pixel coordinates must be non-negative" }
        val width = safeInt(header.width, "Width")
        val height = safeInt(header.height, "Height")
        require(x < width && y < height) { "Pixel coordinates out of bounds" }
        return y * width + x
    }
}

private fun safePixelCount(width: Long, height: Long): Int? {
    val pixelCount = width * height
    if (width != 0L && pixelCount / width != height) {
        return null
    }
    return safeInt(pixelCount, "Pixel count")
}

private fun safeInt(value: Long, label: String): Int {
    require(value <= Int.MAX_VALUE.toLong()) { "$label exceeds Int range" }
    require(value >= 0L) { "$label must be non-negative" }
    return value.toInt()
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinInputStream.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import java.io.FilterInputStream
import java.io.InputStream

class GrinInputStream(input: InputStream) : FilterInputStream(input) {
    fun readHeader(): GrinHeaderReadResult {
        return readHeader(this)
    }

    fun readPixelData(width: Long, height: Long): GrinPixelReadResult {
        return readPixelData(this, width, height)
    }

    fun readRulesBlock(ruleCount: Int, opcodeSetId: Int): GrinRulesReadResult {
        val buffer = ByteArray(GrinFormat.RULES_BLOCK_SIZE)
        readFully(buffer)
        return readRulesBlock(buffer, ruleCount, opcodeSetId)
    }

    private fun readFully(buffer: ByteArray) {
        var offset = 0
        while (offset < buffer.size) {
            val read = read(buffer, offset, buffer.size - offset)
            if (read == -1) {
                throw IllegalArgumentException("Unexpected end of stream")
            }
            offset += read
        }
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinOutputStream.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import java.io.FilterOutputStream
import java.io.OutputStream

class GrinOutputStream(output: OutputStream) : FilterOutputStream(output) {
    fun writeHeader(header: GrinHeader) {
        writeHeader(header, this)
    }

    fun writePixelData(pixels: List<GrinPixel>) {
        writePixelData(pixels, this)
    }

    fun writeRulesBlock(rules: List<GrinRule>, ruleCount: Int) {
        val block = io.grin.lib.writeRulesBlock(rules, ruleCount)
        write(block)
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

class GrinPixel(
    r: Int,
    g: Int,
    b: Int,
    a: Int,
    c: Int
) {
    var r: Int = r and 0xFF
    var g: Int = g and 0xFF
    var b: Int = b and 0xFF
    var a: Int = a and 0xFF
    var c: Int = c and 0xFF

    fun getGroupId(): Int = GrinControlByte.getGroupId(c)

    fun isLocked(): Boolean = GrinControlByte.isLocked(c)

    fun setGroupId(groupId: Int) {
        c = GrinControlByte.setGroupId(c, groupId) and 0xFF
    }

    fun setLocked(locked: Boolean) {
        c = GrinControlByte.setLocked(c, locked) and 0xFF
    }

    fun toBytes(): ByteArray {
        return byteArrayOf(
            r.toByte(),
            g.toByte(),
            b.toByte(),
            a.toByte(),
            c.toByte()
        )
    }

    companion object {
        fun fromBytes(bytes: ByteArray): GrinPixel {
            require(bytes.size == GrinFormat.PIXEL_SIZE_BYTES) {
                "GrinPixel requires exactly ${GrinFormat.PIXEL_SIZE_BYTES} bytes"
            }
            return GrinPixel(
                bytes[GrinPixelLayout.R_OFFSET].toInt() and 0xFF,
                bytes[GrinPixelLayout.G_OFFSET].toInt() and 0xFF,
                bytes[GrinPixelLayout.B_OFFSET].toInt() and 0xFF,
                bytes[GrinPixelLayout.A_OFFSET].toInt() and 0xFF,
                bytes[GrinPixelLayout.C_OFFSET].toInt() and 0xFF
            )
        }
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

class GrinPlayer(
    private val schedulerFactory: (Long) -> TickScheduler = { tickMicros ->
        AndroidTickScheduler(tickMicros)
    },
    private val ruleEngine: RuleEngine = RuleEngine(),
    private val opcodeRegistry: OpcodeRegistry = OpcodeRegistry,
    private val onFrameRendered: (() -> Unit)? = null
) {
    private var image: GrinImage? = null
    private var scheduler: TickScheduler? = null
    private var state: PlaybackState? = null
    private var displayBuffer: DisplayBuffer? = null
    private var controlBytes: IntArray = IntArray(0)

    fun load(file: GrinFile) {
        val header = file.header
        val width = safeInt(header.width, "Width")
        val height = safeInt(header.height, "Height")

        image = GrinImage(header, file.pixels.toMutableList(), file.rules)
        displayBuffer = DisplayBuffer(width, height)
        state = PlaybackState(displayBuffer!!)
        controlBytes = IntArray(file.pixels.size) { index ->
            file.pixels[index].c and GrinControlByte.RESERVED_MASK.inv() and 0xFF
        }

        scheduler?.stop()
        scheduler = schedulerFactory(header.tickMicros).also { sched ->
            sched.setTickCallback { tick -> onTick(tick) }
        }
    }

    fun play() {
        val currentState = state ?: throw IllegalStateException("GrinPlayer.load() must be called before play()")
        val currentScheduler = scheduler ?: throw IllegalStateException("Scheduler not initialized")
        if (currentState.isPlaying) {
            return
        }
        currentState.isPlaying = true
        currentScheduler.start()
    }

    fun pause() {
        val currentState = state ?: return
        val currentScheduler = scheduler ?: return
        currentState.isPlaying = false
        currentScheduler.stop()
    }

    fun stop() {
        state?.reset()
        pause()
    }

    fun seek(tick: Long) {
        require(tick >= 0L) { "Tick must be non-negative" }
        state?.currentTick = tick
        renderFrame(tick)
    }

    fun getCurrentFrame(): DisplayBuffer {
        return displayBuffer ?: throw IllegalStateException("GrinPlayer.load() must be called before getCurrentFrame()")
    }

    fun isPlaying(): Boolean {
        return state?.isPlaying ?: false
    }

    private fun onTick(tick: Long) {
        state?.currentTick = tick
        renderFrame(tick)
    }

    private fun renderFrame(tick: Long) {
        val currentImage = image ?: return
        val buffer = displayBuffer ?: return
        val output = buffer.rgbaData
        val opcodeSetId = currentImage.header.opcodeSetId
        val activeRules = ruleEngine.evaluateRules(currentImage, tick)

        currentImage.pixels.forEachIndexed { index, source ->
            val control = controlBytes[index]
            val outputIndex = index * 4

            if ((control and GrinControlByte.LOCK_MASK) != 0) {
                output[outputIndex] = source.r.toByte()
                output[outputIndex + 1] = source.g.toByte()
                output[outputIndex + 2] = source.b.toByte()
                output[outputIndex + 3] = source.a.toByte()
                return@forEachIndexed
            }

            val working = GrinPixel(source.r, source.g, source.b, source.a, control)
            val groupId = control and GrinControlByte.GROUP_ID_MASK

            for (activeRule in activeRules) {
                if (activeRule.rule.targetsGroup(groupId)) {
                    val opcode = opcodeRegistry.getOpcode(opcodeSetId, activeRule.rule.opcode)
                    opcode.apply(working, tick, activeRule.rule.timing)
                }
            }

            controlBytes[index] = working.c and GrinControlByte.RESERVED_MASK.inv() and 0xFF
            output[outputIndex] = working.r.toByte()
            output[outputIndex + 1] = working.g.toByte()
            output[outputIndex + 2] = working.b.toByte()
            output[outputIndex + 3] = working.a.toByte()
        }
        onFrameRendered?.invoke()
    }
}

private fun safeInt(value: Long, label: String): Int {
    require(value <= Int.MAX_VALUE.toLong()) { "$label exceeds Int range" }
    require(value >= 0L) { "$label must be non-negative" }
    return value.toInt()
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinRule.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import java.nio.ByteBuffer
import java.nio.ByteOrder

class GrinRule(
    groupMask: Int,
    opcode: Int,
    timing: Int
) {
    var groupMask: Int = groupMask and 0xFFFF
    var opcode: Int = opcode and 0xFF
    var timing: Int = timing and 0xFF

    fun targetsGroup(groupId: Int): Boolean {
        return GrinRuleLayout.groupMaskTargetsGroup(groupMask, groupId)
    }

    fun serialize(): ByteArray {
        val buffer = ByteBuffer.allocate(GrinFormat.RULE_ENTRY_SIZE).order(ByteOrder.LITTLE_ENDIAN)
        buffer.putShort(GrinRuleLayout.GROUP_MASK_OFFSET, (groupMask and 0xFFFF).toShort())
        buffer.put(GrinRuleLayout.OPCODE_OFFSET, opcode.toByte())
        buffer.put(GrinRuleLayout.TIMING_OFFSET, timing.toByte())
        return buffer.array()
    }

    companion object {
        fun deserialize(bytes: ByteArray): GrinRule {
            require(bytes.size == GrinFormat.RULE_ENTRY_SIZE) {
                "GrinRule requires exactly ${GrinFormat.RULE_ENTRY_SIZE} bytes"
            }
            val buffer = ByteBuffer.wrap(bytes).order(ByteOrder.LITTLE_ENDIAN)
            val groupMask = buffer.getShort(GrinRuleLayout.GROUP_MASK_OFFSET).toInt() and 0xFFFF
            val opcode = buffer.get(GrinRuleLayout.OPCODE_OFFSET).toInt() and 0xFF
            val timing = buffer.get(GrinRuleLayout.TIMING_OFFSET).toInt() and 0xFF
            return GrinRule(groupMask, opcode, timing)
        }
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinUriLoader.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import android.content.ContentResolver
import android.content.Context
import android.net.Uri
import java.io.File
import java.io.FileInputStream

object GrinUriLoader {
    fun load(context: Context, uri: Uri): GrinFile {
        return when (uri.scheme) {
            ContentResolver.SCHEME_CONTENT -> {
                context.contentResolver.openInputStream(uri)?.use { input ->
                    GrinFile.load(input)
                } ?: throw IllegalArgumentException("Unable to open content URI: $uri")
            }
            ContentResolver.SCHEME_FILE -> {
                val path = uri.path ?: throw IllegalArgumentException("Missing file path: $uri")
                if (path.startsWith("/android_asset/")) {
                    val assetPath = path.removePrefix("/android_asset/")
                    context.assets.open(assetPath).use { input -> GrinFile.load(input) }
                } else {
                    FileInputStream(File(path)).use { input -> GrinFile.load(input) }
                }
            }
            "android.resource" -> {
                val resId = resolveResourceId(context, uri)
                context.resources.openRawResource(resId).use { input -> GrinFile.load(input) }
            }
            else -> throw IllegalArgumentException("Unsupported URI scheme: ${uri.scheme}")
        }
    }

    fun fromAsset(context: Context, assetPath: String): GrinFile {
        context.assets.open(assetPath).use { input ->
            return GrinFile.load(input)
        }
    }

    fun fromRawResource(context: Context, resId: Int): GrinFile {
        context.resources.openRawResource(resId).use { input ->
            return GrinFile.load(input)
        }
    }

    fun fromFile(file: File): GrinFile {
        FileInputStream(file).use { input ->
            return GrinFile.load(input)
        }
    }

    private fun resolveResourceId(context: Context, uri: Uri): Int {
        val pathSegments = uri.pathSegments
        if (pathSegments.size < 2) {
            throw IllegalArgumentException("Invalid android.resource URI: $uri")
        }
        val resType = pathSegments[0]
        val resName = pathSegments[1]
        val resId = context.resources.getIdentifier(resName, resType, uri.authority)
        if (resId == 0) {
            throw IllegalArgumentException("Resource not found: $uri")
        }
        return resId
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinValidation.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

data class GrinValidationResult(
    val ok: Boolean,
    val errors: List<String>,
    val warnings: List<String>
)

enum class ValidationMode {
    STRICT,
    PERMISSIVE
}

data class ValidationReport(
    val ok: Boolean,
    val errors: List<String>,
    val warnings: List<String>,
    val info: List<String>
)

#####/android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

fun validateMagic(bytes: ByteArray): GrinValidationResult {
    if (bytes.size != GrinFormat.MAGIC_BYTES.size) {
        return fail("Magic must be ${GrinFormat.MAGIC_BYTES.size} bytes")
    }
    if (!bytes.contentEquals(GrinFormat.MAGIC_BYTES)) {
        return fail("Magic bytes do not match GRIN")
    }
    return ok()
}

fun validateVersion(major: Int, minor: Int): GrinValidationResult {
    if (major != GrinFormat.VERSION_MAJOR || minor != GrinFormat.VERSION_MINOR) {
        return warn("Unexpected GRIN version")
    }
    return ok()
}

fun validateHeaderSize(size: Int): GrinValidationResult {
    if (size != GrinFormat.HEADER_SIZE_BYTES) {
        return fail("HeaderSize must be ${GrinFormat.HEADER_SIZE_BYTES}")
    }
    return ok()
}

fun validateDimensions(width: Long, height: Long): GrinValidationResult {
    if (width < 0L || height < 0L) {
        return fail("Width and height must be non-negative")
    }
    if (width > 0xFFFFFFFFL || height > 0xFFFFFFFFL) {
        return fail("Width and height must fit in uint32")
    }
    return ok()
}

fun validateTickMicros(tick: Long): GrinValidationResult {
    if (tick < 0L || tick > 0xFFFFFFFFL) {
        return fail("TickMicros must fit in uint32")
    }
    return ok()
}

fun validateRuleCount(count: Int): GrinValidationResult {
    if (count < 0 || count > GrinFormat.MAX_RULE_COUNT) {
        return fail("RuleCount must be 0-${GrinFormat.MAX_RULE_COUNT}")
    }
    return ok()
}

fun validateOpcodeSetId(id: Int): GrinValidationResult {
    if (id < 0 || id > 0xFF) {
        return fail("OpcodeSetId must fit in uint8")
    }
    if (id != 0) {
        return fail("Unknown OpcodeSetId")
    }
    return ok()
}

fun validatePixelDataLength(length: Long, width: Long, height: Long): GrinValidationResult {
    if (length < 0L) {
        return fail("PixelDataLength must be non-negative")
    }
    val dimResult = validateDimensions(width, height)
    if (!dimResult.ok) {
        return dimResult
    }
    val pixelCount = safeMultiply(width, height)
        ?: return fail("PixelDataLength overflow for width/height")
    val expected = safeMultiply(pixelCount, GrinFormat.PIXEL_SIZE_BYTES.toLong())
        ?: return fail("PixelDataLength overflow for width/height")
    if (length != expected) {
        return fail("PixelDataLength does not match width * height * 5")
    }
    return ok()
}

fun validateFileLength(fileLen: Long, dataLen: Long): GrinValidationResult {
    if (fileLen < 0L) {
        return fail("FileLength must be non-negative")
    }
    val minLen = GrinFormat.HEADER_SIZE_BYTES.toLong() + dataLen
    if (fileLen != 0L && fileLen < minLen) {
        return fail("FileLength is smaller than header + pixel data")
    }
    return ok()
}

fun validatePixelDataOffset(offset: Long): GrinValidationResult {
    if (offset != GrinFormat.HEADER_SIZE_BYTES.toLong()) {
        return fail("PixelDataOffset64 must be 128")
    }
    return ok()
}

fun validateReservedFields(reservedA: Long, reservedB: Long, flags: Int): GrinValidationResult {
    if (reservedA != 0L || reservedB != 0L || flags != 0) {
        return warn("Reserved header fields are non-zero")
    }
    return ok()
}

fun validateControlByte(controlByte: Int): GrinValidationResult {
    val errors = mutableListOf<String>()
    val warnings = mutableListOf<String>()

    if (controlByte < 0 || controlByte > 0xFF) {
        errors.add("Control byte must fit in uint8")
    } else {
        val groupResult = validateGroupId(controlByte and GrinControlByte.GROUP_ID_MASK)
        mergeResult(errors, warnings, groupResult)
        val reservedResult = validateReservedBits(controlByte)
        mergeResult(errors, warnings, reservedResult)
    }
    return finalize(errors, warnings)
}

fun validateGroupId(groupId: Int): GrinValidationResult {
    if (groupId < 0 || groupId > 0x0F) {
        return fail("Group ID must be 0-15")
    }
    return ok()
}

fun validateReservedBits(controlByte: Int): GrinValidationResult {
    if ((controlByte and GrinControlByte.RESERVED_MASK) != 0) {
        return warn("Control byte reserved bits are non-zero")
    }
    return ok()
}

fun validateGroupMask(mask: Int): GrinValidationResult {
    if (mask < 0 || mask > 0xFFFF) {
        return fail("GroupMask must fit in uint16")
    }
    return ok()
}

fun validateOpcode(opcode: Int, opcodeSetId: Int): GrinValidationResult {
    if (opcode < 0 || opcode > 0xFF) {
        return fail("Opcode must fit in uint8")
    }
    if (opcodeSetId != 0) {
        return fail("Unknown OpcodeSetId")
    }
    if (opcode > 0x0C) {
        return fail("Unknown opcode for base set")
    }
    return ok()
}

fun validateTiming(timing: Int): GrinValidationResult {
    if (timing < 0 || timing > 0xFF) {
        return fail("Timing must fit in uint8")
    }
    return ok()
}

fun validateGrinFile(
    file: GrinFile,
    mode: ValidationMode = ValidationMode.PERMISSIVE
): ValidationReport {
    val errors = mutableListOf<String>()
    val warnings = mutableListOf<String>()
    val info = mutableListOf<String>()

    val header = file.header
    mergeResult(errors, warnings, validateMagic(header.magic))
    mergeResult(errors, warnings, validateVersion(header.versionMajor, header.versionMinor))
    mergeResult(errors, warnings, validateHeaderSize(header.headerSize))
    mergeResult(errors, warnings, validateDimensions(header.width, header.height))
    mergeResult(errors, warnings, validateTickMicros(header.tickMicros))
    mergeResult(errors, warnings, validateRuleCount(header.ruleCount))
    mergeResult(errors, warnings, validateOpcodeSetId(header.opcodeSetId))
    mergeResult(errors, warnings, validatePixelDataLength(header.pixelDataLength, header.width, header.height))
    mergeResult(errors, warnings, validateFileLength(header.fileLength, header.pixelDataLength))
    mergeResult(errors, warnings, validatePixelDataOffset(header.pixelDataOffset))
    mergeResult(errors, warnings, validateReservedFields(header.reservedA, header.reservedB, header.flags))

    val expectedPixelCount = safeMultiply(header.width, header.height)
    if (expectedPixelCount == null) {
        errors.add("Pixel count exceeds safe range")
    } else if (expectedPixelCount > Int.MAX_VALUE.toLong()) {
        errors.add("Pixel count exceeds Int range")
    } else if (file.pixels.size != expectedPixelCount.toInt()) {
        errors.add("Pixel array length does not match header dimensions")
    }

    if (file.rules.size != header.ruleCount) {
        errors.add("Rule array length does not match header ruleCount")
    }

    var reservedBitsCount = 0
    for (pixel in file.pixels) {
        if ((pixel.c and GrinControlByte.RESERVED_MASK) != 0) {
            reservedBitsCount += 1
        }
    }
    if (reservedBitsCount > 0) {
        warnings.add("Control byte reserved bits set on $reservedBitsCount pixels")
    }

    file.rules.forEachIndexed { index, rule ->
        prefixResult(errors, warnings, validateGroupMask(rule.groupMask), "Rule $index: ")
        prefixResult(errors, warnings, validateOpcode(rule.opcode, header.opcodeSetId), "Rule $index: ")
        prefixResult(errors, warnings, validateTiming(rule.timing), "Rule $index: ")
    }

    info.add("Pixels: ${file.pixels.size}")
    info.add("Rules: ${file.rules.size}")

    val ok = if (mode == ValidationMode.STRICT) {
        errors.isEmpty() && warnings.isEmpty()
    } else {
        errors.isEmpty()
    }

    return ValidationReport(ok, errors, warnings, info)
}

private fun ok(): GrinValidationResult = GrinValidationResult(true, emptyList(), emptyList())

private fun warn(message: String): GrinValidationResult =
    GrinValidationResult(true, emptyList(), listOf(message))

private fun fail(message: String): GrinValidationResult =
    GrinValidationResult(false, listOf(message), emptyList())

private fun finalize(
    errors: List<String>,
    warnings: List<String>
): GrinValidationResult = GrinValidationResult(errors.isEmpty(), errors, warnings)

private fun mergeResult(
    errors: MutableList<String>,
    warnings: MutableList<String>,
    result: GrinValidationResult
) {
    errors.addAll(result.errors)
    warnings.addAll(result.warnings)
}

private fun prefixResult(
    errors: MutableList<String>,
    warnings: MutableList<String>,
    result: GrinValidationResult,
    prefix: String
) {
    errors.addAll(result.errors.map { "$prefix$it" })
    warnings.addAll(result.warnings.map { "$prefix$it" })
}

private fun safeMultiply(a: Long, b: Long): Long? {
    if (a < 0L || b < 0L) {
        return null
    }
    if (a == 0L || b == 0L) {
        return 0L
    }
    val result = a * b
    if (result / a != b) {
        return null
    }
    return result
}

#####/android/lib/src/main/kotlin/io/grin/lib/GrinView.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import android.content.Context
import android.graphics.Canvas
import android.graphics.Rect
import android.util.AttributeSet
import android.view.MotionEvent
import android.view.View

class GrinView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null
) : View(context, attrs) {
    private val renderer = GrinBitmapRenderer()
    private var bitmap = null as android.graphics.Bitmap?
    private var player: GrinPlayer? = null
    private var imageWidth = 0
    private var imageHeight = 0
    private var resumeOnAttach = false

    fun load(file: GrinFile) {
        ensurePlayer().load(file)
        imageWidth = safeInt(file.header.width, "Width")
        imageHeight = safeInt(file.header.height, "Height")
        requestLayout()
        invalidate()
    }

    fun play() {
        ensurePlayer().play()
    }

    fun pause() {
        player?.pause()
    }

    fun stop() {
        player?.stop()
    }

    fun seek(tick: Long) {
        ensurePlayer().seek(tick)
    }

    fun getCurrentFrame(): DisplayBuffer {
        return ensurePlayer().getCurrentFrame()
    }

    override fun onDraw(canvas: Canvas) {
        super.onDraw(canvas)
        val currentPlayer = player ?: return
        val buffer = currentPlayer.getCurrentFrame()
        val rendered = renderer.render(buffer, bitmap)
        bitmap = rendered

        val target = computeTargetRect(rendered.width, rendered.height)
        canvas.drawBitmap(rendered, null, target, null)
    }

    override fun onTouchEvent(event: MotionEvent): Boolean {
        if (event.action == MotionEvent.ACTION_UP) {
            if (player != null) {
                togglePlayback()
                return true
            }
        }
        return super.onTouchEvent(event)
    }

    override fun onAttachedToWindow() {
        super.onAttachedToWindow()
        if (resumeOnAttach) {
            player?.play()
            resumeOnAttach = false
        }
    }

    override fun onDetachedFromWindow() {
        super.onDetachedFromWindow()
        if (player != null) {
            resumeOnAttach = true
            player?.pause()
        }
    }

    override fun onMeasure(widthMeasureSpec: Int, heightMeasureSpec: Int) {
        if (imageWidth == 0 || imageHeight == 0) {
            super.onMeasure(widthMeasureSpec, heightMeasureSpec)
            return
        }
        val width = MeasureSpec.getSize(widthMeasureSpec)
        val height = MeasureSpec.getSize(heightMeasureSpec)
        val aspect = imageWidth.toFloat() / imageHeight.toFloat()

        var measuredWidth = width
        var measuredHeight = (width / aspect).toInt()
        if (measuredHeight > height) {
            measuredHeight = height
            measuredWidth = (height * aspect).toInt()
        }
        setMeasuredDimension(measuredWidth, measuredHeight)
    }

    private fun ensurePlayer(): GrinPlayer {
        if (player == null) {
            player = GrinPlayer(onFrameRendered = { postInvalidateOnAnimation() })
        }
        return player!!
    }

    private fun togglePlayback() {
        val current = player ?: return
        if (current.isPlaying()) {
            current.pause()
        } else {
            current.play()
        }
    }

    private fun computeTargetRect(bitmapWidth: Int, bitmapHeight: Int): Rect {
        val viewWidth = width
        val viewHeight = height
        val aspect = bitmapWidth.toFloat() / bitmapHeight.toFloat()
        var targetWidth = viewWidth
        var targetHeight = (viewWidth / aspect).toInt()
        if (targetHeight > viewHeight) {
            targetHeight = viewHeight
            targetWidth = (viewHeight * aspect).toInt()
        }
        val left = (viewWidth - targetWidth) / 2
        val top = (viewHeight - targetHeight) / 2
        return Rect(left, top, left + targetWidth, top + targetHeight)
    }
}

private fun safeInt(value: Long, label: String): Int {
    require(value <= Int.MAX_VALUE.toLong()) { "$label exceeds Int range" }
    require(value >= 0L) { "$label must be non-negative" }
    return value.toInt()
}

#####/android/lib/src/main/kotlin/io/grin/lib/Opcode.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

interface Opcode {
    fun getId(): Int
    fun getName(): String
    fun apply(pixel: GrinPixel, tick: Long, timing: Int)
    fun getMaxCpuCost(): Int
    fun requiresState(): Boolean
}

#####/android/lib/src/main/kotlin/io/grin/lib/OpcodeRegistry.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

object OpcodeRegistry {
    private val baseOpcodes: Map<Int, Opcode> = mapOf(
        BaseOpcodes.NOP to NopOpcode(),
        BaseOpcodes.FADE_IN to FadeInOpcode(),
        BaseOpcodes.FADE_OUT to FadeOutOpcode(),
        BaseOpcodes.PULSE to PulseOpcode(),
        BaseOpcodes.SHIFT_R to ShiftROpcode(),
        BaseOpcodes.SHIFT_G to ShiftGOpcode(),
        BaseOpcodes.SHIFT_B to ShiftBOpcode(),
        BaseOpcodes.SHIFT_A to ShiftAOpcode(),
        BaseOpcodes.INVERT to InvertOpcode(),
        BaseOpcodes.ROTATE_HUE to RotateHueOpcode(),
        BaseOpcodes.LOCK to LockOpcode(),
        BaseOpcodes.UNLOCK to UnlockOpcode(),
        BaseOpcodes.TOGGLE_LOCK to ToggleLockOpcode()
    )

    fun getOpcode(opcodeSetId: Int, opcodeId: Int): Opcode {
        require(opcodeSetId == 0) { "Unknown OpcodeSetId $opcodeSetId" }
        return baseOpcodes[opcodeId]
            ?: throw IllegalArgumentException("Unknown opcode $opcodeId for base set")
    }

    fun isValidOpcode(opcodeSetId: Int, opcodeId: Int): Boolean {
        if (opcodeSetId != 0) {
            return false
        }
        return baseOpcodes.containsKey(opcodeId)
    }

    fun listOpcodes(opcodeSetId: Int): List<Opcode> {
        if (opcodeSetId != 0) {
            return emptyList()
        }
        return baseOpcodes.values.toList()
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import kotlin.math.abs
import kotlin.math.roundToInt

class NopOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.NOP
    override fun getName(): String = "NOP"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {}
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class FadeInOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.FADE_IN
    override fun getName(): String = "FADE_IN"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        val level = TimingInterpreter.evaluate(timing, tick)
        pixel.a = clampByte((pixel.a * level).roundToInt())
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class FadeOutOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.FADE_OUT
    override fun getName(): String = "FADE_OUT"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        val level = 1.0 - TimingInterpreter.evaluate(timing, tick)
        pixel.a = clampByte((pixel.a * level).roundToInt())
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class PulseOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.PULSE
    override fun getName(): String = "PULSE"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        val level = TimingInterpreter.evaluate(timing, tick)
        pixel.a = clampByte((pixel.a * level).roundToInt())
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class ShiftROpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.SHIFT_R
    override fun getName(): String = "SHIFT_R"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        pixel.r = shiftChannel(pixel.r, tick, timing)
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class ShiftGOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.SHIFT_G
    override fun getName(): String = "SHIFT_G"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        pixel.g = shiftChannel(pixel.g, tick, timing)
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class ShiftBOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.SHIFT_B
    override fun getName(): String = "SHIFT_B"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        pixel.b = shiftChannel(pixel.b, tick, timing)
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class ShiftAOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.SHIFT_A
    override fun getName(): String = "SHIFT_A"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        pixel.a = shiftChannel(pixel.a, tick, timing)
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class InvertOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.INVERT
    override fun getName(): String = "INVERT"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        pixel.r = 255 - pixel.r
        pixel.g = 255 - pixel.g
        pixel.b = 255 - pixel.b
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class RotateHueOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.ROTATE_HUE
    override fun getName(): String = "ROTATE_HUE"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        val rotation = TimingInterpreter.evaluate(timing, tick) * 360.0

        val rNorm = pixel.r / 255.0
        val gNorm = pixel.g / 255.0
        val bNorm = pixel.b / 255.0
        val max = maxOf(rNorm, gNorm, bNorm)
        val min = minOf(rNorm, gNorm, bNorm)
        val delta = max - min
        val l = (max + min) / 2
        var h = 0.0
        var s = 0.0

        if (delta != 0.0) {
            s = delta / (1 - abs(2 * l - 1))
            h = when (max) {
                rNorm -> ((gNorm - bNorm) / delta) % 6
                gNorm -> ((bNorm - rNorm) / delta) + 2
                else -> ((rNorm - gNorm) / delta) + 4
            }
            h *= 60
            if (h < 0) {
                h += 360
            }
        }

        var newHue = (h + rotation) % 360.0
        if (newHue < 0) {
            newHue += 360.0
        }

        val c = (1 - abs(2 * l - 1)) * s
        val hPrime = newHue / 60.0
        val x = c * (1 - abs((hPrime % 2) - 1))

        var r1 = 0.0
        var g1 = 0.0
        var b1 = 0.0
        when {
            hPrime < 1 -> {
                r1 = c
                g1 = x
            }
            hPrime < 2 -> {
                r1 = x
                g1 = c
            }
            hPrime < 3 -> {
                g1 = c
                b1 = x
            }
            hPrime < 4 -> {
                g1 = x
                b1 = c
            }
            hPrime < 5 -> {
                r1 = x
                b1 = c
            }
            else -> {
                r1 = c
                b1 = x
            }
        }

        val m = l - c / 2
        pixel.r = clampByte(((r1 + m) * 255).roundToInt())
        pixel.g = clampByte(((g1 + m) * 255).roundToInt())
        pixel.b = clampByte(((b1 + m) * 255).roundToInt())
    }
    override fun getMaxCpuCost(): Int = 3
    override fun requiresState(): Boolean = false
}

class LockOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.LOCK
    override fun getName(): String = "LOCK"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        pixel.c = pixel.c or GrinControlByte.LOCK_MASK
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class UnlockOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.UNLOCK
    override fun getName(): String = "UNLOCK"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        pixel.c = pixel.c and GrinControlByte.LOCK_MASK.inv()
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

class ToggleLockOpcode : Opcode {
    override fun getId(): Int = BaseOpcodes.TOGGLE_LOCK
    override fun getName(): String = "TOGGLE_LOCK"
    override fun apply(pixel: GrinPixel, tick: Long, timing: Int) {
        pixel.c = pixel.c xor GrinControlByte.LOCK_MASK
    }
    override fun getMaxCpuCost(): Int = 1
    override fun requiresState(): Boolean = false
}

private fun shiftChannel(value: Int, tick: Long, timing: Int): Int {
    val wave = TimingInterpreter.evaluate(timing, tick)
    val delta = ((wave * 2.0) - 1.0) * 255.0
    return clampByte((value + delta).roundToInt())
}

private fun clampByte(value: Int): Int {
    return when {
        value < 0 -> 0
        value > 255 -> 255
        else -> value
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/PlaybackState.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

class PlaybackState(val displayBuffer: DisplayBuffer) {
    var currentTick: Long = 0
    var isPlaying: Boolean = false
    var tickAccumulatorMicros: Long = 0

    fun reset() {
        currentTick = 0
        tickAccumulatorMicros = 0
        isPlaying = false
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/RuleEngine.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

data class ActiveRule(
    val index: Int,
    val rule: GrinRule
)

private const val ACTIVE_THRESHOLD = 0.5

class RuleEngine {
    fun evaluateRules(image: GrinImage, tick: Long): List<ActiveRule> {
        val active = mutableListOf<ActiveRule>()
        image.rules.forEachIndexed { index, rule ->
            val level = TimingInterpreter.evaluate(rule.timing, tick)
            if (level > ACTIVE_THRESHOLD) {
                active.add(ActiveRule(index, rule))
            }
        }
        return active
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/TestTickScheduler.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

class TestTickScheduler : TickScheduler {
    private var tickCallback: TickCallback? = null
    private var currentTick: Long = 0
    private var running = false

    override fun start() {
        running = true
    }

    override fun stop() {
        running = false
    }

    override fun setTickCallback(cb: TickCallback) {
        tickCallback = cb
    }

    override fun getCurrentTick(): Long = currentTick

    fun advance(ticks: Long = 1) {
        if (!running) {
            return
        }
        var index = 0L
        while (index < ticks) {
            currentTick = if (currentTick == Long.MAX_VALUE) 0L else currentTick + 1
            tickCallback?.invoke(currentTick)
            index += 1
        }
    }
}

#####/android/lib/src/main/kotlin/io/grin/lib/TickScheduler.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

typealias TickCallback = (Long) -> Unit

interface TickScheduler {
    fun start()
    fun stop()
    fun setTickCallback(cb: TickCallback)
    fun getCurrentTick(): Long
}

#####/android/lib/src/main/kotlin/io/grin/lib/TimingInterpreter.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import kotlin.math.PI
import kotlin.math.abs
import kotlin.math.cos
import kotlin.math.floor

enum class WaveformType {
    SQUARE,
    TRIANGLE,
    SINE,
    SAWTOOTH
}

object TimingInterpreter {
    fun getPeriod(timing: Int): Int {
        return (timing and 0x0F) + 1
    }

    fun getWaveform(timing: Int): WaveformType {
        return when ((timing ushr 4) and 0x03) {
            0 -> WaveformType.SQUARE
            1 -> WaveformType.TRIANGLE
            2 -> WaveformType.SINE
            else -> WaveformType.SAWTOOTH
        }
    }

    fun getPhaseOffset(timing: Int): Int {
        return (timing ushr 6) and 0x03
    }

    fun evaluate(timing: Int, tick: Long): Double {
        val period = getPeriod(timing).toDouble()
        val phaseOffset = getPhaseOffset(timing) / 4.0
        val phase = (tick / period) + phaseOffset
        val position = phase - floor(phase)
        return when (getWaveform(timing)) {
            WaveformType.SQUARE -> if (position < 0.5) 0.0 else 1.0
            WaveformType.TRIANGLE -> if (position < 0.5) position * 2 else 2 - position * 2
            WaveformType.SINE -> 0.5 - 0.5 * cos(2 * PI * position)
            WaveformType.SAWTOOTH -> position
        }
    }
}

#####/android/lib/src/test/kotlin/io/grin/lib/GrinEndiannessTest.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import org.junit.Assert.assertArrayEquals
import org.junit.Assert.assertEquals
import org.junit.Test

class GrinEndiannessTest {
    @Test
    fun writeUint16LEWritesExpectedBytes() {
        val bytes = writeUint16LE(0x1234)
        assertArrayEquals(byteArrayOf(0x34, 0x12), bytes)
    }

    @Test
    fun writeUint32LEWritesExpectedBytes() {
        val bytes = writeUint32LE(0x78563412)
        assertArrayEquals(byteArrayOf(0x12, 0x34, 0x56, 0x78), bytes)
    }

    @Test
    fun writeUint64LEWritesExpectedBytes() {
        val bytes = writeUint64LE(0x0807060504030201)
        assertArrayEquals(
            byteArrayOf(0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08),
            bytes
        )
    }

    @Test
    fun readUint16LEReadsExpectedValue() {
        val value = readUint16LE(byteArrayOf(0x34, 0x12), 0)
        assertEquals(0x1234, value)
    }

    @Test
    fun readUint32LEReadsExpectedValue() {
        val value = readUint32LE(byteArrayOf(0x12, 0x34, 0x56, 0x78), 0)
        assertEquals(0x78563412, value)
    }

    @Test
    fun readUint64LEReadsExpectedValue() {
        val value = readUint64LE(
            byteArrayOf(0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08),
            0
        )
        assertEquals(0x0807060504030201, value)
    }
}

#####/android/lib/src/test/kotlin/io/grin/lib/GrinReferenceTest.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import org.junit.jupiter.api.Assertions.assertArrayEquals
import org.junit.jupiter.api.Test

class GrinReferenceTest {
    @Test
    fun `serializes minimal file to reference bytes`() {
        val header = GrinHeader(
            magic = GrinFormat.MAGIC_BYTES,
            versionMajor = GrinFormat.VERSION_MAJOR,
            versionMinor = GrinFormat.VERSION_MINOR,
            headerSize = GrinFormat.HEADER_SIZE_BYTES,
            width = 1,
            height = 1,
            tickMicros = 0,
            ruleCount = 0,
            opcodeSetId = 0,
            flags = 0,
            pixelDataLength = 5,
            fileLength = 133,
            pixelDataOffset = 128,
            reservedA = 0,
            reservedB = 0,
            rulesBlock = ByteArray(GrinFormat.RULES_BLOCK_SIZE)
        )
        val pixel = GrinPixel(1, 2, 3, 4, 0)
        val file = GrinFile(header, listOf(pixel), emptyList())

        val expected = ByteArray(GrinFormat.HEADER_SIZE_BYTES + 5)
        expected[0] = 0x47
        expected[1] = 0x52
        expected[2] = 0x49
        expected[3] = 0x4E
        expected[6] = 0x80.toByte()
        expected[8] = 0x01
        expected[12] = 0x01
        expected[24] = 0x05
        expected[32] = 0x85.toByte()
        expected[40] = 0x80.toByte()
        expected[GrinFormat.HEADER_SIZE_BYTES] = 1
        expected[GrinFormat.HEADER_SIZE_BYTES + 1] = 2
        expected[GrinFormat.HEADER_SIZE_BYTES + 2] = 3
        expected[GrinFormat.HEADER_SIZE_BYTES + 3] = 4
        expected[GrinFormat.HEADER_SIZE_BYTES + 4] = 0

        assertArrayEquals(expected, file.toBytes())
    }
}

#####/android/lib/src/test/kotlin/io/grin/lib/OpcodesTest.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.lib

import org.junit.Assert.assertEquals
import org.junit.Assert.assertTrue
import org.junit.Test
import kotlin.math.abs

class OpcodesTest {
    @Test
    fun nopOpcodeLeavesPixelUnchanged() {
        val pixel = GrinPixel(10, 20, 30, 40, 0)
        NopOpcode().apply(pixel, 1, 0x01)
        assertEquals(10, pixel.r)
        assertEquals(20, pixel.g)
        assertEquals(30, pixel.b)
        assertEquals(40, pixel.a)
        assertEquals(0, pixel.c)
    }

    @Test
    fun fadeInCanZeroAlpha() {
        val pixel = GrinPixel(10, 20, 30, 200, 0)
        FadeInOpcode().apply(pixel, 0, 0x01)
        assertEquals(0, pixel.a)
    }

    @Test
    fun fadeOutCanZeroAlpha() {
        val pixel = GrinPixel(10, 20, 30, 200, 0)
        FadeOutOpcode().apply(pixel, 1, 0x01)
        assertEquals(0, pixel.a)
    }

    @Test
    fun shiftOpcodesClampChannels() {
        val rPixel = GrinPixel(10, 20, 30, 40, 0)
        val gPixel = GrinPixel(10, 20, 30, 40, 0)
        val bPixel = GrinPixel(10, 20, 30, 40, 0)
        val aPixel = GrinPixel(10, 20, 30, 40, 0)

        ShiftROpcode().apply(rPixel, 1, 0x01)
        ShiftGOpcode().apply(gPixel, 0, 0x01)
        ShiftBOpcode().apply(bPixel, 1, 0x01)
        ShiftAOpcode().apply(aPixel, 0, 0x01)

        assertEquals(255, rPixel.r)
        assertEquals(0, gPixel.g)
        assertEquals(255, bPixel.b)
        assertEquals(0, aPixel.a)
    }

    @Test
    fun invertOpcodeFlipsRgb() {
        val pixel = GrinPixel(10, 20, 30, 200, 0)
        InvertOpcode().apply(pixel, 0, 0)
        assertEquals(245, pixel.r)
        assertEquals(235, pixel.g)
        assertEquals(225, pixel.b)
        assertEquals(200, pixel.a)
    }

    @Test
    fun rotateHueOpcodeRotatesRedToCyan() {
        val pixel = GrinPixel(255, 0, 0, 255, 0)
        RotateHueOpcode().apply(pixel, 1, 0x31)
        assertChannelApprox(0, pixel.r)
        assertChannelApprox(255, pixel.g)
        assertChannelApprox(255, pixel.b)
    }

    @Test
    fun lockOpcodesToggleLockBit() {
        val pixel = GrinPixel(10, 20, 30, 40, 0)
        LockOpcode().apply(pixel, 0, 0)
        assertEquals(GrinControlByte.LOCK_MASK, pixel.c and GrinControlByte.LOCK_MASK)

        UnlockOpcode().apply(pixel, 0, 0)
        assertEquals(0, pixel.c and GrinControlByte.LOCK_MASK)

        ToggleLockOpcode().apply(pixel, 0, 0)
        assertEquals(GrinControlByte.LOCK_MASK, pixel.c and GrinControlByte.LOCK_MASK)
    }

    private fun assertChannelApprox(expected: Int, actual: Int, tolerance: Int = 1) {
        assertTrue(abs(expected - actual) <= tolerance)
    }
}

#####/android/local.properties#####
sdk.dir=/home/amber/Android/Sdk

#####/android/scripts/gradle-run.sh#####
#!/usr/bin/env bash

# MIT License
#
# Copyright (c) 2025 GRIN Project Contributors
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GRADLE_BIN="${GRADLE_BIN:-}"

if [[ -z "${GRADLE_BIN}" ]]; then
  if [[ -x "${ROOT_DIR}/gradlew" ]]; then
    GRADLE_BIN="${ROOT_DIR}/gradlew"
  elif [[ -n "${GRADLE_HOME:-}" && -x "${GRADLE_HOME}/bin/gradle" ]]; then
    GRADLE_BIN="${GRADLE_HOME}/bin/gradle"
  else
    GRADLE_BIN="$(find "${HOME}/.gradle/wrapper/dists" -type f -path "*/bin/gradle" 2>/dev/null | sort | tail -n 1 || true)"
  fi
fi

if [[ -z "${GRADLE_BIN}" ]]; then
  echo "Gradle not found. Set GRADLE_BIN or GRADLE_HOME, or add gradlew." >&2
  exit 1
fi

cd "${ROOT_DIR}"
"${GRADLE_BIN}" "${@:-:lib:testReleaseUnitTest}"

#####/android/settings.gradle.kts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
// GRIN Android Project Settings
// Graphic Readdressable Indexed Nodes

pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = "grin-android"

include(":lib")
include(":demo")

#####/benchmarks/README.md#####
# GRIN Benchmarks

Run the benchmark harness to capture baseline timings for loading, validation, and rendering.

```
node benchmarks/bench.js --write-baseline
```

Re-run without `--write-baseline` to compare against the stored baseline.

#####/benchmarks/baseline.json#####
{
  "updatedAt": null,
  "sizes": {
    "1x1": null,
    "64x64": null,
    "256x256": null
  }
}

#####/benchmarks/bench.js#####
import fs from "node:fs";
import path from "node:path";
import { performance } from "node:perf_hooks";
import { fileURLToPath } from "node:url";
import { createGrinFile, parseGrinBytes, serializeGrinFile } from "../tools/lib/grin.js";
import { validateGrinFile } from "../tools/lib/validation.js";
import { createRenderState, renderFrame, renderToTick } from "../tools/lib/render.js";

const args = process.argv.slice(2);
const writeBaseline = args.includes("--write-baseline");
const sizes = [
  { label: "1x1", width: 1, height: 1 },
  { label: "64x64", width: 64, height: 64 },
  { label: "256x256", width: 256, height: 256 },
];

const results = {};
for (const size of sizes) {
  const file = createSyntheticFile(size.width, size.height);
  const bytes = serializeGrinFile(file);

  const loadMs = measure(() => {
    parseGrinBytes(bytes);
  }, 50);

  const parsed = parseGrinBytes(bytes);
  const validateMs = measure(() => {
    validateGrinFile(parsed, "permissive");
  }, 50);

  const perTickMs = measure(() => {
    const state = createRenderState(parsed);
    for (let tick = 0; tick < 60; tick += 1) {
      renderFrame(parsed, tick, state);
    }
  }, 5);

  const renderMs = measure(() => {
    renderToTick(parsed, 60);
  }, 5);

  results[size.label] = {
    loadMs,
    validateMs,
    perTickMs,
    renderMs,
  };
}

const baselinePath = path.join(path.dirname(fileURLToPath(import.meta.url)), "baseline.json");
if (writeBaseline) {
  const baseline = {
    updatedAt: new Date().toISOString(),
    sizes: results,
  };
  fs.writeFileSync(baselinePath, `${JSON.stringify(baseline, null, 2)}\n`);
  process.stdout.write(`Baseline written to ${baselinePath}\n`);
} else {
  const baseline = safeReadBaseline(baselinePath);
  process.stdout.write(`${JSON.stringify({ baseline, results }, null, 2)}\n`);
}

function createSyntheticFile(width, height) {
  const pixels = [];
  for (let i = 0; i < width * height; i += 1) {
    const value = i % 256;
    pixels.push({ r: value, g: (value * 3) % 256, b: (value * 7) % 256, a: 255, c: 0 });
  }
  return createGrinFile({ width, height, pixels, rules: [], tickMicros: 1, opcodeSetId: 0 });
}

function measure(fn, iterations) {
  const start = performance.now();
  for (let i = 0; i < iterations; i += 1) {
    fn();
  }
  const end = performance.now();
  return (end - start) / iterations;
}

function safeReadBaseline(baselinePath) {
  try {
    const raw = fs.readFileSync(baselinePath, "utf8");
    return JSON.parse(raw);
  } catch (error) {
    return { updatedAt: null, sizes: {} };
  }
}

#####/docs/android-grid-camera-ux.md#####
# Android Grid Camera + Gallery UX & Data Model

## UX Flow Overview

### Screen Map
1. **Camera Preview**
   - Live posterized preview with grid overlay.
   - Primary actions: capture, toggle grid, palette view, settings.
2. **Capture Review**
   - Frozen posterized frame with channel mapping summary.
   - Actions: accept (save GRIM/GRIN), retake, open editor.
3. **Gallery Grid**
   - Posterized thumbnails in a grid, with quick metadata badges (resolution, palette size).
   - Actions: open editor, export, delete, share.
4. **Editor**
   - Channel selector (0-9/A-F) plus sliders for frequency, color intonation, transparency.
   - Actions: apply, revert, export, back to gallery.

### Navigation Rules
- Camera Preview is the default entry point.
- Capture Review is modal; accepting moves to Gallery and allows immediate Editor open.
- Gallery is the primary browsing surface; Editor is a detail view scoped to one capture.

## Data Model

### Entities
- **CaptureSession**
  - `id` (UUID)
  - `createdAt` (epoch millis)
  - `width`, `height`
  - `gridCols`, `gridRows`
  - `paletteBins` (12-14)
  - `sourceUri` (raw capture or temp buffer)
- **GrinAsset**
  - `id` (UUID)
  - `fileUri` (GRIM/GRIN output path)
  - `previewUri` (posterized PNG)
  - `width`, `height`
  - `tickMicros`
  - `ruleCount`
  - `channelMap` (ordered list of channel assignments)
  - `paletteHistogram` (bin -> count)
  - `createdAt`, `lastEditedAt`
- **ChannelSetting**
  - `channelId` (0-15)
  - `frequency`
  - `intonation`
  - `alpha`

### Storage Plan
- Persist `GrinAsset` and `ChannelSetting` metadata in Room (SQLite).
- Store GRIM/GRIN payloads and preview PNGs in app-scoped storage with stable file names.
- Cache derived thumbnails; invalidate on edit export.

## Posterization & Channel Mapping

### Palette Handling
- Target 12-14 color bins per capture; bins built from a posterization LUT.
- For high-variance scenes, allow adaptive bin count within the 12-14 range.
- Persist ordered palette bins for consistent channel mapping across edits/exports.

### Preview Pipeline Targets
- Aim for 30fps on mid-tier devices, with headroom for 60fps on flagship devices.
- If analysis latency exceeds ~40ms, drop to a fallback profile (75% grid resolution, 12 bins).
- Use CPU posterization with nearest-palette matching; keep frames capped by analysis FPS.

### Channel Mapping Rules
- Assign bins to channels 0-9/A-F using stable sort by frequency, then luminance.
- Keep a deterministic mapping table in `channelMap` to guarantee replayability.
- Provide editor overrides that reassign channels without re-running posterization.

## GRIM/GRIN Metadata Updates
- Update `TickMicros` based on capture preview cadence (e.g., 33_333 for 30fps).
- Set `RuleCount` to the number of active channels.
- Write channel metadata into rule block entries (group mask + opcode + timing) to reflect editor settings.
- Ensure header `PixelDataLength` and `FileLength` reflect generated payload sizes.

## Export Options

### GRIM/GRIN
- Persist updated header settings, channel map, and rules for playback parity.

### PNG Snapshot
- Export an ARGB_8888 bitmap with alpha preserved from the posterized preview.

### GIF Loop
- Render 12-15 frames from GRIN playback at fixed tick intervals.
- Package as a looping GIF with consistent palette ordering.
#####/docs/README.md#####
# GRIN Documentation

This folder contains Phase 12 documentation (plus Phase 14 foundations) that complements the core spec.

- `docs/format-diagram.md` - byte-level layout diagrams and validation notes
- `docs/opcodes.md` - opcode set 0 reference and behavior notes
- `docs/timing.md` - timing byte interpretation and waveform details
- `docs/api-quickstart.md` - API and CLI quick-starts
- `docs/migration-gif-apng.md` - migration guide from frame-based formats
- `docs/tutorial-first-file.md` - first-file tutorial using the CLI tools
- `docs/tutorial-grin-groups.md` - groups and masks tutorial
- `docs/playback-guide-web.md` - web playback integration guide
- `docs/playback-guide-android.md` - Android playback integration guide
- `docs/security-model.md` - security model and validation requirements
- `docs/security-audit-checklist.md` - audit checklist
- `docs/release-preparation.md` - semantic versioning and release tagging
- `docs/compatibility.md` - Android, browser, and Node.js compatibility matrix
- `docs/creative-suite-foundations.md` - shared UX and interchange formats for plugins
- `docs/ui-ux-audit.md` - UX audit inventory, checklist, and backlog (Phase 15.1)
- `docs/android-grid-camera-ux.md` - UX flow and data model for the Android grid camera + gallery app
- `docs/api/web/` - generated TypeDoc output (web library)
- `docs/api/android/README.md` - Android API draft (Dokka output configured here)

Related docs outside this folder:

- `grin_technical_specification_v_2.md`
- `grin_technical_specification.md`
- `tchspecdraft.txt` (draft copy for review)
- `ARCHITECTURE.md`
- `SECURITY.md`
- `samples/README.md`

#####/docs/ui-ux-audit.md#####
# GRIN UI/UX Audit (Phase 15.1)

**Audit date:** 2025-09-28

This audit inventories current user-facing surfaces, captures flows and pain points, and establishes a
heuristics checklist, core journeys, and a prioritized UX backlog for Phase 15.

## 1) Inventory of end-user surfaces

| Surface | Location | Primary flows | Pain points | Screenshot notes |
| --- | --- | --- | --- | --- |
| Web demo | `web/demo/index.html`, `web/demo/demo.js`, `web/demo/styles.css` | Drag/drop `.grin` file, choose file, play/pause/stop, seek via slider, load bundled samples. | No visible validation errors, playback controls lack disabled states, metadata panel text-only without hierarchy, missing empty state for samples fetch errors. | Screenshot captured during audit run; not committed to repo to avoid binary artifacts. |
| Android demo | `android/demo/src/main/kotlin/io/grin/demo/MainActivity.kt`, `android/demo/src/main/res/layout/activity_main.xml` | Launch app, load bundled sample, play/stop animation, view metadata. | No clear file-open CTA, limited affordances for scrub/seek, metadata readout dense, lacks error recovery UI. | Screenshots unavailable in current environment (no Android runtime). |
| CLI tools | `tools/bin/grin-encode.js`, `tools/bin/grin-decode.js`, `tools/bin/grin-inspect.js`, `tools/bin/grin-validate.js` | Encode from PNG + rules, decode to PNG, inspect headers, validate files. | Usage output is terse, no examples, errors lack remediation steps, flags not surfaced consistently across tools. | CLI is text-only; captured output notes in this document. |
| Docs onboarding | `docs/README.md` plus `docs/tutorial-first-file.md` | Discover documentation entry points, follow CLI quick start, find spec references. | No explicit “start here” ordering, no UX/UX checklist link before audit, missing callouts for demos. | Screenshots not required; doc navigation captured in audit notes. |

### CLI help capture (sample)

```
Usage: grin-encode <input.png> <output.grin> [--groups <mask.png>] [--rules <rules.json>]
```

## 2) UX heuristics checklist

| Heuristic | Web demo | Android demo | CLI | Docs |
| --- | --- | --- | --- | --- |
| Navigation clarity (clear next step) | Partial | Partial | Partial | Partial |
| Error state clarity (actionable messaging) | Missing | Missing | Partial | Partial |
| Keyboard/mouse affordances (shortcuts, focus) | Missing | Missing | Missing | Partial |
| Accessibility (contrast, target size, labels) | Partial | Partial | N/A | Partial |
| Feedback & system status (loading/progress) | Missing | Missing | Partial | Partial |
| Consistent terminology across surfaces | Partial | Partial | Partial | Partial |
| Discoverability of sample content | Partial | Partial | N/A | Partial |

## 3) Core user journeys + success criteria

### Journey A: Open file
1. User finds the file-open entry point.
2. User selects or drops a `.grin` file.
3. UI validates and loads the file.

**Success criteria**
- Clear CTA for opening a file.
- Validation errors are visible with next-step guidance.
- The UI shows a loaded state with metadata.

### Journey B: Play animation
1. User presses play.
2. Playback starts, status updates, and timing aligns with tick rate.
3. User can pause/stop and resume without losing state.

**Success criteria**
- Playback controls show current state.
- Seek/step is responsive with clear bounds.
- No console-only errors.

### Journey C: Inspect groups
1. User finds group summary or mask information.
2. User filters or inspects group counts.

**Success criteria**
- Group counts are visible.
- Filters are discoverable and reversible.

### Journey D: Export
1. User selects export action.
2. Validation runs and confirms output.
3. User is notified of output location and success/failure.

**Success criteria**
- Export path is explicit.
- Validation results are summarized.
- Failure states provide remediation steps.

## 4) Prioritized UX backlog

| Priority | Platform | Backlog item |
| --- | --- | --- |
| P0 | Web | Add validation error panel with remediation and status indicators next to playback. |
| P0 | Android | Add file-open CTA and error recovery UI when decode fails. |
| P0 | CLI | Provide `--help` with examples for encode/decode/validate and align flag naming. |
| P1 | Web | Add disabled/active states for playback controls and clearer seek bounds. |
| P1 | Android | Introduce playback scrubber + speed controls with accessible touch targets. |
| P1 | Docs | Add “Start here” block and demo links in `docs/README.md`. |
| P2 | Web | Add keyboard shortcuts help modal for playback + group filters. |
| P2 | CLI | Add consistent error taxonomy and remediation hints. |
| P2 | Docs | Add quick UX FAQ and link to audit checklist. |

#####/docs/creative-suite-foundations.md#####
# Creative Suite + GIMP Plugin Foundations (Phase 14.1)

This document defines the shared foundations for Photoshop, Illustrator, and GIMP plugin workflows.
It provides a unified UX model, interchange format, validation workflow, palette legend, and naming
conventions that align with the existing GRIN CLI tooling.

## 1) Pixel-group editing model + UX goals (1-page spec)

**Goal:** Make group ID painting and lock-bit authoring fast, discoverable, and non-destructive,
while preserving the original art and enabling instant validation.

**Core UX elements**

- **Group ID palette (0-15):** A compact legend of 16 swatches labeled `G0`–`G15`. Selecting a
  swatch sets the active group ID for painting or tagging.
- **Lock toggle:** A single toggle/button that sets the lock bit for the active paint/selection
  action. When enabled, applied marks set the lock bit; when disabled, they clear it.
- **Dual-layer workflow (non-destructive):**
  - **Artwork layer(s):** The visible RGBA art the artist paints.
  - **Group/lock metadata layer(s):** Hidden metadata layers (or masks) that store group ID and
    lock-bit information without altering the art.
- **Overlays:**
  - **Group overlay:** Semi-transparent tint showing group ID regions using the shared palette.
  - **Lock overlay:** A hatch/stripe or icon overlay indicating locked pixels.
- **Selection tools:** Brush, lasso, and fill operate on the metadata layers while previewing
  changes on overlays in real time.
- **Rule preview:** A lightweight preview panel that runs `grin-inspect` (static) and
  `grin-validate` (rules sanity) on the exported assets and shows any errors inline.

**UX flow**

1. Artist paints the visible RGBA artwork.
2. Artist switches to **Group Mode**, selects a group from the palette, and paints selections
   into the group metadata layer.
3. Artist toggles **Lock Mode** to mark areas as locked (e.g., logos or static UI elements).
4. Artist exports using the standardized naming conventions to produce RGBA + group map + rules.
5. Validation runs automatically and surfaces warnings/errors before `.grin` export.

## 2) Interchange format between host apps and GRIN toolchain

**Artifacts (all required):**

- **RGBA art:** `<name>.png`
- **Group map:** `<name>.groups.png` (8-bit grayscale, values 0–15)
- **Rules:** `<name>.rules.json`

**Optional (lock map):**

- **Lock map:** `<name>.lock.png` (8-bit grayscale, 0 = unlocked, 255 = locked)

**Rules JSON format (compatible with `tools/bin/grin-encode.js`):**

```json
{
  "tickMicros": 33333,
  "opcodeSetId": 0,
  "rules": [
    { "groupMask": [0, 1, 2], "opcode": 3, "timing": 18 },
    { "groupMask": 8, "opcode": 1, "timing": 4 }
  ]
}
```

**Notes:**

- The group map is a grayscale PNG where pixel values map to group IDs (0–15). The existing
  encoder maps values ≤ 15 directly and rescales others; exporter should write exact 0–15 values
  for fidelity.
- The lock map is optional today; plugin exporters should still generate it for future support.
  When lock support is added to tooling, lock map pixels will set bit 7 in the control byte.

## 3) Shared validation CLI workflow

**CLI expectations:**

1. Encode with group map + rules:
   ```bash
   node tools/bin/grin-encode.js <name>.png <name>.grin --groups <name>.groups.png --rules <name>.rules.json
   ```
2. Validate the output:
   ```bash
   node tools/bin/grin-validate.js <name>.grin
   ```
3. Optional inspection for debugging:
   ```bash
   node tools/bin/grin-inspect.js <name>.grin
   ```

**Plugin behavior:**

- Run the validation step automatically after export.
- If validation fails, show a list of errors with file references and suggested fixes.
- GIMP workflows should export through the Python-Fu panel and surface preview counts from the
  group/lock layers so artists can verify metadata coverage before encoding.

## 4) Shared palette/legend for group IDs and lock overlays

| Group | Label | Color (Hex) | Notes |
|-------|-------|-------------|-------|
| 0     | G0    | #FF1744     | Default primary group |
| 1     | G1    | #FF9100     | Warm secondary |
| 2     | G2    | #FFD600     | Highlight |
| 3     | G3    | #76FF03     | Bright green |
| 4     | G4    | #00E5FF     | Cyan |
| 5     | G5    | #2979FF     | Blue |
| 6     | G6    | #651FFF     | Indigo |
| 7     | G7    | #D500F9     | Purple |
| 8     | G8    | #F50057     | Magenta |
| 9     | G9    | #FF6D00     | Orange |
| 10    | G10   | #C6FF00     | Lime |
| 11    | G11   | #1DE9B6     | Teal |
| 12    | G12   | #00B0FF     | Light blue |
| 13    | G13   | #304FFE     | Royal blue |
| 14    | G14   | #AA00FF     | Violet |
| 15    | G15   | #F06292     | Pink |

**Lock overlay:** Use a diagonal hatch pattern (45°) at 30% opacity, with a lock icon in the
corner of the selection/preview. This remains consistent across Photoshop, Illustrator, and GIMP.

## 5) Output paths and naming conventions

**Export directory:** `exports/` at the project root by default (configurable per plugin).

**Naming standard:**

- `<name>.png` (RGBA art)
- `<name>.groups.png` (group IDs)
- `<name>.lock.png` (optional lock map)
- `<name>.rules.json` (rules)
- `<name>.grin` (final compiled output)

**Example:**

```
exports/
  hero_idle.png
  hero_idle.groups.png
  hero_idle.lock.png
  hero_idle.rules.json
  hero_idle.grin
```

This naming scheme is compatible with `tools/bin/grin-encode.js` inputs and keeps derivative
assets grouped for validation and review.

## 6) GIMP plugin specifics

- **Menu entry:** `Filters → GRIN → GRIN Export...` (Python-Fu).
- **Metadata layers:** The plugin maintains `GRIN_GROUPS` and `GRIN_LOCK` grayscale layers for
  non-destructive group and lock authoring.
- **Selection painting:** Use selections to paint group IDs (0-15) and lock state (0/255) into
  the metadata layers while leaving the visible art untouched.
- **Preview feedback:** The plugin summarizes group and lock pixel counts after each run to help
  validate coverage before encoding.

#####/docs/release-preparation.md#####
# Release Preparation

## Semantic Versioning Scheme

GRIN follows Semantic Versioning: `MAJOR.MINOR.PATCH`.

- **MAJOR**: incompatible format or API changes (binary format, opcode set, or public APIs).
- **MINOR**: backward-compatible additions (new opcodes, new helpers, new tools).
- **PATCH**: backward-compatible fixes (bug fixes, documentation corrections).

While the project is `<1.0.0`, breaking changes may increment the **MINOR** version and
backward-compatible changes may increment the **PATCH** version.

## Release Tagging

Release tags use the format `vX.Y.Z` and point at the exact commit for the release.
The initial release tag is **v0.1.0**.

## Release Artifacts

Release artifacts should include:

- Web package build (`web/dist/`)
- CLI tool bundle (`tools/`)
- Android library (`android/lib/`)
- Checksums for published binaries

## Package Publishing

### Android (Maven Central / JitPack)

1. Ensure `android/lib/build.gradle.kts` has publishing metadata and signing configured.
2. Export credentials for the Central Publisher Portal and signing:
   - `CENTRAL_USERNAME`, `CENTRAL_PASSWORD`
   - `SIGNING_KEY`, `SIGNING_PASSWORD`
3. Run preflight checks:
   - Confirm the Central Portal namespace is verified for `io.grin`.
   - Validate that the in-memory PGP key matches the published public key.
   - Verify the Android version matches the release tag and CHANGELOG entry.
4. Publish the release artifacts:
   - `./gradlew :lib:publish` (from `android/`)
5. In the Central Publisher Portal, review the deployment status and publish it.

For JitPack, push a Git tag and confirm the build at `https://jitpack.io/#grin-format/grin`.

### Web (npm)

1. From `web/`, run `npm run build`.
2. Verify `dist/` output and `web/README.md` contents.
3. Publish with:
   - `npm publish --access public`

### GitHub Releases

1. Push a version tag in the format `vX.Y.Z`.
2. Confirm the `release.yml` workflow attaches the packaged artifacts.
3. Add release notes referencing the CHANGELOG entry.

#####/docs/compatibility.md#####
# Compatibility Matrix

## Android

- **Minimum API level**: 21 (Android 5.0 Lollipop)
- **Target API level**: 34 (aligns with current Android toolchain defaults)
- **Notes**: Rendering relies on standard Android graphics APIs; no native code required.

## Web Browsers

The web library targets modern evergreen browsers with ES6 module support.

- **Chrome**: latest two major versions
- **Firefox**: latest two major versions
- **Safari**: latest two major versions
- **Edge**: latest two major versions

Legacy browsers without ES6 modules (e.g., IE11) are not supported.

## Node.js

- **Minimum Node.js version**: 18.x (per `web/package.json` engine requirements)
- **Recommended**: latest LTS

#####/docs/api-quickstart.md#####
# GRIN API Quick Start

This guide focuses on the current web, Android, and CLI implementations.

## CLI (Node >= 18)

```bash
node tools/bin/grin-validate.js samples/minimal.grin
node tools/bin/grin-inspect.js samples/pulse_red.grin --header --rules
node tools/bin/grin-encode.js input.png output.grin
node tools/bin/grin-decode.js samples/pulse_red.grin output.png --frame 0
```

Animated GIF export:

```bash
node tools/bin/grin-decode.js samples/pulse_red.grin output.gif --gif --frames 60 --fps 30
```

## Web / TypeScript

Build the web package once so `web/dist` is available:

```bash
cd web
npm install
npm run build
```

Canvas playback with the core player:

```ts
import {
  GrinCanvasRenderer,
  GrinLoader,
  GrinPlayer,
  OpcodeRegistry,
  RAFTickScheduler,
  RuleEngine,
} from "./dist/grin.js";

const canvas = document.querySelector("canvas");
const renderer = new GrinCanvasRenderer();
let player = null;

const schedulerFactory = (tickMicros) => new RAFTickScheduler(tickMicros);

const file = await GrinLoader.fromURL("./samples/pulse_red.grin");
player = new GrinPlayer(schedulerFactory, new RuleEngine(), OpcodeRegistry.getInstance(), () => {
  renderer.render(player.getCurrentFrame(), canvas);
});
player.load(file);
player.play();
```

## Web Component

```html
<grin-player src="./samples/pulse_red.grin" autoplay playbackrate="1.5"></grin-player>
```

The custom element exposes `play()`, `pause()`, `currentTime`, and `getCurrentFrame()`.

## Android

Use `GrinView` for drop-in playback:

```kotlin
val grinView = findViewById<GrinView>(R.id.grinView)
val file = GrinUriLoader.fromAsset(this, "samples/minimal.grin")
grinView.load(file)
grinView.play()
```

Or manually manage playback:

```kotlin
val file = GrinFile.load(inputStream)
val player = GrinPlayer()
val renderer = GrinBitmapRenderer()
player.load(file)
player.play()

val frame = player.getCurrentFrame()
val bitmap = renderer.render(frame)
```

#####/docs/format-diagram.md#####
# GRIN Format Diagram

This diagram summarizes the byte-level layout implemented in the current web,
Android, and CLI libraries. All multi-byte integers are little-endian.

## File Layout (128 + pixel data)

```text
0x0000 ┌────────────────────────────────────────────────────────────┐
       │ Header (128 bytes)                                          │
0x0080 ├────────────────────────────────────────────────────────────┤
       │ Pixel data (Width * Height * 5 bytes)                       │
       └────────────────────────────────────────────────────────────┘
```

## Header Layout (128 bytes)

| Offset | Size | Field | Type | Notes |
| ---: | ---: | --- | --- | --- |
| 0 | 4 | Magic | ASCII | "GRIN" |
| 4 | 1 | VersionMajor | uint8 | current 0 |
| 5 | 1 | VersionMinor | uint8 | current 0 |
| 6 | 2 | HeaderSize | uint16 | must be 128 |
| 8 | 4 | Width | uint32 | pixels |
| 12 | 4 | Height | uint32 | pixels |
| 16 | 4 | TickMicros | uint32 | tick duration in microseconds |
| 20 | 1 | RuleCount | uint8 | 0-16 |
| 21 | 1 | OpcodeSetId | uint8 | 0 for base set |
| 22 | 2 | Flags | uint16 | reserved (0) |
| 24 | 8 | PixelDataLength | uint64 | width * height * 5 |
| 32 | 8 | FileLength | uint64 | total bytes (0 allowed) |
| 40 | 8 | PixelDataOffset64 | uint64 | must be 128 |
| 48 | 8 | ReservedA | uint64 | 0 |
| 56 | 8 | ReservedB | uint64 | 0 |
| 64 | 64 | RulesBlock | bytes | 16 rule entries (4 bytes each) |

## Rules Block (64 bytes)

Each rule entry is 4 bytes. Only the first RuleCount entries are active.

| Byte | Field | Type | Notes |
| ---: | --- | --- | --- |
| 0-1 | GroupMask | uint16 | bit i targets group i |
| 2 | Opcode | uint8 | must be valid for OpcodeSetId |
| 3 | Timing | uint8 | see `docs/timing.md` |

## Pixel Layout (5 bytes)

| Byte | Field | Type | Notes |
| ---: | --- | --- | --- |
| 0 | R | uint8 | red |
| 1 | G | uint8 | green |
| 2 | B | uint8 | blue |
| 3 | A | uint8 | alpha |
| 4 | C | uint8 | control byte |

Control byte bits:

```text
7   6   5   4   3   2   1   0
L   R   R   R   G   G   G   G

G = Group ID (0-15)
R = Reserved (must be 0)
L = Lock bit
```

## Reader Validation (Required)

A reader must reject the file if any of the following are true:

- Magic != "GRIN"
- HeaderSize != 128
- RuleCount > 16
- PixelDataOffset64 != 128
- PixelDataLength != Width * Height * 5
- FileLength != 0 and FileLength < 128 + PixelDataLength

Readers should warn if reserved fields or control-byte reserved bits are non-zero.

#####/docs/migration-gif-apng.md#####
# Migration Guide: GIF/APNG to GRIN

GRIN is not a frame-based animation format. It stores a single image plus
group assignments and rule-driven modulation. Migrating from GIF/APNG is
about translating *behavior* into GRIN rules, not copying frames.

## Key Differences

- GIF/APNG: sequence of discrete frames.
- GRIN: one base image, plus opcodes that modulate pixels over time.
- GRIN rules target groups, not individual pixels at runtime.
- Some complex frame-by-frame animations are not expressible in GRIN.

## Migration Strategy

1. Choose a base frame to represent the initial state.
2. Assign groups to areas you want to modulate (up to 16).
3. Translate repeating or periodic effects into GRIN rules.
4. Encode the file and validate it.

## Tools Workflow

1) Prepare a base PNG and optional group mask:

```bash
node tools/bin/grin-encode.js base.png output.grin --groups group-mask.png --rules rules.json
```

2) Example `rules.json`:

```json
{
  "tickMicros": 16666,
  "opcodeSetId": 0,
  "rules": [
    { "groupMask": 1, "opcode": "0x03", "timing": "0x27" }
  ]
}
```

3) Inspect the result:

```bash
node tools/bin/grin-inspect.js output.grin --header --rules --groups
```

## When to Split into Multiple GRIN Files

If your source animation has complex per-frame edits, consider exporting
multiple GRIN files and switching between them externally. GRIN is designed
for deterministic modulation, not arbitrarily scripted timelines.

#####/docs/opcodes.md#####
# GRIN Opcode Reference (OpcodeSetId = 0)

The current implementations (web, Android, tools) define a base opcode set
with IDs 0x00 through 0x0C. Unknown opcode values are treated as invalid.

All opcodes are stateless and operate on a per-pixel working copy during playback.

| ID | Name | Behavior | Notes |
| ---: | --- | --- | --- |
| 0x00 | NOP | No change | CPU cost 1 |
| 0x01 | FADE_IN | Alpha *= timing wave | Uses `TimingInterpreter.evaluate` |
| 0x02 | FADE_OUT | Alpha *= (1 - timing wave) | Uses `TimingInterpreter.evaluate` |
| 0x03 | PULSE | Alpha *= timing wave | Same as FADE_IN in current code |
| 0x04 | SHIFT_R | R += delta | delta = round((wave * 2 - 1) * 255) |
| 0x05 | SHIFT_G | G += delta | delta = round((wave * 2 - 1) * 255) |
| 0x06 | SHIFT_B | B += delta | delta = round((wave * 2 - 1) * 255) |
| 0x07 | SHIFT_A | A += delta | delta = round((wave * 2 - 1) * 255) |
| 0x08 | INVERT | R = 255 - R, etc | Alpha unchanged |
| 0x09 | ROTATE_HUE | Rotate hue by wave * 360 deg | HSL conversion, CPU cost 3 |
| 0x0A | LOCK | Set lock bit | Sets control byte bit 7 |
| 0x0B | UNLOCK | Clear lock bit | Clears control byte bit 7 |
| 0x0C | TOGGLE_LOCK | Toggle lock bit | XOR bit 7 |

Reserved IDs: 0x0D-0x0F.

## Example Rule Entry

```text
GroupMask: 0x0001  (targets group 0)
Opcode:    0x03    (PULSE)
Timing:    0x27    (period 8 ticks, sine wave, phase 0)
```

## Implementation Notes

- SHIFT_* opcodes clamp channel values to 0-255 after applying the delta.
- LOCK/UNLOCK/TOGGLE_LOCK mutate the control byte, which affects future ticks.
- Rotate hue uses HSL conversion and clamps resulting RGB values.

#####/docs/playback-guide-android.md#####
# Android Playback Integration Guide

The Android library provides both a `GrinView` for drop-in playback and the
lower-level `GrinPlayer` if you want custom rendering.

## Using GrinView

```kotlin
val grinView = findViewById<GrinView>(R.id.grinView)
val file = GrinUriLoader.fromAsset(this, "samples/pulse_red.grin")
grinView.load(file)
grinView.play()
```

`GrinView` handles:

- `GrinPlayer` lifecycle
- aspect-correct drawing
- pause/resume on attach/detach

## Using GrinPlayer + GrinBitmapRenderer

```kotlin
val file = GrinFile.load(inputStream)
val player = GrinPlayer()
val renderer = GrinBitmapRenderer()

player.load(file)
player.play()

val frame = player.getCurrentFrame()
val bitmap = renderer.render(frame)
imageView.setImageBitmap(bitmap)
```

The default scheduler uses `AndroidTickScheduler`, which is driven by
`Choreographer` and honors the `TickMicros` value in the file header.

## Loading Files

Use `GrinUriLoader` helpers for common sources:

```kotlin
GrinUriLoader.fromAsset(context, "samples/minimal.grin")
GrinUriLoader.fromRawResource(context, R.raw.my_sample)
GrinUriLoader.fromFile(File("/sdcard/sample.grin"))
```

#####/docs/playback-guide-web.md#####
# Web Playback Integration Guide

This guide covers the core player and the `<grin-player>` custom element.

## Canvas Playback (GrinPlayer)

```ts
import {
  GrinCanvasRenderer,
  GrinLoader,
  GrinPlayer,
  OpcodeRegistry,
  RAFTickScheduler,
  RuleEngine,
} from "./dist/grin.js";

const canvas = document.querySelector("canvas");
const renderer = new GrinCanvasRenderer();
let player = null;

const file = await GrinLoader.fromURL("./samples/pulse_red.grin");
player = new GrinPlayer(
  (tickMicros) => new RAFTickScheduler(tickMicros),
  new RuleEngine(),
  OpcodeRegistry.getInstance(),
  () => renderer.render(player.getCurrentFrame(), canvas)
);

player.load(file);
player.play();
```

Notes:

- `GrinPlayer` expects a `GrinFile` and renders into a `DisplayBuffer`.
- Locked pixels are skipped; rule application is per-group per tick.
- `RAFTickScheduler` uses `requestAnimationFrame` and honors `TickMicros`.

## Web Component (`<grin-player>`)

```html
<grin-player src="./samples/pulse_red.grin" autoplay playbackrate="1.5"></grin-player>
```

Attributes:

- `src`: URL to a `.grin` file
- `autoplay`: start playback after load
- `playbackrate`: scales tick duration (default 1)

API:

- `play()`, `pause()`
- `currentTime` (tick)
- `getCurrentFrame()` (ImageData)

#####/docs/security-audit-checklist.md#####
# GRIN Security Audit Checklist

Use this checklist to review GRIN readers, writers, and playback pipelines.

## File Parsing

- [ ] Magic bytes validated before any other parsing.
- [ ] Header size validated as 128 bytes.
- [ ] RuleCount limited to 0-16.
- [ ] PixelDataOffset64 validated as 128.
- [ ] PixelDataLength == Width * Height * 5.
- [ ] FileLength is 0 or >= 128 + PixelDataLength.
- [ ] Reserved header fields are zeroed on write.
- [ ] Reserved header fields are ignored on read (warn if non-zero).
- [ ] Control byte reserved bits (4-6) are zeroed on write.
- [ ] Control byte reserved bits are warned on read if non-zero.

## Resource Bounds

- [ ] Width/Height are non-negative and within implementation limits.
- [ ] Pixel count and pixel data length checked for overflow.
- [ ] Buffer lengths verified before allocation.

## Opcode and Rule Handling

- [ ] OpcodeSetId is recognized.
- [ ] Unknown opcodes are rejected.
- [ ] Rules block is fixed at 64 bytes.
- [ ] Unused rule entries are zero on write.
- [ ] Rules are applied only to matching group IDs.

## Playback

- [ ] Source pixels are never mutated.
- [ ] Locked pixels bypass rule application.
- [ ] Per-tick processing is O(1) per pixel and stateless.

#####/docs/security-model.md#####
# GRIN Security Model

GRIN is designed to be inspection-safe. Files contain no executable code and
can be validated without unbounded memory or CPU usage.

## Core Principles

- No executable code in files.
- Fixed header size and bounded rule block.
- Deterministic, stateless opcode execution.
- No external resource access during playback.

## Required Validation

All readers should validate the following before allocating or parsing:

- Magic bytes are "GRIN".
- Header size equals 128.
- RuleCount is in 0-16.
- PixelDataOffset64 equals 128.
- PixelDataLength equals Width * Height * 5.
- FileLength is zero or >= 128 + PixelDataLength.

The current implementations also warn on:

- Non-zero reserved header fields.
- Non-zero reserved control byte bits (4-6).
- Unknown opcodes for the active opcode set.

## Resource Bounds

Implementations enforce safe integer bounds when computing:

- pixel count = width * height
- pixel data length = pixel count * 5
- total file length

This avoids integer overflow and ensures allocations are predictable.

## Playback Safety

- Playback operates on a working copy per pixel.
- Source pixels are never mutated.
- Locked pixels are always copied through.
- OpCodes are stateless and O(1) per pixel.

#####/docs/timing.md#####
# GRIN Timing Byte Reference

The timing byte is an 8-bit field used by opcodes that need a wave value.
Both web and Android implementations interpret it the same way.

## Bit Layout

```text
bits 7-6: Phase offset (0-3, quarter-phase increments)
bits 5-4: Waveform type
bits 3-0: Period (0-15 stored, interpreted as 1-16 ticks)
```

## Derived Values

```text
period = (timing & 0x0F) + 1
waveform = (timing >> 4) & 0x03
phaseOffset = ((timing >> 6) & 0x03) / 4

position = ((tick / period) + phaseOffset) % 1
```

Waveform mapping:

| Value | Waveform | Output |
| ---: | --- | --- |
| 0 | square | 0 for first half, 1 for second half |
| 1 | triangle | ramp up then down |
| 2 | sine | 0.5 - 0.5 * cos(2 * pi * position) |
| 3 | sawtooth | ramp up 0 -> 1 |

## Examples

- `0x00`: period 1, square wave, phase 0.
- `0x17`: period 8, triangle wave, phase 0.
- `0x27`: period 8, sine wave, phase 0.
- `0xE3`: period 4, sawtooth wave, phase 3 (offset 0.75).

#####/docs/tutorial-first-file.md#####
# Tutorial: Creating Your First GRIN File

This tutorial walks through creating a simple GRIN file using the CLI tools.

## 1) Prepare an Image

Start with any PNG. A 16x16 or 32x32 image is enough for testing.

## 2) (Optional) Create a Rules File

Create `rules.json` to add a simple pulse:

```json
{
  "tickMicros": 16666,
  "opcodeSetId": 0,
  "rules": [
    { "groupMask": 1, "opcode": "0x03", "timing": "0x27" }
  ]
}
```

This targets group 0 and pulses alpha using a sine wave.

## 3) Encode the GRIN File

```bash
node tools/bin/grin-encode.js input.png output.grin --rules rules.json
```

If you want group control, also provide a group mask image:

```bash
node tools/bin/grin-encode.js input.png output.grin --groups group-mask.png --rules rules.json
```

## 4) Inspect the Result

```bash
node tools/bin/grin-inspect.js output.grin --header --rules --groups
```

## 5) Render a Frame

```bash
node tools/bin/grin-decode.js output.grin output.png --frame 0
```

## 6) Compare with Reference Samples

See `samples/README.md` for reference files such as `samples/pulse_red.grin`
and `samples/minimal.grin`.

#####/docs/tutorial-grin-groups.md#####
# Tutorial: Understanding GRIN Groups

Groups are the only runtime-addressable unit in GRIN. Each pixel belongs to
exactly one group (0-15) and can be targeted by rules via a bitmask.

## Control Byte Recap

The control byte (C) uses bits 0-3 for the group ID and bit 7 for the lock bit.

```text
bit 7: lock
bits 0-3: group ID (0-15)
```

## Rule Group Masks

Each rule has a 16-bit mask. Bit i targets group i.

Examples:

```text
0x0001 -> group 0
0x0003 -> groups 0 and 1
0x8000 -> group 15
0xFFFF -> all groups
```

## Assigning Groups with the Encoder

The CLI encoder reads group IDs from a mask image:

```bash
node tools/bin/grin-encode.js input.png output.grin --groups group-mask.png
```

Group IDs are derived from the mask image red channel:

- 0-15 map directly to group IDs.
- 16-255 map via `round(value / 17)` and clamp to 0-15.

This lets you author mask images using standard 8-bit grayscale tools.

## Example Rules File

```json
{
  "rules": [
    { "groupMask": 1, "opcode": "0x03", "timing": "0x27" },
    { "groupMask": 2, "opcode": "0x04", "timing": "0x17" }
  ]
}
```

This pulses group 0 and shifts red on group 1.

#####/grin_technical_specification.md#####
# GRIN Technical Specification

Status: Final (implementation-aligned)
Version: 0.1

GRIN (Graphic Readdressable Indexed Nodes) is a deterministic image container
format with bounded metadata, a fixed rule budget, and a predictable playback
model. This document reflects the current implementations in `web/`, `android/`,
and `tools/`.

## 1. Scope and Non-Goals

GRIN defines:

- A binary file format for storing a single image plus a fixed rule block.
- A control byte per pixel that encodes group membership and lock state.
- A fixed opcode set for deterministic, stateless modulation during playback.
- A bounded, inspectable runtime model.

GRIN does not define:

- Image generation, prompting, or orchestration.
- Per-pixel runtime addressing beyond group targeting.
- Executable code in files.

## 2. Constants and Types

- Magic: ASCII "GRIN" (0x47 0x52 0x49 0x4E)
- VersionMajor: 0
- VersionMinor: 0
- HeaderSizeBytes: 128 (fixed)
- PixelSizeBytes: 5 (RGBA + control)
- RuleCount: 0-16
- RulesBlockSize: 64 bytes (16 entries x 4 bytes)
- Endianness: Little-endian for all multi-byte integers

## 3. File Layout

```text
Header (128 bytes) + PixelData (Width * Height * 5 bytes)
```

### 3.1 Header Layout (128 bytes)

| Offset | Size | Field | Type | Notes |
| ---: | ---: | --- | --- | --- |
| 0 | 4 | Magic | ASCII | Must be "GRIN" |
| 4 | 1 | VersionMajor | uint8 | 0 |
| 5 | 1 | VersionMinor | uint8 | 0 |
| 6 | 2 | HeaderSize | uint16 | Must be 128 |
| 8 | 4 | Width | uint32 | Pixels |
| 12 | 4 | Height | uint32 | Pixels |
| 16 | 4 | TickMicros | uint32 | Tick duration in microseconds |
| 20 | 1 | RuleCount | uint8 | 0-16 |
| 21 | 1 | OpcodeSetId | uint8 | 0 for base set |
| 22 | 2 | Flags | uint16 | Reserved (0) |
| 24 | 8 | PixelDataLength | uint64 | Must equal Width * Height * 5 |
| 32 | 8 | FileLength | uint64 | Total bytes, 0 allowed |
| 40 | 8 | PixelDataOffset64 | uint64 | Must be 128 |
| 48 | 8 | ReservedA | uint64 | 0 |
| 56 | 8 | ReservedB | uint64 | 0 |
| 64 | 64 | RulesBlock | bytes | 16 rule entries |

### 3.2 Rules Block

RulesBlock is always 64 bytes. Only the first RuleCount entries are active.
Unused entries must be zero.

Each rule entry (4 bytes):

| Byte | Field | Type | Notes |
| ---: | --- | --- | --- |
| 0-1 | GroupMask | uint16 | Bit i targets group i |
| 2 | Opcode | uint8 | Must be valid for OpcodeSetId |
| 3 | Timing | uint8 | See Section 5 |

### 3.3 Pixel Layout (5 bytes)

| Byte | Field | Type | Notes |
| ---: | --- | --- | --- |
| 0 | R | uint8 | Red |
| 1 | G | uint8 | Green |
| 2 | B | uint8 | Blue |
| 3 | A | uint8 | Alpha |
| 4 | C | uint8 | Control byte |

Control byte bits:

- Bits 0-3: Group ID (0-15)
- Bits 4-6: Reserved (must be 0)
- Bit 7: Lock bit (1 = locked)

## 4. Validation Rules

Readers MUST reject if any of the following are true:

- Magic != "GRIN"
- HeaderSize != 128
- RuleCount > 16
- PixelDataOffset64 != 128
- PixelDataLength != Width * Height * 5
- FileLength is non-zero and FileLength < 128 + PixelDataLength

Readers SHOULD warn if:

- Reserved header fields are non-zero
- Control byte reserved bits (4-6) are non-zero
- Unknown OpcodeSetId or opcode

## 5. Timing Byte

Timing is an 8-bit field used to compute a waveform value per tick.

Bit layout:

```text
bits 7-6: Phase offset (0-3, quarter-phase increments)
bits 5-4: Waveform type
bits 3-0: Period (0-15 stored, interpreted as 1-16 ticks)
```

Derived values:

```text
period = (timing & 0x0F) + 1
waveform = (timing >> 4) & 0x03
phaseOffset = ((timing >> 6) & 0x03) / 4
position = ((tick / period) + phaseOffset) % 1
```

Waveforms:

- 0: square (0 for first half, 1 for second half)
- 1: triangle (ramp up then down)
- 2: sine (0.5 - 0.5 * cos(2 * pi * position))
- 3: sawtooth (ramp up 0 -> 1)

## 6. Opcode Set 0 (OpcodeSetId = 0)

The base set is fixed and stateless. Unknown opcodes are invalid.

| ID | Name | Behavior |
| ---: | --- | --- |
| 0x00 | NOP | No change |
| 0x01 | FADE_IN | Alpha *= wave |
| 0x02 | FADE_OUT | Alpha *= (1 - wave) |
| 0x03 | PULSE | Alpha *= wave |
| 0x04 | SHIFT_R | R += delta |
| 0x05 | SHIFT_G | G += delta |
| 0x06 | SHIFT_B | B += delta |
| 0x07 | SHIFT_A | A += delta |
| 0x08 | INVERT | R = 255 - R, G = 255 - G, B = 255 - B |
| 0x09 | ROTATE_HUE | Rotate hue by wave * 360 deg |
| 0x0A | LOCK | Set lock bit |
| 0x0B | UNLOCK | Clear lock bit |
| 0x0C | TOGGLE_LOCK | Toggle lock bit |

SHIFT_* delta:

```text
delta = round((wave * 2 - 1) * 255)
```

All channel writes clamp to 0-255.

## 7. Playback Model

Playback operates on a working copy per pixel and writes to a display buffer.
Source pixels are never mutated.

Rule activation uses the timing waveform level. A rule is active when:

```text
TimingInterpreter.evaluate(timing, tick) > 0.5
```

Per-tick processing:

```text
for each pixel in source:
  control = controlByte
  if control.locked:
    output = source rgba
    continue

  working = copy(source, control)
  for each activeRule:
    if rule.groupMask targets control.groupId:
      apply opcode to working

  output = working rgba
  controlByte = working control (reserved bits cleared)
```

## 8. Security Model

GRIN enforces:

- Fixed header size and fixed rule count
- No executable code in files
- No external resource access during playback
- Bounded memory and CPU cost per tick

Any implementation MUST validate before allocating or processing data.

#####/grin_technical_specification_v_2.md#####
# GRIN — Graphic Readdressable Indexed Nodes

## Canonical Scope

This document defines **GRIN** as a standalone, implementation-ready specification. GRIN is a deterministic image container and playback substrate. It is not a generator, not a renderer, and not a general-purpose execution environment. GRIN defines how image state is stored, addressed, grouped, locked, and modulated over time under strict, inspectable constraints.

This document intentionally excludes all image-generation logic, orchestration, prompting, or creative systems. Any system that emits GRIN-compliant data is external to this specification.

---

## 1. Design Intent

GRIN exists to provide:

- A bounded, inspectable image format
- Deterministic runtime behavior
- Predictable memory, CPU, and metadata costs
- Structural resistance to hidden logic or malicious complexity

GRIN prioritizes **correctness over expressiveness**. If a behavior cannot be expressed within GRIN’s constraints, it is intentionally disallowed.

GRIN is intentionally incomplete.

---

## 2. Core Mental Model

- Images are **state**, not timelines
- Pixels are **nodes**, not colors
- Motion is **modulation**, not replacement
- Groups are **buses**, not selections
- Editing is powerful; playback is dumb
- External systems may observe GRIN state but never execute within it

Nothing inside a GRIN file is allowed to be clever.

---

## 3. Output Contract

All imagery is emitted directly in **GRIN RGBA+C** format.

- No conversion step
- No tagging pass
- No semantic metadata layer

GRIN is the final output format.

---

## 4. Pixel Definition

Each pixel is exactly **5 bytes**:

| Byte | Name | Type | Description |
|---:|---|---|---|
| 0 | R | uint8 | Red channel |
| 1 | G | uint8 | Green channel |
| 2 | B | uint8 | Blue channel |
| 3 | A | uint8 | Alpha channel |
| 4 | C | uint8 | Control byte |

This represents a deliberate 25% size increase over RGBA, paid once.

### 4.1 Control Byte (C)

- Bits 0–3: **Group ID** (0–15)
- Bit 7: **Lock bit**
- Bits 4–6: Reserved (must be zero)

Each pixel:

- Belongs to exactly **one of 16 groups**
- May be **locked or unlocked**

There is no per-pixel metadata beyond this.

---

## 5. Groups

- Exactly **16 groups** exist
- Groups are the **only runtime-addressable unit**

There is:

- No per-pixel addressing at runtime
- No exclusion logic
- No conditionals
- No Venn diagrams

If a group is not called, it is unaffected.

If a subset must be protected, it is locked.

---

## 6. Locking Semantics

Locking is explicit, reversible, and costly.

- Locked pixels ignore all runtime actions
- Unlocking requires an explicit action
- Re-locking requires an explicit action
- Locking and unlocking consume rule budget

Protection is a decision, not a default.

---

## 7. File Container and Fixed Header

GRIN files are **self-describing** within strict limits. Parsing is intentionally small and bounded so that a minimal Java/Kotlin implementation (Android) or a minimal JavaScript implementation (web) can reliably render and optionally play back GRIN.

### 7.1 Byte Order and Invariants

- All multi-byte integers are **little-endian**.
- Header size is **fixed** to enable O(1) seek and predictable worst-case costs.
- Reserved fields **must be written as 0** and **ignored by readers**.
- A compliant file must be parsable without scanning or heuristics.

### 7.2 Fixed Header Size

- **HeaderSizeBytes = 128** (fixed, always present).
- **PixelDataOffset = 128**.

A reader never searches for metadata. It jumps to known offsets.

### 7.3 Header Layout (128 bytes)

All offsets below are from file start.

| Offset | Size | Name | Type | Notes |
|---:|---:|---|---|---|
| 0 | 4 | Magic | ASCII | Must be `GRIN` |
| 4 | 1 | VersionMajor | uint8 | Current: 0 |
| 5 | 1 | VersionMinor | uint8 | Current: 0 |
| 6 | 2 | HeaderSize | uint16 | Must be 128 |
| 8 | 4 | Width | uint32 | Pixels |
| 12 | 4 | Height | uint32 | Pixels |
| 16 | 4 | TickMicros | uint32 | Playback tick duration in microseconds |
| 20 | 1 | RuleCount | uint8 | 0–16 |
| 21 | 1 | OpcodeSetId | uint8 | Identifies the fixed opcode set (reader-known) |
| 22 | 2 | Flags | uint16 | Reserved (0) |
| 24 | 8 | PixelDataLength | uint64 | Must equal `Width * Height * 5` |
| 32 | 8 | FileLength | uint64 | Total bytes in file (optional; 0 allowed) |
| 40 | 8 | PixelDataOffset64 | uint64 | Must be 128 |
| 48 | 8 | ReservedA | uint64 | 0 |
| 56 | 8 | ReservedB | uint64 | 0 |
| 64 | 64 | RulesBlock | bytes | Fixed-size rule block; see §7.4 |

#### 7.3.1 Reader Validation Rules

A reader MUST reject the file if any of these are true:

- Magic != `GRIN`
- HeaderSize != 128
- RuleCount > 16
- PixelDataOffset64 != 128
- PixelDataLength != Width * Height * 5
- FileLength is non-zero and FileLength < 128 + PixelDataLength

A reader SHOULD reject if any reserved field is non-zero.

### 7.4 Rules Block (Fixed 64 bytes)

Rules are stored inside the fixed header to prevent unbounded metadata growth.

- RulesBlock is always 64 bytes.
- Only the first `RuleCount` entries are active.
- Unused entries must be zero.

Each rule entry is 4 bytes (16 rules × 4 bytes = 64 bytes):

| Bytes | Name | Type | Notes |
|---:|---|---|---|
| 0–1 | GroupMask | uint16 | Bit i targets Group i (0–15) |
| 2 | Opcode | uint8 | Must be valid within OpcodeSetId |
| 3 | Timing | uint8 | On/off oscillator timing parameter (reader-defined) |

Rules express **declarative schedules**, not programs.

---

## 8. Opcodes (Fixed Set)

GRIN supports a small, fixed opcode set identified by OpcodeSetId.

This spec defines the **existence** of a fixed opcode set but does not enumerate it here unless and until the opcode list is frozen. Readers must treat any unknown Opcode value as invalid.

Constraints that must hold for any opcode set:

- Must be statically inspectable
- Must have predictable worst-case CPU cost per tick
- Must not require dynamic allocation
- Must not allow hidden logic or unbounded expressiveness

---

## 9. Runtime Behavior Model

Playback is intentionally simple.

On each fixed tick:

1. Determine active rules
2. For each pixel:
   - If locked, skip
   - If pixel’s group is targeted, apply effect
3. Present output

There is:

- No state accumulation
- No drift
- No mutation of stored pixels

---

## 10. Broadcast Model

GRIN uses **broadcast, not invocation**.

- Group state may be broadcast outward
- Nothing may be called inward

GRIN:

- Does not call external code
- Does not request actions
- Does not embed hooks

If nothing is listening, nothing happens.

---

## 11. Editing vs Playback

Editing may:

- Reassign groups
- Change lock states
- Rewrite pixels

Playback may:

- Modulate display only
- Never rewrite stored data

These modes are strictly separated.

---

## 12. Security by Construction

GRIN enforces:

- Fixed header size
- Fixed rule count
- Fixed opcode set
- No executable code
- No dynamic allocation
- No external resource access

Malicious complexity is structurally impossible.

---

## 13. What GRIN Is Not

GRIN is not:

- A video format
- A scripting engine
- A shader language
- A game engine
- A procedural world system

Attempts to turn it into one violate its intent.

---

## 14. Final Principle

If a feature:

- Increases expressiveness without bound
- Requires interpretation instead of inspection
- Cannot be reasoned about statically
- Makes worst-case cost unknowable

It does not belong in GRIN.

Minimalism here is **structural**, not aesthetic.

#####/package-lock.json#####
{
  "name": "grin",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {}
}

#####/plugins/photoshop/manifest.json#####
{
  "manifestVersion": 5,
  "id": "io.grin.photoshop.plugin",
  "name": "GRIN Exporter",
  "version": "0.1.0",
  "main": "src/main.js",
  "host": {
    "app": "PS",
    "minVersion": "22.0.0"
  },
  "entrypoints": [
    {
      "type": "panel",
      "id": "grin-panel",
      "label": "GRIN Export",
      "minimumSize": {
        "width": 300,
        "height": 260
      },
      "maximumSize": {
        "width": 600,
        "height": 800
      },
      "panel": {
        "main": "src/index.html"
      }
    }
  ]
}

#####/plugins/photoshop/package.json#####
{
  "name": "@grin/photoshop-plugin",
  "version": "0.1.0",
  "private": true,
  "description": "GRIN Photoshop UXP panel scaffold.",
  "scripts": {
    "lint": "node -c src/main.js"
  },
  "license": "MIT"
}

#####/plugins/photoshop/README.md#####
# GRIN Photoshop Plugin (UXP)

## Overview

The GRIN Photoshop panel helps artists author GRIN metadata alongside their artwork. It exports
RGBA art, group maps, lock maps, and rules sidecars that can be compiled into a `.grin` file
using the CLI tools described in `docs/creative-suite-foundations.md`.

## Installation

1. Open Adobe Photoshop and enable UXP developer mode.
2. Load the plugin from `plugins/photoshop/` using the UXP Developer Tool.
3. Launch the **GRIN Export** panel from the Plugins menu.

## Authoring Workflow

1. Paint your RGBA artwork in standard layers.
2. Add metadata layers:
   - **Group map layer** named `GRIN_GROUPS` (or `GRIN_GROUP_MAP`).
   - **Lock map layer** named `GRIN_LOCK` (or `GRIN_LOCK_MAP`).
3. Paint the group map using grayscale values **0-15** so each pixel maps to a GRIN group ID.
4. Paint the lock map using **0** for unlocked pixels and **255** for locked pixels.
5. Optionally tag layer names with group IDs and lock hints, e.g. `Hero G3 [L]`.

## Layer Tagging Conventions

The panel scans layer names for metadata tags to help with preview summaries:

- `G0`–`G15` or `[G0]`–`[G15]` set the group ID.
- `LOCK` or `[L]` marks a layer as locked.
- `UNLOCK` or `[U]` clears the lock hint.

## Export Pipeline

1. Click **Export** to choose an output folder.
2. The panel writes:
   - `<name>.png` (RGBA art)
   - `<name>.groups.png` (group map)
   - `<name>.lock.png` (lock map)
   - `<name>.rules.json` (rules sidecar)
3. Run the CLI commands displayed in the status bar:

```bash
node tools/bin/grin-encode.js <name>.png <name>.grin --groups <name>.groups.png --rules <name>.rules.json
node tools/bin/grin-validate.js <name>.grin
```

## Notes

- The export uses the active document title to build file names.
- The group/lock layers must already be authored in grayscale values; the plugin exports them as-is.
- The rules JSON is generated with an empty rule list by default.

#####/plugins/photoshop/src/index.html#####
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GRIN Export Panel</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Panel shell for GRIN group/lock controls. -->
    <section class="panel">
      <header class="panel__header">
        <h1 class="panel__title">GRIN Export</h1>
        <p class="panel__subtitle">Group + lock metadata scaffold</p>
      </header>

      <div class="panel__body">
        <!-- Group selection control placeholder. -->
        <label class="field">
          <span class="field__label">Active Group</span>
          <select id="groupSelect" class="field__control" aria-label="Active group">
            <option value="0">Group 0</option>
            <option value="1">Group 1</option>
            <option value="2">Group 2</option>
            <option value="3">Group 3</option>
            <option value="4">Group 4</option>
            <option value="5">Group 5</option>
            <option value="6">Group 6</option>
            <option value="7">Group 7</option>
            <option value="8">Group 8</option>
            <option value="9">Group 9</option>
            <option value="10">Group 10</option>
            <option value="11">Group 11</option>
            <option value="12">Group 12</option>
            <option value="13">Group 13</option>
            <option value="14">Group 14</option>
            <option value="15">Group 15</option>
          </select>
        </label>

        <!-- Lock toggle placeholder. -->
        <label class="field field--inline">
          <input id="lockToggle" type="checkbox" class="field__checkbox" />
          <span class="field__label">Lock pixels</span>
        </label>

        <!-- Action buttons placeholder. -->
        <div class="actions">
          <button id="previewButton" class="button" type="button">
            Preview
          </button>
          <button id="exportButton" class="button button--primary" type="button">
            Export
          </button>
        </div>
      </div>

      <footer class="panel__footer">
        <p id="status" class="status" aria-live="polite">
          Ready to configure export metadata.
        </p>
      </footer>
    </section>

    <script src="main.js"></script>
  </body>
</html>

#####/plugins/photoshop/src/main.js#####
// GRIN Photoshop plugin logic for layer metadata, export, and validation.

const photoshop = require("photoshop");
const uxp = require("uxp");

const { app, action, core } = photoshop;
const { localFileSystem } = uxp.storage;

const statusElement = document.getElementById("status");
const groupSelect = document.getElementById("groupSelect");
const lockToggle = document.getElementById("lockToggle");
const previewButton = document.getElementById("previewButton");
const exportButton = document.getElementById("exportButton");

const GROUP_TAG_REGEX = /\\bG(1[0-5]|[0-9])\\b/i;
const GROUP_BRACKET_REGEX = /\\[G(1[0-5]|[0-9])\\]/i;
const LOCK_TAG_REGEX = /\\bLOCK\\b|\\[L\\]/i;
const UNLOCK_TAG_REGEX = /\\bUNLOCK\\b|\\[U\\]/i;

/**
 * Update the status footer with a short message.
 * @param {string} message - Status message to display.
 */
function setStatus(message) {
  if (!statusElement) {
    return;
  }
  statusElement.textContent = message;
}

/**
 * Build a friendly summary of the current selection state.
 * @returns {string} summary text
 */
function describeSelection() {
  const groupId = groupSelect ? Number(groupSelect.value) : 0;
  const lockState = lockToggle ? lockToggle.checked : false;
  return `Group ${groupId} • ${lockState ? "Locked" : "Unlocked"}`;
}

/**
 * Normalize a group ID, clamping to 0-15 and defaulting when undefined.
 * @param {number | undefined | null} groupId - Candidate group ID.
 * @param {number} fallback - Fallback group ID when undefined.
 * @returns {number} Normalized group ID.
 */
function normalizeGroupId(groupId, fallback) {
  if (typeof groupId !== "number" || Number.isNaN(groupId)) {
    return fallback;
  }
  if (groupId < 0) {
    return 0;
  }
  if (groupId > 15) {
    return 15;
  }
  return groupId;
}

/**
 * Parse a layer name into group/lock metadata based on tag conventions.
 * @param {string} layerName - Layer name to inspect.
 * @param {number} fallbackGroup - Fallback group ID.
 * @param {boolean} fallbackLock - Fallback lock state.
 * @returns {{groupId: number, locked: boolean, source: string}} Parsed metadata.
 */
function parseLayerNameMetadata(layerName, fallbackGroup, fallbackLock) {
  const bracketMatch = layerName.match(GROUP_BRACKET_REGEX);
  const inlineMatch = layerName.match(GROUP_TAG_REGEX);
  const rawGroup = bracketMatch ? bracketMatch[1] : inlineMatch ? inlineMatch[1] : null;
  const groupId = normalizeGroupId(rawGroup ? Number(rawGroup) : undefined, fallbackGroup);
  const hasLockTag = LOCK_TAG_REGEX.test(layerName);
  const hasUnlockTag = UNLOCK_TAG_REGEX.test(layerName);
  const locked = hasLockTag ? true : hasUnlockTag ? false : fallbackLock;

  return {
    groupId,
    locked,
    source: rawGroup ? "layer-name" : "default",
  };
}

/**
 * Recursively collect all layers in a document for traversal.
 * @param {import('photoshop').Document} document - Photoshop document.
 * @returns {import('photoshop').Layer[]} Flat list of layers.
 */
function collectLayers(document) {
  const allLayers = [];

  /**
   * Walk layers in depth-first order.
   * @param {import('photoshop').Layer[]} layers - Layers to walk.
   */
  function walk(layers) {
    layers.forEach((layer) => {
      allLayers.push(layer);
      if (layer.layers && layer.layers.length > 0) {
        walk(Array.from(layer.layers));
      }
    });
  }

  walk(Array.from(document.layers));
  return allLayers;
}

/**
 * Capture layer metadata for all layers in the active document.
 * @param {import('photoshop').Document} document - Photoshop document.
 * @returns {{layers: Array<{id: number, name: string, groupId: number, locked: boolean, source: string}>}}
 */
function captureLayerMetadata(document) {
  const defaultGroup = groupSelect ? Number(groupSelect.value) : 0;
  const defaultLocked = lockToggle ? lockToggle.checked : false;
  const layers = collectLayers(document);

  return {
    layers: layers.map((layer) => {
      const parsed = parseLayerNameMetadata(layer.name, defaultGroup, defaultLocked);
      const layerLocked = layer.allLocked === true || layer.locked === true;

      return {
        id: layer.id,
        name: layer.name,
        groupId: parsed.groupId,
        locked: layerLocked || parsed.locked,
        source: parsed.source,
      };
    }),
  };
}

/**
 * Build the default export file names for a document.
 * @param {string} documentName - Document title.
 * @returns {{baseName: string, rgbaName: string, groupsName: string, lockName: string, rulesName: string, grinName: string}}
 */
function buildExportNames(documentName) {
  const baseName = documentName.replace(/\\.[^/.]+$/, "");
  return {
    baseName,
    rgbaName: `${baseName}.png`,
    groupsName: `${baseName}.groups.png`,
    lockName: `${baseName}.lock.png`,
    rulesName: `${baseName}.rules.json`,
    grinName: `${baseName}.grin`,
  };
}

/**
 * Prompt the user for an export folder using the UXP file picker.
 * @returns {Promise<import('uxp').storage.Folder>} Export folder handle.
 */
async function pickExportFolder() {
  return localFileSystem.getFolder();
}

/**
 * Save a document as a PNG file using Photoshop's batchPlay API.
 * @param {import('photoshop').Document} document - Document to save.
 * @param {import('uxp').storage.File} file - Destination file handle.
 * @returns {Promise<void>} Completion promise.
 */
async function saveDocumentAsPng(document, file) {
  await action.batchPlay(
    [
      {
        _obj: "save",
        as: {
          _obj: "PNGFormat",
          method: {
            _enum: "PNGMethod",
            _value: "quick",
          },
        },
        in: {
          _path: file.nativePath,
          _kind: "local",
        },
        documentID: document.id,
        copy: true,
        _options: {
          dialogOptions: "dontDisplay",
        },
      },
    ],
    {
      synchronousExecution: true,
      modalBehavior: "execute",
    }
  );
}

/**
 * Temporarily override layer visibility while exporting a PNG.
 * @param {import('photoshop').Document} document - Document to export.
 * @param {import('photoshop').Layer[]} visibleLayers - Layers to keep visible.
 * @param {() => Promise<void>} exporter - Exporter callback.
 * @returns {Promise<void>} Completion promise.
 */
async function withVisibilityOverride(document, visibleLayers, exporter) {
  const allLayers = collectLayers(document);
  const previousVisibility = new Map(allLayers.map((layer) => [layer.id, layer.visible]));
  const visibleIds = new Set(visibleLayers.map((layer) => layer.id));

  allLayers.forEach((layer) => {
    layer.visible = visibleIds.has(layer.id);
  });

  try {
    await exporter();
  } finally {
    allLayers.forEach((layer) => {
      layer.visible = previousVisibility.get(layer.id) ?? true;
    });
  }
}

/**
 * Find a metadata layer by matching allowed names.
 * @param {import('photoshop').Document} document - Document to search.
 * @param {string[]} names - Acceptable layer names.
 * @returns {import('photoshop').Layer | null} Matched layer or null.
 */
function findMetadataLayer(document, names) {
  const normalized = names.map((name) => name.toLowerCase());
  const layers = collectLayers(document);
  return layers.find((layer) => normalized.includes(layer.name.toLowerCase())) ?? null;
}

/**
 * Export metadata layers for group and lock maps.
 * @param {import('photoshop').Document} document - Document to export.
 * @param {import('uxp').storage.File} groupsFile - Output file for groups.
 * @param {import('uxp').storage.File | null} lockFile - Output file for locks.
 * @returns {Promise<void>} Completion promise.
 */
async function exportMetadataMaps(document, groupsFile, lockFile) {
  const groupLayer = findMetadataLayer(document, ["GRIN_GROUPS", "GRIN_GROUP_MAP"]);
  const lockLayer = lockFile ? findMetadataLayer(document, ["GRIN_LOCK", "GRIN_LOCK_MAP"]) : null;

  if (!groupLayer) {
    throw new Error("Missing GRIN_GROUPS layer for group map export.");
  }

  await withVisibilityOverride(document, [groupLayer], async () => {
    await saveDocumentAsPng(document, groupsFile);
  });

  if (lockFile) {
    if (!lockLayer) {
      throw new Error("Missing GRIN_LOCK layer for lock map export.");
    }

    await withVisibilityOverride(document, [lockLayer], async () => {
      await saveDocumentAsPng(document, lockFile);
    });
  }
}

/**
 * Write the rules JSON sidecar for the export pipeline.
 * @param {import('uxp').storage.File} rulesFile - Destination file.
 * @param {Array} rules - Rule definitions.
 * @returns {Promise<void>} Completion promise.
 */
async function writeRulesJson(rulesFile, rules) {
  const payload = {
    tickMicros: 33333,
    opcodeSetId: 0,
    rules,
  };
  await rulesFile.write(JSON.stringify(payload, null, 2));
}

/**
 * Build the CLI command for grin-encode.
 * @param {string} exportRoot - Export folder path.
 * @param {ReturnType<typeof buildExportNames>} names - Export file names.
 * @returns {string} CLI command.
 */
function buildEncodeCommand(exportRoot, names) {
  return `node tools/bin/grin-encode.js \"${exportRoot}/${names.rgbaName}\" \"${exportRoot}/${names.grinName}\" --groups \"${exportRoot}/${names.groupsName}\" --rules \"${exportRoot}/${names.rulesName}\"`;
}

/**
 * Build the CLI command for grin-validate.
 * @param {string} exportRoot - Export folder path.
 * @param {ReturnType<typeof buildExportNames>} names - Export file names.
 * @returns {string} CLI command.
 */
function buildValidateCommand(exportRoot, names) {
  return `node tools/bin/grin-validate.js \"${exportRoot}/${names.grinName}\"`;
}

/**
 * Handle preview action by summarizing layer metadata.
 */
function handlePreview() {
  const document = app.activeDocument;
  if (!document) {
    setStatus("No active document to preview.");
    return;
  }

  const metadata = captureLayerMetadata(document);
  const taggedLayers = metadata.layers.filter((layer) => layer.source === "layer-name");
  setStatus(`Preview: ${taggedLayers.length} tagged layer(s) detected (${describeSelection()}).`);
}

/**
 * Handle export action with metadata capture and export pipeline.
 */
async function handleExport() {
  const document = app.activeDocument;
  if (!document) {
    setStatus("No active document to export.");
    return;
  }

  try {
    setStatus("Selecting export folder...");
    const exportFolder = await pickExportFolder();
    const names = buildExportNames(document.title);
    const rgbaFile = await exportFolder.createFile(names.rgbaName, { overwrite: true });
    const groupsFile = await exportFolder.createFile(names.groupsName, { overwrite: true });
    const lockFile = await exportFolder.createFile(names.lockName, { overwrite: true });
    const rulesFile = await exportFolder.createFile(names.rulesName, { overwrite: true });

    setStatus("Exporting RGBA art...");
    await saveDocumentAsPng(document, rgbaFile);

    setStatus("Exporting group/lock maps...");
    await exportMetadataMaps(document, groupsFile, lockFile);

    setStatus("Writing rules sidecar...");
    await writeRulesJson(rulesFile, []);

    const exportRoot = exportFolder.nativePath.replace(/\\\\/g, "/");
    const encodeCommand = buildEncodeCommand(exportRoot, names);
    const validateCommand = buildValidateCommand(exportRoot, names);

    setStatus(`Export complete. Run: ${encodeCommand} then ${validateCommand}`);
  } catch (error) {
    setStatus(`Export failed: ${error.message}`);
  }
}

/**
 * Handle metadata changes and update the status.
 */
function handleSelectionChange() {
  setStatus(`Selection updated (${describeSelection()}).`);
}

if (groupSelect) {
  groupSelect.addEventListener("change", handleSelectionChange);
}

if (lockToggle) {
  lockToggle.addEventListener("change", handleSelectionChange);
}

if (previewButton) {
  previewButton.addEventListener("click", handlePreview);
}

if (exportButton) {
  exportButton.addEventListener("click", () => {
    core.executeAsModal(handleExport, { commandName: "GRIN Export" });
  });
}

setStatus(`Ready (${describeSelection()}).`);

#####/plugins/photoshop/src/styles.css#####
/* Panel layout styling for the GRIN Photoshop scaffold. */
:root {
  color: #f2f2f2;
  background: #1e1e1e;
  font-family: "Segoe UI", system-ui, sans-serif;
}

body {
  margin: 0;
  padding: 12px;
}

.panel {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.panel__header {
  border-bottom: 1px solid #2d2d2d;
  padding-bottom: 8px;
}

.panel__title {
  font-size: 18px;
  margin: 0;
}

.panel__subtitle {
  font-size: 12px;
  margin: 4px 0 0;
  color: #b5b5b5;
}

.panel__body {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.field--inline {
  flex-direction: row;
  align-items: center;
}

.field__label {
  font-size: 12px;
  color: #c9c9c9;
}

.field__control {
  background: #2b2b2b;
  border: 1px solid #3a3a3a;
  color: #f2f2f2;
  padding: 6px 8px;
  border-radius: 4px;
}

.field__checkbox {
  width: 14px;
  height: 14px;
}

.actions {
  display: flex;
  gap: 8px;
}

.button {
  background: #2b2b2b;
  border: 1px solid #3a3a3a;
  color: #f2f2f2;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
}

.button--primary {
  background: #1a73e8;
  border-color: #1a73e8;
}

#####/plugins/illustrator/manifest.json#####
{
  "manifestVersion": 5,
  "id": "io.grin.illustrator.plugin",
  "name": "GRIN Exporter",
  "version": "0.1.0",
  "main": "src/main.js",
  "host": {
    "app": "ILST",
    "minVersion": "25.0.0"
  },
  "entrypoints": [
    {
      "type": "panel",
      "id": "grin-panel",
      "label": "GRIN Export",
      "minimumSize": {
        "width": 300,
        "height": 260
      },
      "maximumSize": {
        "width": 640,
        "height": 900
      },
      "panel": {
        "main": "src/index.html"
      }
    }
  ]
}

#####/plugins/illustrator/package.json#####
{
  "name": "@grin/illustrator-plugin",
  "version": "0.1.0",
  "private": true,
  "description": "GRIN Illustrator UXP panel scaffold.",
  "scripts": {
    "lint": "node -c src/main.js"
  },
  "license": "MIT"
}

#####/plugins/illustrator/README.md#####
# GRIN Illustrator Plugin (UXP)

## Overview

The GRIN Illustrator panel flattens vector artboards into GRIN-ready raster assets. It exports
RGBA art, group maps, lock maps, and a rules sidecar that can be compiled into a `.grin` file
using the CLI tools described in `docs/creative-suite-foundations.md`.

## Installation

1. Open Adobe Illustrator and enable UXP developer mode.
2. Load the plugin from `plugins/illustrator/` using the UXP Developer Tool.
3. Launch the **GRIN Export** panel from the Plugins menu.

## Vector Flattening Rules

1. Each artboard is flattened into a raster frame.
2. The artboard width maps to the selected **Rasterize Resolution (px)**; height scales to preserve aspect ratio.
3. The artboard origin is treated as the GRIN pixel (0, 0), with pixels laid out left-to-right and top-to-bottom.
4. Stroke, fill, and effects are rasterized using Illustrator's PNG export engine.

## Group + Lock Tagging

The panel reads metadata from page item names or notes:

- `G0`–`G15` or `[G0]`–`[G15]` set the group ID.
- `LOCK` or `[L]` marks a page item as locked.
- `UNLOCK` or `[U]` clears the lock hint.

Use tags on layers or objects to preview how many items are annotated. Tagged metadata can be
used to drive group/lock map creation in your art.

## Export Pipeline

1. Author your vector art on an artboard.
2. Create dedicated metadata layers:
   - **Group map layer** named `GRIN_GROUPS` (or `GRIN_GROUP_MAP`).
   - **Lock map layer** named `GRIN_LOCK` (or `GRIN_LOCK_MAP`).
3. Paint these layers using grayscale values **0-15** for group IDs and **0/255** for lock state.
4. Click **Export Assets** and choose an output folder.
5. The panel writes:
   - `<name>.png` (flattened RGBA art)
   - `<name>.groups.png` (group map)
   - `<name>.lock.png` (lock map)
   - `<name>.rules.json` (rules sidecar)
6. Run the CLI commands displayed in the status bar:

```bash
node tools/bin/grin-encode.js <name>.png <name>.grin --groups <name>.groups.png --rules <name>.rules.json
node tools/bin/grin-validate.js <name>.grin
```

## Notes

- The export uses the active document title to build file names.
- The panel previews tagged metadata but relies on the dedicated metadata layers for map export.
- The rules JSON is generated with an empty rule list by default.

#####/plugins/illustrator/src/index.html#####
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GRIN Export</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- GRIN panel layout for Illustrator export workflows. -->
    <div class="panel">
      <header class="panel__header">
        <h1>GRIN Export</h1>
        <p>Flatten vectors, tag groups, and export GRIN-ready assets.</p>
      </header>

      <section class="panel__section">
        <label for="groupSelect">Default Group</label>
        <select id="groupSelect">
          <!-- Group IDs are 0-15 per GRIN spec. -->
          <option value="0">Group 0</option>
          <option value="1">Group 1</option>
          <option value="2">Group 2</option>
          <option value="3">Group 3</option>
          <option value="4">Group 4</option>
          <option value="5">Group 5</option>
          <option value="6">Group 6</option>
          <option value="7">Group 7</option>
          <option value="8">Group 8</option>
          <option value="9">Group 9</option>
          <option value="10">Group 10</option>
          <option value="11">Group 11</option>
          <option value="12">Group 12</option>
          <option value="13">Group 13</option>
          <option value="14">Group 14</option>
          <option value="15">Group 15</option>
        </select>
      </section>

      <section class="panel__section panel__section--row">
        <label class="checkbox">
          <input type="checkbox" id="lockToggle" />
          <span>Default Locked</span>
        </label>
      </section>

      <section class="panel__section">
        <label for="resolutionInput">Rasterize Resolution (px)</label>
        <input id="resolutionInput" type="number" min="16" max="8192" value="1024" />
      </section>

      <section class="panel__section panel__section--row">
        <button id="previewButton">Preview Metadata</button>
        <button id="exportButton" class="primary">Export Assets</button>
      </section>

      <footer class="panel__footer">
        <span id="status">Ready.</span>
      </footer>
    </div>

    <script src="main.js"></script>
  </body>
</html>

#####/plugins/illustrator/src/main.js#####
// GRIN Illustrator plugin logic for vector flattening, metadata tagging, and export.

const illustrator = require("illustrator");
const uxp = require("uxp");

const { app, core } = illustrator;
const { localFileSystem } = uxp.storage;

const statusElement = document.getElementById("status");
const groupSelect = document.getElementById("groupSelect");
const lockToggle = document.getElementById("lockToggle");
const resolutionInput = document.getElementById("resolutionInput");
const previewButton = document.getElementById("previewButton");
const exportButton = document.getElementById("exportButton");

const GROUP_TAG_REGEX = /\\bG(1[0-5]|[0-9])\\b/i;
const GROUP_BRACKET_REGEX = /\\[G(1[0-5]|[0-9])\\]/i;
const LOCK_TAG_REGEX = /\\bLOCK\\b|\\[L\\]/i;
const UNLOCK_TAG_REGEX = /\\bUNLOCK\\b|\\[U\\]/i;

/**
 * Update the status footer with a short message.
 * @param {string} message - Status message to display.
 */
function setStatus(message) {
  if (!statusElement) {
    return;
  }
  statusElement.textContent = message;
}

/**
 * Build a friendly summary of the current selection state.
 * @returns {string} summary text
 */
function describeSelection() {
  const groupId = groupSelect ? Number(groupSelect.value) : 0;
  const lockState = lockToggle ? lockToggle.checked : false;
  const resolution = resolutionInput ? Number(resolutionInput.value) : 1024;
  return `Group ${groupId} • ${lockState ? "Locked" : "Unlocked"} • ${resolution}px`;
}

/**
 * Normalize a group ID, clamping to 0-15 and defaulting when undefined.
 * @param {number | undefined | null} groupId - Candidate group ID.
 * @param {number} fallback - Fallback group ID when undefined.
 * @returns {number} Normalized group ID.
 */
function normalizeGroupId(groupId, fallback) {
  if (typeof groupId !== "number" || Number.isNaN(groupId)) {
    return fallback;
  }
  if (groupId < 0) {
    return 0;
  }
  if (groupId > 15) {
    return 15;
  }
  return groupId;
}

/**
 * Parse a metadata source string into group/lock hints.
 * @param {string} sourceText - Text to inspect (name or note).
 * @param {number} fallbackGroup - Fallback group ID.
 * @param {boolean} fallbackLock - Fallback lock state.
 * @returns {{groupId: number, locked: boolean, source: string}} Parsed metadata.
 */
function parseMetadataTags(sourceText, fallbackGroup, fallbackLock) {
  const bracketMatch = sourceText.match(GROUP_BRACKET_REGEX);
  const inlineMatch = sourceText.match(GROUP_TAG_REGEX);
  const rawGroup = bracketMatch ? bracketMatch[1] : inlineMatch ? inlineMatch[1] : null;
  const groupId = normalizeGroupId(rawGroup ? Number(rawGroup) : undefined, fallbackGroup);
  const hasLockTag = LOCK_TAG_REGEX.test(sourceText);
  const hasUnlockTag = UNLOCK_TAG_REGEX.test(sourceText);
  const locked = hasLockTag ? true : hasUnlockTag ? false : fallbackLock;

  return {
    groupId,
    locked,
    source: rawGroup ? "tag" : "default",
  };
}

/**
 * Resolve group/lock metadata for a page item using name/note tags.
 * @param {import('illustrator').PageItem} item - Page item to inspect.
 * @param {number} fallbackGroup - Fallback group ID.
 * @param {boolean} fallbackLock - Fallback lock state.
 * @returns {{groupId: number, locked: boolean, source: string}} Metadata payload.
 */
function resolveItemMetadata(item, fallbackGroup, fallbackLock) {
  const nameSource = item.name || "";
  const noteSource = item.note || "";
  const nameMetadata = parseMetadataTags(nameSource, fallbackGroup, fallbackLock);
  const noteMetadata = parseMetadataTags(noteSource, fallbackGroup, fallbackLock);

  if (noteMetadata.source === "tag") {
    return { ...noteMetadata, source: "note" };
  }

  return { ...nameMetadata, source: nameMetadata.source === "tag" ? "name" : "default" };
}

/**
 * Collect all page items in the document for metadata tagging.
 * @param {import('illustrator').Document} document - Illustrator document.
 * @returns {import('illustrator').PageItem[]} Flat list of items.
 */
function collectPageItems(document) {
  return Array.from(document.pageItems || []);
}

/**
 * Capture metadata for page items in the active document.
 * @param {import('illustrator').Document} document - Illustrator document.
 * @returns {{items: Array<{name: string, groupId: number, locked: boolean, source: string}>}}
 */
function captureItemMetadata(document) {
  const defaultGroup = groupSelect ? Number(groupSelect.value) : 0;
  const defaultLocked = lockToggle ? lockToggle.checked : false;
  const items = collectPageItems(document);

  return {
    items: items.map((item) => {
      const metadata = resolveItemMetadata(item, defaultGroup, defaultLocked);
      return {
        name: item.name || "(unnamed)",
        groupId: metadata.groupId,
        locked: item.locked || metadata.locked,
        source: metadata.source,
      };
    }),
  };
}

/**
 * Build a flattening plan that maps vector artboards to raster pixels.
 * @param {import('illustrator').Document} document - Illustrator document.
 * @param {number} resolution - Target raster width in pixels.
 * @returns {{artboardName: string, width: number, height: number, scale: number}[]} Plan steps.
 */
function buildFlatteningPlan(document, resolution) {
  const artboards = Array.from(document.artboards || []);

  return artboards.map((artboard) => {
    const rect = artboard.artboardRect;
    const widthPoints = Math.abs(rect[2] - rect[0]);
    const heightPoints = Math.abs(rect[1] - rect[3]);
    const scale = resolution / widthPoints;
    const heightPixels = Math.round(heightPoints * scale);

    return {
      artboardName: artboard.name || "Artboard",
      width: Math.round(resolution),
      height: heightPixels,
      scale,
    };
  });
}

/**
 * Build the default export file names for a document.
 * @param {string} documentName - Document title.
 * @returns {{baseName: string, rgbaName: string, groupsName: string, lockName: string, rulesName: string, grinName: string}}
 */
function buildExportNames(documentName) {
  const baseName = documentName.replace(/\\.[^/.]+$/, "");
  return {
    baseName,
    rgbaName: `${baseName}.png`,
    groupsName: `${baseName}.groups.png`,
    lockName: `${baseName}.lock.png`,
    rulesName: `${baseName}.rules.json`,
    grinName: `${baseName}.grin`,
  };
}

/**
 * Prompt the user for an export folder using the UXP file picker.
 * @returns {Promise<import('uxp').storage.Folder>} Export folder handle.
 */
async function pickExportFolder() {
  return localFileSystem.getFolder();
}

/**
 * Find a document layer by name.
 * @param {import('illustrator').Document} document - Illustrator document.
 * @param {string} layerName - Target layer name.
 * @returns {import('illustrator').Layer | null} Layer handle.
 */
function findLayerByName(document, layerName) {
  const layers = Array.from(document.layers || []);
  return layers.find((layer) => layer.name === layerName) || null;
}

/**
 * Temporarily override layer visibility while exporting an artboard.
 * @param {import('illustrator').Layer[]} layers - Layers to show.
 * @param {() => Promise<void>} exporter - Exporter callback.
 * @returns {Promise<void>} Completion promise.
 */
async function withLayerVisibilityOverride(layers, exporter) {
  const originalStates = layers.map((layer) => ({ layer, visible: layer.visible }));
  layers.forEach((layer) => {
    layer.visible = true;
  });

  await exporter();

  originalStates.forEach(({ layer, visible }) => {
    layer.visible = visible;
  });
}

/**
 * Export the active artboard as a PNG file at a given resolution.
 * @param {import('illustrator').Document} document - Illustrator document.
 * @param {import('uxp').storage.File} file - Destination file.
 * @param {number} resolution - Target width in pixels.
 * @returns {Promise<void>} Completion promise.
 */
async function exportArtboardAsPng(document, file, resolution) {
  const exportOptions = {
    type: "PNG",
    antiAliasing: true,
    transparency: true,
    resolution,
  };

  await document.exportFile(file, exportOptions);
}

/**
 * Export group and lock maps using dedicated metadata layers.
 * @param {import('illustrator').Document} document - Illustrator document.
 * @param {import('uxp').storage.File} groupsFile - Group map output.
 * @param {import('uxp').storage.File} lockFile - Lock map output.
 * @param {number} resolution - Raster width in pixels.
 * @returns {Promise<void>} Completion promise.
 */
async function exportMetadataMaps(document, groupsFile, lockFile, resolution) {
  const groupLayer = findLayerByName(document, "GRIN_GROUPS") || findLayerByName(document, "GRIN_GROUP_MAP");
  const lockLayer = findLayerByName(document, "GRIN_LOCK") || findLayerByName(document, "GRIN_LOCK_MAP");

  if (!groupLayer) {
    throw new Error("Missing GRIN_GROUPS layer for group map export.");
  }

  await withLayerVisibilityOverride([groupLayer], async () => {
    await exportArtboardAsPng(document, groupsFile, resolution);
  });

  if (lockFile) {
    if (!lockLayer) {
      throw new Error("Missing GRIN_LOCK layer for lock map export.");
    }

    await withLayerVisibilityOverride([lockLayer], async () => {
      await exportArtboardAsPng(document, lockFile, resolution);
    });
  }
}

/**
 * Write the rules JSON sidecar for the export pipeline.
 * @param {import('uxp').storage.File} rulesFile - Destination file.
 * @param {Array} rules - Rule definitions.
 * @returns {Promise<void>} Completion promise.
 */
async function writeRulesJson(rulesFile, rules) {
  const payload = {
    tickMicros: 33333,
    opcodeSetId: 0,
    rules,
  };
  await rulesFile.write(JSON.stringify(payload, null, 2));
}

/**
 * Build the CLI command for grin-encode.
 * @param {string} exportRoot - Export folder path.
 * @param {ReturnType<typeof buildExportNames>} names - Export file names.
 * @returns {string} CLI command.
 */
function buildEncodeCommand(exportRoot, names) {
  return `node tools/bin/grin-encode.js \"${exportRoot}/${names.rgbaName}\" \"${exportRoot}/${names.grinName}\" --groups \"${exportRoot}/${names.groupsName}\" --rules \"${exportRoot}/${names.rulesName}\"`;
}

/**
 * Build the CLI command for grin-validate.
 * @param {string} exportRoot - Export folder path.
 * @param {ReturnType<typeof buildExportNames>} names - Export file names.
 * @returns {string} CLI command.
 */
function buildValidateCommand(exportRoot, names) {
  return `node tools/bin/grin-validate.js \"${exportRoot}/${names.grinName}\"`;
}

/**
 * Handle preview action by summarizing vector metadata and flattening.
 */
function handlePreview() {
  const document = app.activeDocument;
  if (!document) {
    setStatus("No active document to preview.");
    return;
  }

  const resolution = resolutionInput ? Number(resolutionInput.value) : 1024;
  const metadata = captureItemMetadata(document);
  const taggedItems = metadata.items.filter((item) => item.source !== "default");
  const plan = buildFlatteningPlan(document, resolution);
  const artboardSummary = plan.map((entry) => `${entry.artboardName}: ${entry.width}x${entry.height}px`).join(" | ");

  setStatus(`Preview: ${taggedItems.length} tagged item(s). ${artboardSummary}`);
}

/**
 * Handle export action with metadata capture and export pipeline.
 */
async function handleExport() {
  const document = app.activeDocument;
  if (!document) {
    setStatus("No active document to export.");
    return;
  }

  try {
    setStatus("Selecting export folder...");
    const exportFolder = await pickExportFolder();
    const names = buildExportNames(document.title || "grin-export.ai");
    const rgbaFile = await exportFolder.createFile(names.rgbaName, { overwrite: true });
    const groupsFile = await exportFolder.createFile(names.groupsName, { overwrite: true });
    const lockFile = await exportFolder.createFile(names.lockName, { overwrite: true });
    const rulesFile = await exportFolder.createFile(names.rulesName, { overwrite: true });
    const resolution = resolutionInput ? Number(resolutionInput.value) : 1024;

    setStatus("Exporting flattened artboard...");
    await exportArtboardAsPng(document, rgbaFile, resolution);

    setStatus("Exporting group/lock maps...");
    await exportMetadataMaps(document, groupsFile, lockFile, resolution);

    setStatus("Writing rules sidecar...");
    await writeRulesJson(rulesFile, []);

    const exportRoot = exportFolder.nativePath.replace(/\\\\/g, "/");
    const encodeCommand = buildEncodeCommand(exportRoot, names);
    const validateCommand = buildValidateCommand(exportRoot, names);

    setStatus(`Export complete. Run: ${encodeCommand} then ${validateCommand}`);
  } catch (error) {
    setStatus(`Export failed: ${error.message}`);
  }
}

/**
 * Handle metadata changes and update the status.
 */
function handleSelectionChange() {
  setStatus(`Selection updated (${describeSelection()}).`);
}

if (groupSelect) {
  groupSelect.addEventListener("change", handleSelectionChange);
}

if (lockToggle) {
  lockToggle.addEventListener("change", handleSelectionChange);
}

if (resolutionInput) {
  resolutionInput.addEventListener("change", handleSelectionChange);
}

if (previewButton) {
  previewButton.addEventListener("click", handlePreview);
}

if (exportButton) {
  exportButton.addEventListener("click", () => {
    core.executeAsModal(handleExport, { commandName: "GRIN Export" });
  });
}

setStatus(`Ready (${describeSelection()}).`);

#####/plugins/illustrator/src/styles.css#####
/* Panel styling for the Illustrator GRIN exporter. */

:root {
  font-family: "Adobe Clean", system-ui, sans-serif;
  color: #f5f5f5;
  background: #2b2b2b;
}

body {
  margin: 0;
  padding: 0;
}

.panel {
  padding: 16px;
}

.panel__header h1 {
  margin: 0 0 4px;
  font-size: 18px;
}

.panel__header p {
  margin: 0 0 16px;
  font-size: 12px;
  color: #c5c5c5;
}

.panel__section {
  margin-bottom: 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.panel__section--row {
  flex-direction: row;
  align-items: center;
  gap: 10px;
}

label {
  font-size: 12px;
}

select,
input[type="number"] {
  width: 100%;
  padding: 6px 8px;
  border-radius: 4px;
  border: 1px solid #555;
  background: #1e1e1e;
  color: #f5f5f5;
}

button {
  flex: 1;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #3a3a3a;
  color: #f5f5f5;
  cursor: pointer;
}

button.primary {
  border-color: #2680eb;
  background: #2680eb;
}

.checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel__footer {
  margin-top: 16px;
  font-size: 11px;
  color: #b5b5b5;
}

.panel__footer {
  border-top: 1px solid #2d2d2d;
  padding-top: 8px;
}

.status {
  font-size: 12px;
  margin: 0;
  color: #b5b5b5;
}

#####/plugins/gimp/README.md#####
# GRIN GIMP Plugin (Python-Fu)

## Overview

The GRIN GIMP plugin adds a Python-Fu menu entry that helps artists manage GRIN group/lock metadata
and export GRIN-ready assets. It creates dedicated metadata layers, lets you paint group and lock
values into selections, exports RGBA + group/lock PNGs, writes a rules sidecar, and can run the
GRIN CLI validation tools.

## Installation

1. Copy `plugins/gimp/grin_gimp_plugin.py` into your GIMP plug-ins folder:
   - Linux: `~/.config/GIMP/2.10/plug-ins/`
   - macOS: `~/Library/Application Support/GIMP/2.10/plug-ins/`
   - Windows: `%APPDATA%\\GIMP\\2.10\\plug-ins\\`
2. Ensure the script is executable (`chmod +x grin_gimp_plugin.py` on macOS/Linux).
3. Restart GIMP.

The plugin appears under **Filters → GRIN → GRIN Export...**

## Authoring Workflow

1. Paint your RGBA artwork in standard layers.
2. Run **Filters → GRIN → GRIN Export...** to create the metadata layers.
3. Use selections (lasso, brush selection, etc.) to mark regions and re-run the plugin with:
   - **Active Group ID** set to the desired group (0-15).
   - **Lock pixels** toggled when you want the lock map filled.
4. The plugin updates the `GRIN_GROUPS` and `GRIN_LOCK` layers, preserving your original art.

## Export Pipeline

The export step writes the standard GRIN interchange artifacts:

- `<name>.png` (merged RGBA art)
- `<name>.groups.png` (group map)
- `<name>.lock.png` (lock map)
- `<name>.rules.json` (rules sidecar)

After export you can run the CLI manually if desired:

```bash
node tools/bin/grin-encode.js <name>.png <name>.grin --groups <name>.groups.png --rules <name>.rules.json
node tools/bin/grin-validate.js <name>.grin
```

## Notes

- Group map pixels are written with grayscale values 0-15 to preserve exact group IDs.
- Lock map pixels use 0 (unlocked) and 255 (locked).
- The plugin can run `grin-encode` and `grin-validate` directly when configured with the
  correct Node.js executable and CLI script paths.

#####/plugins/gimp/grin_gimp_plugin.py#####
#!/usr/bin/env python3
# GRIN GIMP plugin providing group/lock overlays, export tooling, and validation hooks.

import json
import os
import subprocess
from gimpfu import (  # pylint: disable=unused-wildcard-import
    CLIP_TO_IMAGE,
    FOREGROUND_FILL,
    GRAY_IMAGE,
    MULTIPLY_MODE,
    NORMAL_MODE,
    PF_BOOL,
    PF_DIRNAME,
    PF_INT,
    PF_STRING,
    gimp,
    main,
    pdb,
    register,
)

GROUP_LAYER_NAMES = ["GRIN_GROUPS", "GRIN_GROUP_MAP"]
LOCK_LAYER_NAMES = ["GRIN_LOCK", "GRIN_LOCK_MAP"]


# --- Layer utilities ---


def find_layer_by_name(parent, target_names):
    """Locate a layer by name (case-insensitive), walking through layer groups."""
    # Normalize names once for comparison.
    normalized = [name.lower() for name in target_names]

    # Walk the layer stack recursively, including layer groups.
    for layer in parent.layers:
        if layer.name.lower() in normalized:
            return layer
        # Layer groups in GIMP expose child layers via `layers`.
        if hasattr(layer, "layers"):
            match = find_layer_by_name(layer, target_names)
            if match is not None:
                return match
    return None


def ensure_metadata_layer(image, name, opacity, mode, fill_value):
    """Ensure a grayscale metadata layer exists, creating and filling if needed."""
    layer = find_layer_by_name(image, [name])
    if layer is not None:
        return layer

    # Create a new grayscale layer sized to the image.
    layer = gimp.Layer(
        image,
        name,
        image.width,
        image.height,
        GRAY_IMAGE,
        opacity,
        mode,
    )
    image.add_layer(layer, 0)

    # Fill the layer with the requested grayscale value.
    gimp.context_push()
    try:
        gimp.set_foreground((fill_value, fill_value, fill_value))
        pdb.gimp_image_set_active_layer(image, layer)
        pdb.gimp_edit_fill(layer, FOREGROUND_FILL)
    finally:
        gimp.context_pop()
    return layer


# --- Group/lock editing helpers ---


def ensure_metadata_layers(image):
    """Create group + lock layers with overlay-friendly settings if missing."""
    group_layer = None
    lock_layer = None

    # Create or reuse the group map layer with a slight overlay opacity.
    group_layer = find_layer_by_name(image, GROUP_LAYER_NAMES)
    if group_layer is None:
        group_layer = ensure_metadata_layer(image, "GRIN_GROUPS", 55.0, MULTIPLY_MODE, 0)

    # Create or reuse the lock map layer with slightly stronger visibility.
    lock_layer = find_layer_by_name(image, LOCK_LAYER_NAMES)
    if lock_layer is None:
        lock_layer = ensure_metadata_layer(image, "GRIN_LOCK", 40.0, NORMAL_MODE, 0)

    return group_layer, lock_layer


def apply_group_lock_to_selection(image, group_layer, lock_layer, group_id, locked):
    """Paint the active selection into the group/lock metadata layers."""
    # Ensure a selection exists before painting metadata.
    if pdb.gimp_selection_is_empty(image):
        gimp.message("GRIN: No active selection to paint metadata.")
        return

    # Clamp the group value to the 0-15 range used by GRIN encoders.
    group_value = max(0, min(15, int(group_id)))
    lock_value = 255 if locked else 0

    gimp.context_push()
    try:
        # Fill the group map layer with the group value.
        gimp.set_foreground((group_value, group_value, group_value))
        pdb.gimp_image_set_active_layer(image, group_layer)
        pdb.gimp_edit_fill(group_layer, FOREGROUND_FILL)

        # Fill the lock map layer with the lock value.
        gimp.set_foreground((lock_value, lock_value, lock_value))
        pdb.gimp_image_set_active_layer(image, lock_layer)
        pdb.gimp_edit_fill(lock_layer, FOREGROUND_FILL)
    finally:
        gimp.context_pop()


# --- Pixel map extraction ---


def read_grayscale_values(layer):
    """Read grayscale pixel values from a layer into a flat list."""
    region = layer.get_pixel_rgn(0, 0, layer.width, layer.height, False, False)
    values = []

    # Iterate over rows to avoid allocating one massive buffer.
    for y in range(layer.height):
        row = region[0 : layer.width, y : y + 1]
        row_bytes = bytearray(row)
        # Extract the first channel for grayscale layers.
        for x in range(0, len(row_bytes), region.bpp):
            values.append(row_bytes[x])

    return values


def summarize_group_lock_maps(group_layer, lock_layer):
    """Summarize group and lock usage for preview output."""
    summary = {
        "totalPixels": 0,
        "groupCounts": {str(group_id): 0 for group_id in range(16)},
        "lockedPixels": 0,
        "unlockedPixels": 0,
    }

    if group_layer is None:
        return summary

    group_values = read_grayscale_values(group_layer)
    summary["totalPixels"] = len(group_values)

    # Count group IDs directly from the group map values.
    for value in group_values:
        group_id = value if value <= 15 else int(round(value / 17.0))
        group_id = max(0, min(15, group_id))
        summary["groupCounts"][str(group_id)] += 1

    if lock_layer is not None:
        lock_values = read_grayscale_values(lock_layer)
        # Treat values >= 128 as locked for preview purposes.
        for value in lock_values:
            if value >= 128:
                summary["lockedPixels"] += 1
            else:
                summary["unlockedPixels"] += 1

    return summary


# --- Export pipeline helpers ---


def export_layer_png(image, layer, output_path):
    """Export a specific layer to a PNG file using a temporary image."""
    # Build a temporary image to avoid mutating the working document.
    temp_image = pdb.gimp_image_new(layer.width, layer.height, image.base_type)
    temp_layer = pdb.gimp_layer_new_from_drawable(layer, temp_image)
    pdb.gimp_image_insert_layer(temp_image, temp_layer, None, 0)
    pdb.gimp_image_set_active_layer(temp_image, temp_layer)

    # Save the PNG with typical defaults.
    pdb.file_png_save2(
        temp_image,
        temp_layer,
        output_path,
        output_path,
        0,
        9,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
    )
    pdb.gimp_image_delete(temp_image)


def export_visible_png(image, output_path):
    """Export visible artwork to PNG by merging a temporary image copy."""
    temp_image = pdb.gimp_image_duplicate(image)
    merged_layer = pdb.gimp_image_merge_visible_layers(temp_image, CLIP_TO_IMAGE)
    pdb.file_png_save2(
        temp_image,
        merged_layer,
        output_path,
        output_path,
        0,
        9,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
    )
    pdb.gimp_image_delete(temp_image)


def write_rules_json(output_path):
    """Write a default rules JSON sidecar for GRIN encoding."""
    payload = {"tickMicros": 33333, "opcodeSetId": 0, "rules": []}
    with open(output_path, "w", encoding="utf-8") as handle:
        json.dump(payload, handle, indent=2)


# --- CLI invocation helpers ---


def run_command(command):
    """Run a CLI command and return stdout/stderr combined output."""
    result = subprocess.run(command, capture_output=True, text=True, check=False)
    output = result.stdout.strip() or result.stderr.strip()
    return output or "(no output)"


def build_encode_command(node_path, encode_script, rgba_path, grin_path, groups_path, rules_path):
    """Build the grin-encode CLI command for export guidance."""
    return [
        node_path,
        encode_script,
        rgba_path,
        grin_path,
        "--groups",
        groups_path,
        "--rules",
        rules_path,
    ]


def build_validate_command(node_path, validate_script, grin_path):
    """Build the grin-validate CLI command for validation guidance."""
    return [node_path, validate_script, grin_path]


# --- Main plugin entrypoint ---


def grin_gimp_export(
    image,
    drawable,
    group_id,
    locked,
    apply_to_selection,
    ensure_layers,
    export_assets,
    export_dir,
    base_name,
    run_encode,
    run_validate,
    node_path,
    encode_script,
    validate_script,
):
    """Entry point for the GRIN GIMP export workflow."""
    # Ensure metadata layers exist before editing or exporting.
    group_layer = None
    lock_layer = None
    if ensure_layers:
        group_layer, lock_layer = ensure_metadata_layers(image)
    else:
        group_layer = find_layer_by_name(image, GROUP_LAYER_NAMES)
        lock_layer = find_layer_by_name(image, LOCK_LAYER_NAMES)

    # Apply group/lock values into the metadata layers if requested.
    if apply_to_selection and group_layer and lock_layer:
        apply_group_lock_to_selection(image, group_layer, lock_layer, group_id, locked)

    # Summarize metadata for preview feedback.
    summary = summarize_group_lock_maps(group_layer, lock_layer)
    gimp.message(
        "GRIN Preview:\n"
        f"Total Pixels: {summary['totalPixels']}\n"
        f"Locked Pixels: {summary['lockedPixels']}\n"
        f"Unlocked Pixels: {summary['unlockedPixels']}\n"
        f"Group Counts: {summary['groupCounts']}"
    )

    if not export_assets:
        return

    # Prepare export directory and file names.
    os.makedirs(export_dir, exist_ok=True)
    base = base_name or image.name.replace(os.path.splitext(image.name)[1], "")
    rgba_path = os.path.join(export_dir, f"{base}.png")
    groups_path = os.path.join(export_dir, f"{base}.groups.png")
    lock_path = os.path.join(export_dir, f"{base}.lock.png")
    rules_path = os.path.join(export_dir, f"{base}.rules.json")
    grin_path = os.path.join(export_dir, f"{base}.grin")

    # Export the visible art and metadata layers.
    export_visible_png(image, rgba_path)
    if group_layer is not None:
        export_layer_png(image, group_layer, groups_path)
    if lock_layer is not None:
        export_layer_png(image, lock_layer, lock_path)
    write_rules_json(rules_path)

    # Optionally run the encoding step.
    if run_encode:
        encode_command = build_encode_command(
            node_path, encode_script, rgba_path, grin_path, groups_path, rules_path
        )
        encode_output = run_command(encode_command)
        gimp.message(f"grin-encode output:\n{encode_output}")

    # Optionally run the validation step.
    if run_validate:
        validate_command = build_validate_command(node_path, validate_script, grin_path)
        validate_output = run_command(validate_command)
        gimp.message(f"grin-validate output:\n{validate_output}")


register(
    "python-fu-grin-export",
    "Export GRIN metadata and assets",
    "Prepare GRIN group/lock maps, export PNGs, and run validation.",
    "GRIN Project",
    "GRIN Project",
    "2025",
    "GRIN Export...",
    "*",
    [
        (PF_INT, "group_id", "Active Group ID (0-15)", 0),
        (PF_BOOL, "locked", "Lock pixels", False),
        (PF_BOOL, "apply_to_selection", "Apply to selection", True),
        (PF_BOOL, "ensure_layers", "Ensure metadata layers", True),
        (PF_BOOL, "export_assets", "Export assets", True),
        (PF_DIRNAME, "export_dir", "Export directory", os.path.expanduser("~/grin-exports")),
        (PF_STRING, "base_name", "Base filename (blank uses image name)", ""),
        (PF_BOOL, "run_encode", "Run grin-encode", False),
        (PF_BOOL, "run_validate", "Run grin-validate", False),
        (PF_STRING, "node_path", "Node executable", "node"),
        (PF_STRING, "encode_script", "Path to grin-encode.js", "tools/bin/grin-encode.js"),
        (PF_STRING, "validate_script", "Path to grin-validate.js", "tools/bin/grin-validate.js"),
    ],
    [],
    grin_gimp_export,
    menu="<Image>/Filters/GRIN",
)

main()

#####/samples/README.md#####
# GRIN Sample Files

This directory contains reference `.grin` files for demos, validation checks,
and playback testing. Use `scripts/generate-samples.mjs` to regenerate them.

## Valid Samples

- `minimal.grin` — 1x1, group 0, unlocked, tickMicros 0, no rules.
- `minimal_locked.grin` — 1x1, group 0 locked, tickMicros 0, no rules.
- `pulse_red.grin` — 16x16, red pixels in group 0, PULSE rule (timing 0x27).
- `fade_gradient.grin` — 64x64 grayscale gradient, 4 groups, fade rules per band.
- `color_shift.grin` — 32x32 mid-gray, 3 groups, SHIFT_R/G/B with phase offsets.
- `groups_demo.grin` — 16x16 palette, each column is a distinct group.
- `locking_demo.grin` — 16x16, left half unlocked, right half locked, includes PULSE + LOCK/UNLOCK.
- `timing_demo.grin` — 16x16 quadrants, PULSE with square/triangle/sine/saw timings.
- `max_size.grin` — 512x512 RGB gradient, group 0, no rules.
- `max_rules.grin` — 16x16, 16 rules, all groups targeted, opcode set 0.
- `all_opcodes.grin` — 13x1, group per opcode, one rule per opcode (0x00-0x0C).

## Invalid Samples

- `invalid_magic.grin` — magic bytes changed to "NOPE".
- `invalid_header_size.grin` — HeaderSize set to 127.
- `truncated.grin` — file ends mid-pixel (header + 2 bytes).
- `invalid_opcode.grin` — rule uses opcode 0xFF.

## Minimal File Byte Dumps

`minimal.grin` (133 bytes):

```text
00000000: 47 52 49 4e 00 00 80 00 01 00 00 00 01 00 00 00  GRIN............
00000010: 00 00 00 00 00 00 00 00 05 00 00 00 00 00 00 00  ................
00000020: 85 00 00 00 00 00 00 00 80 00 00 00 00 00 00 00  ................
00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000080: 00 00 00 ff 00                                   .....
```

`minimal_locked.grin` (133 bytes):

```text
00000000: 47 52 49 4e 00 00 80 00 01 00 00 00 01 00 00 00  GRIN............
00000010: 00 00 00 00 00 00 00 00 05 00 00 00 00 00 00 00  ................
00000020: 85 00 00 00 00 00 00 00 80 00 00 00 00 00 00 00  ................
00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00000080: 00 00 00 ff 80                                   .....
```

#####/scripts/generate-samples.mjs#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
import { BaseOpcodeId } from "../tools/lib/opcodes.js";
import { createGrinFile, serializeGrinFile } from "../tools/lib/grin.js";

const root = path.resolve(path.dirname(fileURLToPath(import.meta.url)), "..");
const samplesDir = path.join(root, "samples");

fs.mkdirSync(samplesDir, { recursive: true });

const DEMO_TICK_MICROS = 16666;

function makePixel(r, g, b, a, groupId, locked = false) {
  const group = groupId & 0x0f;
  const lockBit = locked ? 0x80 : 0x00;
  return { r, g, b, a, c: group | lockBit };
}

function makePixelGrid(width, height, pixelFactory) {
  const pixels = [];
  for (let y = 0; y < height; y += 1) {
    for (let x = 0; x < width; x += 1) {
      pixels.push(pixelFactory(x, y));
    }
  }
  return pixels;
}

function writeSample(name, file) {
  const bytes = serializeGrinFile(file);
  fs.writeFileSync(path.join(samplesDir, name), bytes);
  return bytes;
}

function createSample({ name, width, height, pixels, rules, tickMicros }) {
  const file = createGrinFile({
    width,
    height,
    pixels,
    rules,
    tickMicros,
    opcodeSetId: 0,
  });
  return writeSample(name, file);
}

function clampByte(value) {
  return Math.max(0, Math.min(255, value));
}

const palette = [
  [255, 0, 0],
  [0, 255, 0],
  [0, 0, 255],
  [255, 255, 0],
  [255, 0, 255],
  [0, 255, 255],
  [255, 136, 0],
  [136, 255, 0],
  [0, 136, 255],
  [136, 0, 255],
  [255, 0, 136],
  [0, 255, 136],
  [136, 136, 136],
  [255, 255, 255],
  [68, 68, 68],
  [0, 0, 0],
];

const minimalPixels = [makePixel(0, 0, 0, 255, 0)];
const minimalBytes = createSample({
  name: "minimal.grin",
  width: 1,
  height: 1,
  pixels: minimalPixels,
  rules: [],
  tickMicros: 0,
});

const minimalLockedPixels = [makePixel(0, 0, 0, 255, 0, true)];
const minimalLockedBytes = createSample({
  name: "minimal_locked.grin",
  width: 1,
  height: 1,
  pixels: minimalLockedPixels,
  rules: [],
  tickMicros: 0,
});

createSample({
  name: "pulse_red.grin",
  width: 16,
  height: 16,
  pixels: makePixelGrid(16, 16, () => makePixel(255, 0, 0, 255, 0)),
  rules: [{ groupMask: 0x0001, opcode: BaseOpcodeId.PULSE, timing: 0x27 }],
  tickMicros: DEMO_TICK_MICROS,
});

createSample({
  name: "fade_gradient.grin",
  width: 64,
  height: 64,
  pixels: makePixelGrid(64, 64, (x) => {
    const value = clampByte(Math.round((x / 63) * 255));
    const groupId = Math.min(3, Math.floor(x / 16));
    return makePixel(value, value, value, 255, groupId);
  }),
  rules: [
    { groupMask: 0x0001, opcode: BaseOpcodeId.FADE_IN, timing: 0x27 },
    { groupMask: 0x0002, opcode: BaseOpcodeId.FADE_OUT, timing: 0x17 },
    { groupMask: 0x0004, opcode: BaseOpcodeId.FADE_IN, timing: 0x33 },
    { groupMask: 0x0008, opcode: BaseOpcodeId.FADE_OUT, timing: 0x07 },
  ],
  tickMicros: DEMO_TICK_MICROS,
});

createSample({
  name: "color_shift.grin",
  width: 32,
  height: 32,
  pixels: makePixelGrid(32, 32, (x) => {
    const stripeWidth = Math.ceil(32 / 3);
    const groupId = Math.min(2, Math.floor(x / stripeWidth));
    return makePixel(128, 128, 128, 255, groupId);
  }),
  rules: [
    { groupMask: 0x0001, opcode: BaseOpcodeId.SHIFT_R, timing: 0x27 },
    { groupMask: 0x0002, opcode: BaseOpcodeId.SHIFT_G, timing: 0x67 },
    { groupMask: 0x0004, opcode: BaseOpcodeId.SHIFT_B, timing: 0xa7 },
  ],
  tickMicros: DEMO_TICK_MICROS,
});

createSample({
  name: "groups_demo.grin",
  width: 16,
  height: 16,
  pixels: makePixelGrid(16, 16, (x) => {
    const [r, g, b] = palette[x];
    return makePixel(r, g, b, 255, x);
  }),
  rules: [],
  tickMicros: DEMO_TICK_MICROS,
});

createSample({
  name: "locking_demo.grin",
  width: 16,
  height: 16,
  pixels: makePixelGrid(16, 16, (x) => {
    const locked = x >= 8;
    const groupId = locked ? 1 : 0;
    return makePixel(24, 160, 200, 255, groupId, locked);
  }),
  rules: [
    { groupMask: 0x0001, opcode: BaseOpcodeId.PULSE, timing: 0x27 },
    { groupMask: 0x0001, opcode: BaseOpcodeId.LOCK, timing: 0x00 },
    { groupMask: 0x0002, opcode: BaseOpcodeId.UNLOCK, timing: 0x00 },
  ],
  tickMicros: DEMO_TICK_MICROS,
});

createSample({
  name: "timing_demo.grin",
  width: 16,
  height: 16,
  pixels: makePixelGrid(16, 16, (x, y) => {
    const groupId = x < 8 ? (y < 8 ? 0 : 2) : y < 8 ? 1 : 3;
    return makePixel(60, 120, 240, 255, groupId);
  }),
  rules: [
    { groupMask: 0x0001, opcode: BaseOpcodeId.PULSE, timing: 0x01 },
    { groupMask: 0x0002, opcode: BaseOpcodeId.PULSE, timing: 0x13 },
    { groupMask: 0x0004, opcode: BaseOpcodeId.PULSE, timing: 0x27 },
    { groupMask: 0x0008, opcode: BaseOpcodeId.PULSE, timing: 0x37 },
  ],
  tickMicros: DEMO_TICK_MICROS,
});

const maxSize = 512;
createSample({
  name: "max_size.grin",
  width: maxSize,
  height: maxSize,
  pixels: makePixelGrid(maxSize, maxSize, (x, y) => {
    const r = clampByte(Math.round((x / (maxSize - 1)) * 255));
    const g = clampByte(Math.round((y / (maxSize - 1)) * 255));
    return makePixel(r, g, 128, 255, 0);
  }),
  rules: [],
  tickMicros: DEMO_TICK_MICROS,
});

const maxRuleOpcodes = [
  BaseOpcodeId.NOP,
  BaseOpcodeId.FADE_IN,
  BaseOpcodeId.FADE_OUT,
  BaseOpcodeId.PULSE,
  BaseOpcodeId.SHIFT_R,
  BaseOpcodeId.SHIFT_G,
  BaseOpcodeId.SHIFT_B,
  BaseOpcodeId.SHIFT_A,
  BaseOpcodeId.INVERT,
  BaseOpcodeId.ROTATE_HUE,
  BaseOpcodeId.LOCK,
  BaseOpcodeId.UNLOCK,
  BaseOpcodeId.TOGGLE_LOCK,
  BaseOpcodeId.NOP,
  BaseOpcodeId.FADE_IN,
  BaseOpcodeId.FADE_OUT,
];

createSample({
  name: "max_rules.grin",
  width: 16,
  height: 16,
  pixels: makePixelGrid(16, 16, (x, y) => {
    const groupId = x & 0x0f;
    const r = clampByte(32 + groupId * 12);
    const g = clampByte(16 + y * 8);
    const b = clampByte(200 - groupId * 6);
    return makePixel(r, g, b, 255, groupId);
  }),
  rules: maxRuleOpcodes.map((opcode, index) => ({
    groupMask: 0xffff,
    opcode,
    timing: index & 0x0f,
  })),
  tickMicros: DEMO_TICK_MICROS,
});

const opcodeIds = [
  BaseOpcodeId.NOP,
  BaseOpcodeId.FADE_IN,
  BaseOpcodeId.FADE_OUT,
  BaseOpcodeId.PULSE,
  BaseOpcodeId.SHIFT_R,
  BaseOpcodeId.SHIFT_G,
  BaseOpcodeId.SHIFT_B,
  BaseOpcodeId.SHIFT_A,
  BaseOpcodeId.INVERT,
  BaseOpcodeId.ROTATE_HUE,
  BaseOpcodeId.LOCK,
  BaseOpcodeId.UNLOCK,
  BaseOpcodeId.TOGGLE_LOCK,
];

createSample({
  name: "all_opcodes.grin",
  width: opcodeIds.length,
  height: 1,
  pixels: opcodeIds.map((_, index) => {
    const r = clampByte(20 + index * 18);
    const g = clampByte(240 - index * 12);
    return makePixel(r, g, 100, 255, index);
  }),
  rules: opcodeIds.map((opcode, index) => ({
    groupMask: 1 << index,
    opcode,
    timing: 0x27,
  })),
  tickMicros: DEMO_TICK_MICROS,
});

const invalidMagic = Uint8Array.from(minimalBytes);
invalidMagic.set([0x4e, 0x4f, 0x50, 0x45], 0);
fs.writeFileSync(path.join(samplesDir, "invalid_magic.grin"), invalidMagic);

const invalidHeaderSize = Uint8Array.from(minimalBytes);
invalidHeaderSize[6] = 0x7f;
invalidHeaderSize[7] = 0x00;
fs.writeFileSync(path.join(samplesDir, "invalid_header_size.grin"), invalidHeaderSize);

fs.writeFileSync(path.join(samplesDir, "truncated.grin"), minimalBytes.subarray(0, 130));

createSample({
  name: "invalid_opcode.grin",
  width: 1,
  height: 1,
  pixels: minimalPixels,
  rules: [{ groupMask: 0x0001, opcode: 0xff, timing: 0x00 }],
  tickMicros: 0,
});

process.stdout.write(`Generated samples in ${samplesDir}\n`);
process.stdout.write(`minimal.grin bytes: ${minimalBytes.length}\n`);
process.stdout.write(`minimal_locked.grin bytes: ${minimalLockedBytes.length}\n`);

#####/scripts/generate-test-files.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
import { createGrinFile, serializeGrinFile } from "../tools/lib/grin.js";

const root = path.resolve(path.dirname(fileURLToPath(import.meta.url)), "..");
const fixturesPath = path.join(root, "tests", "fixtures", "grin-fixtures.json");
const outputDir = path.join(root, "tests", "fixtures", "generated");

const fixtures = JSON.parse(fs.readFileSync(fixturesPath, "utf8"));

fs.mkdirSync(outputDir, { recursive: true });

for (const [name, fixture] of Object.entries(fixtures)) {
  const pixels = fixture.pixels.map((pixel) => ({
    r: pixel.r,
    g: pixel.g,
    b: pixel.b,
    a: pixel.a,
    c: pixel.c,
  }));
  const file = createGrinFile({
    width: fixture.width,
    height: fixture.height,
    pixels,
    rules: fixture.rules ?? [],
    tickMicros: fixture.tickMicros ?? 0,
    opcodeSetId: fixture.opcodeSetId ?? 0,
  });
  const bytes = serializeGrinFile(file);
  const outputPath = path.join(outputDir, `${name}.grin`);
  fs.writeFileSync(outputPath, bytes);
}

process.stdout.write(`Generated ${Object.keys(fixtures).length} fixture(s) in ${outputDir}\n`);

#####/spec/grin_technical_specification_v_2.md#####
# GRIN — Graphic Readdressable Indexed Nodes

## Canonical Scope

This document defines **GRIN** as a standalone, implementation-ready specification. GRIN is a deterministic image container and playback substrate. It is not a generator, not a renderer, and not a general-purpose execution environment. GRIN defines how image state is stored, addressed, grouped, locked, and modulated over time under strict, inspectable constraints.

This document intentionally excludes all image-generation logic, orchestration, prompting, or creative systems. Any system that emits GRIN-compliant data is external to this specification.

---

## 1. Design Intent

GRIN exists to provide:

- A bounded, inspectable image format
- Deterministic runtime behavior
- Predictable memory, CPU, and metadata costs
- Structural resistance to hidden logic or malicious complexity

GRIN prioritizes **correctness over expressiveness**. If a behavior cannot be expressed within GRIN’s constraints, it is intentionally disallowed.

GRIN is intentionally incomplete.

---

## 2. Core Mental Model

- Images are **state**, not timelines
- Pixels are **nodes**, not colors
- Motion is **modulation**, not replacement
- Groups are **buses**, not selections
- Editing is powerful; playback is dumb
- External systems may observe GRIN state but never execute within it

Nothing inside a GRIN file is allowed to be clever.

---

## 3. Output Contract

All imagery is emitted directly in **GRIN RGBA+C** format.

- No conversion step
- No tagging pass
- No semantic metadata layer

GRIN is the final output format.

---

## 4. Pixel Definition

Each pixel is exactly **5 bytes**:

| Byte | Name | Type | Description |
|---:|---|---|---|
| 0 | R | uint8 | Red channel |
| 1 | G | uint8 | Green channel |
| 2 | B | uint8 | Blue channel |
| 3 | A | uint8 | Alpha channel |
| 4 | C | uint8 | Control byte |

This represents a deliberate 25% size increase over RGBA, paid once.

### 4.1 Control Byte (C)

- Bits 0–3: **Group ID** (0–15)
- Bit 7: **Lock bit**
- Bits 4–6: Reserved (must be zero)

Each pixel:

- Belongs to exactly **one of 16 groups**
- May be **locked or unlocked**

There is no per-pixel metadata beyond this.

---

## 5. Groups

- Exactly **16 groups** exist
- Groups are the **only runtime-addressable unit**

There is:

- No per-pixel addressing at runtime
- No exclusion logic
- No conditionals
- No Venn diagrams

If a group is not called, it is unaffected.

If a subset must be protected, it is locked.

---

## 6. Locking Semantics

Locking is explicit, reversible, and costly.

- Locked pixels ignore all runtime actions
- Unlocking requires an explicit action
- Re-locking requires an explicit action
- Locking and unlocking consume rule budget

Protection is a decision, not a default.

---

## 7. File Container and Fixed Header

GRIN files are **self-describing** within strict limits. Parsing is intentionally small and bounded so that a minimal Java/Kotlin implementation (Android) or a minimal JavaScript implementation (web) can reliably render and optionally play back GRIN.

### 7.1 Byte Order and Invariants

- All multi-byte integers are **little-endian**.
- Header size is **fixed** to enable O(1) seek and predictable worst-case costs.
- Reserved fields **must be written as 0** and **ignored by readers**.
- A compliant file must be parsable without scanning or heuristics.

### 7.2 Fixed Header Size

- **HeaderSizeBytes = 128** (fixed, always present).
- **PixelDataOffset = 128**.

A reader never searches for metadata. It jumps to known offsets.

### 7.3 Header Layout (128 bytes)

All offsets below are from file start.

| Offset | Size | Name | Type | Notes |
|---:|---:|---|---|---|
| 0 | 4 | Magic | ASCII | Must be `GRIN` |
| 4 | 1 | VersionMajor | uint8 | Current: 0 |
| 5 | 1 | VersionMinor | uint8 | Current: 0 |
| 6 | 2 | HeaderSize | uint16 | Must be 128 |
| 8 | 4 | Width | uint32 | Pixels |
| 12 | 4 | Height | uint32 | Pixels |
| 16 | 4 | TickMicros | uint32 | Playback tick duration in microseconds |
| 20 | 1 | RuleCount | uint8 | 0–16 |
| 21 | 1 | OpcodeSetId | uint8 | Identifies the fixed opcode set (reader-known) |
| 22 | 2 | Flags | uint16 | Reserved (0) |
| 24 | 8 | PixelDataLength | uint64 | Must equal `Width * Height * 5` |
| 32 | 8 | FileLength | uint64 | Total bytes in file (optional; 0 allowed) |
| 40 | 8 | PixelDataOffset64 | uint64 | Must be 128 |
| 48 | 8 | ReservedA | uint64 | 0 |
| 56 | 8 | ReservedB | uint64 | 0 |
| 64 | 64 | RulesBlock | bytes | Fixed-size rule block; see §7.4 |

#### 7.3.1 Reader Validation Rules

A reader MUST reject the file if any of these are true:

- Magic != `GRIN`
- HeaderSize != 128
- RuleCount > 16
- PixelDataOffset64 != 128
- PixelDataLength != Width * Height * 5
- FileLength is non-zero and FileLength < 128 + PixelDataLength

A reader SHOULD reject if any reserved field is non-zero.

### 7.4 Rules Block (Fixed 64 bytes)

Rules are stored inside the fixed header to prevent unbounded metadata growth.

- RulesBlock is always 64 bytes.
- Only the first `RuleCount` entries are active.
- Unused entries must be zero.

Each rule entry is 4 bytes (16 rules × 4 bytes = 64 bytes):

| Bytes | Name | Type | Notes |
|---:|---|---|---|
| 0–1 | GroupMask | uint16 | Bit i targets Group i (0–15) |
| 2 | Opcode | uint8 | Must be valid within OpcodeSetId |
| 3 | Timing | uint8 | On/off oscillator timing parameter (reader-defined) |

Rules express **declarative schedules**, not programs.

---

## 8. Opcodes (Fixed Set)

GRIN supports a small, fixed opcode set identified by OpcodeSetId.

This spec defines the **existence** of a fixed opcode set but does not enumerate it here unless and until the opcode list is frozen. Readers must treat any unknown Opcode value as invalid.

Constraints that must hold for any opcode set:

- Must be statically inspectable
- Must have predictable worst-case CPU cost per tick
- Must not require dynamic allocation
- Must not allow hidden logic or unbounded expressiveness

---

## 9. Runtime Behavior Model

Playback is intentionally simple.

On each fixed tick:

1. Determine active rules
2. For each pixel:
   - If locked, skip
   - If pixel’s group is targeted, apply effect
3. Present output

There is:

- No state accumulation
- No drift
- No mutation of stored pixels

---

## 10. Broadcast Model

GRIN uses **broadcast, not invocation**.

- Group state may be broadcast outward
- Nothing may be called inward

GRIN:

- Does not call external code
- Does not request actions
- Does not embed hooks

If nothing is listening, nothing happens.

---

## 11. Editing vs Playback

Editing may:

- Reassign groups
- Change lock states
- Rewrite pixels

Playback may:

- Modulate display only
- Never rewrite stored data

These modes are strictly separated.

---

## 12. Security by Construction

GRIN enforces:

- Fixed header size
- Fixed rule count
- Fixed opcode set
- No executable code
- No dynamic allocation
- No external resource access

Malicious complexity is structurally impossible.

---

## 13. What GRIN Is Not

GRIN is not:

- A video format
- A scripting engine
- A shader language
- A game engine
- A procedural world system

Attempts to turn it into one violate its intent.

---

## 14. Final Principle

If a feature:

- Increases expressiveness without bound
- Requires interpretation instead of inspection
- Cannot be reasoned about statically
- Makes worst-case cost unknowable

It does not belong in GRIN.

Minimalism here is **structural**, not aesthetic.

#####/tchspecdraft.txt#####
# GRIN — Graphic Readdressable Indexed Nodes

## Canonical Scope

This document defines **GRIN** as a standalone, implementation-ready specification. GRIN is a deterministic image container and playback substrate. It is not a generator, not a renderer, and not a general-purpose execution environment. GRIN defines how image state is stored, addressed, grouped, locked, and modulated over time under strict, inspectable constraints.

This document intentionally excludes all image-generation logic, orchestration, prompting, or creative systems. Any system that emits GRIN-compliant data is external to this specification.

---

## 1. Design Intent

GRIN exists to provide:

- A bounded, inspectable image format
- Deterministic runtime behavior
- Predictable memory, CPU, and metadata costs
- Structural resistance to hidden logic or malicious complexity

GRIN prioritizes **correctness over expressiveness**. If a behavior cannot be expressed within GRIN’s constraints, it is intentionally disallowed.

GRIN is intentionally incomplete.

---

## 2. Core Mental Model

- Images are **state**, not timelines
- Pixels are **nodes**, not colors
- Motion is **modulation**, not replacement
- Groups are **buses**, not selections
- Editing is powerful; playback is dumb
- External systems may observe GRIN state but never execute within it

Nothing inside a GRIN file is allowed to be clever.

---

## 3. Output Contract

All imagery is emitted directly in **GRIN RGBA+C** format.

- No conversion step
- No tagging pass
- No semantic metadata layer

GRIN is the final output format.

---

## 4. Pixel Definition

Each pixel is exactly **5 bytes**:

| Byte | Name | Type | Description |
|---:|---|---|---|
| 0 | R | uint8 | Red channel |
| 1 | G | uint8 | Green channel |
| 2 | B | uint8 | Blue channel |
| 3 | A | uint8 | Alpha channel |
| 4 | C | uint8 | Control byte |

This represents a deliberate 25% size increase over RGBA, paid once.

### 4.1 Control Byte (C)

- Bits 0–3: **Group ID** (0–15)
- Bit 7: **Lock bit**
- Bits 4–6: Reserved (must be zero)

Each pixel:

- Belongs to exactly **one of 16 groups**
- May be **locked or unlocked**

There is no per-pixel metadata beyond this.

---

## 5. Groups

- Exactly **16 groups** exist
- Groups are the **only runtime-addressable unit**

There is:

- No per-pixel addressing at runtime
- No exclusion logic
- No conditionals
- No Venn diagrams

If a group is not called, it is unaffected.

If a subset must be protected, it is locked.

---

## 6. Locking Semantics

Locking is explicit, reversible, and costly.

- Locked pixels ignore all runtime actions
- Unlocking requires an explicit action
- Re-locking requires an explicit action
- Locking and unlocking consume rule budget

Protection is a decision, not a default.

---

## 7. File Container and Fixed Header

GRIN files are **self-describing** within strict limits. Parsing is intentionally small and bounded so that a minimal Java/Kotlin implementation (Android) or a minimal JavaScript implementation (web) can reliably render and optionally play back GRIN.

### 7.1 Byte Order and Invariants

- All multi-byte integers are **little-endian**.
- Header size is **fixed** to enable O(1) seek and predictable worst-case costs.
- Reserved fields **must be written as 0** and **ignored by readers**.
- A compliant file must be parsable without scanning or heuristics.

### 7.2 Fixed Header Size

- **HeaderSizeBytes = 128** (fixed, always present).
- **PixelDataOffset = 128**.

A reader never searches for metadata. It jumps to known offsets.

### 7.3 Header Layout (128 bytes)

All offsets below are from file start.

| Offset | Size | Name | Type | Notes |
|---:|---:|---|---|---|
| 0 | 4 | Magic | ASCII | Must be `GRIN` |
| 4 | 1 | VersionMajor | uint8 | Current: 0 |
| 5 | 1 | VersionMinor | uint8 | Current: 0 |
| 6 | 2 | HeaderSize | uint16 | Must be 128 |
| 8 | 4 | Width | uint32 | Pixels |
| 12 | 4 | Height | uint32 | Pixels |
| 16 | 4 | TickMicros | uint32 | Playback tick duration in microseconds |
| 20 | 1 | RuleCount | uint8 | 0–16 |
| 21 | 1 | OpcodeSetId | uint8 | Identifies the fixed opcode set (reader-known) |
| 22 | 2 | Flags | uint16 | Reserved (0) |
| 24 | 8 | PixelDataLength | uint64 | Must equal `Width * Height * 5` |
| 32 | 8 | FileLength | uint64 | Total bytes in file (optional; 0 allowed) |
| 40 | 8 | PixelDataOffset64 | uint64 | Must be 128 |
| 48 | 8 | ReservedA | uint64 | 0 |
| 56 | 8 | ReservedB | uint64 | 0 |
| 64 | 64 | RulesBlock | bytes | Fixed-size rule block; see §7.4 |

#### 7.3.1 Reader Validation Rules

A reader MUST reject the file if any of these are true:

- Magic != `GRIN`
- HeaderSize != 128
- RuleCount > 16
- PixelDataOffset64 != 128
- PixelDataLength != Width * Height * 5
- FileLength is non-zero and FileLength < 128 + PixelDataLength

A reader SHOULD reject if any reserved field is non-zero.

### 7.4 Rules Block (Fixed 64 bytes)

Rules are stored inside the fixed header to prevent unbounded metadata growth.

- RulesBlock is always 64 bytes.
- Only the first `RuleCount` entries are active.
- Unused entries must be zero.

Each rule entry is 4 bytes (16 rules × 4 bytes = 64 bytes):

| Bytes | Name | Type | Notes |
|---:|---|---|---|
| 0–1 | GroupMask | uint16 | Bit i targets Group i (0–15) |
| 2 | Opcode | uint8 | Must be valid within OpcodeSetId |
| 3 | Timing | uint8 | On/off oscillator timing parameter (reader-defined) |

Rules express **declarative schedules**, not programs.

---

## 8. Opcodes (Fixed Set)

GRIN supports a small, fixed opcode set identified by OpcodeSetId.

This spec defines the **existence** of a fixed opcode set but does not enumerate it here unless and until the opcode list is frozen. Readers must treat any unknown Opcode value as invalid.

Constraints that must hold for any opcode set:

- Must be statically inspectable
- Must have predictable worst-case CPU cost per tick
- Must not require dynamic allocation
- Must not allow hidden logic or unbounded expressiveness

---

## 9. Runtime Behavior Model

Playback is intentionally simple.

On each fixed tick:

1. Determine active rules
2. For each pixel:
   - If locked, skip
   - If pixel’s group is targeted, apply effect
3. Present output

There is:

- No state accumulation
- No drift
- No mutation of stored pixels

---

## 10. Broadcast Model

GRIN uses **broadcast, not invocation**.

- Group state may be broadcast outward
- Nothing may be called inward

GRIN:

- Does not call external code
- Does not request actions
- Does not embed hooks

If nothing is listening, nothing happens.

---

## 11. Editing vs Playback

Editing may:

- Reassign groups
- Change lock states
- Rewrite pixels

Playback may:

- Modulate display only
- Never rewrite stored data

These modes are strictly separated.

---

## 12. Security by Construction

GRIN enforces:

- Fixed header size
- Fixed rule count
- Fixed opcode set
- No executable code
- No dynamic allocation
- No external resource access

Malicious complexity is structurally impossible.

---

## 13. What GRIN Is Not

GRIN is not:

- A video format
- A scripting engine
- A shader language
- A game engine
- A procedural world system

Attempts to turn it into one violate its intent.

---

## 14. Final Principle

If a feature:

- Increases expressiveness without bound
- Requires interpretation instead of inspection
- Cannot be reasoned about statically
- Makes worst-case cost unknowable

It does not belong in GRIN.

Minimalism here is **structural**, not aesthetic.

#####/tests/fixtures/README.md#####
# Test Fixtures

This directory contains shared fixtures for GRIN tests.

- `grin-fixtures.json` stores canonical JSON definitions for minimal files.
- Run `node scripts/generate-test-files.js` to materialize binary `.grin` fixtures into `tests/fixtures/generated/`.

#####/tests/fixtures/generated/.gitkeep#####


#####/tests/fixtures/grin-fixtures.json#####
{
  "minimal": {
    "width": 1,
    "height": 1,
    "tickMicros": 0,
    "opcodeSetId": 0,
    "pixels": [
      { "r": 1, "g": 2, "b": 3, "a": 4, "c": 0 }
    ],
    "rules": []
  }
}

#####/immediatetodo.txt#####
# Immediate Documentation + Publishing Tasks

## Document Scan (Completed)
- [x] Scan `docs/` for TODO/TBD/FIXME markers (excluding generated `docs/api` output).
- [x] Confirm no actionable TODO markers were found in authored documentation.

## Required Follow-ups (Actionable)
- [ ] Review `docs/release-preparation.md` for accuracy before the next release cut.
- [ ] Validate Central Publisher Portal credentials and signing keys in a dry-run environment.
- [ ] Verify npm publish access for the `@grin-format/web` scope.

## Maven Central (Android) — User-Friendly Publishing Steps
1. **Prepare credentials**
   - Obtain Central Publisher Portal credentials for the GRIN organization.
   - Export environment variables:
     - `CENTRAL_USERNAME`
     - `CENTRAL_PASSWORD`
     - `SIGNING_KEY` (ASCII-armored PGP private key)
     - `SIGNING_PASSWORD`
2. **Verify Gradle config**
   - Ensure `android/lib/build.gradle.kts` contains the `maven-publish` and `signing` setup.
3. **Publish the release**
   - From `android/`, run:
     ```bash
     ./gradlew :lib:publish
     ```
4. **Publish the deployment**
   - Use the Central Publisher Portal to review the deployment and publish it.
5. **Optional: JitPack**
   - Push a Git tag (e.g., `v0.1.0`) and verify the build at:
     `https://jitpack.io/#grin-format/grin`.

## npm dist (Web) — User-Friendly Publishing Steps
1. **Install dependencies**
   - From `web/`, run:
     ```bash
     npm ci
     ```
2. **Build distribution files**
   - Run:
     ```bash
     npm run build
     ```
   - Confirm `web/dist/` is populated.
3. **Run tests**
   - Execute:
     ```bash
     npm test
     ```
4. **Publish to npm**
   - Publish the scoped package:
     ```bash
     npm publish --access public
     ```

#####/shortlist.Txt#####
- [ ] Add license headers to all source files
- [ ] Refresh layout hierarchy in `web/demo/` (clear header, playback controls, inspector panel)
- [ ] Add accessibility coverage (ARIA labels, focus order, contrast checks)
- [ ] Improve empty, loading, and error states (missing file, validation errors, decode failures)
- [ ] Add keyboard shortcuts for playback, frame stepping, and group filtering
- [ ] Add a validation summary panel (header warnings, rule count, invalid pixels)
- [ ] Align the demo UI with Material 3 components in `android/demo/`
- [ ] Improve playback UX (play/pause, scrubber, speed control, loop toggle)
- [ ] Add file-open flow with recent files and error recovery
- [ ] Add in-app metadata viewer (header fields, rules summary, group counts)
- [ ] Standardize iconography, labels, and terminology across web/android/docs
- [ ] Consolidate error copy and remediation hints for validation failures
- [ ] Add onboarding snippets (first-run guidance, sample file prompts)
- [ ] Decide Windows UI stack (WinUI 3/.NET WPF/Electron) and document rationale
- [ ] Create a Windows desktop viewer app capable of rendering `.grin` files
- [ ] Implement `.grin` and `.grn` file association registration (ProgID, icons)
- [ ] Implement Windows thumbnail and preview support
- [ ] Enable Windows Photos gallery integration
- [ ] Add installer packaging (MSI/EXE via WiX/NSIS) with clean uninstall
- [ ] Add build pipeline for Windows artifacts (CI job + signed binaries)
- [ ] Write Windows install & troubleshooting guide in `docs/windows-desktop.md`
- [ ] Photoshop, Illustrator, and GIMP plugins (see Phase 14 for detailed plan)
- [ ] Export `.grin` files as DMX sequences (pixels as stage lights, groups as DMX worlds)

#####/todo.md#####
# GRIN Build Plan — Ultra-Detailed Agentic Implementation Guide

## Overview

**Project**: GRIN (Graphic Readdressable Indexed Nodes)  
**File Extensions**: `.grin`, `.grn`  
**Target Platforms**: Android (Java/Kotlin), Web Browsers (JavaScript)  
**Architecture**: Deterministic image container with 5-byte pixel structure (RGBA+C), 16 addressable channels, fixed 128-byte header, and bounded rule-based modulation.

---

## Phase 0: Project Scaffolding and Environment Setup

### 0.1 Repository Structure
- [x] Create root directory structure:
  ```
  grin/
  ├── spec/                    # Specification documents
  ├── core/                    # Core library (reference implementation)
  │   ├── src/
  │   ├── tests/
  │   └── build/
  ├── android/                 # Android/Java implementation
  │   ├── lib/
  │   ├── demo/
  │   └── tests/
  ├── web/                     # JavaScript/Browser implementation
  │   ├── lib/
  │   ├── demo/
  │   └── tests/
  ├── tools/                   # CLI utilities
  │   ├── encoder/
  │   ├── decoder/
  │   └── validator/
  ├── samples/                 # Sample .grin files
  └── docs/                    # Generated documentation
  ```

### *** 0.2 Dependency Manifest Creation
- [x] Create `package.json` for web implementation (npm/yarn)
- [x] Create `build.gradle` / `pom.xml` for Android/Java implementation
- [x] Create `Makefile` or `CMakeLists.txt` for native tooling (optional C reference)
- [x] Define minimum SDK versions: Android API 19, ES6+ for browsers

### *** 0.3 CI/CD Pipeline Configuration
- [x] Create `.github/workflows/build.yml` for automated builds
- [x] Create `.github/workflows/test.yml` for automated testing
- [x] Create `.github/workflows/lint.yml` for code quality checks
- [x] Define artifact publishing rules for releases

### 0.4 Development Environment Documentation
- [x] Create `CONTRIBUTING.md` with development setup instructions
- [x] Create `ARCHITECTURE.md` with system overview diagrams
- [x] Create `SECURITY.md` with security considerations

---

## Phase 1: Binary Format Specification Implementation

### 1.1 Magic Number and Versioning Constants
- [x] Define `MAGIC_BYTES` = `[0x47, 0x52, 0x49, 0x4E]` ("GRIN" in ASCII)
  - Summary: Added `MAGIC_BYTES` constants in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Define `VERSION_MAJOR` = `0x00`
  - Summary: Added `VERSION_MAJOR` constants in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Define `VERSION_MINOR` = `0x00`
  - Summary: Added `VERSION_MINOR` constants in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Define `HEADER_SIZE_BYTES` = `128`
  - Summary: Added `HEADER_SIZE_BYTES` constants in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Define `PIXEL_SIZE_BYTES` = `5`
  - Summary: Added `PIXEL_SIZE_BYTES` constants in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Define `MAX_RULE_COUNT` = `16`
  - Summary: Added `MAX_RULE_COUNT` constants in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Define `RULES_BLOCK_SIZE` = `64`
  - Summary: Added `RULES_BLOCK_SIZE` constants in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.

### 1.2 Header Structure Definition (128 bytes total)
- [x] Implement header byte layout structure:
  ```
  Offset 0-3:   Magic (4 bytes, ASCII "GRIN")
  Offset 4:     VersionMajor (1 byte, uint8)
  Offset 5:     VersionMinor (1 byte, uint8)
  Offset 6-7:   HeaderSize (2 bytes, uint16 LE, must be 128)
  Offset 8-11:  Width (4 bytes, uint32 LE)
  Offset 12-15: Height (4 bytes, uint32 LE)
  Offset 16-19: TickMicros (4 bytes, uint32 LE)
  Offset 20:    RuleCount (1 byte, uint8, 0-16)
  Offset 21:    OpcodeSetId (1 byte, uint8)
  Offset 22-23: Flags (2 bytes, uint16 LE, reserved=0)
  Offset 24-31: PixelDataLength (8 bytes, uint64 LE)
  Offset 32-39: FileLength (8 bytes, uint64 LE, 0 allowed)
  Offset 40-47: PixelDataOffset64 (8 bytes, uint64 LE, must be 128)
  Offset 48-55: ReservedA (8 bytes, must be 0)
  Offset 56-63: ReservedB (8 bytes, must be 0)
  Offset 64-127: RulesBlock (64 bytes)
  ```
  - Summary: Added header field offsets/sizes in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.

### 1.3 Rules Block Structure (64 bytes, 16 × 4-byte entries)
- [x] Define rule entry structure (4 bytes each):
  ```
  Bytes 0-1: GroupMask (uint16 LE, bit i → Group i)
  Byte 2:    Opcode (uint8)
  Byte 3:    Timing (uint8, oscillator parameter)
  ```
  - Summary: Added rule entry offsets/sizes in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Implement GroupMask bitmask interpretation (bits 0-15 → groups 0-15)
  - Summary: Added group mask helper functions in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Define timing parameter semantics (reader-defined oscillator control)
  - Summary: Documented timing semantics as a constant in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.

### 1.4 Pixel Structure Definition (5 bytes per pixel)
- [x] Define pixel byte layout:
  ```
  Byte 0: R (uint8, Red channel, 0-255)
  Byte 1: G (uint8, Green channel, 0-255)
  Byte 2: B (uint8, Blue channel, 0-255)
  Byte 3: A (uint8, Alpha channel, 0-255)
  Byte 4: C (uint8, Control byte)
  ```
  - Summary: Added pixel field offsets in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.

### 1.5 Control Byte (C) Bit Field Definition
- [x] Implement control byte bit extraction:
  ```
  Bits 0-3: Group ID (0-15, extracted via C & 0x0F)
  Bits 4-6: Reserved (must be 0, mask 0x70)
  Bit 7:    Lock bit (extracted via (C >> 7) & 0x01)
  ```
  - Summary: Added control-byte masks and extraction helpers in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.
- [x] Create helper functions:
  - `getGroupId(controlByte)` → returns 0-15
  - `isLocked(controlByte)` → returns boolean
  - `setGroupId(controlByte, groupId)` → returns modified byte
  - `setLocked(controlByte, locked)` → returns modified byte
  - Summary: Added control-byte masks and helper functions in `web/lib/format.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFormat.kt`.

---

## Phase 2: Core Data Structures

### 2.1 GrinHeader Class/Struct
- [x] Implement `GrinHeader` with all header fields
  - Summary: Added `GrinHeader` data structures in `web/lib/grin-header.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt`.
- [x] Implement `GrinHeader.serialize()` → byte array (128 bytes)
  - Summary: Implemented 128-byte header serialization with little-endian writes in `web/lib/grin-header.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt`.
- [x] Implement `GrinHeader.deserialize(bytes)` → GrinHeader
  - Summary: Added header deserialization for byte arrays with field parsing in `web/lib/grin-header.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt`.
- [x] Implement `GrinHeader.validate()` → boolean with error messages
  - Summary: Added validation results with errors/warnings in `web/lib/grin-header.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt` plus `android/lib/src/main/kotlin/io/grin/lib/GrinValidation.kt`.

### *** 2.2 GrinPixel Class/Struct
- [x] Implement `GrinPixel` with R, G, B, A, C fields
  - Summary: Added `GrinPixel` data structures in `web/lib/grin-pixel.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt`.
- [x] Implement `GrinPixel.getGroupId()` → int (0-15)
  - Summary: Implemented group ID accessors in `web/lib/grin-pixel.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt`.
- [x] Implement `GrinPixel.isLocked()` → boolean
  - Summary: Implemented lock state checks in `web/lib/grin-pixel.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt`.
- [x] Implement `GrinPixel.setGroupId(int)` → void
  - Summary: Implemented control-byte group mutation in `web/lib/grin-pixel.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt`.
- [x] Implement `GrinPixel.setLocked(boolean)` → void
  - Summary: Implemented control-byte lock mutation in `web/lib/grin-pixel.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt`.
- [x] Implement `GrinPixel.toBytes()` → byte[5]
  - Summary: Added pixel serialization in `web/lib/grin-pixel.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt`.
- [x] Implement `GrinPixel.fromBytes(byte[5])` → GrinPixel
  - Summary: Added pixel deserialization helpers in `web/lib/grin-pixel.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt`.

### *** 2.3 GrinRule Class/Struct
- [x] Implement `GrinRule` with GroupMask, Opcode, Timing fields
  - Summary: Added `GrinRule` data structures in `web/lib/grin-rule.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinRule.kt`.
- [x] Implement `GrinRule.targetsGroup(int groupId)` → boolean
  - Summary: Implemented group targeting checks in `web/lib/grin-rule.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinRule.kt`.
- [x] Implement `GrinRule.serialize()` → byte[4]
  - Summary: Added rule serialization with little-endian group masks in `web/lib/grin-rule.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinRule.kt`.
- [x] Implement `GrinRule.deserialize(byte[4])` → GrinRule
  - Summary: Added rule deserialization helpers in `web/lib/grin-rule.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinRule.kt`.

### 2.4 GrinImage Class/Struct
- [x] Implement `GrinImage` container:
  - `header: GrinHeader`
  - `pixels: GrinPixel[]` (length = width × height)
  - `rules: GrinRule[]` (length = ruleCount, max 16)
  - Summary: Added `GrinImage` containers with header/pixel/rule storage in `web/lib/grin-image.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinImage.kt`.
- [x] Implement pixel indexing: `getPixel(x, y)` → GrinPixel
  - Summary: Implemented indexed pixel accessors in `web/lib/grin-image.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinImage.kt`.
- [x] Implement pixel setting: `setPixel(x, y, pixel)` → void
  - Summary: Implemented indexed pixel mutation in `web/lib/grin-image.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinImage.kt`.
- [x] Implement bounds checking for all accessors
  - Summary: Added coordinate bounds validation in `web/lib/grin-image.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinImage.kt`.
- [x] Implement `getPixelsByGroup(int groupId)` → GrinPixel[]
  - Summary: Added group filtering helpers in `web/lib/grin-image.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinImage.kt`.
- [x] Implement `getLockedPixels()` → GrinPixel[]
  - Summary: Added locked pixel filters in `web/lib/grin-image.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinImage.kt`.
- [x] Implement `getUnlockedPixels()` → GrinPixel[]
  - Summary: Added unlocked pixel filters in `web/lib/grin-image.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinImage.kt`.

### 2.5 GrinFile Class/Struct
- [x] Implement `GrinFile` as complete file representation
  - Summary: Added `GrinFile` containers in `web/lib/grin-file.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFile.kt`.
- [x] Implement `GrinFile.load(path)` → GrinFile
  - Summary: Implemented path-based load for Android and Node.js in `android/lib/src/main/kotlin/io/grin/lib/GrinFile.kt` and `web/lib/grin-file.ts`.
- [x] Implement `GrinFile.load(InputStream)` → GrinFile
  - Summary: Implemented InputStream-based load in `android/lib/src/main/kotlin/io/grin/lib/GrinFile.kt`.
- [x] Implement `GrinFile.load(ArrayBuffer)` → GrinFile (JS)
  - Summary: Implemented ArrayBuffer/Uint8Array load in `web/lib/grin-file.ts`.
- [x] Implement `GrinFile.save(path)` → void
  - Summary: Implemented path-based save for Android and Node.js in `android/lib/src/main/kotlin/io/grin/lib/GrinFile.kt` and `web/lib/grin-file.ts`.
- [x] Implement `GrinFile.toBytes()` → byte[]
  - Summary: Implemented full file serialization in `web/lib/grin-file.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinFile.kt`.

---

## Phase 3: Binary I/O Implementation

### 3.1 Endianness Utilities
- [x] Implement `writeUint16LE(value)` → byte[2]
  - Summary: Added LE write helpers in `web/lib/endianness.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinEndianness.kt`.
- [x] Implement `writeUint32LE(value)` → byte[4]
  - Summary: Added LE write helpers in `web/lib/endianness.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinEndianness.kt`.
- [x] Implement `writeUint64LE(value)` → byte[8]
  - Summary: Added LE write helpers in `web/lib/endianness.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinEndianness.kt`.
- [x] Implement `readUint16LE(bytes, offset)` → int
  - Summary: Added LE read helpers in `web/lib/endianness.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinEndianness.kt`.
- [x] Implement `readUint32LE(bytes, offset)` → long
  - Summary: Added LE read helpers in `web/lib/endianness.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinEndianness.kt`.
- [x] Implement `readUint64LE(bytes, offset)` → long
  - Summary: Added LE read helpers in `web/lib/endianness.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinEndianness.kt`.
- [x] Create unit tests for all endianness functions
  - Summary: Added JUnit coverage in `android/lib/src/test/kotlin/io/grin/lib/GrinEndiannessTest.kt`.

### 3.2 Header Reader Implementation
- [x] Implement `readHeader(InputStream)` → GrinHeader
  - Summary: Added header reads with validation in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and byte-based parsing in `web/lib/grin-io.ts`.
- [x] Implement magic number validation (reject if != "GRIN")
  - Summary: Enforced in `GrinHeader.validate()` via `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt` and `web/lib/grin-header.ts`, used by `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Implement header size validation (reject if != 128)
  - Summary: Enforced in `GrinHeader.validate()` via `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt` and `web/lib/grin-header.ts`, used by `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Implement RuleCount validation (reject if > 16)
  - Summary: Enforced in `GrinHeader.validate()` via `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt` and `web/lib/grin-header.ts`, used by `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Implement PixelDataOffset64 validation (reject if != 128)
  - Summary: Enforced in `GrinHeader.validate()` via `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt` and `web/lib/grin-header.ts`, used by `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Implement PixelDataLength validation (reject if != width × height × 5)
  - Summary: Enforced in `GrinHeader.validate()` via `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt` and `web/lib/grin-header.ts`, used by `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Implement FileLength validation (reject if non-zero and < 128 + PixelDataLength)
  - Summary: Enforced in `GrinHeader.validate()` via `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt` and `web/lib/grin-header.ts`, used by `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Implement reserved field warnings (warn if non-zero)
  - Summary: Validation warnings returned by `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.

### 3.3 Header Writer Implementation
- [x] Implement `writeHeader(GrinHeader, OutputStream)` → void
  - Summary: Added header writers in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and byte-based writer in `web/lib/grin-io.ts`.
- [x] Implement automatic PixelDataLength calculation
  - Summary: Calculated in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Implement automatic FileLength calculation (optional)
  - Summary: Optional file length auto-fill in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Ensure reserved fields are written as 0
  - Summary: Cleared flags/reserved fields in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.

### 3.4 Pixel Data Reader Implementation
- [x] Implement `readPixelData(InputStream, width, height)` → GrinPixel[]
  - Summary: Added InputStream reader in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and byte-based reader in `web/lib/grin-io.ts`.
- [x] Implement streaming pixel read (minimize memory for large images)
  - Summary: Implemented sequential InputStream reads in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt`.
- [x] Implement bounds validation (ensure exact byte count)
  - Summary: Enforced pixel length checks in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Implement control byte reserved bits validation (warn if bits 4-6 non-zero)
  - Summary: Added reserved-bit warnings in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.

### 3.5 Pixel Data Writer Implementation
- [x] Implement `writePixelData(GrinPixel[], OutputStream)` → void
  - Summary: Added streaming writers in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and byte-based writer in `web/lib/grin-io.ts`.
- [x] Implement streaming pixel write for memory efficiency
  - Summary: Implemented per-pixel OutputStream writes in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt`.
- [x] Ensure control byte reserved bits are cleared before write
  - Summary: Sanitized control bytes in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.

### 3.6 Rules Block Reader Implementation
- [x] Implement `readRulesBlock(byte[64], ruleCount)` → GrinRule[]
  - Summary: Added rules block readers in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Validate only first `ruleCount` entries are read
  - Summary: Implemented slicing by ruleCount in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Validate unused entries are zero (warn if not)
  - Summary: Added non-zero unused entry warnings in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Validate opcode against OpcodeSetId (reject unknown opcodes)
  - Summary: Enforced opcode validity for base set in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.

### 3.7 Rules Block Writer Implementation
- [x] Implement `writeRulesBlock(GrinRule[], ruleCount)` → byte[64]
  - Summary: Added rules block writers in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Zero-fill unused rule entries
  - Summary: Zero-filled via default-initialized blocks in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.
- [x] Validate GroupMask values (all 16 bits valid)
  - Summary: Added group mask range checks in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `web/lib/grin-io.ts`.

---

## Phase 4: Validation Engine

### 4.1 Header Validation Suite
- [x] Implement `validateMagic(bytes)` → ValidationResult
  - Summary: Added magic validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateVersion(major, minor)` → ValidationResult
  - Summary: Added version validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateHeaderSize(size)` → ValidationResult
  - Summary: Added header size validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateDimensions(width, height)` → ValidationResult
  - Summary: Added dimension validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateTickMicros(tick)` → ValidationResult
  - Summary: Added tick validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateRuleCount(count)` → ValidationResult
  - Summary: Added rule count validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateOpcodeSetId(id)` → ValidationResult
  - Summary: Added opcode set validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validatePixelDataLength(length, width, height)` → ValidationResult
  - Summary: Added pixel data length validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateFileLength(fileLen, dataLen)` → ValidationResult
  - Summary: Added file length validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validatePixelDataOffset(offset)` → ValidationResult
  - Summary: Added pixel data offset validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateReservedFields(a, b, flags)` → ValidationResult
  - Summary: Added reserved field validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.

### 4.2 Pixel Validation Suite
- [x] Implement `validateControlByte(c)` → ValidationResult
  - Summary: Added control byte validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateGroupId(groupId)` → ValidationResult
  - Summary: Added group ID validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateReservedBits(c)` → ValidationResult
  - Summary: Added reserved bit validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.

### 4.3 Rule Validation Suite
- [x] Implement `validateGroupMask(mask)` → ValidationResult
  - Summary: Added group mask validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateOpcode(opcode, opcodeSetId)` → ValidationResult
  - Summary: Added opcode validation for base set in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement `validateTiming(timing)` → ValidationResult
  - Summary: Added timing validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.

### 4.4 Full File Validation
- [x] Implement `validateGrinFile(GrinFile)` → ValidationReport
  - Summary: Added full file validation in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Create ValidationReport structure with errors, warnings, info
  - Summary: Added ValidationReport types in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidation.kt`.
- [x] Implement strict mode (reject on any warning)
  - Summary: Added strict mode handling in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.
- [x] Implement permissive mode (continue on warnings)
  - Summary: Added permissive mode handling in `web/lib/validation.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinValidationSuite.kt`.

---

## Phase 5: Opcode System

### 5.1 Opcode Set Definition (OpcodeSetId = 0, Base Set)
- [x] Define opcode enumeration:
  ```
  0x00: NOP       - No operation
  0x01: FADE_IN   - Increase alpha over time
  0x02: FADE_OUT  - Decrease alpha over time
  0x03: PULSE     - Oscillate alpha
  0x04: SHIFT_R   - Shift red channel
  0x05: SHIFT_G   - Shift green channel
  0x06: SHIFT_B   - Shift blue channel
  0x07: SHIFT_A   - Shift alpha channel
  0x08: INVERT    - Invert RGB channels
  0x09: ROTATE_HUE - Rotate hue in HSL space
  0x0A: LOCK      - Set lock bit
  0x0B: UNLOCK    - Clear lock bit
  0x0C: TOGGLE_LOCK - Toggle lock bit
  0x0D-0x0F: Reserved for future base set expansion
  ```
  - Summary: Defined base opcode IDs in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/BaseOpcodes.kt`.

### 5.2 Opcode Interface Definition
- [x] Define `Opcode` interface:
  ```
  interface Opcode {
    byte getId();
    String getName();
    void apply(GrinPixel pixel, int tick, byte timing);
    int getMaxCpuCost();  // Predictable worst-case
    boolean requiresState();  // Must be false for GRIN compliance
  }
  ```
  - Summary: Added Opcode interfaces in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcode.kt`.

### 5.3 Opcode Implementation (Base Set)
- [x] Implement `NopOpcode` (0x00)
  - Summary: Added `NopOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `FadeInOpcode` (0x01)
  - Summary: Added `FadeInOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `FadeOutOpcode` (0x02)
  - Summary: Added `FadeOutOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `PulseOpcode` (0x03)
  - Summary: Added `PulseOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `ShiftROpcode` (0x04)
  - Summary: Added `ShiftROpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `ShiftGOpcode` (0x05)
  - Summary: Added `ShiftGOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `ShiftBOpcode` (0x06)
  - Summary: Added `ShiftBOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `ShiftAOpcode` (0x07)
  - Summary: Added `ShiftAOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `InvertOpcode` (0x08)
  - Summary: Added `InvertOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `RotateHueOpcode` (0x09)
  - Summary: Added `RotateHueOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `LockOpcode` (0x0A)
  - Summary: Added `LockOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `UnlockOpcode` (0x0B)
  - Summary: Added `UnlockOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.
- [x] Implement `ToggleLockOpcode` (0x0C)
  - Summary: Added `ToggleLockOpcode` in `web/lib/opcodes.ts` and `android/lib/src/main/kotlin/io/grin/lib/Opcodes.kt`.

### 5.4 Opcode Registry
- [x] Implement `OpcodeRegistry` singleton/factory
  - Summary: Added opcode registries in `web/lib/opcode-registry.ts` and `android/lib/src/main/kotlin/io/grin/lib/OpcodeRegistry.kt`.
- [x] Implement `getOpcode(opcodeSetId, opcodeId)` → Opcode
  - Summary: Implemented opcode lookup in `web/lib/opcode-registry.ts` and `android/lib/src/main/kotlin/io/grin/lib/OpcodeRegistry.kt`.
- [x] Implement `isValidOpcode(opcodeSetId, opcodeId)` → boolean
  - Summary: Implemented opcode validation in `web/lib/opcode-registry.ts` and `android/lib/src/main/kotlin/io/grin/lib/OpcodeRegistry.kt`.
- [x] Implement `listOpcodes(opcodeSetId)` → Opcode[]
  - Summary: Implemented opcode listing in `web/lib/opcode-registry.ts` and `android/lib/src/main/kotlin/io/grin/lib/OpcodeRegistry.kt`.

### *** 5.5 Timing Parameter Interpretation
- [x] Define timing byte semantics:
  ```
  Bits 0-3: Period (0-15, maps to tick multiplier)
  Bits 4-5: Waveform (0=square, 1=triangle, 2=sine, 3=sawtooth)
  Bits 6-7: Phase offset (0-3, quarter-phase increments)
  ```
  - Summary: Implemented timing semantics in `web/lib/timing.ts` and `android/lib/src/main/kotlin/io/grin/lib/TimingInterpreter.kt`.
- [x] Implement `TimingInterpreter.getPeriod(timing)` → int
  - Summary: Added period extraction in `web/lib/timing.ts` and `android/lib/src/main/kotlin/io/grin/lib/TimingInterpreter.kt`.
- [x] Implement `TimingInterpreter.getWaveform(timing)` → WaveformType
  - Summary: Added waveform decoding in `web/lib/timing.ts` and `android/lib/src/main/kotlin/io/grin/lib/TimingInterpreter.kt`.
- [x] Implement `TimingInterpreter.getPhaseOffset(timing)` → int
  - Summary: Added phase offset decoding in `web/lib/timing.ts` and `android/lib/src/main/kotlin/io/grin/lib/TimingInterpreter.kt`.
- [x] Implement `TimingInterpreter.evaluate(timing, tick)` → float (0.0-1.0)
  - Summary: Added waveform evaluation in `web/lib/timing.ts` and `android/lib/src/main/kotlin/io/grin/lib/TimingInterpreter.kt`.

---

## Phase 6: Playback Engine

### 6.1 Playback State Model
- [x] Implement `PlaybackState` class:
  ```
  - currentTick: long
  - isPlaying: boolean
  - tickAccumulatorMicros: long
  - displayBuffer: RGBA[] (output, no control byte)
  ```
  - Summary: Added playback state containers in `web/lib/playback-state.ts` and `android/lib/src/main/kotlin/io/grin/lib/PlaybackState.kt`.
- [x] Ensure no mutation of source GrinImage pixels
  - Summary: Processing uses per-pixel working copies in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.
- [x] Implement tick counter with overflow handling
  - Summary: Added tick overflow handling in `web/lib/tick-scheduler.ts` and `android/lib/src/main/kotlin/io/grin/lib/AndroidTickScheduler.kt`/`android/lib/src/main/kotlin/io/grin/lib/TestTickScheduler.kt`.

### 6.2 Tick Scheduler
- [x] Implement `TickScheduler` interface:
  ```
  interface TickScheduler {
    void start();
    void stop();
    void setTickCallback(TickCallback cb);
    long getCurrentTick();
  }
  ```
  - Summary: Added tick scheduler interfaces in `web/lib/tick-scheduler.ts` and `android/lib/src/main/kotlin/io/grin/lib/TickScheduler.kt`.
- [x] Implement `AndroidTickScheduler` using Handler/Choreographer
  - Summary: Implemented Choreographer-based scheduler in `android/lib/src/main/kotlin/io/grin/lib/AndroidTickScheduler.kt`.
- [x] Implement `BrowserTickScheduler` using requestAnimationFrame
  - Summary: Implemented RAF-based scheduler in `web/lib/tick-scheduler.ts`.
- [x] Implement `TestTickScheduler` for deterministic testing
  - Summary: Added deterministic schedulers in `web/lib/tick-scheduler.ts` and `android/lib/src/main/kotlin/io/grin/lib/TestTickScheduler.kt`.

### 6.3 Rule Evaluation Engine
- [x] Implement `RuleEngine.evaluateRules(GrinImage, tick)` → ActiveRule[]
  - Summary: Added rule engine implementations in `web/lib/rule-engine.ts` and `android/lib/src/main/kotlin/io/grin/lib/RuleEngine.kt`.
- [x] Implement timing-based rule activation:
  ```
  For each rule:
    - Extract timing parameter
    - Evaluate waveform at current tick
    - Determine if rule is active this tick
  ```
  - Summary: Implemented timing-based activation in `web/lib/rule-engine.ts` and `android/lib/src/main/kotlin/io/grin/lib/RuleEngine.kt`.
- [x] Implement rule priority (lower index = higher priority, no conflicts)
  - Summary: Preserved rule order in `web/lib/rule-engine.ts` and `android/lib/src/main/kotlin/io/grin/lib/RuleEngine.kt`.

### 6.4 Pixel Processing Pipeline
- [x] Implement per-tick processing loop:
  ```
  for each pixel in image:
    if pixel.isLocked():
      outputBuffer[i] = pixel.RGBA  // Skip, copy as-is
      continue
    
    for each activeRule:
      if activeRule.targetsGroup(pixel.groupId):
        opcode = getOpcode(activeRule.opcode)
        opcode.apply(pixel, tick, activeRule.timing)
    
    outputBuffer[i] = pixel.RGBA  // After modulation
  ```
  - Summary: Added per-tick processing in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.
- [x] Ensure display buffer is separate from source pixels
  - Summary: Display buffers are separate types in `web/lib/display-buffer.ts` and `android/lib/src/main/kotlin/io/grin/lib/DisplayBuffer.kt`.
- [x] Implement SIMD optimization hints (optional)
  - Summary: Added packed RGBA output path in `web/lib/grin-player.ts` and `tools/lib/render.js`.

### 6.5 Display Buffer Management
- [x] Implement `DisplayBuffer` class:
  ```
  - width: int
  - height: int
  - rgbaData: byte[] (width × height × 4)
  ```
  - Summary: Added display buffer implementations in `web/lib/display-buffer.ts` and `android/lib/src/main/kotlin/io/grin/lib/DisplayBuffer.kt`.
- [x] Implement `DisplayBuffer.clear()` → void
  - Summary: Added clear methods in `web/lib/display-buffer.ts` and `android/lib/src/main/kotlin/io/grin/lib/DisplayBuffer.kt`.
- [x] Implement `DisplayBuffer.setPixel(x, y, r, g, b, a)` → void
  - Summary: Added pixel setters in `web/lib/display-buffer.ts` and `android/lib/src/main/kotlin/io/grin/lib/DisplayBuffer.kt`.
- [x] Implement `DisplayBuffer.toImageData()` → platform-specific image
  - Summary: Implemented `toImageData()` in `web/lib/display-buffer.ts` and `toBitmap()` in `android/lib/src/main/kotlin/io/grin/lib/DisplayBuffer.kt`.

### 6.6 Playback Controller
- [x] Implement `GrinPlayer` class:
  ```
  - image: GrinImage
  - state: PlaybackState
  - scheduler: TickScheduler
  - ruleEngine: RuleEngine
  - displayBuffer: DisplayBuffer
  ```
  - Summary: Added playback controllers in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.
- [x] Implement `GrinPlayer.load(GrinFile)` → void
  - Summary: Implemented load routines in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.
- [x] Implement `GrinPlayer.play()` → void
  - Summary: Implemented play logic in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.
- [x] Implement `GrinPlayer.pause()` → void
  - Summary: Implemented pause logic in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.
- [x] Implement `GrinPlayer.stop()` → void
  - Summary: Implemented stop/reset logic in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.
- [x] Implement `GrinPlayer.seek(tick)` → void
  - Summary: Implemented seek logic in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.
- [x] Implement `GrinPlayer.getCurrentFrame()` → DisplayBuffer
  - Summary: Implemented frame accessors in `web/lib/grin-player.ts` and `android/lib/src/main/kotlin/io/grin/lib/GrinPlayer.kt`.

---

## Phase 7: Android Implementation (Java/Kotlin)

### *** 7.1 Android Module Setup
- [x] Create `grin-android` module with Gradle configuration
  - Summary: Confirmed module setup in `android/settings.gradle.kts` and `android/build.gradle.kts`.
- [x] Set minimum SDK version (API 21)
  - Summary: Set minSdk to 21 in `android/lib/build.gradle.kts` and `android/demo/build.gradle.kts` (docs aligned in `CONTRIBUTING.md`).
- [x] Configure ProGuard/R8 rules for library
  - Summary: Added ProGuard files in `android/lib/proguard-rules.pro` and `android/lib/consumer-rules.pro`.
- [x] Set up Android-specific dependencies
  - Summary: Dependencies live in `android/lib/build.gradle.kts` and `android/demo/build.gradle.kts`.

### 7.2 Java Binary I/O
- [x] Implement `GrinInputStream` extending `FilterInputStream`
  - Summary: Added `GrinInputStream` in `android/lib/src/main/kotlin/io/grin/lib/GrinInputStream.kt`.
- [x] Implement `GrinOutputStream` extending `FilterOutputStream`
  - Summary: Added `GrinOutputStream` in `android/lib/src/main/kotlin/io/grin/lib/GrinOutputStream.kt`.
- [x] Handle Java's signed byte quirks (& 0xFF for unsigned)
  - Summary: Unsigned handling is applied in `android/lib/src/main/kotlin/io/grin/lib/GrinBinaryIO.kt` and `android/lib/src/main/kotlin/io/grin/lib/GrinPixel.kt`.
- [x] Implement `ByteBuffer` usage for efficient header parsing
  - Summary: Header parsing uses ByteBuffer in `android/lib/src/main/kotlin/io/grin/lib/GrinHeader.kt`.

### 7.3 Android Bitmap Integration
- [x] Implement `GrinBitmapRenderer`:
  ```
  - Takes DisplayBuffer
  - Outputs android.graphics.Bitmap (ARGB_8888)
  ```
  - Summary: Added renderer in `android/lib/src/main/kotlin/io/grin/lib/GrinBitmapRenderer.kt`.
- [x] Implement efficient pixel copying (use `copyPixelsFromBuffer`)
  - Summary: Renderer converts RGBA to ARGB and uses `copyPixelsFromBuffer` in `android/lib/src/main/kotlin/io/grin/lib/GrinBitmapRenderer.kt`.
- [x] Handle Bitmap recycling and memory management
  - Summary: Renderer reuses existing bitmaps when dimensions match in `android/lib/src/main/kotlin/io/grin/lib/GrinBitmapRenderer.kt`.

### *** 7.4 Android View Component
- [x] Implement `GrinView` extending `View`:
  ```
  - Handles drawing of GrinBitmap
  - Manages playback lifecycle
  - Supports touch interaction (pause/play)
  ```
  - Summary: Added `GrinView` in `android/lib/src/main/kotlin/io/grin/lib/GrinView.kt`.
- [x] Implement `onDraw(Canvas)` with Bitmap rendering
  - Summary: Rendering implemented in `android/lib/src/main/kotlin/io/grin/lib/GrinView.kt`.
- [x] Implement `onAttachedToWindow()` / `onDetachedFromWindow()` lifecycle
  - Summary: Lifecycle handling implemented in `android/lib/src/main/kotlin/io/grin/lib/GrinView.kt`.
- [x] Implement `onMeasure()` with aspect ratio preservation
  - Summary: Aspect-ratio measurement implemented in `android/lib/src/main/kotlin/io/grin/lib/GrinView.kt`.

### 7.5 Android Choreographer Integration
- [x] Implement `ChoreographerTickScheduler`:
  ```
  - Uses Choreographer.postFrameCallback
  - Calculates tick delta from frame timestamps
  - Handles vsync alignment
  ```
  - Summary: Choreographer-based scheduler provided by `android/lib/src/main/kotlin/io/grin/lib/ChoreographerTickScheduler.kt` and `android/lib/src/main/kotlin/io/grin/lib/AndroidTickScheduler.kt`.
- [x] Implement frame rate limiting (honor TickMicros)
  - Summary: TickMicros-based throttling implemented in `android/lib/src/main/kotlin/io/grin/lib/AndroidTickScheduler.kt`.
- [x] Handle background/foreground transitions
  - Summary: Scheduler start/stop used for lifecycle transitions via `android/lib/src/main/kotlin/io/grin/lib/GrinView.kt`.

### 7.6 Android Content Provider Support
- [x] Implement `GrinContentProvider` for file:// and content:// URIs
  - Summary: Added provider in `android/lib/src/main/kotlin/io/grin/lib/GrinContentProvider.kt` and registered in `android/demo/src/main/AndroidManifest.xml`.
- [x] Handle `ContentResolver.openInputStream()`
  - Summary: Added URI loading via ContentResolver in `android/lib/src/main/kotlin/io/grin/lib/GrinUriLoader.kt`.
- [x] Support loading from assets, raw resources, and external storage
  - Summary: Implemented asset/raw/file loaders in `android/lib/src/main/kotlin/io/grin/lib/GrinUriLoader.kt`.

### *** 7.7 Android Demo Application
- [x] Create demo app with file picker
  - Summary: Added file picker flow in `android/demo/src/main/kotlin/io/grin/demo/MainActivity.kt`.
- [x] Implement gallery view of sample .grin files
  - Summary: Added asset-backed samples list in `android/demo/src/main/kotlin/io/grin/demo/MainActivity.kt` and `android/demo/src/main/assets/samples/minimal.grin`.
- [x] Add playback controls (play, pause, seek)
  - Summary: Added playback controls in `android/demo/src/main/res/layout/activity_main.xml` and wired in `android/demo/src/main/kotlin/io/grin/demo/MainActivity.kt`.
- [x] Display file metadata (dimensions, rule count, tick rate)
  - Summary: Metadata display implemented in `android/demo/src/main/kotlin/io/grin/demo/MainActivity.kt`.

### *** 7.8 Android Grid Camera + Gallery App
- [x] Define UX flow and data model for grid camera + gallery app
  - [x] Document screen map (camera preview, capture review, gallery grid, editor)
  - [x] Specify posterization palette handling (12-14 color groups) and channel mapping (0-9/A-F)
  - [x] Specify GRIM/GRIN file metadata updates (header fields, channel settings)
  - [x] Define export options (GRIN header update, PNG snapshot with alpha, 12-15 frame GIF loop)
  - Summary: Documented UX flow, data model, palette strategy, and export requirements in `docs/android-grid-camera-ux.md`.
- [x] Implement posterized camera preview pipeline
  - [x] Add camera preview frame acquisition (CameraX ImageAnalysis, YUV->RGB conversion)
  - [x] Enforce grid-aligned output dimensions (crop/scale to N x M grid cells)
  - [x] Apply 12-14 color posterization shader (RenderScript/RenderEffect) or CPU pipeline (LUT + k-means fallback)
  - [x] Display posterized preview with live grid overlay (cell borders + channel labels)
  - [x] Document performance targets (30/60fps) and fallback quality settings (reduced grid, lower poster bins)
- [ ] Implement capture flow and channel assignment
  - [ ] Capture posterized frame buffer and generate GRIM/GRIN payload (RGBA+C)
  - [ ] Build palette histogram and auto-assign bins to channels 0-9/A-F (stable sort by frequency)
  - [ ] Persist GRIM/GRIN files with updated header settings (TickMicros, RuleCount, channel metadata)
  - [ ] Log capture metadata for gallery indexing (timestamp, dimensions, palette bins)
- [ ] Build gallery grid and editor UI
  - [ ] Render gallery grid of GRIN/GRIM assets with posterized thumbnails (lazy paging, disk cache)
  - [ ] Add channel selector dropdown (0-9/A-F) in editor (default to most frequent bin)
  - [ ] Add sliders for frequency, color intonation, and transparency (live preview updates)
  - [ ] Apply edits to in-memory preview and persist to header settings (rules + channel overrides)
- [ ] Export workflows
  - [ ] Export PNG snapshot with alpha from current GRIN state (ARGB_8888 bitmap)
  - [ ] Export GIF loop (12-15 frames) derived from GRIN playback (fixed tick interval)
  - [ ] Export updated GRIN/GRIM file with new header settings (channel metadata + rules)
- [ ] Validation, tests, and documentation
  - [ ] Validate posterization color bin counts and channel mapping (unit tests for palette mapping)
  - [ ] Add unit tests for channel assignment and header updates
  - [ ] Add integration tests for export formats (PNG/GIF round-trip)
  - [ ] Update docs for camera/gallery workflow and export options

---

## Phase 8: Web/Browser Implementation (JavaScript)

### *** 8.1 JavaScript Module Setup
- [x] Create `grin-web` package with npm configuration
  - Summary: Package metadata and scripts live in `web/package.json`.
- [x] Configure TypeScript (optional, recommended)
  - Summary: TypeScript configuration remains in `web/tsconfig.json`.
- [x] Set up Rollup/Webpack for bundling
  - Summary: Added Rollup config in `web/rollup.config.mjs` and updated scripts in `web/package.json`.
- [x] Configure ESM and UMD output formats
  - Summary: Rollup outputs ESM, CJS, and UMD bundles via `web/rollup.config.mjs`.

### 8.2 JavaScript Binary I/O
- [x] Implement `GrinReader` class:
  ```
  - Takes ArrayBuffer or Uint8Array
  - Uses DataView for endian-correct reads
  ```
  - Summary: Added `GrinReader` in `web/lib/grin-reader.ts`.
- [x] Implement `GrinWriter` class:
  ```
  - Outputs Uint8Array
  - Uses DataView for endian-correct writes
  ```
  - Summary: Added `GrinWriter` in `web/lib/grin-writer.ts`.
- [x] Handle JavaScript number limitations (safe integers)
  - Summary: Safe integer checks remain in `web/lib/grin-file.ts` and `web/lib/grin-io.ts`.

### 8.3 Canvas Rendering Integration
- [x] Implement `GrinCanvasRenderer`:
  ```
  - Takes DisplayBuffer
  - Outputs to HTMLCanvasElement
  - Uses ImageData and putImageData
  ```
  - Summary: Added canvas renderer in `web/lib/grin-canvas.ts`.
- [x] Implement efficient pixel transfer
  - Summary: Renderer reuses ImageData buffers in `web/lib/grin-canvas.ts`.
- [x] Support OffscreenCanvas for worker rendering
  - Summary: Renderer accepts OffscreenCanvas in `web/lib/grin-canvas.ts`.

### *** 8.4 Web Component
- [x] Implement `<grin-player>` custom element:
  ```html
  <grin-player src="image.grin" autoplay loop></grin-player>
  ```
  - Summary: Added custom element in `web/lib/grin-element.ts`.
- [x] Implement attribute observation (src, autoplay, loop, playbackrate)
  - Summary: Observed attributes handled in `web/lib/grin-element.ts`.
- [x] Implement shadow DOM encapsulation
  - Summary: Shadow DOM with canvas container in `web/lib/grin-element.ts`.
- [x] Expose JavaScript API (play, pause, currentTime, etc.)
  - Summary: Exposed play/pause/currentTime APIs in `web/lib/grin-element.ts` and tick accessors in `web/lib/grin-player.ts`.

### 8.5 requestAnimationFrame Scheduler
- [x] Implement `RAFTickScheduler`:
  ```
  - Uses requestAnimationFrame
  - Calculates tick delta from timestamps
  - Handles tab visibility changes
  ```
  - Summary: Added RAFTickScheduler in `web/lib/tick-scheduler.ts`.
- [x] Implement frame rate limiting (honor TickMicros)
  - Summary: TickMicros throttling in `web/lib/tick-scheduler.ts`.
- [x] Handle `document.hidden` for background tabs
  - Summary: Visibility handling in `web/lib/tick-scheduler.ts`.

### 8.6 Fetch/File API Integration
- [x] Implement `GrinLoader.fromURL(url)` → Promise<GrinFile>
  - Summary: Added URL loading in `web/lib/grin-loader.ts`.
- [x] Implement `GrinLoader.fromFile(File)` → Promise<GrinFile>
  - Summary: Added File loading in `web/lib/grin-loader.ts`.
- [x] Implement `GrinLoader.fromBlob(Blob)` → Promise<GrinFile>
  - Summary: Added Blob loading in `web/lib/grin-loader.ts`.
- [x] Handle streaming for large files (ReadableStream)
  - Summary: Stream-to-buffer support in `web/lib/grin-loader.ts`.

### *** 8.7 Web Demo Application
- [x] Create demo HTML page with drag-and-drop
  - Summary: Added demo page in `web/demo/index.html` and `web/demo/styles.css`.
- [x] Implement file upload interface
  - Summary: File picker and drop zone implemented in `web/demo/demo.js`.
- [x] Add playback controls (play, pause, seek slider)
  - Summary: Playback controls wired in `web/demo/demo.js` and UI in `web/demo/index.html`.
- [x] Display file metadata and validation results
  - Summary: Metadata display added in `web/demo/demo.js`.
- [x] Add sample .grin file gallery
  - Summary: Sample gallery implemented in `web/demo/demo.js` with `web/demo/samples/samples.json` and `web/demo/samples/minimal.grin`.

---

## Phase 9: CLI Tools

### *** 9.1 Validator Tool (`grin-validate`)
- [x] Implement command-line interface:
  ```
  grin-validate <file.grin> [--strict] [--json]
  ```
  - Summary: Added `tools/bin/grin-validate.js` with strict/json flags and shared parsing/validation helpers in `tools/lib/grin.js` + `tools/lib/validation.js`.
- [x] Output validation results (errors, warnings)
  - Summary: Emits per-file info/warnings/errors in text mode or structured JSON.
- [x] Return exit code 0 on success, non-zero on failure
  - Summary: Exits 0 only when all inputs validate (strict mode treats warnings as failures).
- [x] Support batch validation of multiple files
  - Summary: Accepts multiple file paths and aggregates output/exit status.

### *** 9.2 Inspector Tool (`grin-inspect`)
- [x] Implement command-line interface:
  ```
  grin-inspect <file.grin> [--header] [--rules] [--groups] [--pixels]
  ```
  - Summary: Added `tools/bin/grin-inspect.js` with header/rules/groups/pixels selectors and JSON output.
- [x] Output human-readable header information
  - Summary: Prints header fields including sizes, offsets, and version metadata.
- [x] Output rule definitions with decoded opcodes
  - Summary: Lists rule masks/opcodes with opcode name mapping from `BaseOpcodeId`.
- [x] Output group pixel counts and statistics
  - Summary: Emits per-group pixel counts plus locked pixel count.
- [x] Support JSON output format
  - Summary: JSON report includes header/rules/groups/pixels sections as requested.

### *** 9.3 Encoder Tool (`grin-encode`)
- [x] Implement command-line interface:
  ```
  grin-encode <input.png> <output.grin> [--groups <mask.png>] [--rules <rules.json>]
  ```
  - Summary: Added `tools/bin/grin-encode.js` using `tools/lib/png.js` and `tools/lib/grin.js`.
- [x] Read PNG/JPEG input and convert to GRIN format
  - Summary: `tools/lib/png.js` reads PNG/JPEG into RGBA for encoder.
- [x] Support group assignment via mask image (indexed colors → group IDs)
  - Summary: Mask image red channel maps to group IDs with 0-15 clamping.
- [x] Support rule definition via JSON configuration
  - Summary: Encoder parses rule JSON (array or `{ rules, tickMicros, opcodeSetId }`) and builds rules block.
- [x] Validate output file after encoding
  - Summary: Runs `validateGrinFile` before writing output bytes.

### *** 9.4 Decoder Tool (`grin-decode`)
- [x] Implement command-line interface:
  ```
  grin-decode <input.grin> <output.png> [--frame <tick>] [--groups]
  ```
  - Summary: Added `tools/bin/grin-decode.js` with frame selection and group map output.
- [x] Export single frame as PNG (at specified tick or tick 0)
  - Summary: `tools/lib/render.js` renders ticks with opcodes and `tools/lib/png.js` writes PNG/JPEG output.
- [x] Export group visualization (color-coded by group ID)
  - Summary: `renderGroupMap()` uses a 16-color palette per group ID.
- [x] Support animated GIF export (optional)
  - Summary: Added GIF export to `tools/bin/grin-decode.js` with `tools/lib/gif.js`.

---

## Phase 10: Testing Framework

### 10.1 Unit Test Infrastructure
- [x] Set up JUnit 5 for Java/Android tests
  - Summary: Added JUnit 5 plugin/deps in `android/build.gradle.kts` and `android/lib/build.gradle.kts`, with a JUnit 5 reference test in `android/lib/src/test/kotlin/io/grin/lib/GrinReferenceTest.kt`.
- [x] Set up Jest/Vitest for JavaScript tests
  - Summary: Switched web tests to Vitest with `web/vitest.config.ts` and updated `web/package.json`.
- [x] Create shared test fixtures directory
  - Summary: Added shared fixtures at `tests/fixtures` with `tests/fixtures/grin-fixtures.json`.
- [x] Implement test file generators
  - Summary: Added generator script `scripts/generate-test-files.js` to emit fixtures into `tests/fixtures/generated`.

### 10.2 Binary Format Tests
- [x] Test header serialization/deserialization round-trip
  - Summary: Added `web/tests/format-roundtrip.test.ts` to cover `GrinHeader` serialize/deserialize.
- [x] Test pixel serialization/deserialization round-trip
  - Summary: Added `GrinPixel` round-trip coverage in `web/tests/format-roundtrip.test.ts`.
- [x] Test rule serialization/deserialization round-trip
  - Summary: Added `GrinRule` round-trip coverage in `web/tests/format-roundtrip.test.ts`.
- [x] Test endianness handling on big-endian systems (simulated)
  - Summary: Added LE/BE simulation coverage in `web/tests/endianness.test.ts`.
- [x] Test boundary values (max width, max height, max rules)
  - Summary: Added boundary checks for max dimensions and rule count in `web/tests/validation-boundaries.test.ts`.

### 10.3 Validation Tests
- [x] Test magic number validation (valid and invalid)
  - Summary: Added magic validation assertions in `web/tests/validation-boundaries.test.ts`.
- [x] Test header size validation (valid and invalid)
  - Summary: Added header size validation assertions in `web/tests/validation-boundaries.test.ts`.
- [x] Test dimension validation (0, 1, max, overflow)
  - Summary: Added dimension boundary tests in `web/tests/validation-boundaries.test.ts`.
- [x] Test rule count validation (0, 16, 17)
  - Summary: Added rule count boundary tests in `web/tests/validation-boundaries.test.ts`.
- [x] Test PixelDataLength validation (correct, underflow, overflow)
  - Summary: Added pixel data length checks in `web/tests/validation-boundaries.test.ts`.
- [x] Test reserved field warnings
  - Summary: Added reserved field warning coverage in `web/tests/validation-boundaries.test.ts`.

### 10.4 Opcode Tests
- [x] Test each opcode implementation individually
  - Summary: Covered base opcode behavior in `android/lib/src/test/kotlin/io/grin/lib/OpcodesTest.kt`.
- [x] Test opcode timing parameter interpretation
  - Summary: Added waveform/period evaluation tests in `web/tests/timing.test.ts`.
- [x] Test opcode worst-case CPU cost bounds
  - Summary: Verified `getMaxCpuCost()` bounds in `web/tests/opcodes.test.ts`.
- [x] Test opcode statelessness (no accumulated state)
  - Summary: Verified determinism and `requiresState()` in `web/tests/opcodes.test.ts`.

### 10.5 Playback Tests
- [x] Test tick advancement accuracy
  - Summary: Added scheduler-driven tick tests in `web/tests/playback.test.ts`.
- [x] Test rule activation based on timing
  - Summary: Added timing-triggered rule activation coverage in `web/tests/playback.test.ts`.
- [x] Test locked pixel immunity
  - Summary: Added locked pixel immunity coverage in `web/tests/playback.test.ts`.
- [x] Test group targeting correctness
  - Summary: Added group mask targeting assertions in `web/tests/playback.test.ts`.
- [x] Test display buffer isolation from source
  - Summary: Added source immutability checks in `web/tests/playback.test.ts`.

### 10.6 Integration Tests
- [x] Test full file load → validate → play → render cycle
  - Summary: Added full cycle test in `web/tests/integration.test.ts`.
- [x] Test Android implementation against reference
  - Summary: Added reference byte comparison in `android/lib/src/test/kotlin/io/grin/lib/GrinReferenceTest.kt`.
- [x] Test JavaScript implementation against reference
  - Summary: Added reference byte comparison in `web/tests/reference.test.ts`.
- [x] Test cross-platform file compatibility
  - Summary: Added CLI parser compatibility checks in `web/tests/integration.test.ts`.
- [x] Run Android Gradle unit tests
  - Summary: `./gradlew test` succeeded.

### 10.7 Fuzz Testing
- [x] Implement header fuzzer (randomized invalid headers)
  - Summary: Added randomized header coverage in `web/tests/fuzz.test.ts`.
- [x] Implement pixel data fuzzer (truncated, corrupted)
  - Summary: Added truncation fuzz coverage in `web/tests/fuzz.test.ts`.
- [x] Implement rule fuzzer (invalid opcodes, masks)
  - Summary: Added randomized rules block fuzzing in `web/tests/fuzz.test.ts`.
- [x] Verify graceful failure (no crashes, clear errors)
  - Summary: Added error-message assertions in `web/tests/fuzz.test.ts`.

### *** 10.8 Performance Benchmarks
- [x] Benchmark file loading time (various sizes)
  - Summary: Added multi-size benchmark harness in `benchmarks/bench.js`.
- [x] Benchmark validation time
  - Summary: Validation timing captured in `benchmarks/bench.js`.
- [x] Benchmark per-tick processing time
  - Summary: Per-tick timing captured via `renderFrame` loops in `benchmarks/bench.js`.
- [x] Benchmark rendering time (Android Bitmap, Canvas)
  - Summary: Added Android render benchmarks in `android/lib/src/androidTest/kotlin/io/grin/lib/GrinBenchmarkTest.kt`.
- [x] Establish performance regression baselines
  - Summary: Baseline storage in `benchmarks/baseline.json` with harness to update via `benchmarks/bench.js`.

---

## Phase 11: Sample File Creation

### *** 11.1 Minimal Valid File
- [x] Create `minimal.grin`: 1×1 pixel, 0 rules
  - Summary: Added `samples/minimal.grin`.
- [x] Create `minimal_locked.grin`: 1×1 locked pixel, 0 rules
  - Summary: Added `samples/minimal_locked.grin`.
- [x] Document expected byte-for-byte content
  - Summary: Documented byte dumps in `samples/README.md`.

### *** 11.2 Basic Animation Files
- [x] Create `pulse_red.grin`: 16×16, single group pulsing
  - Summary: Added `samples/pulse_red.grin`.
- [x] Create `fade_gradient.grin`: 64×64, multi-group fade
  - Summary: Added `samples/fade_gradient.grin`.
- [x] Create `color_shift.grin`: 32×32, RGB channel shifts
  - Summary: Added `samples/color_shift.grin`.

### *** 11.3 Complex Demo Files
- [x] Create `groups_demo.grin`: Demonstrates all 16 groups
  - Summary: Added `samples/groups_demo.grin`.
- [x] Create `locking_demo.grin`: Demonstrates lock/unlock opcodes
  - Summary: Added `samples/locking_demo.grin` with lock/unlock rules.
- [x] Create `timing_demo.grin`: Demonstrates timing variations
  - Summary: Added `samples/timing_demo.grin`.

### *** 11.4 Edge Case Files
- [x] Create `max_size.grin`: Maximum reasonable dimensions
  - Summary: Added `samples/max_size.grin` (512×512).
- [x] Create `max_rules.grin`: 16 rules, all groups targeted
  - Summary: Added `samples/max_rules.grin`.
- [x] Create `all_opcodes.grin`: Uses every defined opcode
  - Summary: Added `samples/all_opcodes.grin`.

### *** 11.5 Invalid Files (for testing)
- [x] Create `invalid_magic.grin`: Wrong magic bytes
  - Summary: Added `samples/invalid_magic.grin`.
- [x] Create `invalid_header_size.grin`: HeaderSize != 128
  - Summary: Added `samples/invalid_header_size.grin`.
- [x] Create `truncated.grin`: File ends mid-pixel
  - Summary: Added `samples/truncated.grin`.
- [x] Create `invalid_opcode.grin`: Unknown opcode ID
  - Summary: Added `samples/invalid_opcode.grin`.

---

## Phase 12: Documentation

### 12.1 Specification Documentation
- [x] Finalize and version `grin_technical_specification.md`
  - Summary: Final spec added at `grin_technical_specification.md` (draft copy at `tchspecdraft.txt`).
- [x] Create byte-level format diagram (visual)
  - Summary: Added `docs/format-diagram.md`.
- [x] Create opcode reference table with examples
  - Summary: Added `docs/opcodes.md`.
- [x] Create timing parameter reference
  - Summary: Added `docs/timing.md`.

### *** 12.2 API Documentation
- [x] Generate JavaDoc for Android implementation
  - Summary: Draft API reference in `docs/api/android/README.md` and Dokka config added.
- [x] Generate JSDoc/TypeDoc for JavaScript implementation
  - Summary: TypeDoc output in `docs/api/web`.
- [x] Create API quick-start guide
  - Summary: Added `docs/api-quickstart.md`.
- [x] Create migration guide (from GIF/APNG)
  - Summary: Added `docs/migration-gif-apng.md`.

### *** 12.3 Tutorial Documentation
- [x] Write "Creating Your First GRIN File" tutorial
  - Summary: Added `docs/tutorial-first-file.md`.
- [x] Write "Understanding GRIN Groups" tutorial
  - Summary: Added `docs/tutorial-grin-groups.md`.
- [x] Write "Playback Integration Guide" (Android)
  - Summary: Added `docs/playback-guide-android.md`.
- [x] Write "Playback Integration Guide" (Web)
  - Summary: Added `docs/playback-guide-web.md`.

### 12.4 Security Documentation
- [x] Document security model (no executable code)
  - Summary: Added `docs/security-model.md`.
- [x] Document bounded resource consumption
  - Summary: Covered in `docs/security-model.md`.
- [x] Document validation requirements for untrusted input
  - Summary: Covered in `docs/security-model.md`.
- [x] Create security audit checklist
  - Summary: Added `docs/security-audit-checklist.md`.

---

## Phase 13: Release Preparation

### 13.1 Version Tagging
- [x] Define semantic versioning scheme
- [x] Tag initial release (v0.1.0)
- [x] Create CHANGELOG.md with release notes

### *** 13.2 Package Publishing
- [x] Publish Android library to Maven Central / JitPack
- [x] Publish JavaScript library to npm
- [x] Create GitHub Releases with artifacts

### 13.3 Compatibility Matrix
- [x] Document Android API level compatibility
- [x] Document browser version compatibility
- [x] Document Node.js version compatibility

### 13.4 Legal and Licensing
- [x] Choose and apply open-source license
- [ ] Add license headers to all source files
- [x] Create NOTICE file for third-party attributions

---

## Phase 14: Creative Suite + GIMP Plugins

### 14.1 Shared foundations (all plugins)
- [x] Define the pixel-group editing model and UX goals for painting group IDs + lock bits
  - Deliverable: a 1-page UX spec describing how artists select groups, toggle lock, and preview rules.
  - Summary: Documented the shared UX model in `docs/creative-suite-foundations.md`.
- [x] Decide on an interchange format between host apps and the GRIN toolchain
  - Likely: export a layered PNG + JSON sidecar with group/lock metadata.
  - Summary: Standardized PNG + groups PNG + rules JSON artifacts in `docs/creative-suite-foundations.md`.
- [x] Create a shared validation CLI workflow for plugin export
  - Use `tools/bin/grin-validate.js` and `tools/bin/grin-inspect.js` as post-export checks.
  - Summary: Defined the CLI validation flow in `docs/creative-suite-foundations.md`.
- [x] Draft a shared palette/legend for group IDs (0-15) and lock state overlays
  - Define color mapping and UI affordances for every plugin.
  - Summary: Added the palette/legend table in `docs/creative-suite-foundations.md`.
- [x] Define output paths and naming conventions for exports (`.grin`, `.png`, `.json`)
  - Make sure it matches `tools/bin/grin-encode.js` expectations.
  - Summary: Standardized export naming in `docs/creative-suite-foundations.md`.

### 14.2 Photoshop plugin (UXP)
- [x] Set up `plugins/photoshop/` workspace with UXP manifest + dev tooling
  - Include a simple panel scaffold for group/lock selection and export.
  - Summary: Added the Photoshop UXP panel scaffold, manifest, and package metadata in `plugins/photoshop/`.
- [x] Implement layer metadata capture
  - Map layer names or layer tags to group IDs (0-15) and lock bit.
  - Summary: Added tag parsing and layer metadata capture in `plugins/photoshop/src/main.js`.
- [x] Implement pixel-to-group map extraction
  - Render a flattened bitmap with hidden metadata encoding group + lock values.
  - Summary: Exported named metadata layers for group/lock maps in `plugins/photoshop/src/main.js`.
- [x] Implement export pipeline
  - Generate a JSON sidecar and call `tools/bin/grin-encode.js`.
  - Summary: Added PNG export, rules sidecar creation, and CLI command guidance in `plugins/photoshop/src/main.js`.
- [x] Add preview/validation step
  - Use `grin-validate` and report errors in the panel UI.
  - Summary: Added preview metadata summary and validation command output in `plugins/photoshop/src/main.js`.
- [x] Write Photoshop plugin README with install + usage steps
  - Summary: Documented installation, tagging, and export workflow in `plugins/photoshop/README.md`.

### 14.3 Illustrator plugin (UXP)
- [x] Set up `plugins/illustrator/` workspace with UXP manifest + dev tooling
  - Include a panel scaffold matching Photoshop UX.
  - Summary: Added the Illustrator UXP panel scaffold, manifest, and package metadata in `plugins/illustrator/`.
- [x] Implement vector art flattening rules for GRIN export
  - Define how artboards/paths map to pixels, group IDs, and lock bit.
  - Summary: Documented artboard-to-pixel flattening rules and resolution handling in `plugins/illustrator/src/main.js`.
- [x] Implement group/lock metadata tagging in document model
  - Use layer names, object tags, or custom metadata fields.
  - Summary: Added name/note tag parsing for group and lock metadata in `plugins/illustrator/src/main.js`.
- [x] Implement export pipeline
  - Rasterize at user-specified resolution and call `grin-encode.js`.
  - Summary: Added artboard PNG export, metadata map export, and CLI command guidance in `plugins/illustrator/src/main.js`.
- [x] Add preview/validation step
  - Use `grin-validate` and surface errors to the panel.
  - Summary: Added preview summary output and validation command output in `plugins/illustrator/src/main.js`.
- [x] Write Illustrator plugin README with install + usage steps
  - Summary: Documented installation, flattening, tagging, and export workflow in `plugins/illustrator/README.md`.

### 14.4 GIMP plugin (Python)
- [x] Set up `plugins/gimp/` with Python-Fu entry point + menu registration
  - Add configuration dialog for group/lock editing and export settings.
  - Summary: Added the Python-Fu entry point, menu registration, and configuration parameters in `plugins/gimp/grin_gimp_plugin.py`.
- [x] Implement group/lock editing overlays
  - Use layer groups or selection masks to represent group IDs.
  - Summary: Implemented group/lock metadata layers and selection painting overlays in `plugins/gimp/grin_gimp_plugin.py`.
- [x] Implement pixel map extraction
  - Read pixel data + custom metadata for group and lock state.
  - Summary: Added grayscale pixel extraction and group/lock summaries in `plugins/gimp/grin_gimp_plugin.py`.
- [x] Implement export pipeline
  - Export PNG + JSON sidecar and call `grin-encode.js`.
  - Summary: Implemented PNG exports, rules sidecar writing, and optional CLI invocation in `plugins/gimp/grin_gimp_plugin.py`.
- [x] Add preview/validation step
  - Use `grin-validate` and show errors in a dialog.
  - Summary: Added preview metadata summaries and validation output dialogs in `plugins/gimp/grin_gimp_plugin.py`.
- [x] Write GIMP plugin README with install + usage steps
  - Summary: Documented installation, metadata authoring, and export workflow in `plugins/gimp/README.md`.

---

## Phase 15: UI/UX Polish + Windows Desktop Integration

### 15.1 UX Audit + Requirements Backlog
- [x] Inventory all end-user surfaces: `web/demo/`, `android/demo/`, CLI help (`tools/bin/`), and docs onboarding (`docs/README.md`)
  - Capture screenshots, flows, and current pain points.
  - Summary: Captured the current UX surface inventory, flows, and pain points in `docs/ui-ux-audit.md`.
- [x] Create a UX heuristics checklist (navigation clarity, error states, keyboard/mouse affordances, accessibility)
  - Store the checklist in `docs/ui-ux-audit.md` and link from `docs/README.md`.
  - Summary: Added a UX heuristics checklist to `docs/ui-ux-audit.md` and linked it from `docs/README.md`.
- [x] Define core user journeys (open file, play animation, inspect groups, export) with success criteria
  - Add journey maps to `docs/ui-ux-audit.md`.
  - Summary: Documented core journeys and success criteria in `docs/ui-ux-audit.md`.
- [x] Prioritize the UX backlog with severity tags (P0/P1/P2) and platform labels (web/android/cli)
  - Maintain a prioritized list in `docs/ui-ux-audit.md`.
  - Summary: Added a prioritized, labeled UX backlog to `docs/ui-ux-audit.md`.

### 15.2 Web Demo UI Polish (Web)
- [ ] Refresh layout hierarchy in `web/demo/` (clear header, playback controls, inspector panel)
  - Ensure consistent spacing, typography, and control grouping.
- [ ] Add accessibility coverage (ARIA labels, focus order, contrast checks)
  - Document a11y checks in `docs/ui-ux-audit.md`.
- [ ] Improve empty, loading, and error states (missing file, validation errors, decode failures)
  - Provide actionable messaging with next steps.
- [ ] Add keyboard shortcuts for playback, frame stepping, and group filtering
  - Surface shortcuts in a help tooltip or modal.
- [ ] Add a validation summary panel (header warnings, rule count, invalid pixels)
  - Link to existing validation error outputs.

### 15.3 Android Demo UI Polish (Android)
- [ ] Align the demo UI with Material 3 components in `android/demo/`
  - Rebuild the activity layout with proper app bars, cards, and controls.
- [ ] Improve playback UX (play/pause, scrubber, speed control, loop toggle)
  - Ensure touch targets meet accessibility guidelines.
- [ ] Add file-open flow with recent files and error recovery
  - Handle invalid file formats gracefully.
- [ ] Add in-app metadata viewer (header fields, rules summary, group counts)
  - Provide copy/share options for debugging.

### 15.4 Cross-Platform UX Consistency
- [ ] Standardize iconography, labels, and terminology across web/android/docs
  - Maintain a glossary in `docs/ui-ux-audit.md`.
- [ ] Consolidate error copy and remediation hints for validation failures
  - Reference spec sections where possible.
- [ ] Add onboarding snippets (first-run guidance, sample file prompts)
  - Include download links for `samples/` data.

### 15.5 Windows Desktop Viewer + File Associations
- [ ] Decide Windows UI stack (WinUI 3/.NET WPF/Electron) and document rationale
  - Add decision record in `docs/windows-desktop.md`.
- [ ] Create a Windows desktop viewer app capable of rendering `.grin` files
  - Support animation playback, group filtering, and metadata inspection.
- [ ] Implement `.grin` and `.grn` file association registration (ProgID, icons)
  - Ensure double-click opens the viewer app.
- [ ] Implement Windows thumbnail and preview support
  - Option A: WIC codec to decode `.grin` frames for Explorer thumbnails.
  - Option B: IThumbnailProvider/preview handler COM server for Explorer.
- [ ] Enable Windows Photos gallery integration
  - Register `.grin` as an image-capable format via WIC or Photos-compatible handler.
- [ ] Add installer packaging (MSI/EXE via WiX/NSIS) with clean uninstall
  - Register/unregister file associations and shell extensions on install/uninstall.
- [ ] Add build pipeline for Windows artifacts (CI job + signed binaries)
  - Document signing requirements and certificate management.
- [ ] Write Windows install & troubleshooting guide in `docs/windows-desktop.md`
  - Include manual registry fallback steps for power users.

---

## Planned Upgrades (Unimplemented)

- [ ] Photoshop, Illustrator, and GIMP plugins (see Phase 14 for detailed plan)
- [ ] Export `.grin` files as DMX sequences (pixels as stage lights, groups as DMX worlds)

---

## Dependency Graph (Critical Path)

```
Phase 0 (Setup) ──┬──> Phase 1 (Binary Format) ──> Phase 2 (Data Structures)
                  │                                         │
                  │                                         v
                  │                                  Phase 3 (Binary I/O)
                  │                                         │
                  │                    ┌────────────────────┼────────────────────┐
                  │                    v                    v                    v
                  │             Phase 4 (Validation)  Phase 5 (Opcodes)   Phase 6 (Playback)
                  │                    │                    │                    │
                  │                    └────────────────────┴────────────────────┘
                  │                                         │
                  │              ┌──────────────────────────┼──────────────────────────┐
                  │              v                          v                          v
                  │       Phase 7 (Android)          Phase 8 (Web)            Phase 9 (CLI)
                  │              │                          │                          │
                  │              └──────────────────────────┴──────────────────────────┘
                  │                                         │
                  v                                         v
           Phase 10 (Testing) <────────────────────> Phase 11 (Samples)
                  │                                         │
                  └──────────────────────┬──────────────────┘
                                         v
                                  Phase 12 (Docs)
                                         │
                                         v
                                  Phase 13 (Release)
                                         │
                                         v
                            Phase 15 (UI/UX + Windows)
```

---

## Legend

- `***` at step beginning: Task can run in parallel or out of order with other tasks in same phase
- Tasks without `***`: Must be completed sequentially within phase
- Phases generally depend on previous phases unless otherwise noted
- Testing (Phase 10) should run continuously alongside development

---

## Estimated Complexity

| Phase | Estimated Hours | Parallelizable |
|-------|-----------------|----------------|
| 0     | 4-8            | Partially      |
| 1     | 8-12           | No             |
| 2     | 12-16          | Partially      |
| 3     | 16-24          | Partially      |
| 4     | 8-12           | No             |
| 5     | 16-24          | Partially      |
| 6     | 24-32          | No             |
| 7     | 24-32          | Partially      |
| 8     | 24-32          | Partially      |
| 9     | 16-24          | Yes            |
| 10    | 24-32          | Yes            |
| 11    | 8-12           | Yes            |
| 12    | 16-24          | Yes            |
| 13    | 8-12           | Partially      |
| 15    | 32-48          | Partially      |

**Total Estimated**: 232-348 hours for full implementation

---

## Notes for Agentic Agents

1. **Atomic Commits**: Each checkbox item should correspond to a single, reviewable commit
2. **Test-Driven**: Write tests before implementation where possible
3. **Documentation**: Update docs as you implement, not after
4. **Cross-Reference**: Reference spec section numbers in code comments
#####/tools/bin/grin-decode.js#####
#!/usr/bin/env node

/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import path from "node:path";
import { readGrinFile } from "../lib/grin.js";
import { createRenderState, renderFrame, renderGroupMap, renderToTick } from "../lib/render.js";
import { writeGif } from "../lib/gif.js";
import { writeImage } from "../lib/png.js";

const args = process.argv.slice(2);
let inputPath = null;
let outputPath = null;
let frame = 0;
let groups = false;
let gif = false;
let frames = null;
let fps = null;

for (let i = 0; i < args.length; i += 1) {
  const arg = args[i];
  if (arg === "--frame") {
    frame = Number.parseInt(args[i + 1] ?? "0", 10);
    i += 1;
  } else if (arg === "--groups") {
    groups = true;
  } else if (arg === "--gif") {
    gif = true;
  } else if (arg === "--frames") {
    frames = Number.parseInt(args[i + 1] ?? "0", 10);
    i += 1;
  } else if (arg === "--fps") {
    fps = Number.parseInt(args[i + 1] ?? "0", 10);
    i += 1;
  } else if (!arg.startsWith("--")) {
    if (!inputPath) {
      inputPath = arg;
    } else if (!outputPath) {
      outputPath = arg;
    }
  }
}

if (!inputPath || !outputPath) {
  printUsage();
  process.exit(1);
}

try {
  const file = readGrinFile(inputPath);
  const width = file.header.width;
  const height = file.header.height;
  const outputExt = path.extname(outputPath).toLowerCase();
  const isGif = gif || outputExt === ".gif";

  if (isGif && groups) {
    throw new Error("Cannot combine --groups with GIF output");
  }

  if (isGif) {
    const frameCount = Number.isInteger(frames) && frames > 0 ? frames : 60;
    const rate = Number.isInteger(fps) && fps > 0 ? fps : 30;
    const delayMs = Math.max(1, Math.round(1000 / rate));
    const state = createRenderState(file);
    const sequence = [];
    for (let i = 0; i < frameCount; i += 1) {
      sequence.push(renderFrame(file, frame + i, state));
    }
    writeGif(outputPath, width, height, sequence, { delayMs });
    process.stdout.write(`Wrote ${outputPath} (${frameCount} frames @ ${rate}fps)\n`);
    process.exit(0);
  }

  const rgba = groups ? renderGroupMap(file) : renderToTick(file, frame);
  writeImage(outputPath, width, height, rgba);
  process.stdout.write(`Wrote ${outputPath}\n`);
} catch (error) {
  const message = error instanceof Error ? error.message : String(error);
  process.stderr.write(`grin-decode: ${message}\n`);
  process.exit(1);
}

function printUsage() {
  process.stdout.write(
    "Usage: grin-decode <input.grin> <output.png> [--frame <tick>] [--groups]\n" +
      "       grin-decode <input.grin> <output.gif> [--gif] [--frame <tick>] [--frames <count>] [--fps <rate>]\n"
  );
}

#####/tools/bin/grin-encode.js#####
#!/usr/bin/env node

/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import fs from "node:fs";
import { readImage } from "../lib/png.js";
import { createGrinFile, serializeGrinFile } from "../lib/grin.js";
import { validateGrinFile } from "../lib/validation.js";
import { CONTROL_BYTE_MASKS } from "../lib/format.js";

const args = process.argv.slice(2);
let inputPath = null;
let outputPath = null;
let maskPath = null;
let rulesPath = null;

for (let i = 0; i < args.length; i += 1) {
  const arg = args[i];
  if (arg === "--groups") {
    maskPath = args[i + 1];
    i += 1;
  } else if (arg === "--rules") {
    rulesPath = args[i + 1];
    i += 1;
  } else if (!arg.startsWith("--")) {
    if (!inputPath) {
      inputPath = arg;
    } else if (!outputPath) {
      outputPath = arg;
    }
  }
}

if (!inputPath || !outputPath) {
  printUsage();
  process.exit(1);
}

try {
  const inputImage = readImage(inputPath);
  const maskImage = maskPath ? readImage(maskPath) : null;

  if (maskImage && (maskImage.width !== inputImage.width || maskImage.height !== inputImage.height)) {
    throw new Error("Group mask dimensions must match input image");
  }

  const rulesConfig = rulesPath ? loadRules(rulesPath) : { rules: [], tickMicros: 0, opcodeSetId: 0 };

  const pixels = buildPixels(inputImage, maskImage);
  const file = createGrinFile({
    width: inputImage.width,
    height: inputImage.height,
    pixels,
    rules: rulesConfig.rules,
    tickMicros: rulesConfig.tickMicros,
    opcodeSetId: rulesConfig.opcodeSetId,
  });

  const report = validateGrinFile(file, "permissive");
  if (!report.ok) {
    throw new Error(`Validation failed: ${report.errors.join("; ")}`);
  }

  const bytes = serializeGrinFile(file);
  fs.writeFileSync(outputPath, bytes);
  process.stdout.write(`Wrote ${outputPath}\n`);
} catch (error) {
  const message = error instanceof Error ? error.message : String(error);
  process.stderr.write(`grin-encode: ${message}\n`);
  process.exit(1);
}

function buildPixels(inputImage, maskImage) {
  const pixels = [];
  const data = inputImage.data;
  const mask = maskImage ? maskImage.data : null;

  for (let i = 0; i < data.length; i += 4) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];
    const a = data[i + 3];
    const groupId = mask ? mapGroupId(mask[i]) : 0;
    const control = (groupId & CONTROL_BYTE_MASKS.GROUP_ID) | 0;
    pixels.push({ r, g, b, a, c: control });
  }
  return pixels;
}

function mapGroupId(value) {
  if (value <= 15) {
    return value;
  }
  const mapped = Math.round(value / 17);
  if (mapped < 0) return 0;
  if (mapped > 15) return 15;
  return mapped;
}

function loadRules(rulesPath) {
  const raw = fs.readFileSync(rulesPath, "utf8");
  const parsed = JSON.parse(raw);
  const rules = Array.isArray(parsed) ? parsed : parsed.rules || [];
  const tickMicros = Array.isArray(parsed) ? 0 : parsed.tickMicros ?? 0;
  const opcodeSetId = Array.isArray(parsed) ? 0 : parsed.opcodeSetId ?? 0;

  return {
    rules: rules.map((rule) => ({
      groupMask: parseGroupMask(rule.groupMask ?? rule.groups ?? 0),
      opcode: parseNumber(rule.opcode ?? 0),
      timing: parseNumber(rule.timing ?? 0),
    })),
    tickMicros: parseNumber(tickMicros),
    opcodeSetId: parseNumber(opcodeSetId),
  };
}

function parseGroupMask(value) {
  if (Array.isArray(value)) {
    return value.reduce((mask, groupId) => mask | (1 << (parseNumber(groupId) & 0x0f)), 0);
  }
  return parseNumber(value);
}

function parseNumber(value) {
  if (typeof value === "string") {
    const parsed = Number.parseInt(value, 0);
    if (Number.isNaN(parsed)) {
      throw new Error(`Invalid numeric value: ${value}`);
    }
    return parsed;
  }
  if (typeof value === "number") {
    return value;
  }
  return 0;
}

function printUsage() {
  process.stdout.write(
    "Usage: grin-encode <input.png> <output.grin> [--groups <mask.png>] [--rules <rules.json>]\n"
  );
}

#####/tools/bin/grin-inspect.js#####
#!/usr/bin/env node

/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { readGrinFile } from "../lib/grin.js";
import { BaseOpcodeId } from "../lib/opcodes.js";
import { CONTROL_BYTE_MASKS } from "../lib/format.js";

const args = process.argv.slice(2);
const json = args.includes("--json");
const showHeader = args.includes("--header");
const showRules = args.includes("--rules");
const showGroups = args.includes("--groups");
const showPixels = args.includes("--pixels");
const filePath = args.find((arg) => !arg.startsWith("--"));

if (!filePath) {
  printUsage();
  process.exit(1);
}

const sections = {
  header: showHeader,
  rules: showRules,
  groups: showGroups,
  pixels: showPixels,
};

if (!showHeader && !showRules && !showGroups && !showPixels) {
  sections.header = true;
  sections.rules = true;
  sections.groups = true;
}

try {
  const file = readGrinFile(filePath);
  const report = buildReport(file, sections);

  if (json) {
    process.stdout.write(`${JSON.stringify(report, null, 2)}\n`);
  } else {
    outputText(report, sections);
  }
} catch (error) {
  const message = error instanceof Error ? error.message : String(error);
  process.stderr.write(`grin-inspect: ${message}\n`);
  process.exit(1);
}

function buildReport(file, sections) {
  const header = sections.header ? formatHeader(file.header) : null;
  const rules = sections.rules ? formatRules(file.rules) : null;
  const groups = sections.groups ? formatGroups(file.pixels) : null;
  const pixels = sections.pixels ? formatPixels(file) : null;

  return {
    file: filePath,
    header,
    rules,
    groups,
    pixels,
  };
}

function formatHeader(header) {
  return {
    magic: Array.from(header.magic),
    versionMajor: header.versionMajor,
    versionMinor: header.versionMinor,
    headerSize: header.headerSize,
    width: header.width,
    height: header.height,
    tickMicros: header.tickMicros,
    ruleCount: header.ruleCount,
    opcodeSetId: header.opcodeSetId,
    flags: header.flags,
    pixelDataLength: header.pixelDataLength.toString(),
    fileLength: header.fileLength.toString(),
    pixelDataOffset: header.pixelDataOffset.toString(),
  };
}

function formatRules(rules) {
  return rules.map((rule, index) => ({
    index,
    groupMask: rule.groupMask,
    opcode: rule.opcode,
    opcodeName: opcodeName(rule.opcode),
    timing: rule.timing,
  }));
}

function formatGroups(pixels) {
  const counts = new Array(16).fill(0);
  let locked = 0;
  for (const pixel of pixels) {
    const groupId = pixel.c & CONTROL_BYTE_MASKS.GROUP_ID;
    counts[groupId] += 1;
    if ((pixel.c & CONTROL_BYTE_MASKS.LOCK) !== 0) {
      locked += 1;
    }
  }
  return { counts, locked };
}

function formatPixels(file) {
  const pixels = [];
  const width = file.header.width;
  for (let index = 0; index < file.pixels.length; index += 1) {
    const pixel = file.pixels[index];
    const x = index % width;
    const y = Math.floor(index / width);
    pixels.push({
      x,
      y,
      r: pixel.r,
      g: pixel.g,
      b: pixel.b,
      a: pixel.a,
      c: pixel.c,
      groupId: pixel.c & CONTROL_BYTE_MASKS.GROUP_ID,
      locked: (pixel.c & CONTROL_BYTE_MASKS.LOCK) !== 0,
    });
  }
  return pixels;
}

function outputText(report, sections) {
  process.stdout.write(`${report.file}\n`);

  if (sections.header && report.header) {
    const header = report.header;
    process.stdout.write("Header:\n");
    for (const [key, value] of Object.entries(header)) {
      process.stdout.write(`  ${key}: ${value}\n`);
    }
  }

  if (sections.rules && report.rules) {
    process.stdout.write("Rules:\n");
    if (report.rules.length === 0) {
      process.stdout.write("  (none)\n");
    } else {
      for (const rule of report.rules) {
        process.stdout.write(
          `  [${rule.index}] mask=0x${rule.groupMask.toString(16).padStart(4, "0")} opcode=${rule.opcode}` +
            ` (${rule.opcodeName}) timing=${rule.timing}\n`
        );
      }
    }
  }

  if (sections.groups && report.groups) {
    process.stdout.write("Groups:\n");
    report.groups.counts.forEach((count, groupId) => {
      process.stdout.write(`  ${groupId}: ${count}\n`);
    });
    process.stdout.write(`  locked: ${report.groups.locked}\n`);
  }

  if (sections.pixels && report.pixels) {
    process.stdout.write("Pixels:\n");
    for (const pixel of report.pixels) {
      process.stdout.write(
        `  (${pixel.x},${pixel.y}) rgba=(${pixel.r},${pixel.g},${pixel.b},${pixel.a}) c=${pixel.c}` +
          ` group=${pixel.groupId} locked=${pixel.locked}\n`
      );
    }
  }
}

function opcodeName(opcode) {
  const entry = Object.entries(BaseOpcodeId).find(([, value]) => value === opcode);
  return entry ? entry[0] : "UNKNOWN";
}

function printUsage() {
  process.stdout.write(
    "Usage: grin-inspect <file.grin> [--header] [--rules] [--groups] [--pixels] [--json]\n"
  );
}

#####/tools/bin/grin-validate.js#####
#!/usr/bin/env node

/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { readGrinFile } from "../lib/grin.js";
import { validateGrinFile } from "../lib/validation.js";

const args = process.argv.slice(2);
const strict = args.includes("--strict");
const json = args.includes("--json");
const files = args.filter((arg) => !arg.startsWith("--"));

if (files.length === 0) {
  printUsage();
  process.exit(1);
}

const results = [];
let exitCode = 0;

for (const filePath of files) {
  try {
    const file = readGrinFile(filePath);
    const report = validateGrinFile(file, strict ? "strict" : "permissive");
    const result = { file: filePath, ...report };
    results.push(result);
    if (!report.ok) {
      exitCode = 1;
    }
  } catch (error) {
    const message = error instanceof Error ? error.message : String(error);
    const result = { file: filePath, ok: false, errors: [message], warnings: [], info: [] };
    results.push(result);
    exitCode = 1;
  }
}

if (json) {
  process.stdout.write(`${JSON.stringify(results, null, 2)}\n`);
} else {
  for (const result of results) {
    const status = result.ok ? "OK" : "FAIL";
    process.stdout.write(`${result.file}: ${status}\n`);
    for (const info of result.info) {
      process.stdout.write(`  info: ${info}\n`);
    }
    for (const warning of result.warnings) {
      process.stdout.write(`  warning: ${warning}\n`);
    }
    for (const error of result.errors) {
      process.stdout.write(`  error: ${error}\n`);
    }
  }
}

process.exit(exitCode);

function printUsage() {
  process.stdout.write("Usage: grin-validate <file.grin> [--strict] [--json]\n");
}

#####/tools/lib/endianness.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export function readUint16LE(bytes, offset) {
  ensureRange(bytes, offset, 2);
  return bytes[offset] | (bytes[offset + 1] << 8);
}

export function readUint32LE(bytes, offset) {
  ensureRange(bytes, offset, 4);
  return (
    bytes[offset] |
    (bytes[offset + 1] << 8) |
    (bytes[offset + 2] << 16) |
    (bytes[offset + 3] << 24)
  ) >>> 0;
}

export function readUint64LE(bytes, offset) {
  ensureRange(bytes, offset, 8);
  const view = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
  return view.getBigUint64(offset, true);
}

export function writeUint16LE(value) {
  return new Uint8Array([value & 0xff, (value >> 8) & 0xff]);
}

export function writeUint32LE(value) {
  return new Uint8Array([
    value & 0xff,
    (value >> 8) & 0xff,
    (value >> 16) & 0xff,
    (value >> 24) & 0xff,
  ]);
}

export function writeUint64LE(value) {
  const buffer = new ArrayBuffer(8);
  const view = new DataView(buffer);
  view.setBigUint64(0, value, true);
  return new Uint8Array(buffer);
}

function ensureRange(bytes, offset, length) {
  if (offset < 0 || offset + length > bytes.length) {
    throw new RangeError("Read exceeds buffer length");
  }
}

#####/tools/lib/format.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export const MAGIC_BYTES = new Uint8Array([0x47, 0x52, 0x49, 0x4e]);
export const VERSION_MAJOR = 0x00;
export const VERSION_MINOR = 0x00;
export const HEADER_SIZE_BYTES = 128;
export const PIXEL_SIZE_BYTES = 5;
export const MAX_RULE_COUNT = 16;
export const RULES_BLOCK_SIZE = 64;
export const RULE_ENTRY_SIZE = 4;

export const HEADER_FIELDS = {
  MAGIC: { offset: 0, size: 4 },
  VERSION_MAJOR: { offset: 4, size: 1 },
  VERSION_MINOR: { offset: 5, size: 1 },
  HEADER_SIZE: { offset: 6, size: 2 },
  WIDTH: { offset: 8, size: 4 },
  HEIGHT: { offset: 12, size: 4 },
  TICK_MICROS: { offset: 16, size: 4 },
  RULE_COUNT: { offset: 20, size: 1 },
  OPCODE_SET_ID: { offset: 21, size: 1 },
  FLAGS: { offset: 22, size: 2 },
  PIXEL_DATA_LENGTH: { offset: 24, size: 8 },
  FILE_LENGTH: { offset: 32, size: 8 },
  PIXEL_DATA_OFFSET: { offset: 40, size: 8 },
  RESERVED_A: { offset: 48, size: 8 },
  RESERVED_B: { offset: 56, size: 8 },
  RULES_BLOCK: { offset: 64, size: 64 },
};

export const CONTROL_BYTE_MASKS = {
  GROUP_ID: 0x0f,
  RESERVED: 0x70,
  LOCK: 0x80,
};

export function groupMaskTargetsGroup(groupMask, groupId) {
  const shift = groupId & 0x0f;
  return (groupMask & (1 << shift)) !== 0;
}

#####/tools/lib/gif.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import fs from "node:fs";
import gifEncoderModule from "gif-encoder-2";

const GIFEncoder = gifEncoderModule?.default ?? gifEncoderModule;

export function writeGif(filePath, width, height, frames, options = {}) {
  const expectedLength = width * height * 4;
  const delayMs = Number.isInteger(options.delayMs) ? options.delayMs : 100;
  const repeat = Number.isInteger(options.repeat) ? options.repeat : 0;
  const quality = Number.isInteger(options.quality) ? options.quality : 10;

  for (const frame of frames) {
    if (frame.length !== expectedLength) {
      throw new Error("RGBA buffer length does not match width * height * 4");
    }
  }

  const encoder = new GIFEncoder(width, height);
  encoder.setRepeat(repeat);
  encoder.setDelay(delayMs);
  encoder.setQuality(quality);
  encoder.start();

  for (const frame of frames) {
    encoder.addFrame(frame);
  }

  encoder.finish();
  const buffer = encoder.out.getData();
  fs.writeFileSync(filePath, buffer);
}

#####/tools/lib/grin.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import fs from "node:fs";
import {
  CONTROL_BYTE_MASKS,
  HEADER_FIELDS,
  HEADER_SIZE_BYTES,
  MAGIC_BYTES,
  MAX_RULE_COUNT,
  PIXEL_SIZE_BYTES,
  RULE_ENTRY_SIZE,
  RULES_BLOCK_SIZE,
  VERSION_MAJOR,
  VERSION_MINOR,
} from "./format.js";
import {
  readUint16LE,
  readUint32LE,
  readUint64LE,
  writeUint16LE,
  writeUint32LE,
  writeUint64LE,
} from "./endianness.js";

export function readGrinFile(input) {
  const bytes = toUint8Array(input);
  return parseGrinBytes(bytes);
}

export function parseGrinBytes(bytes) {
  if (bytes.length < HEADER_SIZE_BYTES) {
    throw new Error("Buffer too small for GRIN header");
  }

  const headerBytes = bytes.subarray(0, HEADER_SIZE_BYTES);
  const header = parseHeader(headerBytes);
  const rules = parseRulesBlock(header.rulesBlock, header.ruleCount);

  const pixelOffset = safeNumber(header.pixelDataOffset, "PixelDataOffset64");
  const pixelLength = safeNumber(header.pixelDataLength, "PixelDataLength");
  if (bytes.length < pixelOffset + pixelLength) {
    throw new Error("Buffer does not contain full pixel data");
  }
  const pixelBytes = bytes.subarray(pixelOffset, pixelOffset + pixelLength);
  const pixels = parsePixels(pixelBytes, header.width, header.height);

  return { header, pixels, rules };
}

export function serializeGrinFile(file) {
  const header = normalizeHeader(file);
  const headerBytes = serializeHeader(header);
  const pixelBytes = serializePixels(file.pixels);
  const output = new Uint8Array(headerBytes.length + pixelBytes.length);
  output.set(headerBytes, 0);
  output.set(pixelBytes, headerBytes.length);
  return output;
}

export function writeGrinFile(path, file) {
  const bytes = serializeGrinFile(file);
  fs.writeFileSync(path, bytes);
}

export function createGrinFile({
  width,
  height,
  pixels,
  rules = [],
  tickMicros = 0,
  opcodeSetId = 0,
}) {
  if (!Array.isArray(pixels)) {
    throw new Error("Pixels array is required");
  }
  if (!Number.isInteger(width) || !Number.isInteger(height)) {
    throw new Error("Width and height must be integers");
  }
  const rulesBlock = buildRulesBlock(rules);
  const pixelDataLength = BigInt(pixels.length) * BigInt(PIXEL_SIZE_BYTES);
  const fileLength = BigInt(HEADER_SIZE_BYTES) + pixelDataLength;

  const header = {
    magic: cloneBytes(MAGIC_BYTES, MAGIC_BYTES.length),
    versionMajor: VERSION_MAJOR,
    versionMinor: VERSION_MINOR,
    headerSize: HEADER_SIZE_BYTES,
    width,
    height,
    tickMicros,
    ruleCount: rules.length,
    opcodeSetId,
    flags: 0,
    pixelDataLength,
    fileLength,
    pixelDataOffset: BigInt(HEADER_SIZE_BYTES),
    reservedA: 0n,
    reservedB: 0n,
    rulesBlock,
  };

  return { header, pixels, rules };
}

export function parseHeader(bytes) {
  return {
    magic: cloneBytes(
      bytes.subarray(HEADER_FIELDS.MAGIC.offset, HEADER_FIELDS.MAGIC.offset + HEADER_FIELDS.MAGIC.size),
      HEADER_FIELDS.MAGIC.size
    ),
    versionMajor: bytes[HEADER_FIELDS.VERSION_MAJOR.offset],
    versionMinor: bytes[HEADER_FIELDS.VERSION_MINOR.offset],
    headerSize: readUint16LE(bytes, HEADER_FIELDS.HEADER_SIZE.offset),
    width: readUint32LE(bytes, HEADER_FIELDS.WIDTH.offset),
    height: readUint32LE(bytes, HEADER_FIELDS.HEIGHT.offset),
    tickMicros: readUint32LE(bytes, HEADER_FIELDS.TICK_MICROS.offset),
    ruleCount: bytes[HEADER_FIELDS.RULE_COUNT.offset],
    opcodeSetId: bytes[HEADER_FIELDS.OPCODE_SET_ID.offset],
    flags: readUint16LE(bytes, HEADER_FIELDS.FLAGS.offset),
    pixelDataLength: readUint64LE(bytes, HEADER_FIELDS.PIXEL_DATA_LENGTH.offset),
    fileLength: readUint64LE(bytes, HEADER_FIELDS.FILE_LENGTH.offset),
    pixelDataOffset: readUint64LE(bytes, HEADER_FIELDS.PIXEL_DATA_OFFSET.offset),
    reservedA: readUint64LE(bytes, HEADER_FIELDS.RESERVED_A.offset),
    reservedB: readUint64LE(bytes, HEADER_FIELDS.RESERVED_B.offset),
    rulesBlock: cloneBytes(
      bytes.subarray(
        HEADER_FIELDS.RULES_BLOCK.offset,
        HEADER_FIELDS.RULES_BLOCK.offset + HEADER_FIELDS.RULES_BLOCK.size
      ),
      RULES_BLOCK_SIZE
    ),
  };
}

export function serializeHeader(header) {
  const output = new Uint8Array(HEADER_SIZE_BYTES);
  output.set(cloneBytes(header.magic ?? MAGIC_BYTES, HEADER_FIELDS.MAGIC.size), HEADER_FIELDS.MAGIC.offset);
  output[HEADER_FIELDS.VERSION_MAJOR.offset] = header.versionMajor ?? VERSION_MAJOR;
  output[HEADER_FIELDS.VERSION_MINOR.offset] = header.versionMinor ?? VERSION_MINOR;
  output.set(writeUint16LE(header.headerSize ?? HEADER_SIZE_BYTES), HEADER_FIELDS.HEADER_SIZE.offset);
  output.set(writeUint32LE(header.width ?? 0), HEADER_FIELDS.WIDTH.offset);
  output.set(writeUint32LE(header.height ?? 0), HEADER_FIELDS.HEIGHT.offset);
  output.set(writeUint32LE(header.tickMicros ?? 0), HEADER_FIELDS.TICK_MICROS.offset);
  output[HEADER_FIELDS.RULE_COUNT.offset] = header.ruleCount ?? 0;
  output[HEADER_FIELDS.OPCODE_SET_ID.offset] = header.opcodeSetId ?? 0;
  output.set(writeUint16LE(header.flags ?? 0), HEADER_FIELDS.FLAGS.offset);
  output.set(writeUint64LE(toBigInt(header.pixelDataLength)), HEADER_FIELDS.PIXEL_DATA_LENGTH.offset);
  output.set(writeUint64LE(toBigInt(header.fileLength)), HEADER_FIELDS.FILE_LENGTH.offset);
  output.set(writeUint64LE(toBigInt(header.pixelDataOffset)), HEADER_FIELDS.PIXEL_DATA_OFFSET.offset);
  output.set(writeUint64LE(toBigInt(header.reservedA)), HEADER_FIELDS.RESERVED_A.offset);
  output.set(writeUint64LE(toBigInt(header.reservedB)), HEADER_FIELDS.RESERVED_B.offset);
  const rulesBlock = header.rulesBlock ?? new Uint8Array(RULES_BLOCK_SIZE);
  output.set(cloneBytes(rulesBlock, RULES_BLOCK_SIZE), HEADER_FIELDS.RULES_BLOCK.offset);
  return output;
}

export function parseRulesBlock(block, ruleCount) {
  if (ruleCount > MAX_RULE_COUNT) {
    throw new Error(`RuleCount exceeds ${MAX_RULE_COUNT}`);
  }
  if (block.length !== RULES_BLOCK_SIZE) {
    throw new Error("Rules block must be 64 bytes");
  }
  const rules = [];
  for (let i = 0; i < ruleCount; i += 1) {
    const offset = i * RULE_ENTRY_SIZE;
    const groupMask = readUint16LE(block, offset);
    const opcode = block[offset + 2];
    const timing = block[offset + 3];
    rules.push({ groupMask, opcode, timing });
  }
  return rules;
}

export function buildRulesBlock(rules) {
  if (rules.length > MAX_RULE_COUNT) {
    throw new Error(`RuleCount exceeds ${MAX_RULE_COUNT}`);
  }
  const block = new Uint8Array(RULES_BLOCK_SIZE);
  for (let i = 0; i < rules.length; i += 1) {
    const rule = rules[i];
    if (!rule) {
      continue;
    }
    const offset = i * RULE_ENTRY_SIZE;
    const groupMask = rule.groupMask ?? 0;
    block.set(writeUint16LE(groupMask), offset);
    block[offset + 2] = rule.opcode ?? 0;
    block[offset + 3] = rule.timing ?? 0;
  }
  return block;
}

export function parsePixels(pixelBytes, width, height) {
  const expectedLength = width * height * PIXEL_SIZE_BYTES;
  if (!Number.isSafeInteger(expectedLength)) {
    throw new Error("Pixel data length exceeds safe integer range");
  }
  if (pixelBytes.length !== expectedLength) {
    throw new Error("Pixel data length does not match header dimensions");
  }

  const pixels = [];
  for (let offset = 0; offset < pixelBytes.length; offset += PIXEL_SIZE_BYTES) {
    pixels.push({
      r: pixelBytes[offset],
      g: pixelBytes[offset + 1],
      b: pixelBytes[offset + 2],
      a: pixelBytes[offset + 3],
      c: pixelBytes[offset + 4],
    });
  }
  return pixels;
}

export function serializePixels(pixels) {
  const output = new Uint8Array(pixels.length * PIXEL_SIZE_BYTES);
  let offset = 0;
  for (const pixel of pixels) {
    output[offset] = pixel.r & 0xff;
    output[offset + 1] = pixel.g & 0xff;
    output[offset + 2] = pixel.b & 0xff;
    output[offset + 3] = pixel.a & 0xff;
    const control = pixel.c ?? 0;
    output[offset + 4] = control & ~CONTROL_BYTE_MASKS.RESERVED;
    offset += PIXEL_SIZE_BYTES;
  }
  return output;
}

function normalizeHeader(file) {
  if (!file.header) {
    throw new Error("File header is required");
  }
  const pixelDataLength = BigInt(file.pixels.length) * BigInt(PIXEL_SIZE_BYTES);
  const rulesBlock = buildRulesBlock(file.rules);
  const fileLength = BigInt(HEADER_SIZE_BYTES) + pixelDataLength;
  return {
    magic: cloneBytes(file.header.magic ?? MAGIC_BYTES, MAGIC_BYTES.length),
    versionMajor: file.header.versionMajor ?? VERSION_MAJOR,
    versionMinor: file.header.versionMinor ?? VERSION_MINOR,
    headerSize: HEADER_SIZE_BYTES,
    width: file.header.width,
    height: file.header.height,
    tickMicros: file.header.tickMicros ?? 0,
    ruleCount: file.rules.length,
    opcodeSetId: file.header.opcodeSetId ?? 0,
    flags: 0,
    pixelDataLength,
    fileLength,
    pixelDataOffset: BigInt(HEADER_SIZE_BYTES),
    reservedA: 0n,
    reservedB: 0n,
    rulesBlock,
  };
}

function toUint8Array(input) {
  if (typeof input === "string") {
    const buffer = fs.readFileSync(input);
    return new Uint8Array(buffer);
  }
  if (input instanceof Uint8Array) {
    return input;
  }
  if (input instanceof ArrayBuffer) {
    return new Uint8Array(input);
  }
  throw new Error("Unsupported input type for GRIN file");
}

function safeNumber(value, label) {
  if (value > BigInt(Number.MAX_SAFE_INTEGER)) {
    throw new Error(`${label} exceeds safe integer range`);
  }
  return Number(value);
}

function toBigInt(value) {
  if (typeof value === "bigint") {
    return value;
  }
  if (typeof value === "number") {
    return BigInt(value);
  }
  if (value === undefined || value === null) {
    return 0n;
  }
  throw new Error("Expected bigint-compatible value");
}

function cloneBytes(source, size) {
  const copy = new Uint8Array(size);
  copy.set(source.subarray(0, size));
  return copy;
}

#####/tools/lib/opcodes.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { CONTROL_BYTE_MASKS } from "./format.js";
import { TimingInterpreter } from "./timing.js";

export const BaseOpcodeId = {
  NOP: 0x00,
  FADE_IN: 0x01,
  FADE_OUT: 0x02,
  PULSE: 0x03,
  SHIFT_R: 0x04,
  SHIFT_G: 0x05,
  SHIFT_B: 0x06,
  SHIFT_A: 0x07,
  INVERT: 0x08,
  ROTATE_HUE: 0x09,
  LOCK: 0x0a,
  UNLOCK: 0x0b,
  TOGGLE_LOCK: 0x0c,
};

export function applyOpcode(opcodeId, pixel, tick, timing) {
  switch (opcodeId) {
    case BaseOpcodeId.NOP:
      return;
    case BaseOpcodeId.FADE_IN:
      fadeIn(pixel, tick, timing);
      return;
    case BaseOpcodeId.FADE_OUT:
      fadeOut(pixel, tick, timing);
      return;
    case BaseOpcodeId.PULSE:
      pulse(pixel, tick, timing);
      return;
    case BaseOpcodeId.SHIFT_R:
      pixel.r = shiftChannel(pixel.r, tick, timing);
      return;
    case BaseOpcodeId.SHIFT_G:
      pixel.g = shiftChannel(pixel.g, tick, timing);
      return;
    case BaseOpcodeId.SHIFT_B:
      pixel.b = shiftChannel(pixel.b, tick, timing);
      return;
    case BaseOpcodeId.SHIFT_A:
      pixel.a = shiftChannel(pixel.a, tick, timing);
      return;
    case BaseOpcodeId.INVERT:
      pixel.r = 255 - pixel.r;
      pixel.g = 255 - pixel.g;
      pixel.b = 255 - pixel.b;
      return;
    case BaseOpcodeId.ROTATE_HUE:
      rotateHue(pixel, tick, timing);
      return;
    case BaseOpcodeId.LOCK:
      pixel.c |= CONTROL_BYTE_MASKS.LOCK;
      return;
    case BaseOpcodeId.UNLOCK:
      pixel.c &= ~CONTROL_BYTE_MASKS.LOCK;
      return;
    case BaseOpcodeId.TOGGLE_LOCK:
      pixel.c ^= CONTROL_BYTE_MASKS.LOCK;
      return;
    default:
      throw new Error(`Unknown opcode ${opcodeId}`);
  }
}

function fadeIn(pixel, tick, timing) {
  const level = TimingInterpreter.evaluate(timing, tick);
  pixel.a = clampByte(Math.round(pixel.a * level));
}

function fadeOut(pixel, tick, timing) {
  const level = 1 - TimingInterpreter.evaluate(timing, tick);
  pixel.a = clampByte(Math.round(pixel.a * level));
}

function pulse(pixel, tick, timing) {
  const level = TimingInterpreter.evaluate(timing, tick);
  pixel.a = clampByte(Math.round(pixel.a * level));
}

function shiftChannel(value, tick, timing) {
  const wave = TimingInterpreter.evaluate(timing, tick);
  const delta = Math.round((wave * 2 - 1) * 255);
  return clampByte(value + delta);
}

function rotateHue(pixel, tick, timing) {
  const rotation = TimingInterpreter.evaluate(timing, tick) * 360;
  const [h, s, l] = rgbToHsl(pixel.r, pixel.g, pixel.b);
  const newHue = (h + rotation) % 360;
  const [r, g, b] = hslToRgb(newHue, s, l);
  pixel.r = r;
  pixel.g = g;
  pixel.b = b;
}

function clampByte(value) {
  if (value < 0) return 0;
  if (value > 255) return 255;
  return value;
}

function rgbToHsl(r, g, b) {
  const rNorm = r / 255;
  const gNorm = g / 255;
  const bNorm = b / 255;
  const max = Math.max(rNorm, gNorm, bNorm);
  const min = Math.min(rNorm, gNorm, bNorm);
  const delta = max - min;
  let h = 0;
  const l = (max + min) / 2;
  let s = 0;

  if (delta !== 0) {
    s = delta / (1 - Math.abs(2 * l - 1));
    if (max === rNorm) {
      h = ((gNorm - bNorm) / delta) % 6;
    } else if (max === gNorm) {
      h = (bNorm - rNorm) / delta + 2;
    } else {
      h = (rNorm - gNorm) / delta + 4;
    }
    h *= 60;
    if (h < 0) h += 360;
  }

  return [h, s, l];
}

function hslToRgb(h, s, l) {
  const c = (1 - Math.abs(2 * l - 1)) * s;
  const hPrime = h / 60;
  const x = c * (1 - Math.abs((hPrime % 2) - 1));
  let r1 = 0;
  let g1 = 0;
  let b1 = 0;

  if (hPrime >= 0 && hPrime < 1) {
    r1 = c;
    g1 = x;
  } else if (hPrime < 2) {
    r1 = x;
    g1 = c;
  } else if (hPrime < 3) {
    g1 = c;
    b1 = x;
  } else if (hPrime < 4) {
    g1 = x;
    b1 = c;
  } else if (hPrime < 5) {
    r1 = x;
    b1 = c;
  } else {
    r1 = c;
    b1 = x;
  }

  const m = l - c / 2;
  return [
    clampByte(Math.round((r1 + m) * 255)),
    clampByte(Math.round((g1 + m) * 255)),
    clampByte(Math.round((b1 + m) * 255)),
  ];
}

#####/tools/lib/png.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import fs from "node:fs";
import path from "node:path";
import { PNG } from "pngjs";
import jpeg from "jpeg-js";

export function readImage(filePath) {
  const buffer = fs.readFileSync(filePath);
  const ext = path.extname(filePath).toLowerCase();
  if (ext === ".png") {
    const png = PNG.sync.read(buffer);
    return { width: png.width, height: png.height, data: new Uint8Array(png.data) };
  }
  if (ext === ".jpg" || ext === ".jpeg") {
    const decoded = jpeg.decode(buffer, { useTArray: true });
    return { width: decoded.width, height: decoded.height, data: decoded.data };
  }
  throw new Error("Unsupported image format (expected .png or .jpg)");
}

export function writeImage(filePath, width, height, data, options = {}) {
  const ext = path.extname(filePath).toLowerCase();
  const expectedLength = width * height * 4;
  if (data.length !== expectedLength) {
    throw new Error("RGBA buffer length does not match width * height * 4");
  }

  if (ext === ".png") {
    const png = new PNG({ width, height });
    png.data = Buffer.from(data);
    const buffer = PNG.sync.write(png);
    fs.writeFileSync(filePath, buffer);
    return;
  }

  if (ext === ".jpg" || ext === ".jpeg") {
    const quality = Number.isInteger(options.quality) ? options.quality : 90;
    const encoded = jpeg.encode({ data: Buffer.from(data), width, height }, quality);
    fs.writeFileSync(filePath, encoded.data);
    return;
  }

  throw new Error("Unsupported output format (expected .png or .jpg)");
}

#####/tools/lib/render.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { CONTROL_BYTE_MASKS, groupMaskTargetsGroup } from "./format.js";
import { TimingInterpreter } from "./timing.js";
import { applyOpcode } from "./opcodes.js";

const ACTIVE_THRESHOLD = 0.5;
const USE_PACKED_OUTPUT = isLittleEndian();

export function renderToTick(file, tick) {
  if (!Number.isInteger(tick) || tick < 0) {
    throw new Error("Tick must be a non-negative integer");
  }
  const state = createRenderState(file);
  let output = new Uint8Array(file.pixels.length * 4);
  for (let t = 0; t <= tick; t += 1) {
    output = renderFrame(file, t, state);
  }
  return output;
}

export function renderFrame(file, tick, state) {
  const output = new Uint8Array(file.pixels.length * 4);
  const output32 =
    USE_PACKED_OUTPUT && output.byteLength % 4 === 0 ? new Uint32Array(output.buffer) : null;
  const activeRules = evaluateActiveRules(file.rules, tick);

  for (let i = 0; i < file.pixels.length; i += 1) {
    const source = file.pixels[i];
    if (!source) {
      continue;
    }
    const control = state.controlBytes[i] ?? source.c;
    const outputIndex = i * 4;

    if ((control & CONTROL_BYTE_MASKS.LOCK) !== 0) {
      if (output32) {
        output32[i] = packRgba(source.r, source.g, source.b, source.a);
      } else {
        output[outputIndex] = source.r;
        output[outputIndex + 1] = source.g;
        output[outputIndex + 2] = source.b;
        output[outputIndex + 3] = source.a;
      }
      continue;
    }

    const working = {
      r: source.r,
      g: source.g,
      b: source.b,
      a: source.a,
      c: control,
    };
    const groupId = control & CONTROL_BYTE_MASKS.GROUP_ID;

    for (const rule of activeRules) {
      if (groupMaskTargetsGroup(rule.groupMask, groupId)) {
        applyOpcode(rule.opcode, working, tick, rule.timing);
      }
    }

    state.controlBytes[i] = working.c & ~CONTROL_BYTE_MASKS.RESERVED;
    if (output32) {
      output32[i] = packRgba(working.r, working.g, working.b, working.a);
    } else {
      output[outputIndex] = working.r;
      output[outputIndex + 1] = working.g;
      output[outputIndex + 2] = working.b;
      output[outputIndex + 3] = working.a;
    }
  }

  return output;
}

export function renderGroupMap(file) {
  const output = new Uint8Array(file.pixels.length * 4);
  const output32 =
    USE_PACKED_OUTPUT && output.byteLength % 4 === 0 ? new Uint32Array(output.buffer) : null;
  for (let i = 0; i < file.pixels.length; i += 1) {
    const source = file.pixels[i];
    if (!source) {
      continue;
    }
    const groupId = source.c & CONTROL_BYTE_MASKS.GROUP_ID;
    const color = GROUP_COLORS[groupId] ?? [0, 0, 0];
    const offset = i * 4;
    if (output32) {
      output32[i] = packRgba(color[0], color[1], color[2], 255);
    } else {
      output[offset] = color[0];
      output[offset + 1] = color[1];
      output[offset + 2] = color[2];
      output[offset + 3] = 255;
    }
  }
  return output;
}

export function createRenderState(file) {
  const controlBytes = new Uint8Array(file.pixels.length);
  file.pixels.forEach((pixel, index) => {
    controlBytes[index] = pixel.c & ~CONTROL_BYTE_MASKS.RESERVED;
  });
  return { controlBytes };
}

function evaluateActiveRules(rules, tick) {
  return rules.filter((rule) => TimingInterpreter.evaluate(rule.timing, tick) > ACTIVE_THRESHOLD);
}

function isLittleEndian() {
  const buffer = new ArrayBuffer(4);
  new DataView(buffer).setUint32(0, 0x0a0b0c0d, true);
  return new Uint8Array(buffer)[0] === 0x0d;
}

function packRgba(r, g, b, a) {
  return (r | (g << 8) | (b << 16) | (a << 24)) >>> 0;
}

const GROUP_COLORS = [
  [230, 57, 70],
  [29, 53, 87],
  [69, 123, 157],
  [168, 218, 220],
  [241, 250, 238],
  [255, 183, 3],
  [251, 133, 0],
  [33, 158, 188],
  [142, 202, 230],
  [0, 109, 119],
  [131, 56, 236],
  [255, 0, 110],
  [76, 201, 240],
  [6, 214, 160],
  [239, 71, 111],
  [17, 138, 178],
];

#####/tools/lib/timing.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export const TimingInterpreter = {
  getPeriod(timing) {
    return (timing & 0x0f) + 1;
  },

  getWaveform(timing) {
    const waveform = (timing >> 4) & 0x03;
    switch (waveform) {
      case 0:
        return "square";
      case 1:
        return "triangle";
      case 2:
        return "sine";
      default:
        return "sawtooth";
    }
  },

  getPhaseOffset(timing) {
    return (timing >> 6) & 0x03;
  },

  evaluate(timing, tick) {
    const period = this.getPeriod(timing);
    const phaseOffset = this.getPhaseOffset(timing) / 4;
    const position = ((tick / period) + phaseOffset) % 1;
    switch (this.getWaveform(timing)) {
      case "square":
        return position < 0.5 ? 0 : 1;
      case "triangle":
        return position < 0.5 ? position * 2 : 2 - position * 2;
      case "sine":
        return 0.5 - 0.5 * Math.cos(2 * Math.PI * position);
      case "sawtooth":
        return position;
      default:
        return 0;
    }
  },
};

#####/tools/lib/validation.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import {
  CONTROL_BYTE_MASKS,
  HEADER_SIZE_BYTES,
  MAGIC_BYTES,
  MAX_RULE_COUNT,
  PIXEL_SIZE_BYTES,
  VERSION_MAJOR,
  VERSION_MINOR,
} from "./format.js";

export function validateMagic(bytes) {
  if (bytes.length !== MAGIC_BYTES.length) {
    return fail(`Magic must be ${MAGIC_BYTES.length} bytes`);
  }
  for (let i = 0; i < MAGIC_BYTES.length; i += 1) {
    if (bytes[i] !== MAGIC_BYTES[i]) {
      return fail("Magic bytes do not match GRIN");
    }
  }
  return ok();
}

export function validateVersion(major, minor) {
  if (!Number.isInteger(major) || !Number.isInteger(minor)) {
    return fail("Version fields must be integers");
  }
  if (major !== VERSION_MAJOR || minor !== VERSION_MINOR) {
    return warn("Unexpected GRIN version");
  }
  return ok();
}

export function validateHeaderSize(size) {
  if (size !== HEADER_SIZE_BYTES) {
    return fail(`HeaderSize must be ${HEADER_SIZE_BYTES}`);
  }
  return ok();
}

export function validateDimensions(width, height) {
  if (!Number.isInteger(width) || !Number.isInteger(height)) {
    return fail("Width and height must be integers");
  }
  if (width < 0 || height < 0) {
    return fail("Width and height must be non-negative");
  }
  if (width > 0xffffffff || height > 0xffffffff) {
    return fail("Width and height must fit in uint32");
  }
  return ok();
}

export function validateTickMicros(tick) {
  if (!Number.isInteger(tick) || tick < 0 || tick > 0xffffffff) {
    return fail("TickMicros must fit in uint32");
  }
  return ok();
}

export function validateRuleCount(count) {
  if (!Number.isInteger(count) || count < 0 || count > MAX_RULE_COUNT) {
    return fail(`RuleCount must be 0-${MAX_RULE_COUNT}`);
  }
  return ok();
}

export function validateOpcodeSetId(id) {
  if (!Number.isInteger(id) || id < 0 || id > 0xff) {
    return fail("OpcodeSetId must fit in uint8");
  }
  if (id !== 0) {
    return fail("Unknown OpcodeSetId");
  }
  return ok();
}

export function validatePixelDataLength(length, width, height) {
  if (length < 0n) {
    return fail("PixelDataLength must be non-negative");
  }
  const dimResult = validateDimensions(width, height);
  if (!dimResult.ok) {
    return dimResult;
  }
  const expected = BigInt(width) * BigInt(height) * BigInt(PIXEL_SIZE_BYTES);
  if (length !== expected) {
    return fail("PixelDataLength does not match width * height * 5");
  }
  return ok();
}

export function validateFileLength(fileLen, dataLen) {
  if (fileLen < 0n) {
    return fail("FileLength must be non-negative");
  }
  const minLen = BigInt(HEADER_SIZE_BYTES) + dataLen;
  if (fileLen !== 0n && fileLen < minLen) {
    return fail("FileLength is smaller than header + pixel data");
  }
  return ok();
}

export function validatePixelDataOffset(offset) {
  if (offset !== BigInt(HEADER_SIZE_BYTES)) {
    return fail("PixelDataOffset64 must be 128");
  }
  return ok();
}

export function validateReservedFields(reservedA, reservedB, flags) {
  if (flags !== 0 || reservedA !== 0n || reservedB !== 0n) {
    return warn("Reserved header fields are non-zero");
  }
  return ok();
}

export function validateControlByte(controlByte) {
  const errors = [];
  const warnings = [];

  if (!Number.isInteger(controlByte) || controlByte < 0 || controlByte > 0xff) {
    errors.push("Control byte must fit in uint8");
  } else {
    const groupResult = validateGroupId(controlByte & CONTROL_BYTE_MASKS.GROUP_ID);
    mergeResult(errors, warnings, groupResult);
    const reservedResult = validateReservedBits(controlByte);
    mergeResult(errors, warnings, reservedResult);
  }

  return finalize(errors, warnings);
}

export function validateGroupId(groupId) {
  if (!Number.isInteger(groupId) || groupId < 0 || groupId > 0x0f) {
    return fail("Group ID must be 0-15");
  }
  return ok();
}

export function validateReservedBits(controlByte) {
  if ((controlByte & CONTROL_BYTE_MASKS.RESERVED) !== 0) {
    return warn("Control byte reserved bits are non-zero");
  }
  return ok();
}

export function validateGroupMask(mask) {
  if (!Number.isInteger(mask) || mask < 0 || mask > 0xffff) {
    return fail("GroupMask must fit in uint16");
  }
  return ok();
}

export function validateOpcode(opcode, opcodeSetId) {
  if (!Number.isInteger(opcode) || opcode < 0 || opcode > 0xff) {
    return fail("Opcode must fit in uint8");
  }
  if (opcodeSetId !== 0) {
    return fail("Unknown OpcodeSetId");
  }
  if (opcode > 0x0c) {
    return fail("Unknown opcode for base set");
  }
  return ok();
}

export function validateTiming(timing) {
  if (!Number.isInteger(timing) || timing < 0 || timing > 0xff) {
    return fail("Timing must fit in uint8");
  }
  return ok();
}

export function validateGrinFile(file, mode = "permissive") {
  const errors = [];
  const warnings = [];
  const info = [];

  const header = file.header;
  mergeResult(errors, warnings, validateMagic(header.magic));
  mergeResult(errors, warnings, validateVersion(header.versionMajor, header.versionMinor));
  mergeResult(errors, warnings, validateHeaderSize(header.headerSize));
  mergeResult(errors, warnings, validateDimensions(header.width, header.height));
  mergeResult(errors, warnings, validateTickMicros(header.tickMicros));
  mergeResult(errors, warnings, validateRuleCount(header.ruleCount));
  mergeResult(errors, warnings, validateOpcodeSetId(header.opcodeSetId));
  mergeResult(
    errors,
    warnings,
    validatePixelDataLength(header.pixelDataLength, header.width, header.height)
  );
  mergeResult(errors, warnings, validateFileLength(header.fileLength, header.pixelDataLength));
  mergeResult(errors, warnings, validatePixelDataOffset(header.pixelDataOffset));
  mergeResult(errors, warnings, validateReservedFields(header.reservedA, header.reservedB, header.flags));

  const expectedPixelCount = header.width * header.height;
  if (!Number.isSafeInteger(expectedPixelCount) || expectedPixelCount < 0) {
    errors.push("Pixel count exceeds safe integer range");
  } else if (file.pixels.length !== expectedPixelCount) {
    errors.push("Pixel array length does not match header dimensions");
  }

  if (file.rules.length !== header.ruleCount) {
    errors.push("Rule array length does not match header ruleCount");
  }

  let reservedBitsCount = 0;
  for (const pixel of file.pixels) {
    if ((pixel.c & CONTROL_BYTE_MASKS.RESERVED) !== 0) {
      reservedBitsCount += 1;
    }
  }
  if (reservedBitsCount > 0) {
    warnings.push(`Control byte reserved bits set on ${reservedBitsCount} pixels`);
  }

  file.rules.forEach((rule, index) => {
    const groupMaskResult = validateGroupMask(rule.groupMask);
    const opcodeResult = validateOpcode(rule.opcode, header.opcodeSetId);
    const timingResult = validateTiming(rule.timing);
    prefixResult(errors, warnings, groupMaskResult, `Rule ${index}: `);
    prefixResult(errors, warnings, opcodeResult, `Rule ${index}: `);
    prefixResult(errors, warnings, timingResult, `Rule ${index}: `);
  });

  info.push(`Pixels: ${file.pixels.length}`);
  info.push(`Rules: ${file.rules.length}`);

  const okResult =
    mode === "strict" ? errors.length === 0 && warnings.length === 0 : errors.length === 0;
  return { ok: okResult, errors, warnings, info };
}

function ok() {
  return { ok: true, errors: [], warnings: [] };
}

function warn(message) {
  return { ok: true, errors: [], warnings: [message] };
}

function fail(message) {
  return { ok: false, errors: [message], warnings: [] };
}

function finalize(errors, warnings) {
  return { ok: errors.length === 0, errors, warnings };
}

function mergeResult(errors, warnings, result) {
  errors.push(...result.errors);
  warnings.push(...result.warnings);
}

function prefixResult(errors, warnings, result, prefix) {
  errors.push(...result.errors.map((error) => `${prefix}${error}`));
  warnings.push(...result.warnings.map((warning) => `${prefix}${warning}`));
}

#####/tools/package-lock.json#####
{
  "name": "@grin-format/tools",
  "version": "0.1.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "@grin-format/tools",
      "version": "0.1.0",
      "dependencies": {
        "gif-encoder-2": "^1.0.5",
        "jpeg-js": "^0.4.4",
        "pngjs": "^7.0.0"
      },
      "bin": {
        "grin-decode": "bin/grin-decode.js",
        "grin-encode": "bin/grin-encode.js",
        "grin-inspect": "bin/grin-inspect.js",
        "grin-validate": "bin/grin-validate.js"
      },
      "engines": {
        "node": ">=18.0.0"
      }
    },
    "node_modules/gif-encoder-2": {
      "version": "1.0.5",
      "resolved": "https://registry.npmjs.org/gif-encoder-2/-/gif-encoder-2-1.0.5.tgz",
      "integrity": "sha512-fsRAKbZuUoZ7FYGjpFElmflTkKwsn/CzAmL/xDl4558aTAgysIDCUF6AXWO8dmai/ApfZACbPVAM+vPezJXlFg=="
    },
    "node_modules/jpeg-js": {
      "version": "0.4.4",
      "resolved": "https://registry.npmjs.org/jpeg-js/-/jpeg-js-0.4.4.tgz",
      "integrity": "sha512-WZzeDOEtTOBK4Mdsar0IqEU5sMr3vSV2RqkAIzUEV2BHnUfKGyswWFPFwK5EeDo93K3FohSHbLAjj0s1Wzd+dg=="
    },
    "node_modules/pngjs": {
      "version": "7.0.0",
      "resolved": "https://registry.npmjs.org/pngjs/-/pngjs-7.0.0.tgz",
      "integrity": "sha512-LKWqWJRhstyYo9pGvgor/ivk2w94eSjE3RGVuzLGlr3NmD8bf7RcYGze1mNdEHRP6TRP6rMuDHk5t44hnTRyow==",
      "engines": {
        "node": ">=14.19.0"
      }
    }
  }
}

#####/tools/package.json#####
{
  "name": "@grin-format/tools",
  "version": "0.1.0",
  "description": "GRIN CLI utilities (validate, inspect, encode, decode)",
  "type": "module",
  "bin": {
    "grin-validate": "./bin/grin-validate.js",
    "grin-inspect": "./bin/grin-inspect.js",
    "grin-encode": "./bin/grin-encode.js",
    "grin-decode": "./bin/grin-decode.js"
  },
  "scripts": {
    "lint": "echo \"no lint configured\"",
    "test": "echo \"no tests configured\""
  },
  "dependencies": {
    "gif-encoder-2": "^1.0.5",
    "jpeg-js": "^0.4.4",
    "pngjs": "^7.0.0"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}

#####/web/demo/demo.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import {
  GrinCanvasRenderer,
  GrinLoader,
  GrinPlayer,
  OpcodeRegistry,
  RAFTickScheduler,
  RuleEngine,
} from "../dist/grin.js";

const canvas = document.getElementById("previewCanvas");
const playButton = document.getElementById("playButton");
const pauseButton = document.getElementById("pauseButton");
const stopButton = document.getElementById("stopButton");
const seekSlider = document.getElementById("seekSlider");
const metadata = document.getElementById("metadata");
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const sampleList = document.getElementById("sampleList");

const renderer = new GrinCanvasRenderer();
let player = null;

const schedulerFactory = (tickMicros) => new RAFTickScheduler(tickMicros);

const makePlayer = () =>
  new GrinPlayer(schedulerFactory, new RuleEngine(), OpcodeRegistry.getInstance(), () => {
    if (!player) return;
    renderer.render(player.getCurrentFrame(), canvas);
  });

async function loadFile(file) {
  const grinFile = await GrinLoader.fromFile(file);
  initializePlayer(grinFile);
}

async function loadFromUrl(url) {
  const grinFile = await GrinLoader.fromURL(url);
  initializePlayer(grinFile);
}

function initializePlayer(grinFile) {
  player = makePlayer();
  player.load(grinFile);
  canvas.width = grinFile.header.width;
  canvas.height = grinFile.header.height;
  renderer.render(player.getCurrentFrame(), canvas);
  metadata.textContent = [
    `Dimensions: ${grinFile.header.width} × ${grinFile.header.height}`,
    `Rules: ${grinFile.header.ruleCount}`,
    `Tick Rate: ${grinFile.header.tickMicros} µs`,
  ].join("\n");
  seekSlider.value = "0";
}

playButton.addEventListener("click", () => {
  if (!player) return;
  player.play();
});

pauseButton.addEventListener("click", () => {
  player?.pause();
});

stopButton.addEventListener("click", () => {
  if (!player) return;
  player.stop();
  seekSlider.value = "0";
  renderer.render(player.getCurrentFrame(), canvas);
});

seekSlider.addEventListener("input", (event) => {
  if (!player) return;
  const value = Number(event.target.value);
  player.seek(value);
  renderer.render(player.getCurrentFrame(), canvas);
});

dropZone.addEventListener("dragover", (event) => {
  event.preventDefault();
  dropZone.classList.add("dragover");
});

dropZone.addEventListener("dragleave", () => {
  dropZone.classList.remove("dragover");
});

dropZone.addEventListener("drop", (event) => {
  event.preventDefault();
  dropZone.classList.remove("dragover");
  const file = event.dataTransfer.files[0];
  if (file) {
    loadFile(file);
  }
});

fileInput.addEventListener("change", (event) => {
  const file = event.target.files[0];
  if (file) {
    loadFile(file);
  }
});

async function loadSamples() {
  try {
    const response = await fetch("./samples/samples.json");
    if (!response.ok) {
      sampleList.innerHTML = "<li>No samples available</li>";
      return;
    }
    const samples = await response.json();
    sampleList.innerHTML = "";
    samples.forEach((sample) => {
      const li = document.createElement("li");
      li.textContent = sample.name;
      li.addEventListener("click", () => loadFromUrl(sample.path));
      sampleList.appendChild(li);
    });
  } catch (error) {
    sampleList.innerHTML = "<li>No samples available</li>";
  }
}

loadSamples();

#####/web/demo/index.html#####
<!doctype html>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GRIN Web Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="noise"></div>
    <main class="app">
      <header class="hero">
        <div>
          <p class="eyebrow">GRIN FORMAT</p>
          <h1>Graphic Readdressable Indexed Nodes</h1>
          <p class="subtitle">
            Deterministic playback, bounded cost, and strict validation. Drag a file to
            see it pulse.
          </p>
        </div>
        <div class="drop" id="dropZone">
          <span>Drop a .grin file</span>
          <label class="file-button">
            <input id="fileInput" type="file" accept=".grin,.grn" />
            Choose file
          </label>
        </div>
      </header>

      <section class="stage">
        <div class="panel">
          <h2>Playback</h2>
          <div class="controls">
            <button id="playButton">Play</button>
            <button id="pauseButton">Pause</button>
            <button id="stopButton">Stop</button>
          </div>
          <label class="slider">
            <span>Seek</span>
            <input id="seekSlider" type="range" min="0" max="1000" value="0" />
          </label>
          <div class="meta" id="metadata">
            <p>Load a file to see metadata.</p>
          </div>
        </div>

        <div class="screen">
          <canvas id="previewCanvas"></canvas>
          <div class="badge">Live RGBA Buffer</div>
        </div>
      </section>

      <section class="samples">
        <div>
          <h2>Sample Gallery</h2>
          <p>Quick-start with bundled samples.</p>
        </div>
        <ul id="sampleList"></ul>
      </section>
    </main>

    <script type="module" src="./demo.js"></script>
  </body>
</html>

#####/web/demo/samples/samples.json#####
[
  {
    "name": "Minimal 1×1",
    "path": "./samples/minimal.grin"
  }
]

#####/web/demo/styles.css#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
:root {
  color-scheme: light;
  --ink: #111111;
  --mist: #f7f5ef;
  --accent: #ff6b6b;
  --accent-dark: #d64545;
  --teal: #3dd6d0;
  --sun: #f2c94c;
  --panel: rgba(255, 255, 255, 0.85);
  --border: rgba(17, 17, 17, 0.12);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: "Space Grotesk", system-ui, sans-serif;
  color: var(--ink);
  background: radial-gradient(circle at top left, #fef7e6 0%, #eef9f5 45%, #f2f5ff 100%);
  min-height: 100vh;
}

.noise {
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cg fill='%23000' fill-opacity='0.04'%3E%3Ccircle cx='12' cy='20' r='2'/%3E%3Ccircle cx='70' cy='40' r='1.5'/%3E%3Ccircle cx='100' cy='90' r='2'/%3E%3Ccircle cx='30' cy='100' r='1.2'/%3E%3C/g%3E%3C/svg%3E");
  mix-blend-mode: multiply;
  pointer-events: none;
  opacity: 0.5;
}

.app {
  max-width: 1100px;
  margin: 0 auto;
  padding: 48px 24px 72px;
  position: relative;
  z-index: 1;
}

.hero {
  display: grid;
  grid-template-columns: minmax(0, 1fr) minmax(0, 280px);
  gap: 32px;
  align-items: center;
  margin-bottom: 48px;
}

.eyebrow {
  font-family: "IBM Plex Mono", monospace;
  text-transform: uppercase;
  letter-spacing: 0.24em;
  font-size: 0.75rem;
  color: rgba(17, 17, 17, 0.6);
  margin: 0 0 12px;
}

h1 {
  margin: 0;
  font-size: clamp(2.2rem, 4vw, 3.2rem);
  line-height: 1.05;
}

.subtitle {
  font-size: 1.1rem;
  line-height: 1.6;
  max-width: 520px;
}

.drop {
  display: grid;
  gap: 12px;
  padding: 24px;
  border-radius: 18px;
  background: var(--panel);
  border: 1px dashed var(--border);
  text-align: center;
  font-weight: 600;
}

.file-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--ink);
  color: white;
  cursor: pointer;
  font-weight: 600;
}

.file-button input {
  display: none;
}

.stage {
  display: grid;
  grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
  gap: 28px;
  align-items: stretch;
  margin-bottom: 48px;
}

.panel {
  background: var(--panel);
  border-radius: 20px;
  padding: 24px;
  border: 1px solid var(--border);
  box-shadow: 0 20px 45px rgba(17, 17, 17, 0.08);
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 16px 0;
}

button {
  border: none;
  background: var(--accent);
  color: white;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}

button:nth-child(2) {
  background: var(--teal);
}

button:nth-child(3) {
  background: var(--accent-dark);
}

.slider {
  display: grid;
  gap: 8px;
  font-weight: 600;
}

.slider input[type="range"] {
  width: 100%;
}

.meta {
  font-family: "IBM Plex Mono", monospace;
  background: rgba(17, 17, 17, 0.05);
  border-radius: 12px;
  padding: 12px;
  margin-top: 16px;
  font-size: 0.85rem;
  white-space: pre-line;
}

.screen {
  position: relative;
  background: #0d0d0d;
  border-radius: 24px;
  padding: 16px;
  min-height: 360px;
  display: grid;
  place-items: center;
  box-shadow: 0 30px 60px rgba(17, 17, 17, 0.25);
}

.screen canvas {
  width: 100%;
  height: auto;
  border-radius: 16px;
  background: #000;
}

.badge {
  position: absolute;
  top: 18px;
  right: 18px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 0.75rem;
  backdrop-filter: blur(10px);
}

.samples {
  display: grid;
  gap: 16px;
}

.samples ul {
  list-style: none;
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}

.samples li {
  background: var(--panel);
  border-radius: 14px;
  padding: 12px 14px;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.samples li:hover {
  transform: translateY(-3px);
}

@media (max-width: 860px) {
  .hero {
    grid-template-columns: 1fr;
  }
  .stage {
    grid-template-columns: 1fr;
  }
}

#####/web/lib/display-buffer.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export class DisplayBuffer {
  width: number;
  height: number;
  rgbaData: Uint8ClampedArray;

  constructor(width: number, height: number) {
    if (!Number.isInteger(width) || !Number.isInteger(height) || width <= 0 || height <= 0) {
      throw new Error("DisplayBuffer dimensions must be positive integers");
    }
    this.width = width;
    this.height = height;
    this.rgbaData = new Uint8ClampedArray(width * height * 4);
  }

  clear(): void {
    this.rgbaData.fill(0);
  }

  setPixel(x: number, y: number, r: number, g: number, b: number, a: number): void {
    if (!Number.isInteger(x) || !Number.isInteger(y)) {
      throw new RangeError("Pixel coordinates must be integers");
    }
    if (x < 0 || y < 0 || x >= this.width || y >= this.height) {
      throw new RangeError("Pixel coordinates out of bounds");
    }
    const offset = (y * this.width + x) * 4;
    this.rgbaData[offset] = r & 0xff;
    this.rgbaData[offset + 1] = g & 0xff;
    this.rgbaData[offset + 2] = b & 0xff;
    this.rgbaData[offset + 3] = a & 0xff;
  }

  toImageData(): ImageData {
    if (typeof ImageData === "undefined") {
      throw new Error("ImageData is not available in this environment");
    }
    return new ImageData(this.rgbaData, this.width, this.height);
  }
}

#####/web/lib/endianness.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export function writeUint16LE(value: number): Uint8Array {
  const buffer = new ArrayBuffer(2);
  const view = new DataView(buffer);
  view.setUint16(0, value & 0xffff, true);
  return new Uint8Array(buffer);
}

export function writeUint32LE(value: number): Uint8Array {
  const buffer = new ArrayBuffer(4);
  const view = new DataView(buffer);
  view.setUint32(0, value >>> 0, true);
  return new Uint8Array(buffer);
}

export function writeUint64LE(value: bigint): Uint8Array {
  const buffer = new ArrayBuffer(8);
  const view = new DataView(buffer);
  view.setBigUint64(0, value, true);
  return new Uint8Array(buffer);
}

export function readUint16LE(bytes: Uint8Array, offset: number): number {
  ensureRange(bytes, offset, 2);
  const view = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
  return view.getUint16(offset, true);
}

export function readUint32LE(bytes: Uint8Array, offset: number): number {
  ensureRange(bytes, offset, 4);
  const view = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
  return view.getUint32(offset, true);
}

export function readUint64LE(bytes: Uint8Array, offset: number): bigint {
  ensureRange(bytes, offset, 8);
  const view = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
  return view.getBigUint64(offset, true);
}

function ensureRange(bytes: Uint8Array, offset: number, length: number): void {
  if (offset < 0 || offset + length > bytes.length) {
    throw new RangeError("Read exceeds buffer length");
  }
}

#####/web/lib/format.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
// Spec references: §§4, 4.1, 7.2-7.4 (grin_technical_specification_v_2.md)

export const MAGIC_BYTES = new Uint8Array([0x47, 0x52, 0x49, 0x4e]); // "GRIN"
export const VERSION_MAJOR = 0x00;
export const VERSION_MINOR = 0x00;
export const HEADER_SIZE_BYTES = 128;
export const PIXEL_SIZE_BYTES = 5;
export const MAX_RULE_COUNT = 16;
export const RULES_BLOCK_SIZE = 64;
export const RULE_ENTRY_SIZE = 4;

export const HEADER_FIELDS = {
  MAGIC: { offset: 0, size: 4 },
  VERSION_MAJOR: { offset: 4, size: 1 },
  VERSION_MINOR: { offset: 5, size: 1 },
  HEADER_SIZE: { offset: 6, size: 2 },
  WIDTH: { offset: 8, size: 4 },
  HEIGHT: { offset: 12, size: 4 },
  TICK_MICROS: { offset: 16, size: 4 },
  RULE_COUNT: { offset: 20, size: 1 },
  OPCODE_SET_ID: { offset: 21, size: 1 },
  FLAGS: { offset: 22, size: 2 },
  PIXEL_DATA_LENGTH: { offset: 24, size: 8 },
  FILE_LENGTH: { offset: 32, size: 8 },
  PIXEL_DATA_OFFSET: { offset: 40, size: 8 },
  RESERVED_A: { offset: 48, size: 8 },
  RESERVED_B: { offset: 56, size: 8 },
  RULES_BLOCK: { offset: 64, size: 64 },
} as const;

export const RULE_ENTRY_FIELDS = {
  GROUP_MASK: { offset: 0, size: 2 },
  OPCODE: { offset: 2, size: 1 },
  TIMING: { offset: 3, size: 1 },
} as const;

export const TIMING_SEMANTICS = "reader-defined oscillator control";

export function groupMaskTargetsGroup(groupMask: number, groupId: number): boolean {
  const shift = groupId & 0x0f;
  return (groupMask & (1 << shift)) !== 0;
}

export const PIXEL_FIELDS = {
  R: { offset: 0, size: 1 },
  G: { offset: 1, size: 1 },
  B: { offset: 2, size: 1 },
  A: { offset: 3, size: 1 },
  C: { offset: 4, size: 1 },
} as const;

export const CONTROL_BYTE_MASKS = {
  GROUP_ID: 0x0f,
  RESERVED: 0x70,
  LOCK: 0x80,
} as const;

export function getGroupId(controlByte: number): number {
  return controlByte & CONTROL_BYTE_MASKS.GROUP_ID;
}

export function isLocked(controlByte: number): boolean {
  return (controlByte & CONTROL_BYTE_MASKS.LOCK) !== 0;
}

export function setGroupId(controlByte: number, groupId: number): number {
  const cleared = controlByte & ~CONTROL_BYTE_MASKS.GROUP_ID;
  return cleared | (groupId & CONTROL_BYTE_MASKS.GROUP_ID);
}

export function setLocked(controlByte: number, locked: boolean): number {
  if (locked) {
    return controlByte | CONTROL_BYTE_MASKS.LOCK;
  }
  return controlByte & ~CONTROL_BYTE_MASKS.LOCK;
}

#####/web/lib/grin-canvas.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { DisplayBuffer } from "./display-buffer";

export class GrinCanvasRenderer {
  private imageData: ImageData | null = null;

  render(displayBuffer: DisplayBuffer, canvas: HTMLCanvasElement | OffscreenCanvas): void {
    const width = displayBuffer.width;
    const height = displayBuffer.height;
    const context = canvas.getContext("2d");
    if (!context) {
      throw new Error("Unable to obtain 2D context");
    }
    if (!this.imageData || this.imageData.width !== width || this.imageData.height !== height) {
      this.imageData = new ImageData(width, height);
    }
    this.imageData.data.set(displayBuffer.rgbaData);
    context.putImageData(this.imageData, 0, 0);
  }
}

#####/web/lib/grin-element.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { GrinFile } from "./grin-file";
import { GrinCanvasRenderer } from "./grin-canvas";
import { GrinLoader } from "./grin-loader";
import { GrinPlayer } from "./grin-player";
import { OpcodeRegistry } from "./opcode-registry";
import { RAFTickScheduler, TickScheduler } from "./tick-scheduler";
import { RuleEngine } from "./rule-engine";

export class GrinPlayerElement extends HTMLElement {
  static get observedAttributes(): string[] {
    return ["src", "autoplay", "playbackrate"];
  }

  private canvas: HTMLCanvasElement;
  private renderer: GrinCanvasRenderer;
  private player: GrinPlayer | null = null;
  private file: GrinFile | null = null;
  private autoplay = false;
  private playbackRate = 1;

  constructor() {
    super();
    const shadow = this.attachShadow({ mode: "open" });
    const container = document.createElement("div");
    container.className = "grin-player";
    this.canvas = document.createElement("canvas");
    this.canvas.width = 1;
    this.canvas.height = 1;
    container.appendChild(this.canvas);

    const style = document.createElement("style");
    style.textContent = `
      :host {
        display: block;
        font-family: "Space Grotesk", system-ui, sans-serif;
        color: #101010;
      }
      .grin-player {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: radial-gradient(circle at 20% 20%, #f2f5ff, #e7f6ef 55%, #fef3e3 100%);
        border: 1px solid rgba(16, 16, 16, 0.08);
        box-shadow: 0 12px 32px rgba(16, 16, 16, 0.12);
        padding: 12px;
      }
      canvas {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 12px;
        background: #000;
      }
    `;

    shadow.appendChild(style);
    shadow.appendChild(container);

    this.renderer = new GrinCanvasRenderer();
  }

  connectedCallback(): void {
    this.autoplay = this.hasAttribute("autoplay");
    this.playbackRate = this.parsePlaybackRate(this.getAttribute("playbackrate"));

    const src = this.getAttribute("src");
    if (src) {
      void this.loadFromUrl(src);
    }
  }

  disconnectedCallback(): void {
    this.player?.pause();
  }

  attributeChangedCallback(name: string, _oldValue: string | null, newValue: string | null): void {
    switch (name) {
      case "src":
        if (newValue) {
          void this.loadFromUrl(newValue);
        }
        break;
      case "autoplay":
        this.autoplay = newValue !== null;
        if (this.autoplay) {
          this.player?.play();
        }
        break;
      case "playbackrate":
        this.playbackRate = this.parsePlaybackRate(newValue);
        if (this.file) {
          this.loadFile(this.file);
        }
        break;
    }
  }

  play(): void {
    this.player?.play();
  }

  pause(): void {
    this.player?.pause();
  }

  get currentTime(): number {
    return this.player?.getCurrentTick() ?? 0;
  }

  set currentTime(tick: number) {
    if (!this.player) {
      return;
    }
    if (!Number.isInteger(tick) || tick < 0) {
      return;
    }
    this.player.seek(tick);
  }

  getCurrentFrame(): ImageData | null {
    if (!this.player) {
      return null;
    }
    const buffer = this.player.getCurrentFrame();
    return new ImageData(buffer.rgbaData, buffer.width, buffer.height);
  }

  private async loadFromUrl(url: string): Promise<void> {
    const file = await GrinLoader.fromURL(url);
    this.loadFile(file);
  }

  private loadFile(file: GrinFile): void {
    this.file = file;
    this.canvas.width = file.header.width;
    this.canvas.height = file.header.height;
    const schedulerFactory = (tickMicros: number): TickScheduler => {
      const scaled = Math.max(1, Math.floor(tickMicros / this.playbackRate));
      return new RAFTickScheduler(scaled);
    };
    this.player = new GrinPlayer(
      schedulerFactory,
      new RuleEngine(),
      OpcodeRegistry.getInstance(),
      () => this.render()
    );
    this.player.load(file);
    this.render();
    if (this.autoplay) {
      this.player.play();
    }
  }

  private render(): void {
    if (!this.player) {
      return;
    }
    const frame = this.player.getCurrentFrame();
    this.renderer.render(frame, this.canvas);
  }

  private parsePlaybackRate(value: string | null): number {
    if (!value) {
      return 1;
    }
    const parsed = Number(value);
    if (!Number.isFinite(parsed) || parsed <= 0) {
      return 1;
    }
    return parsed;
  }
}

if (typeof window !== "undefined" && !customElements.get("grin-player")) {
  customElements.define("grin-player", GrinPlayerElement);
}

#####/web/lib/grin-file.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import {
  HEADER_SIZE_BYTES,
  MAX_RULE_COUNT,
  PIXEL_SIZE_BYTES,
  RULE_ENTRY_SIZE,
  RULES_BLOCK_SIZE,
} from "./format";
import { GrinHeader } from "./grin-header";
import { GrinImage } from "./grin-image";
import { GrinPixel } from "./grin-pixel";
import { GrinRule } from "./grin-rule";
import { writePixelData } from "./grin-io";

export class GrinFile {
  header: GrinHeader;
  pixels: GrinPixel[];
  rules: GrinRule[];

  constructor(header: GrinHeader, pixels: GrinPixel[], rules: GrinRule[]) {
    this.header = header;
    this.pixels = pixels;
    this.rules = rules;
  }

  static load(input: ArrayBuffer | Uint8Array | string): GrinFile {
    if (typeof input === "string") {
      const fs = getNodeFs();
      if (!fs) {
        throw new Error("GrinFile.load(path) is only available in Node.js");
      }
      const bytes = fs.readFileSync(input) as Uint8Array;
      return GrinFile.loadBytes(bytes);
    }
    const bytes = input instanceof Uint8Array ? input : new Uint8Array(input);
    return GrinFile.loadBytes(bytes);
  }

  toBytes(): Uint8Array {
    const rulesBlock = buildRulesBlock(this.rules);
    const pixelDataLength = BigInt(this.pixels.length) * BigInt(PIXEL_SIZE_BYTES);
    const header = this.header.clone({
      ruleCount: this.rules.length,
      rulesBlock,
      pixelDataLength,
      pixelDataOffset: BigInt(HEADER_SIZE_BYTES),
    });

    const outputLength = HEADER_SIZE_BYTES + safeNumber(pixelDataLength, "PixelDataLength");
    const output = new Uint8Array(outputLength);
    output.set(header.serialize(), 0);

    const pixelBytes = writePixelData(this.pixels);
    output.set(pixelBytes, HEADER_SIZE_BYTES);

    return output;
  }

  save(path: string): void {
    const fs = getNodeFs();
    if (!fs) {
      throw new Error("GrinFile.save(path) is only available in Node.js");
    }
    fs.writeFileSync(path, this.toBytes());
  }

  private static loadBytes(bytes: Uint8Array): GrinFile {
    if (bytes.length < HEADER_SIZE_BYTES) {
      throw new Error("Buffer too small for GRIN header");
    }

    const headerBytes = bytes.subarray(0, HEADER_SIZE_BYTES);
    const header = GrinHeader.deserialize(headerBytes);
    const validation = header.validate();
    if (!validation.ok) {
      throw new Error(`Invalid GRIN header: ${validation.errors.join("; ")}`);
    }

    const rules = parseRules(header.rulesBlock, header.ruleCount);
    const pixelOffset = safeNumber(header.pixelDataOffset, "PixelDataOffset64");
    const pixelLength = safeNumber(header.pixelDataLength, "PixelDataLength");
    if (bytes.length < pixelOffset + pixelLength) {
      throw new Error("Buffer does not contain full pixel data");
    }
    const pixelBytes = bytes.subarray(pixelOffset, pixelOffset + pixelLength);
    const pixels = parsePixels(pixelBytes, header.width, header.height);
    const image = new GrinImage(header, pixels, rules);

    return new GrinFile(image.header, image.pixels, image.rules);
  }
}

function parseRules(rulesBlock: Uint8Array, ruleCount: number): GrinRule[] {
  if (ruleCount > MAX_RULE_COUNT) {
    throw new Error(`RuleCount exceeds ${MAX_RULE_COUNT}`);
  }
  const rules: GrinRule[] = [];
  for (let i = 0; i < ruleCount; i += 1) {
    const offset = i * RULE_ENTRY_SIZE;
    const slice = rulesBlock.subarray(offset, offset + RULE_ENTRY_SIZE);
    rules.push(GrinRule.deserialize(slice));
  }
  return rules;
}

function parsePixels(pixelBytes: Uint8Array, width: number, height: number): GrinPixel[] {
  const expectedLength = width * height * PIXEL_SIZE_BYTES;
  if (!Number.isSafeInteger(expectedLength)) {
    throw new Error("Pixel data length exceeds safe integer range");
  }
  if (pixelBytes.length !== expectedLength) {
    throw new Error("Pixel data length does not match header dimensions");
  }

  const pixels: GrinPixel[] = [];
  for (let offset = 0; offset < pixelBytes.length; offset += PIXEL_SIZE_BYTES) {
    pixels.push(GrinPixel.fromBytes(pixelBytes.subarray(offset, offset + PIXEL_SIZE_BYTES)));
  }
  return pixels;
}

function buildRulesBlock(rules: GrinRule[]): Uint8Array {
  if (rules.length > MAX_RULE_COUNT) {
    throw new Error(`Rule count exceeds ${MAX_RULE_COUNT}`);
  }
  const rulesBlock = new Uint8Array(RULES_BLOCK_SIZE);
  for (let i = 0; i < rules.length; i += 1) {
    const rule = rules[i];
    if (!rule) {
      continue;
    }
    const offset = i * RULE_ENTRY_SIZE;
    rulesBlock.set(rule.serialize(), offset);
  }
  return rulesBlock;
}

function safeNumber(value: bigint, label: string): number {
  if (value > BigInt(Number.MAX_SAFE_INTEGER)) {
    throw new Error(`${label} exceeds safe integer range`);
  }
  return Number(value);
}

function getNodeFs(): typeof import("fs") | null {
  const request = Function("return typeof require === 'function' ? require : null")() as
    | ((id: string) => typeof import("fs"))
    | null;
  if (!request) {
    return null;
  }
  return request("fs");
}

#####/web/lib/grin-header.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import {
  HEADER_FIELDS,
  HEADER_SIZE_BYTES,
  MAGIC_BYTES,
  MAX_RULE_COUNT,
  PIXEL_SIZE_BYTES,
  RULES_BLOCK_SIZE,
  VERSION_MAJOR,
  VERSION_MINOR,
} from "./format";

export type GrinValidationResult = {
  ok: boolean;
  errors: string[];
  warnings: string[];
};

export type GrinHeaderInit = {
  width: number;
  height: number;
  tickMicros?: number;
  ruleCount?: number;
  opcodeSetId?: number;
  flags?: number;
  pixelDataLength?: bigint;
  fileLength?: bigint;
  pixelDataOffset?: bigint;
  reservedA?: bigint;
  reservedB?: bigint;
  rulesBlock?: Uint8Array;
  versionMajor?: number;
  versionMinor?: number;
  magic?: Uint8Array;
  headerSize?: number;
};

export class GrinHeader {
  magic: Uint8Array;
  versionMajor: number;
  versionMinor: number;
  headerSize: number;
  width: number;
  height: number;
  tickMicros: number;
  ruleCount: number;
  opcodeSetId: number;
  flags: number;
  pixelDataLength: bigint;
  fileLength: bigint;
  pixelDataOffset: bigint;
  reservedA: bigint;
  reservedB: bigint;
  rulesBlock: Uint8Array;

  constructor(init: GrinHeaderInit) {
    this.magic = copyBytes(init.magic ?? MAGIC_BYTES, HEADER_FIELDS.MAGIC.size);
    this.versionMajor = init.versionMajor ?? VERSION_MAJOR;
    this.versionMinor = init.versionMinor ?? VERSION_MINOR;
    this.headerSize = init.headerSize ?? HEADER_SIZE_BYTES;
    this.width = init.width;
    this.height = init.height;
    this.tickMicros = init.tickMicros ?? 0;
    this.ruleCount = init.ruleCount ?? 0;
    this.opcodeSetId = init.opcodeSetId ?? 0;
    this.flags = init.flags ?? 0;
    const expectedPixelLength =
      BigInt(this.width) * BigInt(this.height) * BigInt(PIXEL_SIZE_BYTES);
    this.pixelDataLength = init.pixelDataLength ?? expectedPixelLength;
    this.fileLength = init.fileLength ?? 0n;
    this.pixelDataOffset = init.pixelDataOffset ?? BigInt(HEADER_SIZE_BYTES);
    this.reservedA = init.reservedA ?? 0n;
    this.reservedB = init.reservedB ?? 0n;
    this.rulesBlock = copyBytes(
      init.rulesBlock ?? new Uint8Array(RULES_BLOCK_SIZE),
      RULES_BLOCK_SIZE
    );
  }

  static deserialize(bytes: Uint8Array): GrinHeader {
    if (bytes.length < HEADER_SIZE_BYTES) {
      throw new Error(`Header requires ${HEADER_SIZE_BYTES} bytes`);
    }
    const view = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
    const magic = copyBytes(
      bytes.subarray(HEADER_FIELDS.MAGIC.offset, HEADER_FIELDS.MAGIC.offset + HEADER_FIELDS.MAGIC.size),
      HEADER_FIELDS.MAGIC.size
    );
    const versionMajor = view.getUint8(HEADER_FIELDS.VERSION_MAJOR.offset);
    const versionMinor = view.getUint8(HEADER_FIELDS.VERSION_MINOR.offset);
    const headerSize = view.getUint16(HEADER_FIELDS.HEADER_SIZE.offset, true);
    const width = view.getUint32(HEADER_FIELDS.WIDTH.offset, true);
    const height = view.getUint32(HEADER_FIELDS.HEIGHT.offset, true);
    const tickMicros = view.getUint32(HEADER_FIELDS.TICK_MICROS.offset, true);
    const ruleCount = view.getUint8(HEADER_FIELDS.RULE_COUNT.offset);
    const opcodeSetId = view.getUint8(HEADER_FIELDS.OPCODE_SET_ID.offset);
    const flags = view.getUint16(HEADER_FIELDS.FLAGS.offset, true);
    const pixelDataLength = view.getBigUint64(HEADER_FIELDS.PIXEL_DATA_LENGTH.offset, true);
    const fileLength = view.getBigUint64(HEADER_FIELDS.FILE_LENGTH.offset, true);
    const pixelDataOffset = view.getBigUint64(HEADER_FIELDS.PIXEL_DATA_OFFSET.offset, true);
    const reservedA = view.getBigUint64(HEADER_FIELDS.RESERVED_A.offset, true);
    const reservedB = view.getBigUint64(HEADER_FIELDS.RESERVED_B.offset, true);
    const rulesBlock = copyBytes(
      bytes.subarray(
        HEADER_FIELDS.RULES_BLOCK.offset,
        HEADER_FIELDS.RULES_BLOCK.offset + HEADER_FIELDS.RULES_BLOCK.size
      ),
      RULES_BLOCK_SIZE
    );

    return new GrinHeader({
      magic,
      versionMajor,
      versionMinor,
      headerSize,
      width,
      height,
      tickMicros,
      ruleCount,
      opcodeSetId,
      flags,
      pixelDataLength,
      fileLength,
      pixelDataOffset,
      reservedA,
      reservedB,
      rulesBlock,
    });
  }

  serialize(): Uint8Array {
    const buffer = new ArrayBuffer(HEADER_SIZE_BYTES);
    const view = new DataView(buffer);
    const bytes = new Uint8Array(buffer);

    bytes.set(this.magic, HEADER_FIELDS.MAGIC.offset);
    view.setUint8(HEADER_FIELDS.VERSION_MAJOR.offset, this.versionMajor);
    view.setUint8(HEADER_FIELDS.VERSION_MINOR.offset, this.versionMinor);
    view.setUint16(HEADER_FIELDS.HEADER_SIZE.offset, this.headerSize, true);
    view.setUint32(HEADER_FIELDS.WIDTH.offset, this.width, true);
    view.setUint32(HEADER_FIELDS.HEIGHT.offset, this.height, true);
    view.setUint32(HEADER_FIELDS.TICK_MICROS.offset, this.tickMicros, true);
    view.setUint8(HEADER_FIELDS.RULE_COUNT.offset, this.ruleCount);
    view.setUint8(HEADER_FIELDS.OPCODE_SET_ID.offset, this.opcodeSetId);
    view.setUint16(HEADER_FIELDS.FLAGS.offset, this.flags, true);
    view.setBigUint64(HEADER_FIELDS.PIXEL_DATA_LENGTH.offset, this.pixelDataLength, true);
    view.setBigUint64(HEADER_FIELDS.FILE_LENGTH.offset, this.fileLength, true);
    view.setBigUint64(HEADER_FIELDS.PIXEL_DATA_OFFSET.offset, this.pixelDataOffset, true);
    view.setBigUint64(HEADER_FIELDS.RESERVED_A.offset, this.reservedA, true);
    view.setBigUint64(HEADER_FIELDS.RESERVED_B.offset, this.reservedB, true);
    bytes.set(this.rulesBlock, HEADER_FIELDS.RULES_BLOCK.offset);

    return bytes;
  }

  validate(): GrinValidationResult {
    const errors: string[] = [];
    const warnings: string[] = [];

    if (!matchesMagic(this.magic)) {
      errors.push("Magic bytes do not match GRIN");
    }

    if (this.headerSize !== HEADER_SIZE_BYTES) {
      errors.push(`HeaderSize must be ${HEADER_SIZE_BYTES}`);
    }

    if (this.ruleCount > MAX_RULE_COUNT) {
      errors.push(`RuleCount exceeds ${MAX_RULE_COUNT}`);
    }

    if (this.pixelDataOffset !== BigInt(HEADER_SIZE_BYTES)) {
      errors.push("PixelDataOffset64 must be 128");
    }

    const expectedPixelLength =
      BigInt(this.width) * BigInt(this.height) * BigInt(PIXEL_SIZE_BYTES);
    if (this.pixelDataLength !== expectedPixelLength) {
      errors.push("PixelDataLength does not match width * height * 5");
    }

    const minFileLength = BigInt(HEADER_SIZE_BYTES) + this.pixelDataLength;
    if (this.fileLength !== 0n && this.fileLength < minFileLength) {
      errors.push("FileLength is smaller than header + pixel data");
    }

    if (this.rulesBlock.length !== RULES_BLOCK_SIZE) {
      errors.push("RulesBlock must be 64 bytes");
    }

    if (this.flags !== 0) {
      warnings.push("Flags field is non-zero");
    }

    if (this.reservedA !== 0n || this.reservedB !== 0n) {
      warnings.push("Reserved header fields are non-zero");
    }

    if (this.versionMajor !== VERSION_MAJOR || this.versionMinor !== VERSION_MINOR) {
      warnings.push("Unexpected GRIN version");
    }

    return { ok: errors.length === 0, errors, warnings };
  }

  clone(overrides: Partial<GrinHeaderInit> = {}): GrinHeader {
    return new GrinHeader({
      magic: overrides.magic ?? this.magic,
      versionMajor: overrides.versionMajor ?? this.versionMajor,
      versionMinor: overrides.versionMinor ?? this.versionMinor,
      headerSize: overrides.headerSize ?? this.headerSize,
      width: overrides.width ?? this.width,
      height: overrides.height ?? this.height,
      tickMicros: overrides.tickMicros ?? this.tickMicros,
      ruleCount: overrides.ruleCount ?? this.ruleCount,
      opcodeSetId: overrides.opcodeSetId ?? this.opcodeSetId,
      flags: overrides.flags ?? this.flags,
      pixelDataLength: overrides.pixelDataLength ?? this.pixelDataLength,
      fileLength: overrides.fileLength ?? this.fileLength,
      pixelDataOffset: overrides.pixelDataOffset ?? this.pixelDataOffset,
      reservedA: overrides.reservedA ?? this.reservedA,
      reservedB: overrides.reservedB ?? this.reservedB,
      rulesBlock: overrides.rulesBlock ?? this.rulesBlock,
    });
  }
}

function matchesMagic(bytes: Uint8Array): boolean {
  if (bytes.length !== MAGIC_BYTES.length) {
    return false;
  }
  for (let i = 0; i < MAGIC_BYTES.length; i += 1) {
    if (bytes[i] !== MAGIC_BYTES[i]) {
      return false;
    }
  }
  return true;
}

function copyBytes(source: Uint8Array, size: number): Uint8Array {
  if (source.length !== size) {
    const copy = new Uint8Array(size);
    copy.set(source.subarray(0, size));
    return copy;
  }
  return new Uint8Array(source);
}

#####/web/lib/grin-image.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { GrinHeader } from "./grin-header";
import { GrinPixel } from "./grin-pixel";
import { GrinRule } from "./grin-rule";

export class GrinImage {
  header: GrinHeader;
  pixels: GrinPixel[];
  rules: GrinRule[];

  constructor(header: GrinHeader, pixels: GrinPixel[], rules: GrinRule[]) {
    this.header = header;
    this.pixels = pixels;
    this.rules = rules;

    const expectedPixelCount = this.header.width * this.header.height;
    if (!Number.isSafeInteger(expectedPixelCount)) {
      throw new Error("Pixel count exceeds safe integer range");
    }
    if (pixels.length !== expectedPixelCount) {
      throw new Error("Pixel array length does not match header dimensions");
    }
    if (rules.length !== this.header.ruleCount) {
      throw new Error("Rule array length does not match header ruleCount");
    }
  }

  getPixel(x: number, y: number): GrinPixel {
    const index = this.indexFor(x, y);
    const pixel = this.pixels[index];
    if (!pixel) {
      throw new Error("Pixel index out of range");
    }
    return pixel;
  }

  setPixel(x: number, y: number, pixel: GrinPixel): void {
    const index = this.indexFor(x, y);
    this.pixels[index] = pixel;
  }

  getPixelsByGroup(groupId: number): GrinPixel[] {
    return this.pixels.filter((pixel) => pixel.getGroupId() === (groupId & 0x0f));
  }

  getLockedPixels(): GrinPixel[] {
    return this.pixels.filter((pixel) => pixel.isLocked());
  }

  getUnlockedPixels(): GrinPixel[] {
    return this.pixels.filter((pixel) => !pixel.isLocked());
  }

  private indexFor(x: number, y: number): number {
    if (!Number.isInteger(x) || !Number.isInteger(y)) {
      throw new RangeError("Pixel coordinates must be integers");
    }
    if (x < 0 || y < 0 || x >= this.header.width || y >= this.header.height) {
      throw new RangeError("Pixel coordinates out of bounds");
    }
    return y * this.header.width + x;
  }
}

#####/web/lib/grin-io.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import {
  CONTROL_BYTE_MASKS,
  HEADER_SIZE_BYTES,
  MAX_RULE_COUNT,
  PIXEL_SIZE_BYTES,
  RULE_ENTRY_SIZE,
  RULES_BLOCK_SIZE,
} from "./format";
import { GrinHeader } from "./grin-header";
import { GrinPixel } from "./grin-pixel";
import { GrinRule } from "./grin-rule";

export type GrinHeaderReadResult = {
  header: GrinHeader;
  warnings: string[];
};

export type GrinPixelReadResult = {
  pixels: GrinPixel[];
  warnings: string[];
};

export type GrinRulesReadResult = {
  rules: GrinRule[];
  warnings: string[];
};

export function readHeader(bytes: Uint8Array): GrinHeaderReadResult {
  if (bytes.length < HEADER_SIZE_BYTES) {
    throw new Error("Buffer too small for GRIN header");
  }
  const headerBytes = bytes.subarray(0, HEADER_SIZE_BYTES);
  const header = GrinHeader.deserialize(headerBytes);
  const validation = header.validate();
  if (!validation.ok) {
    throw new Error(`Invalid GRIN header: ${validation.errors.join("; ")}`);
  }
  return { header, warnings: validation.warnings };
}

export function writeHeader(header: GrinHeader): Uint8Array {
  const width = toSafeBigInt(header.width, "Width");
  const height = toSafeBigInt(header.height, "Height");
  const pixelDataLength = width * height * BigInt(PIXEL_SIZE_BYTES);
  const fileLength =
    header.fileLength !== 0n
      ? header.fileLength
      : BigInt(HEADER_SIZE_BYTES) + pixelDataLength;

  const normalized = header.clone({
    headerSize: HEADER_SIZE_BYTES,
    pixelDataLength,
    fileLength,
    pixelDataOffset: BigInt(HEADER_SIZE_BYTES),
    flags: 0,
    reservedA: 0n,
    reservedB: 0n,
  });

  return normalized.serialize();
}

export function readPixelData(
  bytes: Uint8Array,
  width: number,
  height: number
): GrinPixelReadResult {
  const expectedLength = safePixelLength(width, height);
  if (bytes.length !== expectedLength) {
    throw new Error("Pixel data length does not match header dimensions");
  }

  const pixels: GrinPixel[] = [];
  let reservedCount = 0;
  for (let offset = 0; offset < bytes.length; offset += PIXEL_SIZE_BYTES) {
    const slice = bytes.subarray(offset, offset + PIXEL_SIZE_BYTES);
    const controlByte = slice[4] ?? 0;
    if ((controlByte & CONTROL_BYTE_MASKS.RESERVED) !== 0) {
      reservedCount += 1;
    }
    pixels.push(GrinPixel.fromBytes(slice));
  }

  const warnings: string[] = [];
  if (reservedCount > 0) {
    warnings.push(`Control byte reserved bits set on ${reservedCount} pixels`);
  }
  return { pixels, warnings };
}

export function writePixelData(pixels: GrinPixel[]): Uint8Array {
  const output = new Uint8Array(pixels.length * PIXEL_SIZE_BYTES);
  let offset = 0;
  for (const pixel of pixels) {
    output[offset] = pixel.r & 0xff;
    output[offset + 1] = pixel.g & 0xff;
    output[offset + 2] = pixel.b & 0xff;
    output[offset + 3] = pixel.a & 0xff;
    const control = pixel.c & 0xff;
    output[offset + 4] = control & ~CONTROL_BYTE_MASKS.RESERVED;
    offset += PIXEL_SIZE_BYTES;
  }
  return output;
}

export function readRulesBlock(
  bytes: Uint8Array,
  ruleCount: number,
  opcodeSetId: number
): GrinRulesReadResult {
  if (bytes.length !== RULES_BLOCK_SIZE) {
    throw new Error("Rules block must be exactly 64 bytes");
  }
  if (ruleCount > MAX_RULE_COUNT) {
    throw new Error(`RuleCount exceeds ${MAX_RULE_COUNT}`);
  }

  const rules: GrinRule[] = [];
  for (let i = 0; i < ruleCount; i += 1) {
    const offset = i * RULE_ENTRY_SIZE;
    const slice = bytes.subarray(offset, offset + RULE_ENTRY_SIZE);
    const rule = GrinRule.deserialize(slice);
    if (!isValidOpcode(opcodeSetId, rule.opcode)) {
      throw new Error(`Unknown opcode ${rule.opcode} for opcode set ${opcodeSetId}`);
    }
    rules.push(rule);
  }

  const warnings: string[] = [];
  for (let i = ruleCount * RULE_ENTRY_SIZE; i < bytes.length; i += 1) {
    if (bytes[i] !== 0) {
      warnings.push("Unused rules block entries are non-zero");
      break;
    }
  }

  return { rules, warnings };
}

export function writeRulesBlock(rules: GrinRule[], ruleCount: number): Uint8Array {
  if (ruleCount > MAX_RULE_COUNT) {
    throw new Error(`RuleCount exceeds ${MAX_RULE_COUNT}`);
  }
  if (rules.length < ruleCount) {
    throw new Error("Rule list is shorter than ruleCount");
  }
  const block = new Uint8Array(RULES_BLOCK_SIZE);
  for (let i = 0; i < ruleCount; i += 1) {
    const rule = rules[i];
    if (!rule) {
      continue;
    }
    if (rule.groupMask < 0 || rule.groupMask > 0xffff) {
      throw new Error("GroupMask must fit in 16 bits");
    }
    block.set(rule.serialize(), i * RULE_ENTRY_SIZE);
  }
  return block;
}

function safePixelLength(width: number, height: number): number {
  if (!Number.isInteger(width) || !Number.isInteger(height) || width < 0 || height < 0) {
    throw new Error("Width and height must be non-negative integers");
  }
  const pixelCount = width * height;
  if (!Number.isSafeInteger(pixelCount)) {
    throw new Error("Pixel count exceeds safe integer range");
  }
  const length = pixelCount * PIXEL_SIZE_BYTES;
  if (!Number.isSafeInteger(length)) {
    throw new Error("Pixel data length exceeds safe integer range");
  }
  return length;
}

function toSafeBigInt(value: number, label: string): bigint {
  if (!Number.isSafeInteger(value) || value < 0) {
    throw new Error(`${label} must be a non-negative safe integer`);
  }
  return BigInt(value);
}

function isValidOpcode(opcodeSetId: number, opcode: number): boolean {
  if (opcodeSetId !== 0) {
    return false;
  }
  return opcode >= 0x00 && opcode <= 0x0c;
}

#####/web/lib/grin-loader.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { GrinFile } from "./grin-file";

export class GrinLoader {
  static async fromURL(url: string): Promise<GrinFile> {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Failed to fetch ${url}: ${response.status}`);
    }
    if (response.body) {
      const buffer = await readStream(response.body);
      return GrinFile.load(buffer);
    }
    const buffer = await response.arrayBuffer();
    return GrinFile.load(buffer);
  }

  static async fromFile(file: File): Promise<GrinFile> {
    const buffer = await file.arrayBuffer();
    return GrinFile.load(buffer);
  }

  static async fromBlob(blob: Blob): Promise<GrinFile> {
    const buffer = await blob.arrayBuffer();
    return GrinFile.load(buffer);
  }
}

async function readStream(stream: ReadableStream<Uint8Array>): Promise<ArrayBuffer> {
  const reader = stream.getReader();
  const chunks: Uint8Array[] = [];
  let total = 0;

  while (true) {
    const { done, value } = await reader.read();
    if (done) {
      break;
    }
    if (value) {
      chunks.push(value);
      total += value.length;
    }
  }

  const output = new Uint8Array(total);
  let offset = 0;
  for (const chunk of chunks) {
    output.set(chunk, offset);
    offset += chunk.length;
  }
  return output.buffer;
}

#####/web/lib/grin-pixel.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import {
  CONTROL_BYTE_MASKS,
  getGroupId,
  isLocked,
  setGroupId,
  setLocked,
} from "./format";

export class GrinPixel {
  r: number;
  g: number;
  b: number;
  a: number;
  c: number;

  constructor(r: number, g: number, b: number, a: number, c: number) {
    this.r = r & 0xff;
    this.g = g & 0xff;
    this.b = b & 0xff;
    this.a = a & 0xff;
    this.c = c & 0xff;
  }

  static fromBytes(bytes: Uint8Array): GrinPixel {
    if (bytes.length !== 5) {
      throw new Error("GrinPixel requires exactly 5 bytes");
    }
    return new GrinPixel(bytes[0] ?? 0, bytes[1] ?? 0, bytes[2] ?? 0, bytes[3] ?? 0, bytes[4] ?? 0);
  }

  getGroupId(): number {
    return getGroupId(this.c);
  }

  isLocked(): boolean {
    return isLocked(this.c);
  }

  setGroupId(groupId: number): void {
    this.c = setGroupId(this.c, groupId) & 0xff;
  }

  setLocked(locked: boolean): void {
    this.c = setLocked(this.c, locked) & 0xff;
  }

  toBytes(): Uint8Array {
    return new Uint8Array([this.r, this.g, this.b, this.a, this.c]);
  }

  reservedBits(): number {
    return this.c & CONTROL_BYTE_MASKS.RESERVED;
  }
}

#####/web/lib/grin-player.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { CONTROL_BYTE_MASKS } from "./format";
import { GrinFile } from "./grin-file";
import { GrinImage } from "./grin-image";
import { GrinPixel } from "./grin-pixel";
import { DisplayBuffer } from "./display-buffer";
import { OpcodeRegistry } from "./opcode-registry";
import { PlaybackState } from "./playback-state";
import { RuleEngine } from "./rule-engine";
import { RAFTickScheduler, TickScheduler } from "./tick-scheduler";

const USE_PACKED_OUTPUT = isLittleEndian();

export class GrinPlayer {
  private image: GrinImage | null = null;
  private scheduler: TickScheduler | null = null;
  private readonly schedulerFactory: (tickMicros: number) => TickScheduler;
  private readonly ruleEngine: RuleEngine;
  private readonly registry: OpcodeRegistry;
  private controlBytes = new Uint8Array(0);
  private state: PlaybackState | null = null;
  private displayBuffer: DisplayBuffer | null = null;
  private readonly onFrameRendered: (() => void) | null;

  constructor(
    schedulerFactory: (tickMicros: number) => TickScheduler = (tickMicros) =>
      new RAFTickScheduler(tickMicros),
    ruleEngine: RuleEngine = new RuleEngine(),
    registry: OpcodeRegistry = OpcodeRegistry.getInstance(),
    onFrameRendered: (() => void) | null = null
  ) {
    this.schedulerFactory = schedulerFactory;
    this.ruleEngine = ruleEngine;
    this.registry = registry;
    this.onFrameRendered = onFrameRendered;
  }

  load(file: GrinFile): void {
    this.image = new GrinImage(file.header, file.pixels, file.rules);
    this.displayBuffer = new DisplayBuffer(this.image.header.width, this.image.header.height);
    this.state = new PlaybackState(this.displayBuffer);
    this.controlBytes = new Uint8Array(this.image.pixels.length);
    this.image.pixels.forEach((pixel, index) => {
      this.controlBytes[index] = pixel.c & ~CONTROL_BYTE_MASKS.RESERVED;
    });

    if (this.scheduler) {
      this.scheduler.stop();
    }
    this.scheduler = this.schedulerFactory(this.image.header.tickMicros);
    this.scheduler.setTickCallback((tick) => this.onTick(tick));
  }

  play(): void {
    if (!this.state || !this.scheduler) {
      throw new Error("GrinPlayer.load() must be called before play()");
    }
    if (this.state.isPlaying) {
      return;
    }
    this.state.isPlaying = true;
    this.scheduler.start();
  }

  pause(): void {
    if (!this.state || !this.scheduler) {
      return;
    }
    this.state.isPlaying = false;
    this.scheduler.stop();
  }

  stop(): void {
    if (!this.state) {
      return;
    }
    this.pause();
    this.state.reset();
  }

  seek(tick: number): void {
    if (!this.state || !this.image) {
      throw new Error("GrinPlayer.load() must be called before seek()");
    }
    if (!Number.isInteger(tick) || tick < 0) {
      throw new RangeError("Tick must be a non-negative integer");
    }
    this.state.currentTick = tick;
    this.renderFrame(tick);
  }

  getCurrentFrame(): DisplayBuffer {
    if (!this.displayBuffer) {
      throw new Error("GrinPlayer.load() must be called before getCurrentFrame()");
    }
    return this.displayBuffer;
  }

  isPlaying(): boolean {
    return this.state?.isPlaying ?? false;
  }

  getCurrentTick(): number {
    return this.state?.currentTick ?? 0;
  }

  private onTick(tick: number): void {
    if (!this.state) {
      return;
    }
    this.state.currentTick = tick;
    this.renderFrame(tick);
  }

  private renderFrame(tick: number): void {
    if (!this.image || !this.displayBuffer) {
      return;
    }
    const activeRules = this.ruleEngine.evaluateRules(this.image, tick);
    const output = this.displayBuffer.rgbaData;
    const output32 =
      USE_PACKED_OUTPUT && output.byteLength % 4 === 0
        ? new Uint32Array(output.buffer, output.byteOffset, output.byteLength / 4)
        : null;
    const opcodeSetId = this.image.header.opcodeSetId;

    for (let i = 0; i < this.image.pixels.length; i += 1) {
      const source = this.image.pixels[i];
      if (!source) {
        continue;
      }
      const control = this.controlBytes[i] ?? source.c;
      const outputIndex = i * 4;

      if ((control & CONTROL_BYTE_MASKS.LOCK) !== 0) {
        if (output32) {
          output32[i] = packRgba(source.r, source.g, source.b, source.a);
        } else {
          output[outputIndex] = source.r;
          output[outputIndex + 1] = source.g;
          output[outputIndex + 2] = source.b;
          output[outputIndex + 3] = source.a;
        }
        continue;
      }

      const working = new GrinPixel(source.r, source.g, source.b, source.a, control);
      const groupId = control & CONTROL_BYTE_MASKS.GROUP_ID;

      for (const activeRule of activeRules) {
        if (activeRule.rule.targetsGroup(groupId)) {
          const opcode = this.registry.getOpcode(opcodeSetId, activeRule.rule.opcode);
          opcode.apply(working, tick, activeRule.rule.timing);
        }
      }

      this.controlBytes[i] = working.c & ~CONTROL_BYTE_MASKS.RESERVED;
      if (output32) {
        output32[i] = packRgba(working.r, working.g, working.b, working.a);
      } else {
        output[outputIndex] = working.r;
        output[outputIndex + 1] = working.g;
        output[outputIndex + 2] = working.b;
        output[outputIndex + 3] = working.a;
      }
    }
    if (this.onFrameRendered) {
      this.onFrameRendered();
    }
  }
}

function isLittleEndian(): boolean {
  const buffer = new ArrayBuffer(4);
  new DataView(buffer).setUint32(0, 0x0a0b0c0d, true);
  return new Uint8Array(buffer)[0] === 0x0d;
}

function packRgba(r: number, g: number, b: number, a: number): number {
  return (r | (g << 8) | (b << 16) | (a << 24)) >>> 0;
}

#####/web/lib/grin-reader.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { HEADER_FIELDS, HEADER_SIZE_BYTES, RULES_BLOCK_SIZE } from "./format";
import { GrinHeader } from "./grin-header";
import { GrinFile } from "./grin-file";
import { readPixelData, readRulesBlock } from "./grin-io";

export class GrinReader {
  private bytes: Uint8Array;
  private view: DataView;

  constructor(buffer: ArrayBuffer | Uint8Array) {
    this.bytes = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);
    this.view = new DataView(this.bytes.buffer, this.bytes.byteOffset, this.bytes.byteLength);
  }

  readHeader(): GrinHeader {
    if (this.bytes.length < HEADER_SIZE_BYTES) {
      throw new Error("Buffer too small for GRIN header");
    }
    const magic = this.bytes.subarray(0, 4);
    const versionMajor = this.view.getUint8(HEADER_FIELDS.VERSION_MAJOR.offset);
    const versionMinor = this.view.getUint8(HEADER_FIELDS.VERSION_MINOR.offset);
    const headerSize = this.view.getUint16(HEADER_FIELDS.HEADER_SIZE.offset, true);
    const width = this.view.getUint32(HEADER_FIELDS.WIDTH.offset, true);
    const height = this.view.getUint32(HEADER_FIELDS.HEIGHT.offset, true);
    const tickMicros = this.view.getUint32(HEADER_FIELDS.TICK_MICROS.offset, true);
    const ruleCount = this.view.getUint8(HEADER_FIELDS.RULE_COUNT.offset);
    const opcodeSetId = this.view.getUint8(HEADER_FIELDS.OPCODE_SET_ID.offset);
    const flags = this.view.getUint16(HEADER_FIELDS.FLAGS.offset, true);
    const pixelDataLength = this.view.getBigUint64(HEADER_FIELDS.PIXEL_DATA_LENGTH.offset, true);
    const fileLength = this.view.getBigUint64(HEADER_FIELDS.FILE_LENGTH.offset, true);
    const pixelDataOffset = this.view.getBigUint64(HEADER_FIELDS.PIXEL_DATA_OFFSET.offset, true);
    const reservedA = this.view.getBigUint64(HEADER_FIELDS.RESERVED_A.offset, true);
    const reservedB = this.view.getBigUint64(HEADER_FIELDS.RESERVED_B.offset, true);
    const rulesBlock = this.bytes.subarray(
      HEADER_FIELDS.RULES_BLOCK.offset,
      HEADER_FIELDS.RULES_BLOCK.offset + RULES_BLOCK_SIZE
    );

    return new GrinHeader({
      magic,
      versionMajor,
      versionMinor,
      headerSize,
      width,
      height,
      tickMicros,
      ruleCount,
      opcodeSetId,
      flags,
      pixelDataLength,
      fileLength,
      pixelDataOffset,
      reservedA,
      reservedB,
      rulesBlock,
    });
  }

  readFile(): GrinFile {
    const header = this.readHeader();
    const rules = readRulesBlock(header.rulesBlock, header.ruleCount, header.opcodeSetId).rules;
    const pixelOffset = Number(header.pixelDataOffset);
    const pixelLength = Number(header.pixelDataLength);
    const pixelBytes = this.bytes.subarray(pixelOffset, pixelOffset + pixelLength);
    const pixels = readPixelData(pixelBytes, header.width, header.height).pixels;
    return new GrinFile(header, pixels, rules);
  }
}

#####/web/lib/grin-rule.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { RULE_ENTRY_SIZE, groupMaskTargetsGroup } from "./format";

export class GrinRule {
  groupMask: number;
  opcode: number;
  timing: number;

  constructor(groupMask: number, opcode: number, timing: number) {
    this.groupMask = groupMask & 0xffff;
    this.opcode = opcode & 0xff;
    this.timing = timing & 0xff;
  }

  targetsGroup(groupId: number): boolean {
    return groupMaskTargetsGroup(this.groupMask, groupId);
  }

  serialize(): Uint8Array {
    const buffer = new ArrayBuffer(RULE_ENTRY_SIZE);
    const view = new DataView(buffer);
    view.setUint16(0, this.groupMask, true);
    view.setUint8(2, this.opcode);
    view.setUint8(3, this.timing);
    return new Uint8Array(buffer);
  }

  static deserialize(bytes: Uint8Array): GrinRule {
    if (bytes.length !== RULE_ENTRY_SIZE) {
      throw new Error("GrinRule requires exactly 4 bytes");
    }
    const view = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
    const groupMask = view.getUint16(0, true);
    const opcode = view.getUint8(2);
    const timing = view.getUint8(3);
    return new GrinRule(groupMask, opcode, timing);
  }
}

#####/web/lib/grin-writer.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { HEADER_SIZE_BYTES, PIXEL_SIZE_BYTES } from "./format";
import { GrinFile } from "./grin-file";
import { GrinHeader } from "./grin-header";
import { writePixelData, writeRulesBlock } from "./grin-io";

export class GrinWriter {
  static writeHeader(header: GrinHeader): Uint8Array {
    return header.serialize();
  }

  static writeFile(file: GrinFile): Uint8Array {
    const rulesBlock = writeRulesBlock(file.rules, file.rules.length);
    const pixelBytes = writePixelData(file.pixels);
    const pixelDataLength = BigInt(pixelBytes.length);

    const header = file.header.clone({
      ruleCount: file.rules.length,
      rulesBlock,
      pixelDataLength,
      pixelDataOffset: BigInt(HEADER_SIZE_BYTES),
      fileLength: BigInt(HEADER_SIZE_BYTES + pixelBytes.length),
    });

    const output = new Uint8Array(HEADER_SIZE_BYTES + pixelBytes.length);
    output.set(header.serialize(), 0);
    output.set(pixelBytes, HEADER_SIZE_BYTES);
    return output;
  }

  static writePixels(pixels: number[]): Uint8Array {
    if (pixels.length % PIXEL_SIZE_BYTES !== 0) {
      throw new Error("Pixel array length must be a multiple of 5");
    }
    return new Uint8Array(pixels);
  }
}

#####/web/lib/index.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export * from "./format";
export * from "./endianness";
export * from "./grin-header";
export * from "./grin-pixel";
export * from "./grin-rule";
export * from "./grin-image";
export * from "./grin-file";
export * from "./grin-reader";
export * from "./grin-writer";
export * from "./grin-io";
export * from "./grin-loader";
export * from "./validation";
export * from "./timing";
export * from "./opcodes";
export * from "./opcode-registry";
export * from "./display-buffer";
export * from "./tick-scheduler";
export * from "./rule-engine";
export * from "./grin-player";
export * from "./grin-canvas";
export * from "./grin-element";

#####/web/lib/opcode-registry.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import {
  BaseOpcodeId,
  FadeInOpcode,
  FadeOutOpcode,
  InvertOpcode,
  LockOpcode,
  NopOpcode,
  Opcode,
  PulseOpcode,
  RotateHueOpcode,
  ShiftAOpcode,
  ShiftBOpcode,
  ShiftGOpcode,
  ShiftROpcode,
  ToggleLockOpcode,
  UnlockOpcode,
} from "./opcodes";

export class OpcodeRegistry {
  private static instance: OpcodeRegistry | null = null;
  private readonly baseOpcodes: Map<number, Opcode>;

  private constructor() {
    this.baseOpcodes = new Map<number, Opcode>([
      [BaseOpcodeId.NOP, new NopOpcode()],
      [BaseOpcodeId.FADE_IN, new FadeInOpcode()],
      [BaseOpcodeId.FADE_OUT, new FadeOutOpcode()],
      [BaseOpcodeId.PULSE, new PulseOpcode()],
      [BaseOpcodeId.SHIFT_R, new ShiftROpcode()],
      [BaseOpcodeId.SHIFT_G, new ShiftGOpcode()],
      [BaseOpcodeId.SHIFT_B, new ShiftBOpcode()],
      [BaseOpcodeId.SHIFT_A, new ShiftAOpcode()],
      [BaseOpcodeId.INVERT, new InvertOpcode()],
      [BaseOpcodeId.ROTATE_HUE, new RotateHueOpcode()],
      [BaseOpcodeId.LOCK, new LockOpcode()],
      [BaseOpcodeId.UNLOCK, new UnlockOpcode()],
      [BaseOpcodeId.TOGGLE_LOCK, new ToggleLockOpcode()],
    ]);
  }

  static getInstance(): OpcodeRegistry {
    if (!OpcodeRegistry.instance) {
      OpcodeRegistry.instance = new OpcodeRegistry();
    }
    return OpcodeRegistry.instance;
  }

  getOpcode(opcodeSetId: number, opcodeId: number): Opcode {
    if (opcodeSetId !== 0) {
      throw new Error(`Unknown OpcodeSetId ${opcodeSetId}`);
    }
    const opcode = this.baseOpcodes.get(opcodeId);
    if (!opcode) {
      throw new Error(`Unknown opcode ${opcodeId} for base set`);
    }
    return opcode;
  }

  isValidOpcode(opcodeSetId: number, opcodeId: number): boolean {
    if (opcodeSetId !== 0) {
      return false;
    }
    return this.baseOpcodes.has(opcodeId);
  }

  listOpcodes(opcodeSetId: number): Opcode[] {
    if (opcodeSetId !== 0) {
      return [];
    }
    return Array.from(this.baseOpcodes.values());
  }
}

#####/web/lib/opcodes.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { CONTROL_BYTE_MASKS } from "./format";
import { GrinPixel } from "./grin-pixel";
import { TimingInterpreter } from "./timing";

export const BaseOpcodeId = {
  NOP: 0x00,
  FADE_IN: 0x01,
  FADE_OUT: 0x02,
  PULSE: 0x03,
  SHIFT_R: 0x04,
  SHIFT_G: 0x05,
  SHIFT_B: 0x06,
  SHIFT_A: 0x07,
  INVERT: 0x08,
  ROTATE_HUE: 0x09,
  LOCK: 0x0a,
  UNLOCK: 0x0b,
  TOGGLE_LOCK: 0x0c,
} as const;

export interface Opcode {
  getId(): number;
  getName(): string;
  apply(pixel: GrinPixel, tick: number, timing: number): void;
  getMaxCpuCost(): number;
  requiresState(): boolean;
}

export class NopOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.NOP;
  }
  getName(): string {
    return "NOP";
  }
  apply(_pixel: GrinPixel, _tick: number, _timing: number): void {}
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class FadeInOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.FADE_IN;
  }
  getName(): string {
    return "FADE_IN";
  }
  apply(pixel: GrinPixel, tick: number, timing: number): void {
    const level = TimingInterpreter.evaluate(timing, tick);
    pixel.a = clampByte(Math.round(pixel.a * level));
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class FadeOutOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.FADE_OUT;
  }
  getName(): string {
    return "FADE_OUT";
  }
  apply(pixel: GrinPixel, tick: number, timing: number): void {
    const level = 1 - TimingInterpreter.evaluate(timing, tick);
    pixel.a = clampByte(Math.round(pixel.a * level));
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class PulseOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.PULSE;
  }
  getName(): string {
    return "PULSE";
  }
  apply(pixel: GrinPixel, tick: number, timing: number): void {
    const level = TimingInterpreter.evaluate(timing, tick);
    pixel.a = clampByte(Math.round(pixel.a * level));
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class ShiftROpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.SHIFT_R;
  }
  getName(): string {
    return "SHIFT_R";
  }
  apply(pixel: GrinPixel, tick: number, timing: number): void {
    pixel.r = shiftChannel(pixel.r, tick, timing);
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class ShiftGOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.SHIFT_G;
  }
  getName(): string {
    return "SHIFT_G";
  }
  apply(pixel: GrinPixel, tick: number, timing: number): void {
    pixel.g = shiftChannel(pixel.g, tick, timing);
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class ShiftBOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.SHIFT_B;
  }
  getName(): string {
    return "SHIFT_B";
  }
  apply(pixel: GrinPixel, tick: number, timing: number): void {
    pixel.b = shiftChannel(pixel.b, tick, timing);
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class ShiftAOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.SHIFT_A;
  }
  getName(): string {
    return "SHIFT_A";
  }
  apply(pixel: GrinPixel, tick: number, timing: number): void {
    pixel.a = shiftChannel(pixel.a, tick, timing);
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class InvertOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.INVERT;
  }
  getName(): string {
    return "INVERT";
  }
  apply(pixel: GrinPixel, _tick: number, _timing: number): void {
    pixel.r = 255 - pixel.r;
    pixel.g = 255 - pixel.g;
    pixel.b = 255 - pixel.b;
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class RotateHueOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.ROTATE_HUE;
  }
  getName(): string {
    return "ROTATE_HUE";
  }
  apply(pixel: GrinPixel, tick: number, timing: number): void {
    const rotation = TimingInterpreter.evaluate(timing, tick) * 360;
    const [h, s, l] = rgbToHsl(pixel.r, pixel.g, pixel.b);
    const newHue = (h + rotation) % 360;
    const [r, g, b] = hslToRgb(newHue, s, l);
    pixel.r = r;
    pixel.g = g;
    pixel.b = b;
  }
  getMaxCpuCost(): number {
    return 3;
  }
  requiresState(): boolean {
    return false;
  }
}

export class LockOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.LOCK;
  }
  getName(): string {
    return "LOCK";
  }
  apply(pixel: GrinPixel, _tick: number, _timing: number): void {
    pixel.c = pixel.c | CONTROL_BYTE_MASKS.LOCK;
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class UnlockOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.UNLOCK;
  }
  getName(): string {
    return "UNLOCK";
  }
  apply(pixel: GrinPixel, _tick: number, _timing: number): void {
    pixel.c = pixel.c & ~CONTROL_BYTE_MASKS.LOCK;
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

export class ToggleLockOpcode implements Opcode {
  getId(): number {
    return BaseOpcodeId.TOGGLE_LOCK;
  }
  getName(): string {
    return "TOGGLE_LOCK";
  }
  apply(pixel: GrinPixel, _tick: number, _timing: number): void {
    pixel.c = pixel.c ^ CONTROL_BYTE_MASKS.LOCK;
  }
  getMaxCpuCost(): number {
    return 1;
  }
  requiresState(): boolean {
    return false;
  }
}

function shiftChannel(value: number, tick: number, timing: number): number {
  const wave = TimingInterpreter.evaluate(timing, tick);
  const delta = Math.round((wave * 2 - 1) * 255);
  return clampByte(value + delta);
}

function clampByte(value: number): number {
  if (value < 0) {
    return 0;
  }
  if (value > 255) {
    return 255;
  }
  return value;
}

function rgbToHsl(r: number, g: number, b: number): [number, number, number] {
  const rNorm = r / 255;
  const gNorm = g / 255;
  const bNorm = b / 255;
  const max = Math.max(rNorm, gNorm, bNorm);
  const min = Math.min(rNorm, gNorm, bNorm);
  const delta = max - min;
  let h = 0;
  const l = (max + min) / 2;
  let s = 0;

  if (delta !== 0) {
    s = delta / (1 - Math.abs(2 * l - 1));
    if (max === rNorm) {
      h = ((gNorm - bNorm) / delta) % 6;
    } else if (max === gNorm) {
      h = (bNorm - rNorm) / delta + 2;
    } else {
      h = (rNorm - gNorm) / delta + 4;
    }
    h *= 60;
    if (h < 0) {
      h += 360;
    }
  }

  return [h, s, l];
}

function hslToRgb(h: number, s: number, l: number): [number, number, number] {
  const c = (1 - Math.abs(2 * l - 1)) * s;
  const hPrime = h / 60;
  const x = c * (1 - Math.abs((hPrime % 2) - 1));
  let r1 = 0;
  let g1 = 0;
  let b1 = 0;

  if (hPrime >= 0 && hPrime < 1) {
    r1 = c;
    g1 = x;
  } else if (hPrime < 2) {
    r1 = x;
    g1 = c;
  } else if (hPrime < 3) {
    g1 = c;
    b1 = x;
  } else if (hPrime < 4) {
    g1 = x;
    b1 = c;
  } else if (hPrime < 5) {
    r1 = x;
    b1 = c;
  } else {
    r1 = c;
    b1 = x;
  }

  const m = l - c / 2;
  return [
    clampByte(Math.round((r1 + m) * 255)),
    clampByte(Math.round((g1 + m) * 255)),
    clampByte(Math.round((b1 + m) * 255)),
  ];
}

#####/web/lib/playback-state.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { DisplayBuffer } from "./display-buffer";

export class PlaybackState {
  currentTick: number;
  isPlaying: boolean;
  tickAccumulatorMicros: number;
  displayBuffer: DisplayBuffer;

  constructor(displayBuffer: DisplayBuffer) {
    this.displayBuffer = displayBuffer;
    this.currentTick = 0;
    this.isPlaying = false;
    this.tickAccumulatorMicros = 0;
  }

  reset(): void {
    this.currentTick = 0;
    this.tickAccumulatorMicros = 0;
    this.isPlaying = false;
  }
}

#####/web/lib/player.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export { GrinPlayer } from "./grin-player";
export { GrinPlayerElement } from "./grin-element";
export { GrinCanvasRenderer } from "./grin-canvas";

#####/web/lib/rule-engine.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { GrinImage } from "./grin-image";
import { GrinRule } from "./grin-rule";
import { TimingInterpreter } from "./timing";

export type ActiveRule = {
  index: number;
  rule: GrinRule;
};

const ACTIVE_THRESHOLD = 0.5;

export class RuleEngine {
  evaluateRules(image: GrinImage, tick: number): ActiveRule[] {
    const active: ActiveRule[] = [];
    image.rules.forEach((rule, index) => {
      const level = TimingInterpreter.evaluate(rule.timing, tick);
      if (level > ACTIVE_THRESHOLD) {
        active.push({ index, rule });
      }
    });
    return active;
  }
}

#####/web/lib/tick-scheduler.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export type TickCallback = (tick: number) => void;

export interface TickScheduler {
  start(): void;
  stop(): void;
  setTickCallback(cb: TickCallback): void;
  getCurrentTick(): number;
}

export class BrowserTickScheduler implements TickScheduler {
  private tickMicros: number;
  private tickCallback: TickCallback | null = null;
  private currentTick = 0;
  private accumulatorMicros = 0;
  private lastTimestamp = 0;
  private running = false;
  private requestId: number | null = null;

  constructor(tickMicros: number) {
    this.tickMicros = Math.max(1, Math.floor(tickMicros));
  }

  setTickCallback(cb: TickCallback): void {
    this.tickCallback = cb;
  }

  getCurrentTick(): number {
    return this.currentTick;
  }

  start(): void {
    if (this.running) {
      return;
    }
    this.running = true;
    this.lastTimestamp = 0;
    this.accumulatorMicros = 0;
    this.requestId = requestAnimationFrame(this.onFrame);
  }

  stop(): void {
    if (!this.running) {
      return;
    }
    this.running = false;
    if (this.requestId !== null) {
      cancelAnimationFrame(this.requestId);
      this.requestId = null;
    }
  }

  private onFrame = (timestamp: number): void => {
    if (!this.running) {
      return;
    }
    if (this.lastTimestamp === 0) {
      this.lastTimestamp = timestamp;
    }
    const deltaMicros = (timestamp - this.lastTimestamp) * 1000;
    this.lastTimestamp = timestamp;
    this.accumulatorMicros += deltaMicros;

    while (this.accumulatorMicros >= this.tickMicros) {
      this.accumulatorMicros -= this.tickMicros;
      this.currentTick = nextTick(this.currentTick);
      if (this.tickCallback) {
        this.tickCallback(this.currentTick);
      }
    }

    this.requestId = requestAnimationFrame(this.onFrame);
  };
}

export class RAFTickScheduler implements TickScheduler {
  private tickMicros: number;
  private tickCallback: TickCallback | null = null;
  private currentTick = 0;
  private accumulatorMicros = 0;
  private lastTimestamp = 0;
  private running = false;
  private requestId: number | null = null;
  private isHidden = false;

  constructor(tickMicros: number) {
    this.tickMicros = Math.max(1, Math.floor(tickMicros));
    if (typeof document !== "undefined") {
      this.isHidden = document.hidden;
      document.addEventListener("visibilitychange", () => {
        this.isHidden = document.hidden;
        if (!this.isHidden) {
          this.lastTimestamp = 0;
        }
      });
    }
  }

  setTickCallback(cb: TickCallback): void {
    this.tickCallback = cb;
  }

  getCurrentTick(): number {
    return this.currentTick;
  }

  start(): void {
    if (this.running) {
      return;
    }
    this.running = true;
    this.lastTimestamp = 0;
    this.accumulatorMicros = 0;
    this.requestId = requestAnimationFrame(this.onFrame);
  }

  stop(): void {
    if (!this.running) {
      return;
    }
    this.running = false;
    if (this.requestId !== null) {
      cancelAnimationFrame(this.requestId);
      this.requestId = null;
    }
  }

  private onFrame = (timestamp: number): void => {
    if (!this.running) {
      return;
    }
    if (this.isHidden) {
      this.requestId = requestAnimationFrame(this.onFrame);
      return;
    }
    if (this.lastTimestamp === 0) {
      this.lastTimestamp = timestamp;
    }
    const deltaMicros = (timestamp - this.lastTimestamp) * 1000;
    this.lastTimestamp = timestamp;
    this.accumulatorMicros += deltaMicros;

    while (this.accumulatorMicros >= this.tickMicros) {
      this.accumulatorMicros -= this.tickMicros;
      this.currentTick = nextTick(this.currentTick);
      if (this.tickCallback) {
        this.tickCallback(this.currentTick);
      }
    }

    this.requestId = requestAnimationFrame(this.onFrame);
  };
}

export class TestTickScheduler implements TickScheduler {
  private tickCallback: TickCallback | null = null;
  private currentTick = 0;
  private running = false;

  setTickCallback(cb: TickCallback): void {
    this.tickCallback = cb;
  }

  getCurrentTick(): number {
    return this.currentTick;
  }

  start(): void {
    this.running = true;
  }

  stop(): void {
    this.running = false;
  }

  advance(ticks = 1): void {
    if (!this.running) {
      return;
    }
    for (let i = 0; i < ticks; i += 1) {
      this.currentTick = nextTick(this.currentTick);
      if (this.tickCallback) {
        this.tickCallback(this.currentTick);
      }
    }
  }
}

function nextTick(currentTick: number): number {
  if (currentTick >= Number.MAX_SAFE_INTEGER) {
    return 0;
  }
  return currentTick + 1;
}

#####/web/lib/timing.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
export type WaveformType = "square" | "triangle" | "sine" | "sawtooth";

export const TimingInterpreter = {
  getPeriod(timing: number): number {
    return (timing & 0x0f) + 1;
  },

  getWaveform(timing: number): WaveformType {
    const waveform = (timing >> 4) & 0x03;
    switch (waveform) {
      case 0:
        return "square";
      case 1:
        return "triangle";
      case 2:
        return "sine";
      default:
        return "sawtooth";
    }
  },

  getPhaseOffset(timing: number): number {
    return (timing >> 6) & 0x03;
  },

  evaluate(timing: number, tick: number): number {
    const period = this.getPeriod(timing);
    const phaseOffset = this.getPhaseOffset(timing) / 4;
    const position = ((tick / period) + phaseOffset) % 1;
    const waveform = this.getWaveform(timing);
    switch (waveform) {
      case "square":
        return position < 0.5 ? 0 : 1;
      case "triangle":
        return position < 0.5 ? position * 2 : 2 - position * 2;
      case "sine":
        return 0.5 - 0.5 * Math.cos(2 * Math.PI * position);
      case "sawtooth":
        return position;
    }
  },
} as const;

#####/web/lib/validation.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import {
  CONTROL_BYTE_MASKS,
  HEADER_SIZE_BYTES,
  MAGIC_BYTES,
  MAX_RULE_COUNT,
  PIXEL_SIZE_BYTES,
  VERSION_MAJOR,
  VERSION_MINOR,
} from "./format";
import { GrinFile } from "./grin-file";

export type ValidationResult = {
  ok: boolean;
  errors: string[];
  warnings: string[];
};

export type ValidationReport = {
  ok: boolean;
  errors: string[];
  warnings: string[];
  info: string[];
};

export type ValidationMode = "strict" | "permissive";

export function validateMagic(bytes: Uint8Array): ValidationResult {
  if (bytes.length !== MAGIC_BYTES.length) {
    return fail(`Magic must be ${MAGIC_BYTES.length} bytes`);
  }
  for (let i = 0; i < MAGIC_BYTES.length; i += 1) {
    if (bytes[i] !== MAGIC_BYTES[i]) {
      return fail("Magic bytes do not match GRIN");
    }
  }
  return ok();
}

export function validateVersion(major: number, minor: number): ValidationResult {
  if (!Number.isInteger(major) || !Number.isInteger(minor)) {
    return fail("Version fields must be integers");
  }
  if (major !== VERSION_MAJOR || minor !== VERSION_MINOR) {
    return warn("Unexpected GRIN version");
  }
  return ok();
}

export function validateHeaderSize(size: number): ValidationResult {
  if (size !== HEADER_SIZE_BYTES) {
    return fail(`HeaderSize must be ${HEADER_SIZE_BYTES}`);
  }
  return ok();
}

export function validateDimensions(width: number, height: number): ValidationResult {
  if (!Number.isInteger(width) || !Number.isInteger(height)) {
    return fail("Width and height must be integers");
  }
  if (width < 0 || height < 0) {
    return fail("Width and height must be non-negative");
  }
  if (width > 0xffffffff || height > 0xffffffff) {
    return fail("Width and height must fit in uint32");
  }
  return ok();
}

export function validateTickMicros(tick: number): ValidationResult {
  if (!Number.isInteger(tick) || tick < 0 || tick > 0xffffffff) {
    return fail("TickMicros must fit in uint32");
  }
  return ok();
}

export function validateRuleCount(count: number): ValidationResult {
  if (!Number.isInteger(count) || count < 0 || count > MAX_RULE_COUNT) {
    return fail(`RuleCount must be 0-${MAX_RULE_COUNT}`);
  }
  return ok();
}

export function validateOpcodeSetId(id: number): ValidationResult {
  if (!Number.isInteger(id) || id < 0 || id > 0xff) {
    return fail("OpcodeSetId must fit in uint8");
  }
  if (id !== 0) {
    return fail("Unknown OpcodeSetId");
  }
  return ok();
}

export function validatePixelDataLength(
  length: bigint,
  width: number,
  height: number
): ValidationResult {
  if (length < 0n) {
    return fail("PixelDataLength must be non-negative");
  }
  const dimResult = validateDimensions(width, height);
  if (!dimResult.ok) {
    return dimResult;
  }
  const expected =
    BigInt(width) * BigInt(height) * BigInt(PIXEL_SIZE_BYTES);
  if (length !== expected) {
    return fail("PixelDataLength does not match width * height * 5");
  }
  return ok();
}

export function validateFileLength(fileLen: bigint, dataLen: bigint): ValidationResult {
  if (fileLen < 0n) {
    return fail("FileLength must be non-negative");
  }
  const minLen = BigInt(HEADER_SIZE_BYTES) + dataLen;
  if (fileLen !== 0n && fileLen < minLen) {
    return fail("FileLength is smaller than header + pixel data");
  }
  return ok();
}

export function validatePixelDataOffset(offset: bigint): ValidationResult {
  if (offset !== BigInt(HEADER_SIZE_BYTES)) {
    return fail("PixelDataOffset64 must be 128");
  }
  return ok();
}

export function validateReservedFields(
  reservedA: bigint,
  reservedB: bigint,
  flags: number
): ValidationResult {
  if (flags !== 0 || reservedA !== 0n || reservedB !== 0n) {
    return warn("Reserved header fields are non-zero");
  }
  return ok();
}

export function validateControlByte(controlByte: number): ValidationResult {
  const errors: string[] = [];
  const warnings: string[] = [];

  if (!Number.isInteger(controlByte) || controlByte < 0 || controlByte > 0xff) {
    errors.push("Control byte must fit in uint8");
  } else {
    const groupResult = validateGroupId(controlByte & CONTROL_BYTE_MASKS.GROUP_ID);
    mergeResult(errors, warnings, groupResult);
    const reservedResult = validateReservedBits(controlByte);
    mergeResult(errors, warnings, reservedResult);
  }

  return finalize(errors, warnings);
}

export function validateGroupId(groupId: number): ValidationResult {
  if (!Number.isInteger(groupId) || groupId < 0 || groupId > 0x0f) {
    return fail("Group ID must be 0-15");
  }
  return ok();
}

export function validateReservedBits(controlByte: number): ValidationResult {
  if ((controlByte & CONTROL_BYTE_MASKS.RESERVED) !== 0) {
    return warn("Control byte reserved bits are non-zero");
  }
  return ok();
}

export function validateGroupMask(mask: number): ValidationResult {
  if (!Number.isInteger(mask) || mask < 0 || mask > 0xffff) {
    return fail("GroupMask must fit in uint16");
  }
  return ok();
}

export function validateOpcode(opcode: number, opcodeSetId: number): ValidationResult {
  if (!Number.isInteger(opcode) || opcode < 0 || opcode > 0xff) {
    return fail("Opcode must fit in uint8");
  }
  if (opcodeSetId !== 0) {
    return fail("Unknown OpcodeSetId");
  }
  if (opcode > 0x0c) {
    return fail("Unknown opcode for base set");
  }
  return ok();
}

export function validateTiming(timing: number): ValidationResult {
  if (!Number.isInteger(timing) || timing < 0 || timing > 0xff) {
    return fail("Timing must fit in uint8");
  }
  return ok();
}

export function validateGrinFile(
  file: GrinFile,
  mode: ValidationMode = "permissive"
): ValidationReport {
  const errors: string[] = [];
  const warnings: string[] = [];
  const info: string[] = [];

  const header = file.header;
  mergeResult(errors, warnings, validateMagic(header.magic));
  mergeResult(errors, warnings, validateVersion(header.versionMajor, header.versionMinor));
  mergeResult(errors, warnings, validateHeaderSize(header.headerSize));
  mergeResult(errors, warnings, validateDimensions(header.width, header.height));
  mergeResult(errors, warnings, validateTickMicros(header.tickMicros));
  mergeResult(errors, warnings, validateRuleCount(header.ruleCount));
  mergeResult(errors, warnings, validateOpcodeSetId(header.opcodeSetId));
  mergeResult(
    errors,
    warnings,
    validatePixelDataLength(header.pixelDataLength, header.width, header.height)
  );
  mergeResult(errors, warnings, validateFileLength(header.fileLength, header.pixelDataLength));
  mergeResult(errors, warnings, validatePixelDataOffset(header.pixelDataOffset));
  mergeResult(errors, warnings, validateReservedFields(header.reservedA, header.reservedB, header.flags));

  const expectedPixelCount = header.width * header.height;
  if (!Number.isSafeInteger(expectedPixelCount) || expectedPixelCount < 0) {
    errors.push("Pixel count exceeds safe integer range");
  } else if (file.pixels.length !== expectedPixelCount) {
    errors.push("Pixel array length does not match header dimensions");
  }

  if (file.rules.length !== header.ruleCount) {
    errors.push("Rule array length does not match header ruleCount");
  }

  let reservedBitsCount = 0;
  for (const pixel of file.pixels) {
    if ((pixel.c & CONTROL_BYTE_MASKS.RESERVED) !== 0) {
      reservedBitsCount += 1;
    }
  }
  if (reservedBitsCount > 0) {
    warnings.push(`Control byte reserved bits set on ${reservedBitsCount} pixels`);
  }

  file.rules.forEach((rule, index) => {
    const groupMaskResult = validateGroupMask(rule.groupMask);
    const opcodeResult = validateOpcode(rule.opcode, header.opcodeSetId);
    const timingResult = validateTiming(rule.timing);
    prefixResult(errors, warnings, groupMaskResult, `Rule ${index}: `);
    prefixResult(errors, warnings, opcodeResult, `Rule ${index}: `);
    prefixResult(errors, warnings, timingResult, `Rule ${index}: `);
  });

  info.push(`Pixels: ${file.pixels.length}`);
  info.push(`Rules: ${file.rules.length}`);

  const okResult = mode === "strict" ? errors.length === 0 && warnings.length === 0 : errors.length === 0;
  return { ok: okResult, errors, warnings, info };
}

function ok(): ValidationResult {
  return { ok: true, errors: [], warnings: [] };
}

function warn(message: string): ValidationResult {
  return { ok: true, errors: [], warnings: [message] };
}

function fail(message: string): ValidationResult {
  return { ok: false, errors: [message], warnings: [] };
}

function finalize(errors: string[], warnings: string[]): ValidationResult {
  return { ok: errors.length === 0, errors, warnings };
}

function mergeResult(
  errors: string[],
  warnings: string[],
  result: ValidationResult
): void {
  errors.push(...result.errors);
  warnings.push(...result.warnings);
}

function prefixResult(
  errors: string[],
  warnings: string[],
  result: ValidationResult,
  prefix: string
): void {
  errors.push(...result.errors.map((error) => `${prefix}${error}`));
  warnings.push(...result.warnings.map((warning) => `${prefix}${warning}`));
}

#####/web/package-lock.json#####
{
  "name": "@grin-format/web",
  "version": "0.1.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "@grin-format/web",
      "version": "0.1.0",
      "license": "MIT",
      "devDependencies": {
        "@rollup/plugin-commonjs": "^25.0.8",
        "@rollup/plugin-node-resolve": "^15.2.3",
        "@types/node": "^20.0.0",
        "@typescript-eslint/eslint-plugin": "^6.0.0",
        "@typescript-eslint/parser": "^6.0.0",
        "eslint": "^8.56.0",
        "rollup": "^4.24.0",
        "tsx": "^4.19.2",
        "typedoc": "^0.25.13",
        "typescript": "^5.3.0",
        "vitest": "^1.6.0"
      },
      "engines": {
        "node": ">=18.0.0"
      }
    },
    "node_modules/@esbuild/aix-ppc64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.27.2.tgz",
      "integrity": "sha512-GZMB+a0mOMZs4MpDbj8RJp4cw+w1WV5NYD6xzgvzUJ5Ek2jerwfO2eADyI6ExDSUED+1X8aMbegahsJi+8mgpw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-arm": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.27.2.tgz",
      "integrity": "sha512-DVNI8jlPa7Ujbr1yjU2PfUSRtAUZPG9I1RwW4F4xFB1Imiu2on0ADiI/c3td+KmDtVKNbi+nffGDQMfcIMkwIA==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-arm64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.27.2.tgz",
      "integrity": "sha512-pvz8ZZ7ot/RBphf8fv60ljmaoydPU12VuXHImtAs0XhLLw+EXBi2BLe3OYSBslR4rryHvweW5gmkKFwTiFy6KA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-x64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.27.2.tgz",
      "integrity": "sha512-z8Ank4Byh4TJJOh4wpz8g2vDy75zFL0TlZlkUkEwYXuPSgX8yzep596n6mT7905kA9uHZsf/o2OJZubl2l3M7A==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/darwin-arm64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.27.2.tgz",
      "integrity": "sha512-davCD2Zc80nzDVRwXTcQP/28fiJbcOwvdolL0sOiOsbwBa72kegmVU0Wrh1MYrbuCL98Omp5dVhQFWRKR2ZAlg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/darwin-x64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.27.2.tgz",
      "integrity": "sha512-ZxtijOmlQCBWGwbVmwOF/UCzuGIbUkqB1faQRf5akQmxRJ1ujusWsb3CVfk/9iZKr2L5SMU5wPBi1UWbvL+VQA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/freebsd-arm64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.27.2.tgz",
      "integrity": "sha512-lS/9CN+rgqQ9czogxlMcBMGd+l8Q3Nj1MFQwBZJyoEKI50XGxwuzznYdwcav6lpOGv5BqaZXqvBSiB/kJ5op+g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/freebsd-x64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.27.2.tgz",
      "integrity": "sha512-tAfqtNYb4YgPnJlEFu4c212HYjQWSO/w/h/lQaBK7RbwGIkBOuNKQI9tqWzx7Wtp7bTPaGC6MJvWI608P3wXYA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-arm": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.27.2.tgz",
      "integrity": "sha512-vWfq4GaIMP9AIe4yj1ZUW18RDhx6EPQKjwe7n8BbIecFtCQG4CfHGaHuh7fdfq+y3LIA2vGS/o9ZBGVxIDi9hw==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-arm64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.27.2.tgz",
      "integrity": "sha512-hYxN8pr66NsCCiRFkHUAsxylNOcAQaxSSkHMMjcpx0si13t1LHFphxJZUiGwojB1a/Hd5OiPIqDdXONia6bhTw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-ia32": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.27.2.tgz",
      "integrity": "sha512-MJt5BRRSScPDwG2hLelYhAAKh9imjHK5+NE/tvnRLbIqUWa+0E9N4WNMjmp/kXXPHZGqPLxggwVhz7QP8CTR8w==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-loong64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.27.2.tgz",
      "integrity": "sha512-lugyF1atnAT463aO6KPshVCJK5NgRnU4yb3FUumyVz+cGvZbontBgzeGFO1nF+dPueHD367a2ZXe1NtUkAjOtg==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-mips64el": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.27.2.tgz",
      "integrity": "sha512-nlP2I6ArEBewvJ2gjrrkESEZkB5mIoaTswuqNFRv/WYd+ATtUpe9Y09RnJvgvdag7he0OWgEZWhviS1OTOKixw==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-ppc64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.27.2.tgz",
      "integrity": "sha512-C92gnpey7tUQONqg1n6dKVbx3vphKtTHJaNG2Ok9lGwbZil6DrfyecMsp9CrmXGQJmZ7iiVXvvZH6Ml5hL6XdQ==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-riscv64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.27.2.tgz",
      "integrity": "sha512-B5BOmojNtUyN8AXlK0QJyvjEZkWwy/FKvakkTDCziX95AowLZKR6aCDhG7LeF7uMCXEJqwa8Bejz5LTPYm8AvA==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-s390x": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.27.2.tgz",
      "integrity": "sha512-p4bm9+wsPwup5Z8f4EpfN63qNagQ47Ua2znaqGH6bqLlmJ4bx97Y9JdqxgGZ6Y8xVTixUnEkoKSHcpRlDnNr5w==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-x64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.27.2.tgz",
      "integrity": "sha512-uwp2Tip5aPmH+NRUwTcfLb+W32WXjpFejTIOWZFw/v7/KnpCDKG66u4DLcurQpiYTiYwQ9B7KOeMJvLCu/OvbA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/netbsd-arm64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-arm64/-/netbsd-arm64-0.27.2.tgz",
      "integrity": "sha512-Kj6DiBlwXrPsCRDeRvGAUb/LNrBASrfqAIok+xB0LxK8CHqxZ037viF13ugfsIpePH93mX7xfJp97cyDuTZ3cw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/netbsd-x64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.27.2.tgz",
      "integrity": "sha512-HwGDZ0VLVBY3Y+Nw0JexZy9o/nUAWq9MlV7cahpaXKW6TOzfVno3y3/M8Ga8u8Yr7GldLOov27xiCnqRZf0tCA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openbsd-arm64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-arm64/-/openbsd-arm64-0.27.2.tgz",
      "integrity": "sha512-DNIHH2BPQ5551A7oSHD0CKbwIA/Ox7+78/AWkbS5QoRzaqlev2uFayfSxq68EkonB+IKjiuxBFoV8ESJy8bOHA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openbsd-x64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.27.2.tgz",
      "integrity": "sha512-/it7w9Nb7+0KFIzjalNJVR5bOzA9Vay+yIPLVHfIQYG/j+j9VTH84aNB8ExGKPU4AzfaEvN9/V4HV+F+vo8OEg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openharmony-arm64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/openharmony-arm64/-/openharmony-arm64-0.27.2.tgz",
      "integrity": "sha512-LRBbCmiU51IXfeXk59csuX/aSaToeG7w48nMwA6049Y4J4+VbWALAuXcs+qcD04rHDuSCSRKdmY63sruDS5qag==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openharmony"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/sunos-x64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.27.2.tgz",
      "integrity": "sha512-kMtx1yqJHTmqaqHPAzKCAkDaKsffmXkPHThSfRwZGyuqyIeBvf08KSsYXl+abf5HDAPMJIPnbBfXvP2ZC2TfHg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-arm64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.27.2.tgz",
      "integrity": "sha512-Yaf78O/B3Kkh+nKABUF++bvJv5Ijoy9AN1ww904rOXZFLWVc5OLOfL56W+C8F9xn5JQZa3UX6m+IktJnIb1Jjg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-ia32": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.27.2.tgz",
      "integrity": "sha512-Iuws0kxo4yusk7sw70Xa2E2imZU5HoixzxfGCdxwBdhiDgt9vX9VUCBhqcwY7/uh//78A1hMkkROMJq9l27oLQ==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-x64": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.27.2.tgz",
      "integrity": "sha512-sRdU18mcKf7F+YgheI/zGf5alZatMUTKj/jNS6l744f9u3WFu4v7twcUI9vu4mknF4Y9aDlblIie0IM+5xxaqQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@eslint-community/eslint-utils": {
      "version": "4.9.1",
      "resolved": "https://registry.npmjs.org/@eslint-community/eslint-utils/-/eslint-utils-4.9.1.tgz",
      "integrity": "sha512-phrYmNiYppR7znFEdqgfWHXR6NCkZEK7hwWDHZUjit/2/U0r6XvkDl0SYnoM51Hq7FhCGdLDT6zxCCOY1hexsQ==",
      "dev": true,
      "dependencies": {
        "eslint-visitor-keys": "^3.4.3"
      },
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      },
      "peerDependencies": {
        "eslint": "^6.0.0 || ^7.0.0 || >=8.0.0"
      }
    },
    "node_modules/@eslint-community/regexpp": {
      "version": "4.12.2",
      "resolved": "https://registry.npmjs.org/@eslint-community/regexpp/-/regexpp-4.12.2.tgz",
      "integrity": "sha512-EriSTlt5OC9/7SXkRSCAhfSxxoSUgBm33OH+IkwbdpgoqsSsUg7y3uh+IICI/Qg4BBWr3U2i39RpmycbxMq4ew==",
      "dev": true,
      "engines": {
        "node": "^12.0.0 || ^14.0.0 || >=16.0.0"
      }
    },
    "node_modules/@eslint/eslintrc": {
      "version": "2.1.4",
      "resolved": "https://registry.npmjs.org/@eslint/eslintrc/-/eslintrc-2.1.4.tgz",
      "integrity": "sha512-269Z39MS6wVJtsoUl10L60WdkhJVdPG24Q4eZTH3nnF6lpvSShEK3wQjDX9JRWAUPvPh7COouPpU9IrqaZFvtQ==",
      "dev": true,
      "dependencies": {
        "ajv": "^6.12.4",
        "debug": "^4.3.2",
        "espree": "^9.6.0",
        "globals": "^13.19.0",
        "ignore": "^5.2.0",
        "import-fresh": "^3.2.1",
        "js-yaml": "^4.1.0",
        "minimatch": "^3.1.2",
        "strip-json-comments": "^3.1.1"
      },
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/@eslint/eslintrc/node_modules/brace-expansion": {
      "version": "1.1.12",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.12.tgz",
      "integrity": "sha512-9T9UjW3r0UW5c1Q7GTwllptXwhvYmEzFhzMfZ9H7FQWt+uZePjZPjBP/W1ZEyZ1twGWom5/56TF4lPcqjnDHcg==",
      "dev": true,
      "dependencies": {
        "balanced-match": "^1.0.0",
        "concat-map": "0.0.1"
      }
    },
    "node_modules/@eslint/eslintrc/node_modules/minimatch": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
      "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
      "dev": true,
      "dependencies": {
        "brace-expansion": "^1.1.7"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/@eslint/js": {
      "version": "8.57.1",
      "resolved": "https://registry.npmjs.org/@eslint/js/-/js-8.57.1.tgz",
      "integrity": "sha512-d9zaMRSTIKDLhctzH12MtXvJKSSUhaHcjV+2Z+GK+EEY7XKpP5yR4x+N3TAcHTcu963nIr+TMcCb4DBCYX1z6Q==",
      "dev": true,
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      }
    },
    "node_modules/@humanwhocodes/config-array": {
      "version": "0.13.0",
      "resolved": "https://registry.npmjs.org/@humanwhocodes/config-array/-/config-array-0.13.0.tgz",
      "integrity": "sha512-DZLEEqFWQFiyK6h5YIeynKx7JlvCYWL0cImfSRXZ9l4Sg2efkFGTuFf6vzXjK1cq6IYkU+Eg/JizXw+TD2vRNw==",
      "deprecated": "Use @eslint/config-array instead",
      "dev": true,
      "dependencies": {
        "@humanwhocodes/object-schema": "^2.0.3",
        "debug": "^4.3.1",
        "minimatch": "^3.0.5"
      },
      "engines": {
        "node": ">=10.10.0"
      }
    },
    "node_modules/@humanwhocodes/config-array/node_modules/brace-expansion": {
      "version": "1.1.12",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.12.tgz",
      "integrity": "sha512-9T9UjW3r0UW5c1Q7GTwllptXwhvYmEzFhzMfZ9H7FQWt+uZePjZPjBP/W1ZEyZ1twGWom5/56TF4lPcqjnDHcg==",
      "dev": true,
      "dependencies": {
        "balanced-match": "^1.0.0",
        "concat-map": "0.0.1"
      }
    },
    "node_modules/@humanwhocodes/config-array/node_modules/minimatch": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
      "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
      "dev": true,
      "dependencies": {
        "brace-expansion": "^1.1.7"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/@humanwhocodes/module-importer": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/@humanwhocodes/module-importer/-/module-importer-1.0.1.tgz",
      "integrity": "sha512-bxveV4V8v5Yb4ncFTT3rPSgZBOpCkjfK0y4oVVVJwIuDVBRMDXrPyXRL988i5ap9m9bnyEEjWfm5WkBmtffLfA==",
      "dev": true,
      "engines": {
        "node": ">=12.22"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/nzakas"
      }
    },
    "node_modules/@humanwhocodes/object-schema": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/@humanwhocodes/object-schema/-/object-schema-2.0.3.tgz",
      "integrity": "sha512-93zYdMES/c1D69yZiKDBj0V24vqNzB/koF26KPaagAfd3P/4gUlh3Dys5ogAK+Exi9QyzlD8x/08Zt7wIKcDcA==",
      "deprecated": "Use @eslint/object-schema instead",
      "dev": true
    },
    "node_modules/@jest/schemas": {
      "version": "29.6.3",
      "resolved": "https://registry.npmjs.org/@jest/schemas/-/schemas-29.6.3.tgz",
      "integrity": "sha512-mo5j5X+jIZmJQveBKeS/clAueipV7KgiX1vMgCxam1RNYiqE1w62n0/tJJnHtjW8ZHcQco5gY85jA3mi0L+nSA==",
      "dev": true,
      "dependencies": {
        "@sinclair/typebox": "^0.27.8"
      },
      "engines": {
        "node": "^14.15.0 || ^16.10.0 || >=18.0.0"
      }
    },
    "node_modules/@jridgewell/sourcemap-codec": {
      "version": "1.5.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
      "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
      "dev": true
    },
    "node_modules/@nodelib/fs.scandir": {
      "version": "2.1.5",
      "resolved": "https://registry.npmjs.org/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz",
      "integrity": "sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==",
      "dev": true,
      "dependencies": {
        "@nodelib/fs.stat": "2.0.5",
        "run-parallel": "^1.1.9"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@nodelib/fs.stat": {
      "version": "2.0.5",
      "resolved": "https://registry.npmjs.org/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz",
      "integrity": "sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==",
      "dev": true,
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@nodelib/fs.walk": {
      "version": "1.2.8",
      "resolved": "https://registry.npmjs.org/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz",
      "integrity": "sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==",
      "dev": true,
      "dependencies": {
        "@nodelib/fs.scandir": "2.1.5",
        "fastq": "^1.6.0"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@rollup/plugin-commonjs": {
      "version": "25.0.8",
      "resolved": "https://registry.npmjs.org/@rollup/plugin-commonjs/-/plugin-commonjs-25.0.8.tgz",
      "integrity": "sha512-ZEZWTK5n6Qde0to4vS9Mr5x/0UZoqCxPVR9KRUjU4kA2sO7GEUn1fop0DAwpO6z0Nw/kJON9bDmSxdWxO/TT1A==",
      "dev": true,
      "dependencies": {
        "@rollup/pluginutils": "^5.0.1",
        "commondir": "^1.0.1",
        "estree-walker": "^2.0.2",
        "glob": "^8.0.3",
        "is-reference": "1.2.1",
        "magic-string": "^0.30.3"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "rollup": "^2.68.0||^3.0.0||^4.0.0"
      },
      "peerDependenciesMeta": {
        "rollup": {
          "optional": true
        }
      }
    },
    "node_modules/@rollup/plugin-commonjs/node_modules/glob": {
      "version": "8.1.0",
      "resolved": "https://registry.npmjs.org/glob/-/glob-8.1.0.tgz",
      "integrity": "sha512-r8hpEjiQEYlF2QU0df3dS+nxxSIreXQS1qRhMJM0Q5NDdR386C7jb7Hwwod8Fgiuex+k0GFjgft18yvxm5XoCQ==",
      "deprecated": "Glob versions prior to v9 are no longer supported",
      "dev": true,
      "dependencies": {
        "fs.realpath": "^1.0.0",
        "inflight": "^1.0.4",
        "inherits": "2",
        "minimatch": "^5.0.1",
        "once": "^1.3.0"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/@rollup/plugin-commonjs/node_modules/minimatch": {
      "version": "5.1.6",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-5.1.6.tgz",
      "integrity": "sha512-lKwV/1brpG6mBUFHtb7NUmtABCb2WZZmm2wNiOA5hAb8VdCS4B3dtMWyvcoViccwAW/COERjXLt0zP1zXUN26g==",
      "dev": true,
      "dependencies": {
        "brace-expansion": "^2.0.1"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/@rollup/plugin-node-resolve": {
      "version": "15.3.1",
      "resolved": "https://registry.npmjs.org/@rollup/plugin-node-resolve/-/plugin-node-resolve-15.3.1.tgz",
      "integrity": "sha512-tgg6b91pAybXHJQMAAwW9VuWBO6Thi+q7BCNARLwSqlmsHz0XYURtGvh/AuwSADXSI4h/2uHbs7s4FzlZDGSGA==",
      "dev": true,
      "dependencies": {
        "@rollup/pluginutils": "^5.0.1",
        "@types/resolve": "1.20.2",
        "deepmerge": "^4.2.2",
        "is-module": "^1.0.0",
        "resolve": "^1.22.1"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "rollup": "^2.78.0||^3.0.0||^4.0.0"
      },
      "peerDependenciesMeta": {
        "rollup": {
          "optional": true
        }
      }
    },
    "node_modules/@rollup/pluginutils": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/@rollup/pluginutils/-/pluginutils-5.3.0.tgz",
      "integrity": "sha512-5EdhGZtnu3V88ces7s53hhfK5KSASnJZv8Lulpc04cWO3REESroJXg73DFsOmgbU2BhwV0E20bu2IDZb3VKW4Q==",
      "dev": true,
      "dependencies": {
        "@types/estree": "^1.0.0",
        "estree-walker": "^2.0.2",
        "picomatch": "^4.0.2"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "rollup": "^1.20.0||^2.0.0||^3.0.0||^4.0.0"
      },
      "peerDependenciesMeta": {
        "rollup": {
          "optional": true
        }
      }
    },
    "node_modules/@rollup/pluginutils/node_modules/picomatch": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
      "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
      "dev": true,
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/@rollup/rollup-android-arm-eabi": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.55.1.tgz",
      "integrity": "sha512-9R0DM/ykwfGIlNu6+2U09ga0WXeZ9MRC2Ter8jnz8415VbuIykVuc6bhdrbORFZANDmTDvq26mJrEVTl8TdnDg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-android-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.55.1.tgz",
      "integrity": "sha512-eFZCb1YUqhTysgW3sj/55du5cG57S7UTNtdMjCW7LwVcj3dTTcowCsC8p7uBdzKsZYa8J7IDE8lhMI+HX1vQvg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-darwin-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.55.1.tgz",
      "integrity": "sha512-p3grE2PHcQm2e8PSGZdzIhCKbMCw/xi9XvMPErPhwO17vxtvCN5FEA2mSLgmKlCjHGMQTP6phuQTYWUnKewwGg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-darwin-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.55.1.tgz",
      "integrity": "sha512-rDUjG25C9qoTm+e02Esi+aqTKSBYwVTaoS1wxcN47/Luqef57Vgp96xNANwt5npq9GDxsH7kXxNkJVEsWEOEaQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.55.1.tgz",
      "integrity": "sha512-+JiU7Jbp5cdxekIgdte0jfcu5oqw4GCKr6i3PJTlXTCU5H5Fvtkpbs4XJHRmWNXF+hKmn4v7ogI5OQPaupJgOg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.55.1.tgz",
      "integrity": "sha512-V5xC1tOVWtLLmr3YUk2f6EJK4qksksOYiz/TCsFHu/R+woubcLWdC9nZQmwjOAbmExBIVKsm1/wKmEy4z4u4Bw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.55.1.tgz",
      "integrity": "sha512-Rn3n+FUk2J5VWx+ywrG/HGPTD9jXNbicRtTM11e/uorplArnXZYsVifnPPqNNP5BsO3roI4n8332ukpY/zN7rQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.55.1.tgz",
      "integrity": "sha512-grPNWydeKtc1aEdrJDWk4opD7nFtQbMmV7769hiAaYyUKCT1faPRm2av8CX1YJsZ4TLAZcg9gTR1KvEzoLjXkg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.55.1.tgz",
      "integrity": "sha512-a59mwd1k6x8tXKcUxSyISiquLwB5pX+fJW9TkWU46lCqD/GRDe9uDN31jrMmVP3feI3mhAdvcCClhV8V5MhJFQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.55.1.tgz",
      "integrity": "sha512-puS1MEgWX5GsHSoiAsF0TYrpomdvkaXm0CofIMG5uVkP6IBV+ZO9xhC5YEN49nsgYo1DuuMquF9+7EDBVYu4uA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-gnu/-/rollup-linux-loong64-gnu-4.55.1.tgz",
      "integrity": "sha512-r3Wv40in+lTsULSb6nnoudVbARdOwb2u5fpeoOAZjFLznp6tDU8kd+GTHmJoqZ9lt6/Sys33KdIHUaQihFcu7g==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-musl/-/rollup-linux-loong64-musl-4.55.1.tgz",
      "integrity": "sha512-MR8c0+UxAlB22Fq4R+aQSPBayvYa3+9DrwG/i1TKQXFYEaoW3B5b/rkSRIypcZDdWjWnpcvxbNaAJDcSbJU3Lw==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.55.1.tgz",
      "integrity": "sha512-3KhoECe1BRlSYpMTeVrD4sh2Pw2xgt4jzNSZIIPLFEsnQn9gAnZagW9+VqDqAHgm1Xc77LzJOo2LdigS5qZ+gw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-musl/-/rollup-linux-ppc64-musl-4.55.1.tgz",
      "integrity": "sha512-ziR1OuZx0vdYZZ30vueNZTg73alF59DicYrPViG0NEgDVN8/Jl87zkAPu4u6VjZST2llgEUjaiNl9JM6HH1Vdw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.55.1.tgz",
      "integrity": "sha512-uW0Y12ih2XJRERZ4jAfKamTyIHVMPQnTZcQjme2HMVDAHY4amf5u414OqNYC+x+LzRdRcnIG1YodLrrtA8xsxw==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.55.1.tgz",
      "integrity": "sha512-u9yZ0jUkOED1BFrqu3BwMQoixvGHGZ+JhJNkNKY/hyoEgOwlqKb62qu+7UjbPSHYjiVy8kKJHvXKv5coH4wDeg==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-s390x-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.55.1.tgz",
      "integrity": "sha512-/0PenBCmqM4ZUd0190j7J0UsQ/1nsi735iPRakO8iPciE7BQ495Y6msPzaOmvx0/pn+eJVVlZrNrSh4WSYLxNg==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.55.1.tgz",
      "integrity": "sha512-a8G4wiQxQG2BAvo+gU6XrReRRqj+pLS2NGXKm8io19goR+K8lw269eTrPkSdDTALwMmJp4th2Uh0D8J9bEV1vg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.55.1.tgz",
      "integrity": "sha512-bD+zjpFrMpP/hqkfEcnjXWHMw5BIghGisOKPj+2NaNDuVT+8Ds4mPf3XcPHuat1tz89WRL+1wbcxKY3WSbiT7w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-openbsd-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openbsd-x64/-/rollup-openbsd-x64-4.55.1.tgz",
      "integrity": "sha512-eLXw0dOiqE4QmvikfQ6yjgkg/xDM+MdU9YJuP4ySTibXU0oAvnEWXt7UDJmD4UkYialMfOGFPJnIHSe/kdzPxg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openbsd"
      ]
    },
    "node_modules/@rollup/rollup-openharmony-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.55.1.tgz",
      "integrity": "sha512-xzm44KgEP11te3S2HCSyYf5zIzWmx3n8HDCc7EE59+lTcswEWNpvMLfd9uJvVX8LCg9QWG67Xt75AuHn4vgsXw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openharmony"
      ]
    },
    "node_modules/@rollup/rollup-win32-arm64-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.55.1.tgz",
      "integrity": "sha512-yR6Bl3tMC/gBok5cz/Qi0xYnVbIxGx5Fcf/ca0eB6/6JwOY+SRUcJfI0OpeTpPls7f194as62thCt/2BjxYN8g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-ia32-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.55.1.tgz",
      "integrity": "sha512-3fZBidchE0eY0oFZBnekYCfg+5wAB0mbpCBuofh5mZuzIU/4jIVkbESmd2dOsFNS78b53CYv3OAtwqkZZmU5nA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-gnu/-/rollup-win32-x64-gnu-4.55.1.tgz",
      "integrity": "sha512-xGGY5pXj69IxKb4yv/POoocPy/qmEGhimy/FoTpTSVju3FYXUQQMFCaZZXJVidsmGxRioZAwpThl/4zX41gRKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.55.1.tgz",
      "integrity": "sha512-SPEpaL6DX4rmcXtnhdrQYgzQ5W2uW3SCJch88lB2zImhJRhIIK44fkUrgIV/Q8yUNfw5oyZ5vkeQsZLhCb06lw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@sinclair/typebox": {
      "version": "0.27.8",
      "resolved": "https://registry.npmjs.org/@sinclair/typebox/-/typebox-0.27.8.tgz",
      "integrity": "sha512-+Fj43pSMwJs4KRrH/938Uf+uAELIgVBmQzg/q1YG10djyfA3TnrU8N8XzqCh/okZdszqBQTZf96idMfE5lnwTA==",
      "dev": true
    },
    "node_modules/@types/estree": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
      "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
      "dev": true
    },
    "node_modules/@types/json-schema": {
      "version": "7.0.15",
      "resolved": "https://registry.npmjs.org/@types/json-schema/-/json-schema-7.0.15.tgz",
      "integrity": "sha512-5+fP8P8MFNC+AyZCDxrB2pkZFPGzqQWUzpSeuuVLvm8VMcorNYavBqoFcxK8bQz4Qsbn4oUEEem4wDLfcysGHA==",
      "dev": true
    },
    "node_modules/@types/node": {
      "version": "20.19.28",
      "resolved": "https://registry.npmjs.org/@types/node/-/node-20.19.28.tgz",
      "integrity": "sha512-VyKBr25BuFDzBFCK5sUM6ZXiWfqgCTwTAOK8qzGV/m9FCirXYDlmczJ+d5dXBAQALGCdRRdbteKYfJ84NGEusw==",
      "dev": true,
      "dependencies": {
        "undici-types": "~6.21.0"
      }
    },
    "node_modules/@types/resolve": {
      "version": "1.20.2",
      "resolved": "https://registry.npmjs.org/@types/resolve/-/resolve-1.20.2.tgz",
      "integrity": "sha512-60BCwRFOZCQhDncwQdxxeOEEkbc5dIMccYLwbxsS4TUNeVECQ/pBJ0j09mrHOl/JJvpRPGwO9SvE4nR2Nb/a4Q==",
      "dev": true
    },
    "node_modules/@types/semver": {
      "version": "7.7.1",
      "resolved": "https://registry.npmjs.org/@types/semver/-/semver-7.7.1.tgz",
      "integrity": "sha512-FmgJfu+MOcQ370SD0ev7EI8TlCAfKYU+B4m5T3yXc1CiRN94g/SZPtsCkk506aUDtlMnFZvasDwHHUcZUEaYuA==",
      "dev": true
    },
    "node_modules/@typescript-eslint/eslint-plugin": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/@typescript-eslint/eslint-plugin/-/eslint-plugin-6.21.0.tgz",
      "integrity": "sha512-oy9+hTPCUFpngkEZUSzbf9MxI65wbKFoQYsgPdILTfbUldp5ovUuphZVe4i30emU9M/kP+T64Di0mxl7dSw3MA==",
      "dev": true,
      "dependencies": {
        "@eslint-community/regexpp": "^4.5.1",
        "@typescript-eslint/scope-manager": "6.21.0",
        "@typescript-eslint/type-utils": "6.21.0",
        "@typescript-eslint/utils": "6.21.0",
        "@typescript-eslint/visitor-keys": "6.21.0",
        "debug": "^4.3.4",
        "graphemer": "^1.4.0",
        "ignore": "^5.2.4",
        "natural-compare": "^1.4.0",
        "semver": "^7.5.4",
        "ts-api-utils": "^1.0.1"
      },
      "engines": {
        "node": "^16.0.0 || >=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/typescript-eslint"
      },
      "peerDependencies": {
        "@typescript-eslint/parser": "^6.0.0 || ^6.0.0-alpha",
        "eslint": "^7.0.0 || ^8.0.0"
      },
      "peerDependenciesMeta": {
        "typescript": {
          "optional": true
        }
      }
    },
    "node_modules/@typescript-eslint/parser": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/@typescript-eslint/parser/-/parser-6.21.0.tgz",
      "integrity": "sha512-tbsV1jPne5CkFQCgPBcDOt30ItF7aJoZL997JSF7MhGQqOeT3svWRYxiqlfA5RUdlHN6Fi+EI9bxqbdyAUZjYQ==",
      "dev": true,
      "dependencies": {
        "@typescript-eslint/scope-manager": "6.21.0",
        "@typescript-eslint/types": "6.21.0",
        "@typescript-eslint/typescript-estree": "6.21.0",
        "@typescript-eslint/visitor-keys": "6.21.0",
        "debug": "^4.3.4"
      },
      "engines": {
        "node": "^16.0.0 || >=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/typescript-eslint"
      },
      "peerDependencies": {
        "eslint": "^7.0.0 || ^8.0.0"
      },
      "peerDependenciesMeta": {
        "typescript": {
          "optional": true
        }
      }
    },
    "node_modules/@typescript-eslint/scope-manager": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/@typescript-eslint/scope-manager/-/scope-manager-6.21.0.tgz",
      "integrity": "sha512-OwLUIWZJry80O99zvqXVEioyniJMa+d2GrqpUTqi5/v5D5rOrppJVBPa0yKCblcigC0/aYAzxxqQ1B+DS2RYsg==",
      "dev": true,
      "dependencies": {
        "@typescript-eslint/types": "6.21.0",
        "@typescript-eslint/visitor-keys": "6.21.0"
      },
      "engines": {
        "node": "^16.0.0 || >=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/typescript-eslint"
      }
    },
    "node_modules/@typescript-eslint/type-utils": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/@typescript-eslint/type-utils/-/type-utils-6.21.0.tgz",
      "integrity": "sha512-rZQI7wHfao8qMX3Rd3xqeYSMCL3SoiSQLBATSiVKARdFGCYSRvmViieZjqc58jKgs8Y8i9YvVVhRbHSTA4VBag==",
      "dev": true,
      "dependencies": {
        "@typescript-eslint/typescript-estree": "6.21.0",
        "@typescript-eslint/utils": "6.21.0",
        "debug": "^4.3.4",
        "ts-api-utils": "^1.0.1"
      },
      "engines": {
        "node": "^16.0.0 || >=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/typescript-eslint"
      },
      "peerDependencies": {
        "eslint": "^7.0.0 || ^8.0.0"
      },
      "peerDependenciesMeta": {
        "typescript": {
          "optional": true
        }
      }
    },
    "node_modules/@typescript-eslint/types": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/@typescript-eslint/types/-/types-6.21.0.tgz",
      "integrity": "sha512-1kFmZ1rOm5epu9NZEZm1kckCDGj5UJEf7P1kliH4LKu/RkwpsfqqGmY2OOcUs18lSlQBKLDYBOGxRVtrMN5lpg==",
      "dev": true,
      "engines": {
        "node": "^16.0.0 || >=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/typescript-eslint"
      }
    },
    "node_modules/@typescript-eslint/typescript-estree": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/@typescript-eslint/typescript-estree/-/typescript-estree-6.21.0.tgz",
      "integrity": "sha512-6npJTkZcO+y2/kr+z0hc4HwNfrrP4kNYh57ek7yCNlrBjWQ1Y0OS7jiZTkgumrvkX5HkEKXFZkkdFNkaW2wmUQ==",
      "dev": true,
      "dependencies": {
        "@typescript-eslint/types": "6.21.0",
        "@typescript-eslint/visitor-keys": "6.21.0",
        "debug": "^4.3.4",
        "globby": "^11.1.0",
        "is-glob": "^4.0.3",
        "minimatch": "9.0.3",
        "semver": "^7.5.4",
        "ts-api-utils": "^1.0.1"
      },
      "engines": {
        "node": "^16.0.0 || >=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/typescript-eslint"
      },
      "peerDependenciesMeta": {
        "typescript": {
          "optional": true
        }
      }
    },
    "node_modules/@typescript-eslint/utils": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/@typescript-eslint/utils/-/utils-6.21.0.tgz",
      "integrity": "sha512-NfWVaC8HP9T8cbKQxHcsJBY5YE1O33+jpMwN45qzWWaPDZgLIbo12toGMWnmhvCpd3sIxkpDw3Wv1B3dYrbDQQ==",
      "dev": true,
      "dependencies": {
        "@eslint-community/eslint-utils": "^4.4.0",
        "@types/json-schema": "^7.0.12",
        "@types/semver": "^7.5.0",
        "@typescript-eslint/scope-manager": "6.21.0",
        "@typescript-eslint/types": "6.21.0",
        "@typescript-eslint/typescript-estree": "6.21.0",
        "semver": "^7.5.4"
      },
      "engines": {
        "node": "^16.0.0 || >=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/typescript-eslint"
      },
      "peerDependencies": {
        "eslint": "^7.0.0 || ^8.0.0"
      }
    },
    "node_modules/@typescript-eslint/visitor-keys": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/@typescript-eslint/visitor-keys/-/visitor-keys-6.21.0.tgz",
      "integrity": "sha512-JJtkDduxLi9bivAB+cYOVMtbkqdPOhZ+ZI5LC47MIRrDV4Yn2o+ZnW10Nkmr28xRpSpdJ6Sm42Hjf2+REYXm0A==",
      "dev": true,
      "dependencies": {
        "@typescript-eslint/types": "6.21.0",
        "eslint-visitor-keys": "^3.4.1"
      },
      "engines": {
        "node": "^16.0.0 || >=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/typescript-eslint"
      }
    },
    "node_modules/@ungap/structured-clone": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/@ungap/structured-clone/-/structured-clone-1.3.0.tgz",
      "integrity": "sha512-WmoN8qaIAo7WTYWbAZuG8PYEhn5fkz7dZrqTBZ7dtt//lL2Gwms1IcnQ5yHqjDfX8Ft5j4YzDM23f87zBfDe9g==",
      "dev": true
    },
    "node_modules/@vitest/expect": {
      "version": "1.6.1",
      "resolved": "https://registry.npmjs.org/@vitest/expect/-/expect-1.6.1.tgz",
      "integrity": "sha512-jXL+9+ZNIJKruofqXuuTClf44eSpcHlgj3CiuNihUF3Ioujtmc0zIa3UJOW5RjDK1YLBJZnWBlPuqhYycLioog==",
      "dev": true,
      "dependencies": {
        "@vitest/spy": "1.6.1",
        "@vitest/utils": "1.6.1",
        "chai": "^4.3.10"
      },
      "funding": {
        "url": "https://opencollective.com/vitest"
      }
    },
    "node_modules/@vitest/runner": {
      "version": "1.6.1",
      "resolved": "https://registry.npmjs.org/@vitest/runner/-/runner-1.6.1.tgz",
      "integrity": "sha512-3nSnYXkVkf3mXFfE7vVyPmi3Sazhb/2cfZGGs0JRzFsPFvAMBEcrweV1V1GsrstdXeKCTXlJbvnQwGWgEIHmOA==",
      "dev": true,
      "dependencies": {
        "@vitest/utils": "1.6.1",
        "p-limit": "^5.0.0",
        "pathe": "^1.1.1"
      },
      "funding": {
        "url": "https://opencollective.com/vitest"
      }
    },
    "node_modules/@vitest/runner/node_modules/p-limit": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/p-limit/-/p-limit-5.0.0.tgz",
      "integrity": "sha512-/Eaoq+QyLSiXQ4lyYV23f14mZRQcXnxfHrN0vCai+ak9G0pp9iEQukIIZq5NccEvwRB8PUnZT0KsOoDCINS1qQ==",
      "dev": true,
      "dependencies": {
        "yocto-queue": "^1.0.0"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/@vitest/runner/node_modules/yocto-queue": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/yocto-queue/-/yocto-queue-1.2.2.tgz",
      "integrity": "sha512-4LCcse/U2MHZ63HAJVE+v71o7yOdIe4cZ70Wpf8D/IyjDKYQLV5GD46B+hSTjJsvV5PztjvHoU580EftxjDZFQ==",
      "dev": true,
      "engines": {
        "node": ">=12.20"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/@vitest/snapshot": {
      "version": "1.6.1",
      "resolved": "https://registry.npmjs.org/@vitest/snapshot/-/snapshot-1.6.1.tgz",
      "integrity": "sha512-WvidQuWAzU2p95u8GAKlRMqMyN1yOJkGHnx3M1PL9Raf7AQ1kwLKg04ADlCa3+OXUZE7BceOhVZiuWAbzCKcUQ==",
      "dev": true,
      "dependencies": {
        "magic-string": "^0.30.5",
        "pathe": "^1.1.1",
        "pretty-format": "^29.7.0"
      },
      "funding": {
        "url": "https://opencollective.com/vitest"
      }
    },
    "node_modules/@vitest/spy": {
      "version": "1.6.1",
      "resolved": "https://registry.npmjs.org/@vitest/spy/-/spy-1.6.1.tgz",
      "integrity": "sha512-MGcMmpGkZebsMZhbQKkAf9CX5zGvjkBTqf8Zx3ApYWXr3wG+QvEu2eXWfnIIWYSJExIp4V9FCKDEeygzkYrXMw==",
      "dev": true,
      "dependencies": {
        "tinyspy": "^2.2.0"
      },
      "funding": {
        "url": "https://opencollective.com/vitest"
      }
    },
    "node_modules/@vitest/utils": {
      "version": "1.6.1",
      "resolved": "https://registry.npmjs.org/@vitest/utils/-/utils-1.6.1.tgz",
      "integrity": "sha512-jOrrUvXM4Av9ZWiG1EajNto0u96kWAhJ1LmPmJhXXQx/32MecEKd10pOLYgS2BQx1TgkGhloPU1ArDW2vvaY6g==",
      "dev": true,
      "dependencies": {
        "diff-sequences": "^29.6.3",
        "estree-walker": "^3.0.3",
        "loupe": "^2.3.7",
        "pretty-format": "^29.7.0"
      },
      "funding": {
        "url": "https://opencollective.com/vitest"
      }
    },
    "node_modules/@vitest/utils/node_modules/estree-walker": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/estree-walker/-/estree-walker-3.0.3.tgz",
      "integrity": "sha512-7RUKfXgSMMkzt6ZuXmqapOurLGPPfgj6l9uRZ7lRGolvk0y2yocc35LdcxKC5PQZdn2DMqioAQ2NoWcrTKmm6g==",
      "dev": true,
      "dependencies": {
        "@types/estree": "^1.0.0"
      }
    },
    "node_modules/acorn": {
      "version": "8.15.0",
      "resolved": "https://registry.npmjs.org/acorn/-/acorn-8.15.0.tgz",
      "integrity": "sha512-NZyJarBfL7nWwIq+FDL6Zp/yHEhePMNnnJ0y3qfieCrmNvYct8uvtiV41UvlSe6apAfk0fY1FbWx+NwfmpvtTg==",
      "dev": true,
      "bin": {
        "acorn": "bin/acorn"
      },
      "engines": {
        "node": ">=0.4.0"
      }
    },
    "node_modules/acorn-jsx": {
      "version": "5.3.2",
      "resolved": "https://registry.npmjs.org/acorn-jsx/-/acorn-jsx-5.3.2.tgz",
      "integrity": "sha512-rq9s+JNhf0IChjtDXxllJ7g41oZk5SlXtp0LHwyA5cejwn7vKmKp4pPri6YEePv2PU65sAsegbXtIinmDFDXgQ==",
      "dev": true,
      "peerDependencies": {
        "acorn": "^6.0.0 || ^7.0.0 || ^8.0.0"
      }
    },
    "node_modules/acorn-walk": {
      "version": "8.3.4",
      "resolved": "https://registry.npmjs.org/acorn-walk/-/acorn-walk-8.3.4.tgz",
      "integrity": "sha512-ueEepnujpqee2o5aIYnvHU6C0A42MNdsIDeqy5BydrkuC5R1ZuUFnm27EeFJGoEHJQgn3uleRvmTXaJgfXbt4g==",
      "dev": true,
      "dependencies": {
        "acorn": "^8.11.0"
      },
      "engines": {
        "node": ">=0.4.0"
      }
    },
    "node_modules/ajv": {
      "version": "6.12.6",
      "resolved": "https://registry.npmjs.org/ajv/-/ajv-6.12.6.tgz",
      "integrity": "sha512-j3fVLgvTo527anyYyJOGTYJbG+vnnQYvE0m5mmkc1TK+nxAppkCLMIL0aZ4dblVCNoGShhm+kzE4ZUykBoMg4g==",
      "dev": true,
      "dependencies": {
        "fast-deep-equal": "^3.1.1",
        "fast-json-stable-stringify": "^2.0.0",
        "json-schema-traverse": "^0.4.1",
        "uri-js": "^4.2.2"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/epoberezkin"
      }
    },
    "node_modules/ansi-regex": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz",
      "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/ansi-sequence-parser": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/ansi-sequence-parser/-/ansi-sequence-parser-1.1.3.tgz",
      "integrity": "sha512-+fksAx9eG3Ab6LDnLs3ZqZa8KVJ/jYnX+D4Qe1azX+LFGFAXqynCQLOdLpNYN/l9e7l6hMWwZbrnctqr6eSQSw==",
      "dev": true
    },
    "node_modules/ansi-styles": {
      "version": "4.3.0",
      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-4.3.0.tgz",
      "integrity": "sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==",
      "dev": true,
      "dependencies": {
        "color-convert": "^2.0.1"
      },
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
      }
    },
    "node_modules/argparse": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/argparse/-/argparse-2.0.1.tgz",
      "integrity": "sha512-8+9WqebbFzpX9OR+Wa6O29asIogeRMzcGtAINdpMHHyAg10f05aSFVBbcEqGf/PXw1EjAZ+q2/bEBg3DvurK3Q==",
      "dev": true
    },
    "node_modules/array-union": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/array-union/-/array-union-2.1.0.tgz",
      "integrity": "sha512-HGyxoOTYUyCM6stUe6EJgnd4EoewAI7zMdfqO+kGjnlZmBDz/cR5pf8r/cR4Wq60sL/p0IkcjUEEPwS3GFrIyw==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/assertion-error": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/assertion-error/-/assertion-error-1.1.0.tgz",
      "integrity": "sha512-jgsaNduz+ndvGyFt3uSuWqvy4lCnIJiovtouQN5JZHOKCS2QuhEdbcQHFhVksz2N2U9hXJo8odG7ETyWlEeuDw==",
      "dev": true,
      "engines": {
        "node": "*"
      }
    },
    "node_modules/balanced-match": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/balanced-match/-/balanced-match-1.0.2.tgz",
      "integrity": "sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==",
      "dev": true
    },
    "node_modules/brace-expansion": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.2.tgz",
      "integrity": "sha512-Jt0vHyM+jmUBqojB7E1NIYadt0vI0Qxjxd2TErW94wDz+E2LAm5vKMXXwg6ZZBTHPuUlDgQHKXvjGBdfcF1ZDQ==",
      "dev": true,
      "dependencies": {
        "balanced-match": "^1.0.0"
      }
    },
    "node_modules/braces": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.3.tgz",
      "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
      "dev": true,
      "dependencies": {
        "fill-range": "^7.1.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/cac": {
      "version": "6.7.14",
      "resolved": "https://registry.npmjs.org/cac/-/cac-6.7.14.tgz",
      "integrity": "sha512-b6Ilus+c3RrdDk+JhLKUAQfzzgLEPy6wcXqS7f/xe1EETvsDP6GORG7SFuOs6cID5YkqchW/LXZbX5bc8j7ZcQ==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/callsites": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/callsites/-/callsites-3.1.0.tgz",
      "integrity": "sha512-P8BjAsXvZS+VIDUI11hHCQEv74YT67YUi5JJFNWIqL235sBmjX4+qx9Muvls5ivyNENctx46xQLQ3aTuE7ssaQ==",
      "dev": true,
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/chai": {
      "version": "4.5.0",
      "resolved": "https://registry.npmjs.org/chai/-/chai-4.5.0.tgz",
      "integrity": "sha512-RITGBfijLkBddZvnn8jdqoTypxvqbOLYQkGGxXzeFjVHvudaPw0HNFD9x928/eUwYWd2dPCugVqspGALTZZQKw==",
      "dev": true,
      "dependencies": {
        "assertion-error": "^1.1.0",
        "check-error": "^1.0.3",
        "deep-eql": "^4.1.3",
        "get-func-name": "^2.0.2",
        "loupe": "^2.3.6",
        "pathval": "^1.1.1",
        "type-detect": "^4.1.0"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/chalk": {
      "version": "4.1.2",
      "resolved": "https://registry.npmjs.org/chalk/-/chalk-4.1.2.tgz",
      "integrity": "sha512-oKnbhFyRIXpUuez8iBMmyEa4nbj4IOQyuhc/wy9kY7/WVPcwIO9VA668Pu8RkO7+0G76SLROeyw9CpQ061i4mA==",
      "dev": true,
      "dependencies": {
        "ansi-styles": "^4.1.0",
        "supports-color": "^7.1.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/chalk/chalk?sponsor=1"
      }
    },
    "node_modules/check-error": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/check-error/-/check-error-1.0.3.tgz",
      "integrity": "sha512-iKEoDYaRmd1mxM90a2OEfWhjsjPpYPuQ+lMYsoxB126+t8fw7ySEO48nmDg5COTjxDI65/Y2OWpeEHk3ZOe8zg==",
      "dev": true,
      "dependencies": {
        "get-func-name": "^2.0.2"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/color-convert": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz",
      "integrity": "sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==",
      "dev": true,
      "dependencies": {
        "color-name": "~1.1.4"
      },
      "engines": {
        "node": ">=7.0.0"
      }
    },
    "node_modules/color-name": {
      "version": "1.1.4",
      "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.4.tgz",
      "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
      "dev": true
    },
    "node_modules/commondir": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/commondir/-/commondir-1.0.1.tgz",
      "integrity": "sha512-W9pAhw0ja1Edb5GVdIF1mjZw/ASI0AlShXM83UUGe2DVr5TdAPEA1OA8m/g8zWp9x6On7gqufY+FatDbC3MDQg==",
      "dev": true
    },
    "node_modules/concat-map": {
      "version": "0.0.1",
      "resolved": "https://registry.npmjs.org/concat-map/-/concat-map-0.0.1.tgz",
      "integrity": "sha512-/Srv4dswyQNBfohGpz9o6Yb3Gz3SrUDqBH5rTuhGR7ahtlbYKnVxw2bCFMRljaA7EXHaXZ8wsHdodFvbkhKmqg==",
      "dev": true
    },
    "node_modules/confbox": {
      "version": "0.1.8",
      "resolved": "https://registry.npmjs.org/confbox/-/confbox-0.1.8.tgz",
      "integrity": "sha512-RMtmw0iFkeR4YV+fUOSucriAQNb9g8zFR52MWCtl+cCZOFRNL6zeB395vPzFhEjjn4fMxXudmELnl/KF/WrK6w==",
      "dev": true
    },
    "node_modules/cross-spawn": {
      "version": "7.0.6",
      "resolved": "https://registry.npmjs.org/cross-spawn/-/cross-spawn-7.0.6.tgz",
      "integrity": "sha512-uV2QOWP2nWzsy2aMp8aRibhi9dlzF5Hgh5SHaB9OiTGEyDTiJJyx0uy51QXdyWbtAHNua4XJzUKca3OzKUd3vA==",
      "dev": true,
      "dependencies": {
        "path-key": "^3.1.0",
        "shebang-command": "^2.0.0",
        "which": "^2.0.1"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/debug": {
      "version": "4.4.3",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
      "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
      "dev": true,
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/deep-eql": {
      "version": "4.1.4",
      "resolved": "https://registry.npmjs.org/deep-eql/-/deep-eql-4.1.4.tgz",
      "integrity": "sha512-SUwdGfqdKOwxCPeVYjwSyRpJ7Z+fhpwIAtmCUdZIWZ/YP5R9WAsyuSgpLVDi9bjWoN2LXHNss/dk3urXtdQxGg==",
      "dev": true,
      "dependencies": {
        "type-detect": "^4.0.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/deep-is": {
      "version": "0.1.4",
      "resolved": "https://registry.npmjs.org/deep-is/-/deep-is-0.1.4.tgz",
      "integrity": "sha512-oIPzksmTg4/MriiaYGO+okXDT7ztn/w3Eptv/+gSIdMdKsJo0u4CfYNFJPy+4SKMuCqGw2wxnA+URMg3t8a/bQ==",
      "dev": true
    },
    "node_modules/deepmerge": {
      "version": "4.3.1",
      "resolved": "https://registry.npmjs.org/deepmerge/-/deepmerge-4.3.1.tgz",
      "integrity": "sha512-3sUqbMEc77XqpdNO7FRyRog+eW3ph+GYCbj+rK+uYyRMuwsVy0rMiVtPn+QJlKFvWP/1PYpapqYn0Me2knFn+A==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/diff-sequences": {
      "version": "29.6.3",
      "resolved": "https://registry.npmjs.org/diff-sequences/-/diff-sequences-29.6.3.tgz",
      "integrity": "sha512-EjePK1srD3P08o2j4f0ExnylqRs5B9tJjcp9t1krH2qRi8CCdsYfwe9JgSLurFBWwq4uOlipzfk5fHNvwFKr8Q==",
      "dev": true,
      "engines": {
        "node": "^14.15.0 || ^16.10.0 || >=18.0.0"
      }
    },
    "node_modules/dir-glob": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/dir-glob/-/dir-glob-3.0.1.tgz",
      "integrity": "sha512-WkrWp9GR4KXfKGYzOLmTuGVi1UWFfws377n9cc55/tb6DuqyF6pcQ5AbiHEshaDpY9v6oaSr2XCDidGmMwdzIA==",
      "dev": true,
      "dependencies": {
        "path-type": "^4.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/doctrine": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/doctrine/-/doctrine-3.0.0.tgz",
      "integrity": "sha512-yS+Q5i3hBf7GBkd4KG8a7eBNNWNGLTaEwwYWUijIYM7zrlYDM0BFXHjjPWlWZ1Rg7UaddZeIDmi9jF3HmqiQ2w==",
      "dev": true,
      "dependencies": {
        "esutils": "^2.0.2"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/esbuild": {
      "version": "0.27.2",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.27.2.tgz",
      "integrity": "sha512-HyNQImnsOC7X9PMNaCIeAm4ISCQXs5a5YasTXVliKv4uuBo1dKrG0A+uQS8M5eXjVMnLg3WgXaKvprHlFJQffw==",
      "dev": true,
      "hasInstallScript": true,
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=18"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.27.2",
        "@esbuild/android-arm": "0.27.2",
        "@esbuild/android-arm64": "0.27.2",
        "@esbuild/android-x64": "0.27.2",
        "@esbuild/darwin-arm64": "0.27.2",
        "@esbuild/darwin-x64": "0.27.2",
        "@esbuild/freebsd-arm64": "0.27.2",
        "@esbuild/freebsd-x64": "0.27.2",
        "@esbuild/linux-arm": "0.27.2",
        "@esbuild/linux-arm64": "0.27.2",
        "@esbuild/linux-ia32": "0.27.2",
        "@esbuild/linux-loong64": "0.27.2",
        "@esbuild/linux-mips64el": "0.27.2",
        "@esbuild/linux-ppc64": "0.27.2",
        "@esbuild/linux-riscv64": "0.27.2",
        "@esbuild/linux-s390x": "0.27.2",
        "@esbuild/linux-x64": "0.27.2",
        "@esbuild/netbsd-arm64": "0.27.2",
        "@esbuild/netbsd-x64": "0.27.2",
        "@esbuild/openbsd-arm64": "0.27.2",
        "@esbuild/openbsd-x64": "0.27.2",
        "@esbuild/openharmony-arm64": "0.27.2",
        "@esbuild/sunos-x64": "0.27.2",
        "@esbuild/win32-arm64": "0.27.2",
        "@esbuild/win32-ia32": "0.27.2",
        "@esbuild/win32-x64": "0.27.2"
      }
    },
    "node_modules/escape-string-regexp": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/escape-string-regexp/-/escape-string-regexp-4.0.0.tgz",
      "integrity": "sha512-TtpcNJ3XAzx3Gq8sWRzJaVajRs0uVxA2YAkdb1jm2YkPz4G6egUFAyA3n5vtEIZefPk5Wa4UXbKuS5fKkJWdgA==",
      "dev": true,
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/eslint": {
      "version": "8.57.1",
      "resolved": "https://registry.npmjs.org/eslint/-/eslint-8.57.1.tgz",
      "integrity": "sha512-ypowyDxpVSYpkXr9WPv2PAZCtNip1Mv5KTW0SCurXv/9iOpcrH9PaqUElksqEB6pChqHGDRCFTyrZlGhnLNGiA==",
      "deprecated": "This version is no longer supported. Please see https://eslint.org/version-support for other options.",
      "dev": true,
      "dependencies": {
        "@eslint-community/eslint-utils": "^4.2.0",
        "@eslint-community/regexpp": "^4.6.1",
        "@eslint/eslintrc": "^2.1.4",
        "@eslint/js": "8.57.1",
        "@humanwhocodes/config-array": "^0.13.0",
        "@humanwhocodes/module-importer": "^1.0.1",
        "@nodelib/fs.walk": "^1.2.8",
        "@ungap/structured-clone": "^1.2.0",
        "ajv": "^6.12.4",
        "chalk": "^4.0.0",
        "cross-spawn": "^7.0.2",
        "debug": "^4.3.2",
        "doctrine": "^3.0.0",
        "escape-string-regexp": "^4.0.0",
        "eslint-scope": "^7.2.2",
        "eslint-visitor-keys": "^3.4.3",
        "espree": "^9.6.1",
        "esquery": "^1.4.2",
        "esutils": "^2.0.2",
        "fast-deep-equal": "^3.1.3",
        "file-entry-cache": "^6.0.1",
        "find-up": "^5.0.0",
        "glob-parent": "^6.0.2",
        "globals": "^13.19.0",
        "graphemer": "^1.4.0",
        "ignore": "^5.2.0",
        "imurmurhash": "^0.1.4",
        "is-glob": "^4.0.0",
        "is-path-inside": "^3.0.3",
        "js-yaml": "^4.1.0",
        "json-stable-stringify-without-jsonify": "^1.0.1",
        "levn": "^0.4.1",
        "lodash.merge": "^4.6.2",
        "minimatch": "^3.1.2",
        "natural-compare": "^1.4.0",
        "optionator": "^0.9.3",
        "strip-ansi": "^6.0.1",
        "text-table": "^0.2.0"
      },
      "bin": {
        "eslint": "bin/eslint.js"
      },
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/eslint-scope": {
      "version": "7.2.2",
      "resolved": "https://registry.npmjs.org/eslint-scope/-/eslint-scope-7.2.2.tgz",
      "integrity": "sha512-dOt21O7lTMhDM+X9mB4GX+DZrZtCUJPL/wlcTqxyrx5IvO0IYtILdtrQGQp+8n5S0gwSVmOf9NQrjMOgfQZlIg==",
      "dev": true,
      "dependencies": {
        "esrecurse": "^4.3.0",
        "estraverse": "^5.2.0"
      },
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/eslint-visitor-keys": {
      "version": "3.4.3",
      "resolved": "https://registry.npmjs.org/eslint-visitor-keys/-/eslint-visitor-keys-3.4.3.tgz",
      "integrity": "sha512-wpc+LXeiyiisxPlEkUzU6svyS1frIO3Mgxj1fdy7Pm8Ygzguax2N3Fa/D/ag1WqbOprdI+uY6wMUl8/a2G+iag==",
      "dev": true,
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/eslint/node_modules/brace-expansion": {
      "version": "1.1.12",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.12.tgz",
      "integrity": "sha512-9T9UjW3r0UW5c1Q7GTwllptXwhvYmEzFhzMfZ9H7FQWt+uZePjZPjBP/W1ZEyZ1twGWom5/56TF4lPcqjnDHcg==",
      "dev": true,
      "dependencies": {
        "balanced-match": "^1.0.0",
        "concat-map": "0.0.1"
      }
    },
    "node_modules/eslint/node_modules/minimatch": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
      "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
      "dev": true,
      "dependencies": {
        "brace-expansion": "^1.1.7"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/espree": {
      "version": "9.6.1",
      "resolved": "https://registry.npmjs.org/espree/-/espree-9.6.1.tgz",
      "integrity": "sha512-oruZaFkjorTpF32kDSI5/75ViwGeZginGGy2NoOSg3Q9bnwlnmDm4HLnkl0RE3n+njDXR037aY1+x58Z/zFdwQ==",
      "dev": true,
      "dependencies": {
        "acorn": "^8.9.0",
        "acorn-jsx": "^5.3.2",
        "eslint-visitor-keys": "^3.4.1"
      },
      "engines": {
        "node": "^12.22.0 || ^14.17.0 || >=16.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/eslint"
      }
    },
    "node_modules/esquery": {
      "version": "1.7.0",
      "resolved": "https://registry.npmjs.org/esquery/-/esquery-1.7.0.tgz",
      "integrity": "sha512-Ap6G0WQwcU/LHsvLwON1fAQX9Zp0A2Y6Y/cJBl9r/JbW90Zyg4/zbG6zzKa2OTALELarYHmKu0GhpM5EO+7T0g==",
      "dev": true,
      "dependencies": {
        "estraverse": "^5.1.0"
      },
      "engines": {
        "node": ">=0.10"
      }
    },
    "node_modules/esrecurse": {
      "version": "4.3.0",
      "resolved": "https://registry.npmjs.org/esrecurse/-/esrecurse-4.3.0.tgz",
      "integrity": "sha512-KmfKL3b6G+RXvP8N1vr3Tq1kL/oCFgn2NYXEtqP8/L3pKapUA4G8cFVaoF3SU323CD4XypR/ffioHmkti6/Tag==",
      "dev": true,
      "dependencies": {
        "estraverse": "^5.2.0"
      },
      "engines": {
        "node": ">=4.0"
      }
    },
    "node_modules/estraverse": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/estraverse/-/estraverse-5.3.0.tgz",
      "integrity": "sha512-MMdARuVEQziNTeJD8DgMqmhwR11BRQ/cBP+pLtYdSTnf3MIO8fFeiINEbX36ZdNlfU/7A9f3gUw49B3oQsvwBA==",
      "dev": true,
      "engines": {
        "node": ">=4.0"
      }
    },
    "node_modules/estree-walker": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/estree-walker/-/estree-walker-2.0.2.tgz",
      "integrity": "sha512-Rfkk/Mp/DL7JVje3u18FxFujQlTNR2q6QfMSMB7AvCBx91NGj/ba3kCfza0f6dVDbw7YlRf/nDrn7pQrCCyQ/w==",
      "dev": true
    },
    "node_modules/esutils": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/esutils/-/esutils-2.0.3.tgz",
      "integrity": "sha512-kVscqXk4OCp68SZ0dkgEKVi6/8ij300KBWTJq32P/dYeWTSwK41WyTxalN1eRmA5Z9UU/LX9D7FWSmV9SAYx6g==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/execa": {
      "version": "8.0.1",
      "resolved": "https://registry.npmjs.org/execa/-/execa-8.0.1.tgz",
      "integrity": "sha512-VyhnebXciFV2DESc+p6B+y0LjSm0krU4OgJN44qFAhBY0TJ+1V61tYD2+wHusZ6F9n5K+vl8k0sTy7PEfV4qpg==",
      "dev": true,
      "dependencies": {
        "cross-spawn": "^7.0.3",
        "get-stream": "^8.0.1",
        "human-signals": "^5.0.0",
        "is-stream": "^3.0.0",
        "merge-stream": "^2.0.0",
        "npm-run-path": "^5.1.0",
        "onetime": "^6.0.0",
        "signal-exit": "^4.1.0",
        "strip-final-newline": "^3.0.0"
      },
      "engines": {
        "node": ">=16.17"
      },
      "funding": {
        "url": "https://github.com/sindresorhus/execa?sponsor=1"
      }
    },
    "node_modules/fast-deep-equal": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/fast-deep-equal/-/fast-deep-equal-3.1.3.tgz",
      "integrity": "sha512-f3qQ9oQy9j2AhBe/H9VC91wLmKBCCU/gDOnKNAYG5hswO7BLKj09Hc5HYNz9cGI++xlpDCIgDaitVs03ATR84Q==",
      "dev": true
    },
    "node_modules/fast-glob": {
      "version": "3.3.3",
      "resolved": "https://registry.npmjs.org/fast-glob/-/fast-glob-3.3.3.tgz",
      "integrity": "sha512-7MptL8U0cqcFdzIzwOTHoilX9x5BrNqye7Z/LuC7kCMRio1EMSyqRK3BEAUD7sXRq4iT4AzTVuZdhgQ2TCvYLg==",
      "dev": true,
      "dependencies": {
        "@nodelib/fs.stat": "^2.0.2",
        "@nodelib/fs.walk": "^1.2.3",
        "glob-parent": "^5.1.2",
        "merge2": "^1.3.0",
        "micromatch": "^4.0.8"
      },
      "engines": {
        "node": ">=8.6.0"
      }
    },
    "node_modules/fast-glob/node_modules/glob-parent": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
      "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
      "dev": true,
      "dependencies": {
        "is-glob": "^4.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/fast-json-stable-stringify": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/fast-json-stable-stringify/-/fast-json-stable-stringify-2.1.0.tgz",
      "integrity": "sha512-lhd/wF+Lk98HZoTCtlVraHtfh5XYijIjalXck7saUtuanSDyLMxnHhSXEDJqHxD7msR8D0uCmqlkwjCV8xvwHw==",
      "dev": true
    },
    "node_modules/fast-levenshtein": {
      "version": "2.0.6",
      "resolved": "https://registry.npmjs.org/fast-levenshtein/-/fast-levenshtein-2.0.6.tgz",
      "integrity": "sha512-DCXu6Ifhqcks7TZKY3Hxp3y6qphY5SJZmrWMDrKcERSOXWQdMhU9Ig/PYrzyw/ul9jOIyh0N4M0tbC5hodg8dw==",
      "dev": true
    },
    "node_modules/fastq": {
      "version": "1.20.1",
      "resolved": "https://registry.npmjs.org/fastq/-/fastq-1.20.1.tgz",
      "integrity": "sha512-GGToxJ/w1x32s/D2EKND7kTil4n8OVk/9mycTc4VDza13lOvpUZTGX3mFSCtV9ksdGBVzvsyAVLM6mHFThxXxw==",
      "dev": true,
      "dependencies": {
        "reusify": "^1.0.4"
      }
    },
    "node_modules/file-entry-cache": {
      "version": "6.0.1",
      "resolved": "https://registry.npmjs.org/file-entry-cache/-/file-entry-cache-6.0.1.tgz",
      "integrity": "sha512-7Gps/XWymbLk2QLYK4NzpMOrYjMhdIxXuIvy2QBsLE6ljuodKvdkWs/cpyJJ3CVIVpH0Oi1Hvg1ovbMzLdFBBg==",
      "dev": true,
      "dependencies": {
        "flat-cache": "^3.0.4"
      },
      "engines": {
        "node": "^10.12.0 || >=12.0.0"
      }
    },
    "node_modules/fill-range": {
      "version": "7.1.1",
      "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.1.1.tgz",
      "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
      "dev": true,
      "dependencies": {
        "to-regex-range": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/find-up": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/find-up/-/find-up-5.0.0.tgz",
      "integrity": "sha512-78/PXT1wlLLDgTzDs7sjq9hzz0vXD+zn+7wypEe4fXQxCmdmqfGsEPQxmiCSQI3ajFV91bVSsvNtrJRiW6nGng==",
      "dev": true,
      "dependencies": {
        "locate-path": "^6.0.0",
        "path-exists": "^4.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/flat-cache": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/flat-cache/-/flat-cache-3.2.0.tgz",
      "integrity": "sha512-CYcENa+FtcUKLmhhqyctpclsq7QF38pKjZHsGNiSQF5r4FtoKDWabFDl3hzaEQMvT1LHEysw5twgLvpYYb4vbw==",
      "dev": true,
      "dependencies": {
        "flatted": "^3.2.9",
        "keyv": "^4.5.3",
        "rimraf": "^3.0.2"
      },
      "engines": {
        "node": "^10.12.0 || >=12.0.0"
      }
    },
    "node_modules/flatted": {
      "version": "3.3.3",
      "resolved": "https://registry.npmjs.org/flatted/-/flatted-3.3.3.tgz",
      "integrity": "sha512-GX+ysw4PBCz0PzosHDepZGANEuFCMLrnRTiEy9McGjmkCQYwRq4A/X786G/fjM/+OjsWSU1ZrY5qyARZmO/uwg==",
      "dev": true
    },
    "node_modules/fs.realpath": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/fs.realpath/-/fs.realpath-1.0.0.tgz",
      "integrity": "sha512-OO0pH2lK6a0hZnAdau5ItzHPI6pUlvI7jMVnxUQRtw4owF2wk8lOSabtGDCTP4Ggrg2MbGnWO9X8K1t4+fGMDw==",
      "dev": true
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "dev": true,
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-func-name": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/get-func-name/-/get-func-name-2.0.2.tgz",
      "integrity": "sha512-8vXOvuE167CtIc3OyItco7N/dpRtBbYOsPsXCz7X/PMnlGjYjSGuZJgM1Y7mmew7BKf9BqvLX2tnOVy1BBUsxQ==",
      "dev": true,
      "engines": {
        "node": "*"
      }
    },
    "node_modules/get-stream": {
      "version": "8.0.1",
      "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-8.0.1.tgz",
      "integrity": "sha512-VaUJspBffn/LMCJVoMvSAdmscJyS1auj5Zulnn5UoYcY531UWmdwhRWkcGKnGU93m5HSXP9LP2usOryrBtQowA==",
      "dev": true,
      "engines": {
        "node": ">=16"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/get-tsconfig": {
      "version": "4.13.0",
      "resolved": "https://registry.npmjs.org/get-tsconfig/-/get-tsconfig-4.13.0.tgz",
      "integrity": "sha512-1VKTZJCwBrvbd+Wn3AOgQP/2Av+TfTCOlE4AcRJE72W1ksZXbAx8PPBR9RzgTeSPzlPMHrbANMH3LbltH73wxQ==",
      "dev": true,
      "dependencies": {
        "resolve-pkg-maps": "^1.0.0"
      },
      "funding": {
        "url": "https://github.com/privatenumber/get-tsconfig?sponsor=1"
      }
    },
    "node_modules/glob": {
      "version": "7.2.3",
      "resolved": "https://registry.npmjs.org/glob/-/glob-7.2.3.tgz",
      "integrity": "sha512-nFR0zLpU2YCaRxwoCJvL6UvCH2JFyFVIvwTLsIf21AuHlMskA1hhTdk+LlYJtOlYt9v6dvszD2BGRqBL+iQK9Q==",
      "deprecated": "Glob versions prior to v9 are no longer supported",
      "dev": true,
      "dependencies": {
        "fs.realpath": "^1.0.0",
        "inflight": "^1.0.4",
        "inherits": "2",
        "minimatch": "^3.1.1",
        "once": "^1.3.0",
        "path-is-absolute": "^1.0.0"
      },
      "engines": {
        "node": "*"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/glob-parent": {
      "version": "6.0.2",
      "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-6.0.2.tgz",
      "integrity": "sha512-XxwI8EOhVQgWp6iDL+3b0r86f4d6AX6zSU55HfB4ydCEuXLXc5FcYeOu+nnGftS4TEju/11rt4KJPTMgbfmv4A==",
      "dev": true,
      "dependencies": {
        "is-glob": "^4.0.3"
      },
      "engines": {
        "node": ">=10.13.0"
      }
    },
    "node_modules/glob/node_modules/brace-expansion": {
      "version": "1.1.12",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.12.tgz",
      "integrity": "sha512-9T9UjW3r0UW5c1Q7GTwllptXwhvYmEzFhzMfZ9H7FQWt+uZePjZPjBP/W1ZEyZ1twGWom5/56TF4lPcqjnDHcg==",
      "dev": true,
      "dependencies": {
        "balanced-match": "^1.0.0",
        "concat-map": "0.0.1"
      }
    },
    "node_modules/glob/node_modules/minimatch": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
      "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
      "dev": true,
      "dependencies": {
        "brace-expansion": "^1.1.7"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/globals": {
      "version": "13.24.0",
      "resolved": "https://registry.npmjs.org/globals/-/globals-13.24.0.tgz",
      "integrity": "sha512-AhO5QUcj8llrbG09iWhPU2B204J1xnPeL8kQmVorSsy+Sjj1sk8gIyh6cUocGmH4L0UuhAJy+hJMRA4mgA4mFQ==",
      "dev": true,
      "dependencies": {
        "type-fest": "^0.20.2"
      },
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/globby": {
      "version": "11.1.0",
      "resolved": "https://registry.npmjs.org/globby/-/globby-11.1.0.tgz",
      "integrity": "sha512-jhIXaOzy1sb8IyocaruWSn1TjmnBVs8Ayhcy83rmxNJ8q2uWKCAj3CnJY+KpGSXCueAPc0i05kVvVKtP1t9S3g==",
      "dev": true,
      "dependencies": {
        "array-union": "^2.1.0",
        "dir-glob": "^3.0.1",
        "fast-glob": "^3.2.9",
        "ignore": "^5.2.0",
        "merge2": "^1.4.1",
        "slash": "^3.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/graphemer": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/graphemer/-/graphemer-1.4.0.tgz",
      "integrity": "sha512-EtKwoO6kxCL9WO5xipiHTZlSzBm7WLT627TqC/uVRd0HKmq8NXyebnNYxDoBi7wt8eTWrUrKXCOVaFq9x1kgag==",
      "dev": true
    },
    "node_modules/has-flag": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-4.0.0.tgz",
      "integrity": "sha512-EykJT/Q1KjTWctppgIAgfSO0tKVuZUjhgMr17kqTumMl6Afv3EISleU7qZUzoXDFTAHTDC4NOoG/ZxU3EvlMPQ==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "dev": true,
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/human-signals": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/human-signals/-/human-signals-5.0.0.tgz",
      "integrity": "sha512-AXcZb6vzzrFAUE61HnN4mpLqd/cSIwNQjtNWR0euPm6y0iqx3G4gOXaIDdtdDwZmhwe82LA6+zinmW4UBWVePQ==",
      "dev": true,
      "engines": {
        "node": ">=16.17.0"
      }
    },
    "node_modules/ignore": {
      "version": "5.3.2",
      "resolved": "https://registry.npmjs.org/ignore/-/ignore-5.3.2.tgz",
      "integrity": "sha512-hsBTNUqQTDwkWtcdYI2i06Y/nUBEsNEDJKjWdigLvegy8kDuJAS8uRlpkkcQpyEXL0Z/pjDy5HBmMjRCJ2gq+g==",
      "dev": true,
      "engines": {
        "node": ">= 4"
      }
    },
    "node_modules/import-fresh": {
      "version": "3.3.1",
      "resolved": "https://registry.npmjs.org/import-fresh/-/import-fresh-3.3.1.tgz",
      "integrity": "sha512-TR3KfrTZTYLPB6jUjfx6MF9WcWrHL9su5TObK4ZkYgBdWKPOFoSoQIdEuTuR82pmtxH2spWG9h6etwfr1pLBqQ==",
      "dev": true,
      "dependencies": {
        "parent-module": "^1.0.0",
        "resolve-from": "^4.0.0"
      },
      "engines": {
        "node": ">=6"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/imurmurhash": {
      "version": "0.1.4",
      "resolved": "https://registry.npmjs.org/imurmurhash/-/imurmurhash-0.1.4.tgz",
      "integrity": "sha512-JmXMZ6wuvDmLiHEml9ykzqO6lwFbof0GG4IkcGaENdCRDDmMVnny7s5HsIgHCbaq0w2MyPhDqkhTUgS2LU2PHA==",
      "dev": true,
      "engines": {
        "node": ">=0.8.19"
      }
    },
    "node_modules/inflight": {
      "version": "1.0.6",
      "resolved": "https://registry.npmjs.org/inflight/-/inflight-1.0.6.tgz",
      "integrity": "sha512-k92I/b08q4wvFscXCLvqfsHCrjrF7yiXsQuIVvVE7N82W3+aqpzuUdBbfhWcy/FZR3/4IgflMgKLOsvPDrGCJA==",
      "deprecated": "This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.",
      "dev": true,
      "dependencies": {
        "once": "^1.3.0",
        "wrappy": "1"
      }
    },
    "node_modules/inherits": {
      "version": "2.0.4",
      "resolved": "https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz",
      "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==",
      "dev": true
    },
    "node_modules/is-core-module": {
      "version": "2.16.1",
      "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.16.1.tgz",
      "integrity": "sha512-UfoeMA6fIJ8wTYFEUjelnaGI67v6+N7qXJEvQuIGa99l4xsCruSYOVSQ0uPANn4dAzm8lkYPaKLrrijLq7x23w==",
      "dev": true,
      "dependencies": {
        "hasown": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-extglob": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/is-extglob/-/is-extglob-2.1.1.tgz",
      "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-glob": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
      "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
      "dev": true,
      "dependencies": {
        "is-extglob": "^2.1.1"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-module": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/is-module/-/is-module-1.0.0.tgz",
      "integrity": "sha512-51ypPSPCoTEIN9dy5Oy+h4pShgJmPCygKfyRCISBI+JoWT/2oJvK8QPxmwv7b/p239jXrm9M1mlQbyKJ5A152g==",
      "dev": true
    },
    "node_modules/is-number": {
      "version": "7.0.0",
      "resolved": "https://registry.npmjs.org/is-number/-/is-number-7.0.0.tgz",
      "integrity": "sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==",
      "dev": true,
      "engines": {
        "node": ">=0.12.0"
      }
    },
    "node_modules/is-path-inside": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/is-path-inside/-/is-path-inside-3.0.3.tgz",
      "integrity": "sha512-Fd4gABb+ycGAmKou8eMftCupSir5lRxqf4aD/vd0cD2qc4HL07OjCeuHMr8Ro4CoMaeCKDB0/ECBOVWjTwUvPQ==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/is-reference": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/is-reference/-/is-reference-1.2.1.tgz",
      "integrity": "sha512-U82MsXXiFIrjCK4otLT+o2NA2Cd2g5MLoOVXUZjIOhLurrRxpEXzI8O0KZHr3IjLvlAH1kTPYSuqer5T9ZVBKQ==",
      "dev": true,
      "dependencies": {
        "@types/estree": "*"
      }
    },
    "node_modules/is-stream": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/is-stream/-/is-stream-3.0.0.tgz",
      "integrity": "sha512-LnQR4bZ9IADDRSkvpqMGvt/tEJWclzklNgSw48V5EAaAeDd6qGvN8ei6k5p0tvxSR171VmGyHuTiAOfxAbr8kA==",
      "dev": true,
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/isexe": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/isexe/-/isexe-2.0.0.tgz",
      "integrity": "sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw==",
      "dev": true
    },
    "node_modules/js-tokens": {
      "version": "9.0.1",
      "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-9.0.1.tgz",
      "integrity": "sha512-mxa9E9ITFOt0ban3j6L5MpjwegGz6lBQmM1IJkWeBZGcMxto50+eWdjC/52xDbS2vy0k7vIMK0Fe2wfL9OQSpQ==",
      "dev": true
    },
    "node_modules/js-yaml": {
      "version": "4.1.1",
      "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-4.1.1.tgz",
      "integrity": "sha512-qQKT4zQxXl8lLwBtHMWwaTcGfFOZviOJet3Oy/xmGk2gZH677CJM9EvtfdSkgWcATZhj/55JZ0rmy3myCT5lsA==",
      "dev": true,
      "dependencies": {
        "argparse": "^2.0.1"
      },
      "bin": {
        "js-yaml": "bin/js-yaml.js"
      }
    },
    "node_modules/json-buffer": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/json-buffer/-/json-buffer-3.0.1.tgz",
      "integrity": "sha512-4bV5BfR2mqfQTJm+V5tPPdf+ZpuhiIvTuAB5g8kcrXOZpTT/QwwVRWBywX1ozr6lEuPdbHxwaJlm9G6mI2sfSQ==",
      "dev": true
    },
    "node_modules/json-schema-traverse": {
      "version": "0.4.1",
      "resolved": "https://registry.npmjs.org/json-schema-traverse/-/json-schema-traverse-0.4.1.tgz",
      "integrity": "sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==",
      "dev": true
    },
    "node_modules/json-stable-stringify-without-jsonify": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/json-stable-stringify-without-jsonify/-/json-stable-stringify-without-jsonify-1.0.1.tgz",
      "integrity": "sha512-Bdboy+l7tA3OGW6FjyFHWkP5LuByj1Tk33Ljyq0axyzdk9//JSi2u3fP1QSmd1KNwq6VOKYGlAu87CisVir6Pw==",
      "dev": true
    },
    "node_modules/jsonc-parser": {
      "version": "3.3.1",
      "resolved": "https://registry.npmjs.org/jsonc-parser/-/jsonc-parser-3.3.1.tgz",
      "integrity": "sha512-HUgH65KyejrUFPvHFPbqOY0rsFip3Bo5wb4ngvdi1EpCYWUQDC5V+Y7mZws+DLkr4M//zQJoanu1SP+87Dv1oQ==",
      "dev": true
    },
    "node_modules/keyv": {
      "version": "4.5.4",
      "resolved": "https://registry.npmjs.org/keyv/-/keyv-4.5.4.tgz",
      "integrity": "sha512-oxVHkHR/EJf2CNXnWxRLW6mg7JyCCUcG0DtEGmL2ctUo1PNTin1PUil+r/+4r5MpVgC/fn1kjsx7mjSujKqIpw==",
      "dev": true,
      "dependencies": {
        "json-buffer": "3.0.1"
      }
    },
    "node_modules/levn": {
      "version": "0.4.1",
      "resolved": "https://registry.npmjs.org/levn/-/levn-0.4.1.tgz",
      "integrity": "sha512-+bT2uH4E5LGE7h/n3evcS/sQlJXCpIp6ym8OWJ5eV6+67Dsql/LaaT7qJBAt2rzfoa/5QBGBhxDix1dMt2kQKQ==",
      "dev": true,
      "dependencies": {
        "prelude-ls": "^1.2.1",
        "type-check": "~0.4.0"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/local-pkg": {
      "version": "0.5.1",
      "resolved": "https://registry.npmjs.org/local-pkg/-/local-pkg-0.5.1.tgz",
      "integrity": "sha512-9rrA30MRRP3gBD3HTGnC6cDFpaE1kVDWxWgqWJUN0RvDNAo+Nz/9GxB+nHOH0ifbVFy0hSA1V6vFDvnx54lTEQ==",
      "dev": true,
      "dependencies": {
        "mlly": "^1.7.3",
        "pkg-types": "^1.2.1"
      },
      "engines": {
        "node": ">=14"
      },
      "funding": {
        "url": "https://github.com/sponsors/antfu"
      }
    },
    "node_modules/locate-path": {
      "version": "6.0.0",
      "resolved": "https://registry.npmjs.org/locate-path/-/locate-path-6.0.0.tgz",
      "integrity": "sha512-iPZK6eYjbxRu3uB4/WZ3EsEIMJFMqAoopl3R+zuq0UjcAm/MO6KCweDgPfP3elTztoKP3KtnVHxTn2NHBSDVUw==",
      "dev": true,
      "dependencies": {
        "p-locate": "^5.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/lodash.merge": {
      "version": "4.6.2",
      "resolved": "https://registry.npmjs.org/lodash.merge/-/lodash.merge-4.6.2.tgz",
      "integrity": "sha512-0KpjqXRVvrYyCsX1swR/XTK0va6VQkQM6MNo7PqW77ByjAhoARA8EfrP1N4+KlKj8YS0ZUCtRT/YUuhyYDujIQ==",
      "dev": true
    },
    "node_modules/loupe": {
      "version": "2.3.7",
      "resolved": "https://registry.npmjs.org/loupe/-/loupe-2.3.7.tgz",
      "integrity": "sha512-zSMINGVYkdpYSOBmLi0D1Uo7JU9nVdQKrHxC8eYlV+9YKK9WePqAlL7lSlorG/U2Fw1w0hTBmaa/jrQ3UbPHtA==",
      "dev": true,
      "dependencies": {
        "get-func-name": "^2.0.1"
      }
    },
    "node_modules/lunr": {
      "version": "2.3.9",
      "resolved": "https://registry.npmjs.org/lunr/-/lunr-2.3.9.tgz",
      "integrity": "sha512-zTU3DaZaF3Rt9rhN3uBMGQD3dD2/vFQqnvZCDv4dl5iOzq2IZQqTxu90r4E5J+nP70J3ilqVCrbho2eWaeW8Ow==",
      "dev": true
    },
    "node_modules/magic-string": {
      "version": "0.30.21",
      "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.21.tgz",
      "integrity": "sha512-vd2F4YUyEXKGcLHoq+TEyCjxueSeHnFxyyjNp80yg0XV4vUhnDer/lvvlqM/arB5bXQN5K2/3oinyCRyx8T2CQ==",
      "dev": true,
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.5"
      }
    },
    "node_modules/marked": {
      "version": "4.3.0",
      "resolved": "https://registry.npmjs.org/marked/-/marked-4.3.0.tgz",
      "integrity": "sha512-PRsaiG84bK+AMvxziE/lCFss8juXjNaWzVbN5tXAm4XjeaS9NAHhop+PjQxz2A9h8Q4M/xGmzP8vqNwy6JeK0A==",
      "dev": true,
      "bin": {
        "marked": "bin/marked.js"
      },
      "engines": {
        "node": ">= 12"
      }
    },
    "node_modules/merge-stream": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/merge-stream/-/merge-stream-2.0.0.tgz",
      "integrity": "sha512-abv/qOcuPfk3URPfDzmZU1LKmuw8kT+0nIHvKrKgFrwifol/doWcdA4ZqsWQ8ENrFKkd67Mfpo/LovbIUsbt3w==",
      "dev": true
    },
    "node_modules/merge2": {
      "version": "1.4.1",
      "resolved": "https://registry.npmjs.org/merge2/-/merge2-1.4.1.tgz",
      "integrity": "sha512-8q7VEgMJW4J8tcfVPy8g09NcQwZdbwFEqhe/WZkoIzjn/3TGDwtOCYtXGxA3O8tPzpczCCDgv+P2P5y00ZJOOg==",
      "dev": true,
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/micromatch": {
      "version": "4.0.8",
      "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.8.tgz",
      "integrity": "sha512-PXwfBhYu0hBCPw8Dn0E+WDYb7af3dSLVWKi3HGv84IdF4TyFoC0ysxFd0Goxw7nSv4T/PzEJQxsYsEiFCKo2BA==",
      "dev": true,
      "dependencies": {
        "braces": "^3.0.3",
        "picomatch": "^2.3.1"
      },
      "engines": {
        "node": ">=8.6"
      }
    },
    "node_modules/mimic-fn": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/mimic-fn/-/mimic-fn-4.0.0.tgz",
      "integrity": "sha512-vqiC06CuhBTUdZH+RYl8sFrL096vA45Ok5ISO6sE/Mr1jRbGH4Csnhi8f3wKVl7x8mO4Au7Ir9D3Oyv1VYMFJw==",
      "dev": true,
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/minimatch": {
      "version": "9.0.3",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.3.tgz",
      "integrity": "sha512-RHiac9mvaRw0x3AYRgDC1CxAP7HTcNrrECeA8YYJeWnpo+2Q5CegtZjaotWTWxDG3UeGA1coE05iH1mPjT/2mg==",
      "dev": true,
      "dependencies": {
        "brace-expansion": "^2.0.1"
      },
      "engines": {
        "node": ">=16 || 14 >=14.17"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/mlly": {
      "version": "1.8.0",
      "resolved": "https://registry.npmjs.org/mlly/-/mlly-1.8.0.tgz",
      "integrity": "sha512-l8D9ODSRWLe2KHJSifWGwBqpTZXIXTeo8mlKjY+E2HAakaTeNpqAyBZ8GSqLzHgw4XmHmC8whvpjJNMbFZN7/g==",
      "dev": true,
      "dependencies": {
        "acorn": "^8.15.0",
        "pathe": "^2.0.3",
        "pkg-types": "^1.3.1",
        "ufo": "^1.6.1"
      }
    },
    "node_modules/mlly/node_modules/pathe": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/pathe/-/pathe-2.0.3.tgz",
      "integrity": "sha512-WUjGcAqP1gQacoQe+OBJsFA7Ld4DyXuUIjZ5cc75cLHvJ7dtNsTugphxIADwspS+AraAUePCKrSVtPLFj/F88w==",
      "dev": true
    },
    "node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "dev": true
    },
    "node_modules/nanoid": {
      "version": "3.3.11",
      "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.11.tgz",
      "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "bin": {
        "nanoid": "bin/nanoid.cjs"
      },
      "engines": {
        "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
      }
    },
    "node_modules/natural-compare": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/natural-compare/-/natural-compare-1.4.0.tgz",
      "integrity": "sha512-OWND8ei3VtNC9h7V60qff3SVobHr996CTwgxubgyQYEpg290h9J0buyECNNJexkFm5sOajh5G116RYA1c8ZMSw==",
      "dev": true
    },
    "node_modules/npm-run-path": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/npm-run-path/-/npm-run-path-5.3.0.tgz",
      "integrity": "sha512-ppwTtiJZq0O/ai0z7yfudtBpWIoxM8yE6nHi1X47eFR2EWORqfbu6CnPlNsjeN683eT0qG6H/Pyf9fCcvjnnnQ==",
      "dev": true,
      "dependencies": {
        "path-key": "^4.0.0"
      },
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/npm-run-path/node_modules/path-key": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-4.0.0.tgz",
      "integrity": "sha512-haREypq7xkM7ErfgIyA0z+Bj4AGKlMSdlQE2jvJo6huWD1EdkKYV+G/T4nq0YEF2vgTT8kqMFKo1uHn950r4SQ==",
      "dev": true,
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/once": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/once/-/once-1.4.0.tgz",
      "integrity": "sha512-lNaJgI+2Q5URQBkccEKHTQOPaXdUxnZZElQTZY0MFUAuaEqe1E+Nyvgdz/aIyNi6Z9MzO5dv1H8n58/GELp3+w==",
      "dev": true,
      "dependencies": {
        "wrappy": "1"
      }
    },
    "node_modules/onetime": {
      "version": "6.0.0",
      "resolved": "https://registry.npmjs.org/onetime/-/onetime-6.0.0.tgz",
      "integrity": "sha512-1FlR+gjXK7X+AsAHso35MnyN5KqGwJRi/31ft6x0M194ht7S+rWAvd7PHss9xSKMzE0asv1pyIHaJYq+BbacAQ==",
      "dev": true,
      "dependencies": {
        "mimic-fn": "^4.0.0"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/optionator": {
      "version": "0.9.4",
      "resolved": "https://registry.npmjs.org/optionator/-/optionator-0.9.4.tgz",
      "integrity": "sha512-6IpQ7mKUxRcZNLIObR0hz7lxsapSSIYNZJwXPGeF0mTVqGKFIXj1DQcMoT22S3ROcLyY/rz0PWaWZ9ayWmad9g==",
      "dev": true,
      "dependencies": {
        "deep-is": "^0.1.3",
        "fast-levenshtein": "^2.0.6",
        "levn": "^0.4.1",
        "prelude-ls": "^1.2.1",
        "type-check": "^0.4.0",
        "word-wrap": "^1.2.5"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/p-limit": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/p-limit/-/p-limit-3.1.0.tgz",
      "integrity": "sha512-TYOanM3wGwNGsZN2cVTYPArw454xnXj5qmWF1bEoAc4+cU/ol7GVh7odevjp1FNHduHc3KZMcFduxU5Xc6uJRQ==",
      "dev": true,
      "dependencies": {
        "yocto-queue": "^0.1.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/p-locate": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/p-locate/-/p-locate-5.0.0.tgz",
      "integrity": "sha512-LaNjtRWUBY++zB5nE/NwcaoMylSPk+S+ZHNB1TzdbMJMny6dynpAGt7X/tl/QYq3TIeE6nxHppbo2LGymrG5Pw==",
      "dev": true,
      "dependencies": {
        "p-limit": "^3.0.2"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/parent-module": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/parent-module/-/parent-module-1.0.1.tgz",
      "integrity": "sha512-GQ2EWRpQV8/o+Aw8YqtfZZPfNRWZYkbidE9k5rpl/hC3vtHHBfGm2Ifi6qWV+coDGkrUKZAxE3Lot5kcsRlh+g==",
      "dev": true,
      "dependencies": {
        "callsites": "^3.0.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/path-exists": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-exists/-/path-exists-4.0.0.tgz",
      "integrity": "sha512-ak9Qy5Q7jYb2Wwcey5Fpvg2KoAc/ZIhLSLOSBmRmygPsGwkVVt0fZa0qrtMz+m6tJTAHfZQ8FnmB4MG4LWy7/w==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/path-is-absolute": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/path-is-absolute/-/path-is-absolute-1.0.1.tgz",
      "integrity": "sha512-AVbw3UJ2e9bq64vSaS9Am0fje1Pa8pbGqTTsmXfaIiMpnr5DlDhfJOuLj9Sf95ZPVDAUerDfEk88MPmPe7UCQg==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/path-key": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-3.1.1.tgz",
      "integrity": "sha512-ojmeN0qd+y0jszEtoY48r0Peq5dwMEkIlCOu6Q5f41lfkswXuKtYrhgoTpLnyIcHm24Uhqx+5Tqm2InSwLhE6Q==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/path-parse": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/path-parse/-/path-parse-1.0.7.tgz",
      "integrity": "sha512-LDJzPVEEEPR+y48z93A0Ed0yXb8pAByGWo/k5YYdYgpY2/2EsOsksJrq7lOHxryrVOn1ejG6oAp8ahvOIQD8sw==",
      "dev": true
    },
    "node_modules/path-type": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-type/-/path-type-4.0.0.tgz",
      "integrity": "sha512-gDKb8aZMDeD/tZWs9P6+q0J9Mwkdl6xMV8TjnGP3qJVJ06bdMgkbBlLU8IdfOsIsFz2BW1rNVT3XuNEl8zPAvw==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/pathe": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/pathe/-/pathe-1.1.2.tgz",
      "integrity": "sha512-whLdWMYL2TwI08hn8/ZqAbrVemu0LNaNNJZX73O6qaIdCTfXutsLhMkjdENX0qhsQ9uIimo4/aQOmXkoon2nDQ==",
      "dev": true
    },
    "node_modules/pathval": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/pathval/-/pathval-1.1.1.tgz",
      "integrity": "sha512-Dp6zGqpTdETdR63lehJYPeIOqpiNBNtc7BpWSLrOje7UaIsE5aY92r/AunQA7rsXvet3lrJ3JnZX29UPTKXyKQ==",
      "dev": true,
      "engines": {
        "node": "*"
      }
    },
    "node_modules/picocolors": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
      "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
      "dev": true
    },
    "node_modules/picomatch": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-2.3.1.tgz",
      "integrity": "sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==",
      "dev": true,
      "engines": {
        "node": ">=8.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/pkg-types": {
      "version": "1.3.1",
      "resolved": "https://registry.npmjs.org/pkg-types/-/pkg-types-1.3.1.tgz",
      "integrity": "sha512-/Jm5M4RvtBFVkKWRu2BLUTNP8/M2a+UwuAX+ae4770q1qVGtfjG+WTCupoZixokjmHiry8uI+dlY8KXYV5HVVQ==",
      "dev": true,
      "dependencies": {
        "confbox": "^0.1.8",
        "mlly": "^1.7.4",
        "pathe": "^2.0.1"
      }
    },
    "node_modules/pkg-types/node_modules/pathe": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/pathe/-/pathe-2.0.3.tgz",
      "integrity": "sha512-WUjGcAqP1gQacoQe+OBJsFA7Ld4DyXuUIjZ5cc75cLHvJ7dtNsTugphxIADwspS+AraAUePCKrSVtPLFj/F88w==",
      "dev": true
    },
    "node_modules/postcss": {
      "version": "8.5.6",
      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.5.6.tgz",
      "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/postcss"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "dependencies": {
        "nanoid": "^3.3.11",
        "picocolors": "^1.1.1",
        "source-map-js": "^1.2.1"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      }
    },
    "node_modules/prelude-ls": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/prelude-ls/-/prelude-ls-1.2.1.tgz",
      "integrity": "sha512-vkcDPrRZo1QZLbn5RLGPpg/WmIQ65qoWWhcGKf/b5eplkkarX0m9z8ppCat4mlOqUsWpyNuYgO3VRyrYHSzX5g==",
      "dev": true,
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/pretty-format": {
      "version": "29.7.0",
      "resolved": "https://registry.npmjs.org/pretty-format/-/pretty-format-29.7.0.tgz",
      "integrity": "sha512-Pdlw/oPxN+aXdmM9R00JVC9WVFoCLTKJvDVLgmJ+qAffBMxsV85l/Lu7sNx4zSzPyoL2euImuEwHhOXdEgNFZQ==",
      "dev": true,
      "dependencies": {
        "@jest/schemas": "^29.6.3",
        "ansi-styles": "^5.0.0",
        "react-is": "^18.0.0"
      },
      "engines": {
        "node": "^14.15.0 || ^16.10.0 || >=18.0.0"
      }
    },
    "node_modules/pretty-format/node_modules/ansi-styles": {
      "version": "5.2.0",
      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-5.2.0.tgz",
      "integrity": "sha512-Cxwpt2SfTzTtXcfOlzGEee8O+c+MmUgGrNiBcXnuWxuFJHe6a5Hz7qwhwe5OgaSYI0IJvkLqWX1ASG+cJOkEiA==",
      "dev": true,
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
      }
    },
    "node_modules/punycode": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/punycode/-/punycode-2.3.1.tgz",
      "integrity": "sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==",
      "dev": true,
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/queue-microtask": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/queue-microtask/-/queue-microtask-1.2.3.tgz",
      "integrity": "sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ]
    },
    "node_modules/react-is": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react-is/-/react-is-18.3.1.tgz",
      "integrity": "sha512-/LLMVyas0ljjAtoYiPqYiL8VWXzUUdThrmU5+n20DZv+a+ClRoevUzw5JxU+Ieh5/c87ytoTBV9G1FiKfNJdmg==",
      "dev": true
    },
    "node_modules/resolve": {
      "version": "1.22.11",
      "resolved": "https://registry.npmjs.org/resolve/-/resolve-1.22.11.tgz",
      "integrity": "sha512-RfqAvLnMl313r7c9oclB1HhUEAezcpLjz95wFH4LVuhk9JF/r22qmVP9AMmOU4vMX7Q8pN8jwNg/CSpdFnMjTQ==",
      "dev": true,
      "dependencies": {
        "is-core-module": "^2.16.1",
        "path-parse": "^1.0.7",
        "supports-preserve-symlinks-flag": "^1.0.0"
      },
      "bin": {
        "resolve": "bin/resolve"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/resolve-from": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-4.0.0.tgz",
      "integrity": "sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==",
      "dev": true,
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/resolve-pkg-maps": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/resolve-pkg-maps/-/resolve-pkg-maps-1.0.0.tgz",
      "integrity": "sha512-seS2Tj26TBVOC2NIc2rOe2y2ZO7efxITtLZcGSOnHHNOQ7CkiUBfw0Iw2ck6xkIhPwLhKNLS8BO+hEpngQlqzw==",
      "dev": true,
      "funding": {
        "url": "https://github.com/privatenumber/resolve-pkg-maps?sponsor=1"
      }
    },
    "node_modules/reusify": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/reusify/-/reusify-1.1.0.tgz",
      "integrity": "sha512-g6QUff04oZpHs0eG5p83rFLhHeV00ug/Yf9nZM6fLeUrPguBTkTQOdpAWWspMh55TZfVQDPaN3NQJfbVRAxdIw==",
      "dev": true,
      "engines": {
        "iojs": ">=1.0.0",
        "node": ">=0.10.0"
      }
    },
    "node_modules/rimraf": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/rimraf/-/rimraf-3.0.2.tgz",
      "integrity": "sha512-JZkJMZkAGFFPP2YqXZXPbMlMBgsxzE8ILs4lMIX/2o0L9UBw9O/Y3o6wFw/i9YLapcUJWwqbi3kdxIPdC62TIA==",
      "deprecated": "Rimraf versions prior to v4 are no longer supported",
      "dev": true,
      "dependencies": {
        "glob": "^7.1.3"
      },
      "bin": {
        "rimraf": "bin.js"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/rollup": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.55.1.tgz",
      "integrity": "sha512-wDv/Ht1BNHB4upNbK74s9usvl7hObDnvVzknxqY/E/O3X6rW1U1rV1aENEfJ54eFZDTNo7zv1f5N4edCluH7+A==",
      "dev": true,
      "dependencies": {
        "@types/estree": "1.0.8"
      },
      "bin": {
        "rollup": "dist/bin/rollup"
      },
      "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
      },
      "optionalDependencies": {
        "@rollup/rollup-android-arm-eabi": "4.55.1",
        "@rollup/rollup-android-arm64": "4.55.1",
        "@rollup/rollup-darwin-arm64": "4.55.1",
        "@rollup/rollup-darwin-x64": "4.55.1",
        "@rollup/rollup-freebsd-arm64": "4.55.1",
        "@rollup/rollup-freebsd-x64": "4.55.1",
        "@rollup/rollup-linux-arm-gnueabihf": "4.55.1",
        "@rollup/rollup-linux-arm-musleabihf": "4.55.1",
        "@rollup/rollup-linux-arm64-gnu": "4.55.1",
        "@rollup/rollup-linux-arm64-musl": "4.55.1",
        "@rollup/rollup-linux-loong64-gnu": "4.55.1",
        "@rollup/rollup-linux-loong64-musl": "4.55.1",
        "@rollup/rollup-linux-ppc64-gnu": "4.55.1",
        "@rollup/rollup-linux-ppc64-musl": "4.55.1",
        "@rollup/rollup-linux-riscv64-gnu": "4.55.1",
        "@rollup/rollup-linux-riscv64-musl": "4.55.1",
        "@rollup/rollup-linux-s390x-gnu": "4.55.1",
        "@rollup/rollup-linux-x64-gnu": "4.55.1",
        "@rollup/rollup-linux-x64-musl": "4.55.1",
        "@rollup/rollup-openbsd-x64": "4.55.1",
        "@rollup/rollup-openharmony-arm64": "4.55.1",
        "@rollup/rollup-win32-arm64-msvc": "4.55.1",
        "@rollup/rollup-win32-ia32-msvc": "4.55.1",
        "@rollup/rollup-win32-x64-gnu": "4.55.1",
        "@rollup/rollup-win32-x64-msvc": "4.55.1",
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/run-parallel": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/run-parallel/-/run-parallel-1.2.0.tgz",
      "integrity": "sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "dependencies": {
        "queue-microtask": "^1.2.2"
      }
    },
    "node_modules/semver": {
      "version": "7.7.3",
      "resolved": "https://registry.npmjs.org/semver/-/semver-7.7.3.tgz",
      "integrity": "sha512-SdsKMrI9TdgjdweUSR9MweHA4EJ8YxHn8DFaDisvhVlUOe4BF1tLD7GAj0lIqWVl+dPb/rExr0Btby5loQm20Q==",
      "dev": true,
      "bin": {
        "semver": "bin/semver.js"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/shebang-command": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/shebang-command/-/shebang-command-2.0.0.tgz",
      "integrity": "sha512-kHxr2zZpYtdmrN1qDjrrX/Z1rR1kG8Dx+gkpK1G4eXmvXswmcE1hTWBWYUzlraYw1/yZp6YuDY77YtvbN0dmDA==",
      "dev": true,
      "dependencies": {
        "shebang-regex": "^3.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/shebang-regex": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/shebang-regex/-/shebang-regex-3.0.0.tgz",
      "integrity": "sha512-7++dFhtcx3353uBaq8DDR4NuxBetBzC7ZQOhmTQInHEd6bSrXdiEyzCvG07Z44UYdLShWUyXt5M/yhz8ekcb1A==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/shiki": {
      "version": "0.14.7",
      "resolved": "https://registry.npmjs.org/shiki/-/shiki-0.14.7.tgz",
      "integrity": "sha512-dNPAPrxSc87ua2sKJ3H5dQ/6ZaY8RNnaAqK+t0eG7p0Soi2ydiqbGOTaZCqaYvA/uZYfS1LJnemt3Q+mSfcPCg==",
      "dev": true,
      "dependencies": {
        "ansi-sequence-parser": "^1.1.0",
        "jsonc-parser": "^3.2.0",
        "vscode-oniguruma": "^1.7.0",
        "vscode-textmate": "^8.0.0"
      }
    },
    "node_modules/siginfo": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/siginfo/-/siginfo-2.0.0.tgz",
      "integrity": "sha512-ybx0WO1/8bSBLEWXZvEd7gMW3Sn3JFlW3TvX1nREbDLRNQNaeNN8WK0meBwPdAaOI7TtRRRJn/Es1zhrrCHu7g==",
      "dev": true
    },
    "node_modules/signal-exit": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-4.1.0.tgz",
      "integrity": "sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==",
      "dev": true,
      "engines": {
        "node": ">=14"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/slash": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/slash/-/slash-3.0.0.tgz",
      "integrity": "sha512-g9Q1haeby36OSStwb4ntCGGGaKsaVSjQ68fBxoQcutl5fS1vuY18H3wSt3jFyFtrkx+Kz0V1G85A4MyAdDMi2Q==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/source-map-js": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/stackback": {
      "version": "0.0.2",
      "resolved": "https://registry.npmjs.org/stackback/-/stackback-0.0.2.tgz",
      "integrity": "sha512-1XMJE5fQo1jGH6Y/7ebnwPOBEkIEnT4QF32d5R1+VXdXveM0IBMJt8zfaxX1P3QhVwrYe+576+jkANtSS2mBbw==",
      "dev": true
    },
    "node_modules/std-env": {
      "version": "3.10.0",
      "resolved": "https://registry.npmjs.org/std-env/-/std-env-3.10.0.tgz",
      "integrity": "sha512-5GS12FdOZNliM5mAOxFRg7Ir0pWz8MdpYm6AY6VPkGpbA7ZzmbzNcBJQ0GPvvyWgcY7QAhCgf9Uy89I03faLkg==",
      "dev": true
    },
    "node_modules/strip-ansi": {
      "version": "6.0.1",
      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
      "dev": true,
      "dependencies": {
        "ansi-regex": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/strip-final-newline": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/strip-final-newline/-/strip-final-newline-3.0.0.tgz",
      "integrity": "sha512-dOESqjYr96iWYylGObzd39EuNTa5VJxyvVAEm5Jnh7KGo75V43Hk1odPQkNDyXNmUR6k+gEiDVXnjB8HJ3crXw==",
      "dev": true,
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/strip-json-comments": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/strip-json-comments/-/strip-json-comments-3.1.1.tgz",
      "integrity": "sha512-6fPc+R4ihwqP6N/aIv2f1gMH8lOVtWQHoqC4yK6oSDVVocumAsfCqjkXnqiYMhmMwS/mEHLp7Vehlt3ql6lEig==",
      "dev": true,
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/strip-literal": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/strip-literal/-/strip-literal-2.1.1.tgz",
      "integrity": "sha512-631UJ6O00eNGfMiWG78ck80dfBab8X6IVFB51jZK5Icd7XAs60Z5y7QdSd/wGIklnWvRbUNloVzhOKKmutxQ6Q==",
      "dev": true,
      "dependencies": {
        "js-tokens": "^9.0.1"
      },
      "funding": {
        "url": "https://github.com/sponsors/antfu"
      }
    },
    "node_modules/supports-color": {
      "version": "7.2.0",
      "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
      "integrity": "sha512-qpCAvRl9stuOHveKsn7HncJRvv501qIacKzQlO/+Lwxc9+0q2wLyv4Dfvt80/DPn2pqOBsJdDiogXGR9+OvwRw==",
      "dev": true,
      "dependencies": {
        "has-flag": "^4.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/supports-preserve-symlinks-flag": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/supports-preserve-symlinks-flag/-/supports-preserve-symlinks-flag-1.0.0.tgz",
      "integrity": "sha512-ot0WnXS9fgdkgIcePe6RHNk1WA8+muPa6cSjeR3V8K27q9BB1rTE3R1p7Hv0z1ZyAc8s6Vvv8DIyWf681MAt0w==",
      "dev": true,
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/text-table": {
      "version": "0.2.0",
      "resolved": "https://registry.npmjs.org/text-table/-/text-table-0.2.0.tgz",
      "integrity": "sha512-N+8UisAXDGk8PFXP4HAzVR9nbfmVJ3zYLAWiTIoqC5v5isinhr+r5uaO8+7r3BMfuNIufIsA7RdpVgacC2cSpw==",
      "dev": true
    },
    "node_modules/tinybench": {
      "version": "2.9.0",
      "resolved": "https://registry.npmjs.org/tinybench/-/tinybench-2.9.0.tgz",
      "integrity": "sha512-0+DUvqWMValLmha6lr4kD8iAMK1HzV0/aKnCtWb9v9641TnP/MFb7Pc2bxoxQjTXAErryXVgUOfv2YqNllqGeg==",
      "dev": true
    },
    "node_modules/tinypool": {
      "version": "0.8.4",
      "resolved": "https://registry.npmjs.org/tinypool/-/tinypool-0.8.4.tgz",
      "integrity": "sha512-i11VH5gS6IFeLY3gMBQ00/MmLncVP7JLXOw1vlgkytLmJK7QnEr7NXf0LBdxfmNPAeyetukOk0bOYrJrFGjYJQ==",
      "dev": true,
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/tinyspy": {
      "version": "2.2.1",
      "resolved": "https://registry.npmjs.org/tinyspy/-/tinyspy-2.2.1.tgz",
      "integrity": "sha512-KYad6Vy5VDWV4GH3fjpseMQ/XU2BhIYP7Vzd0LG44qRWm/Yt2WCOTicFdvmgo6gWaqooMQCawTtILVQJupKu7A==",
      "dev": true,
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/to-regex-range": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
      "dev": true,
      "dependencies": {
        "is-number": "^7.0.0"
      },
      "engines": {
        "node": ">=8.0"
      }
    },
    "node_modules/ts-api-utils": {
      "version": "1.4.3",
      "resolved": "https://registry.npmjs.org/ts-api-utils/-/ts-api-utils-1.4.3.tgz",
      "integrity": "sha512-i3eMG77UTMD0hZhgRS562pv83RC6ukSAC2GMNWc+9dieh/+jDM5u5YG+NHX6VNDRHQcHwmsTHctP9LhbC3WxVw==",
      "dev": true,
      "engines": {
        "node": ">=16"
      },
      "peerDependencies": {
        "typescript": ">=4.2.0"
      }
    },
    "node_modules/tsx": {
      "version": "4.21.0",
      "resolved": "https://registry.npmjs.org/tsx/-/tsx-4.21.0.tgz",
      "integrity": "sha512-5C1sg4USs1lfG0GFb2RLXsdpXqBSEhAaA/0kPL01wxzpMqLILNxIxIOKiILz+cdg/pLnOUxFYOR5yhHU666wbw==",
      "dev": true,
      "dependencies": {
        "esbuild": "~0.27.0",
        "get-tsconfig": "^4.7.5"
      },
      "bin": {
        "tsx": "dist/cli.mjs"
      },
      "engines": {
        "node": ">=18.0.0"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      }
    },
    "node_modules/type-check": {
      "version": "0.4.0",
      "resolved": "https://registry.npmjs.org/type-check/-/type-check-0.4.0.tgz",
      "integrity": "sha512-XleUoc9uwGXqjWwXaUTZAmzMcFZ5858QA2vvx1Ur5xIcixXIP+8LnFDgRplU30us6teqdlskFfu+ae4K79Ooew==",
      "dev": true,
      "dependencies": {
        "prelude-ls": "^1.2.1"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/type-detect": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/type-detect/-/type-detect-4.1.0.tgz",
      "integrity": "sha512-Acylog8/luQ8L7il+geoSxhEkazvkslg7PSNKOX59mbB9cOveP5aq9h74Y7YU8yDpJwetzQQrfIwtf4Wp4LKcw==",
      "dev": true,
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/type-fest": {
      "version": "0.20.2",
      "resolved": "https://registry.npmjs.org/type-fest/-/type-fest-0.20.2.tgz",
      "integrity": "sha512-Ne+eE4r0/iWnpAxD852z3A+N0Bt5RN//NjJwRd2VFHEmrywxf5vsZlh4R6lixl6B+wz/8d+maTSAkN1FIkI3LQ==",
      "dev": true,
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/typedoc": {
      "version": "0.25.13",
      "resolved": "https://registry.npmjs.org/typedoc/-/typedoc-0.25.13.tgz",
      "integrity": "sha512-pQqiwiJ+Z4pigfOnnysObszLiU3mVLWAExSPf+Mu06G/qsc3wzbuM56SZQvONhHLncLUhYzOVkjFFpFfL5AzhQ==",
      "dev": true,
      "dependencies": {
        "lunr": "^2.3.9",
        "marked": "^4.3.0",
        "minimatch": "^9.0.3",
        "shiki": "^0.14.7"
      },
      "bin": {
        "typedoc": "bin/typedoc"
      },
      "engines": {
        "node": ">= 16"
      },
      "peerDependencies": {
        "typescript": "4.6.x || 4.7.x || 4.8.x || 4.9.x || 5.0.x || 5.1.x || 5.2.x || 5.3.x || 5.4.x"
      }
    },
    "node_modules/typescript": {
      "version": "5.4.5",
      "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.4.5.tgz",
      "integrity": "sha512-vcI4UpRgg81oIRUFwR0WSIHKt11nJ7SAVlYNIu+QpqeyXP+gpQJy/Z4+F0aGxSE4MqwjyXvW/TzgkLAx2AGHwQ==",
      "dev": true,
      "bin": {
        "tsc": "bin/tsc",
        "tsserver": "bin/tsserver"
      },
      "engines": {
        "node": ">=14.17"
      }
    },
    "node_modules/ufo": {
      "version": "1.6.2",
      "resolved": "https://registry.npmjs.org/ufo/-/ufo-1.6.2.tgz",
      "integrity": "sha512-heMioaxBcG9+Znsda5Q8sQbWnLJSl98AFDXTO80wELWEzX3hordXsTdxrIfMQoO9IY1MEnoGoPjpoKpMj+Yx0Q==",
      "dev": true
    },
    "node_modules/undici-types": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-6.21.0.tgz",
      "integrity": "sha512-iwDZqg0QAGrg9Rav5H4n0M64c3mkR59cJ6wQp+7C4nI0gsmExaedaYLNO44eT4AtBBwjbTiGPMlt2Md0T9H9JQ==",
      "dev": true
    },
    "node_modules/uri-js": {
      "version": "4.4.1",
      "resolved": "https://registry.npmjs.org/uri-js/-/uri-js-4.4.1.tgz",
      "integrity": "sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==",
      "dev": true,
      "dependencies": {
        "punycode": "^2.1.0"
      }
    },
    "node_modules/vite": {
      "version": "5.4.21",
      "resolved": "https://registry.npmjs.org/vite/-/vite-5.4.21.tgz",
      "integrity": "sha512-o5a9xKjbtuhY6Bi5S3+HvbRERmouabWbyUcpXXUA1u+GNUKoROi9byOJ8M0nHbHYHkYICiMlqxkg1KkYmm25Sw==",
      "dev": true,
      "dependencies": {
        "esbuild": "^0.21.3",
        "postcss": "^8.4.43",
        "rollup": "^4.20.0"
      },
      "bin": {
        "vite": "bin/vite.js"
      },
      "engines": {
        "node": "^18.0.0 || >=20.0.0"
      },
      "funding": {
        "url": "https://github.com/vitejs/vite?sponsor=1"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      },
      "peerDependencies": {
        "@types/node": "^18.0.0 || >=20.0.0",
        "less": "*",
        "lightningcss": "^1.21.0",
        "sass": "*",
        "sass-embedded": "*",
        "stylus": "*",
        "sugarss": "*",
        "terser": "^5.4.0"
      },
      "peerDependenciesMeta": {
        "@types/node": {
          "optional": true
        },
        "less": {
          "optional": true
        },
        "lightningcss": {
          "optional": true
        },
        "sass": {
          "optional": true
        },
        "sass-embedded": {
          "optional": true
        },
        "stylus": {
          "optional": true
        },
        "sugarss": {
          "optional": true
        },
        "terser": {
          "optional": true
        }
      }
    },
    "node_modules/vite-node": {
      "version": "1.6.1",
      "resolved": "https://registry.npmjs.org/vite-node/-/vite-node-1.6.1.tgz",
      "integrity": "sha512-YAXkfvGtuTzwWbDSACdJSg4A4DZiAqckWe90Zapc/sEX3XvHcw1NdurM/6od8J207tSDqNbSsgdCacBgvJKFuA==",
      "dev": true,
      "dependencies": {
        "cac": "^6.7.14",
        "debug": "^4.3.4",
        "pathe": "^1.1.1",
        "picocolors": "^1.0.0",
        "vite": "^5.0.0"
      },
      "bin": {
        "vite-node": "vite-node.mjs"
      },
      "engines": {
        "node": "^18.0.0 || >=20.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/vitest"
      }
    },
    "node_modules/vite/node_modules/@esbuild/aix-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
      "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/android-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
      "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/android-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
      "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/android-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
      "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/darwin-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
      "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/darwin-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
      "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/freebsd-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
      "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/freebsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
      "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
      "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
      "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
      "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-loong64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
      "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-mips64el": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
      "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
      "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-riscv64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
      "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-s390x": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
      "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/linux-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
      "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/netbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
      "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/openbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
      "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/sunos-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
      "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/win32-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
      "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/win32-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
      "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/@esbuild/win32-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
      "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/vite/node_modules/esbuild": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.21.5.tgz",
      "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
      "dev": true,
      "hasInstallScript": true,
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=12"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.21.5",
        "@esbuild/android-arm": "0.21.5",
        "@esbuild/android-arm64": "0.21.5",
        "@esbuild/android-x64": "0.21.5",
        "@esbuild/darwin-arm64": "0.21.5",
        "@esbuild/darwin-x64": "0.21.5",
        "@esbuild/freebsd-arm64": "0.21.5",
        "@esbuild/freebsd-x64": "0.21.5",
        "@esbuild/linux-arm": "0.21.5",
        "@esbuild/linux-arm64": "0.21.5",
        "@esbuild/linux-ia32": "0.21.5",
        "@esbuild/linux-loong64": "0.21.5",
        "@esbuild/linux-mips64el": "0.21.5",
        "@esbuild/linux-ppc64": "0.21.5",
        "@esbuild/linux-riscv64": "0.21.5",
        "@esbuild/linux-s390x": "0.21.5",
        "@esbuild/linux-x64": "0.21.5",
        "@esbuild/netbsd-x64": "0.21.5",
        "@esbuild/openbsd-x64": "0.21.5",
        "@esbuild/sunos-x64": "0.21.5",
        "@esbuild/win32-arm64": "0.21.5",
        "@esbuild/win32-ia32": "0.21.5",
        "@esbuild/win32-x64": "0.21.5"
      }
    },
    "node_modules/vitest": {
      "version": "1.6.1",
      "resolved": "https://registry.npmjs.org/vitest/-/vitest-1.6.1.tgz",
      "integrity": "sha512-Ljb1cnSJSivGN0LqXd/zmDbWEM0RNNg2t1QW/XUhYl/qPqyu7CsqeWtqQXHVaJsecLPuDoak2oJcZN2QoRIOag==",
      "dev": true,
      "dependencies": {
        "@vitest/expect": "1.6.1",
        "@vitest/runner": "1.6.1",
        "@vitest/snapshot": "1.6.1",
        "@vitest/spy": "1.6.1",
        "@vitest/utils": "1.6.1",
        "acorn-walk": "^8.3.2",
        "chai": "^4.3.10",
        "debug": "^4.3.4",
        "execa": "^8.0.1",
        "local-pkg": "^0.5.0",
        "magic-string": "^0.30.5",
        "pathe": "^1.1.1",
        "picocolors": "^1.0.0",
        "std-env": "^3.5.0",
        "strip-literal": "^2.0.0",
        "tinybench": "^2.5.1",
        "tinypool": "^0.8.3",
        "vite": "^5.0.0",
        "vite-node": "1.6.1",
        "why-is-node-running": "^2.2.2"
      },
      "bin": {
        "vitest": "vitest.mjs"
      },
      "engines": {
        "node": "^18.0.0 || >=20.0.0"
      },
      "funding": {
        "url": "https://opencollective.com/vitest"
      },
      "peerDependencies": {
        "@edge-runtime/vm": "*",
        "@types/node": "^18.0.0 || >=20.0.0",
        "@vitest/browser": "1.6.1",
        "@vitest/ui": "1.6.1",
        "happy-dom": "*",
        "jsdom": "*"
      },
      "peerDependenciesMeta": {
        "@edge-runtime/vm": {
          "optional": true
        },
        "@types/node": {
          "optional": true
        },
        "@vitest/browser": {
          "optional": true
        },
        "@vitest/ui": {
          "optional": true
        },
        "happy-dom": {
          "optional": true
        },
        "jsdom": {
          "optional": true
        }
      }
    },
    "node_modules/vscode-oniguruma": {
      "version": "1.7.0",
      "resolved": "https://registry.npmjs.org/vscode-oniguruma/-/vscode-oniguruma-1.7.0.tgz",
      "integrity": "sha512-L9WMGRfrjOhgHSdOYgCt/yRMsXzLDJSL7BPrOZt73gU0iWO4mpqzqQzOz5srxqTvMBaR0XZTSrVWo4j55Rc6cA==",
      "dev": true
    },
    "node_modules/vscode-textmate": {
      "version": "8.0.0",
      "resolved": "https://registry.npmjs.org/vscode-textmate/-/vscode-textmate-8.0.0.tgz",
      "integrity": "sha512-AFbieoL7a5LMqcnOF04ji+rpXadgOXnZsxQr//r83kLPr7biP7am3g9zbaZIaBGwBRWeSvoMD4mgPdX3e4NWBg==",
      "dev": true
    },
    "node_modules/which": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/which/-/which-2.0.2.tgz",
      "integrity": "sha512-BLI3Tl1TW3Pvl70l3yq3Y64i+awpwXqsGBYWkkqMtnbXgrMD+yj7rhW0kuEDxzJaYXGjEW5ogapKNMEKNMjibA==",
      "dev": true,
      "dependencies": {
        "isexe": "^2.0.0"
      },
      "bin": {
        "node-which": "bin/node-which"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/why-is-node-running": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/why-is-node-running/-/why-is-node-running-2.3.0.tgz",
      "integrity": "sha512-hUrmaWBdVDcxvYqnyh09zunKzROWjbZTiNy8dBEjkS7ehEDQibXJ7XvlmtbwuTclUiIyN+CyXQD4Vmko8fNm8w==",
      "dev": true,
      "dependencies": {
        "siginfo": "^2.0.0",
        "stackback": "0.0.2"
      },
      "bin": {
        "why-is-node-running": "cli.js"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/word-wrap": {
      "version": "1.2.5",
      "resolved": "https://registry.npmjs.org/word-wrap/-/word-wrap-1.2.5.tgz",
      "integrity": "sha512-BN22B5eaMMI9UMtjrGd5g5eCYPpCPDUy0FJXbYsaT5zYxjFOckS53SQDE3pWkVoWpHXVb3BrYcEN4Twa55B5cA==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/wrappy": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/wrappy/-/wrappy-1.0.2.tgz",
      "integrity": "sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==",
      "dev": true
    },
    "node_modules/yocto-queue": {
      "version": "0.1.0",
      "resolved": "https://registry.npmjs.org/yocto-queue/-/yocto-queue-0.1.0.tgz",
      "integrity": "sha512-rVksvsnNCdJ/ohGc6xgPwyN8eheCxsiLM8mxuE/t/mOVqJewPuO1miLpTHQiRgTKCLexL4MeAFVagts7HmNZ2Q==",
      "dev": true,
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    }
  }
}

#####/web/package.json#####
{
  "name": "@grin-format/web",
  "version": "0.1.0",
  "description": "GRIN (Graphic Readdressable Indexed Nodes) image format - Web/JavaScript implementation",
  "keywords": [
    "grin",
    "image",
    "animation",
    "canvas",
    "web-component"
  ],
  "license": "MIT",
  "author": "GRIN Project Contributors",
  "repository": {
    "type": "git",
    "url": "https://github.com/grin-format/grin.git",
    "directory": "web"
  },
  "type": "module",
  "main": "./dist/grin.cjs",
  "module": "./dist/grin.js",
  "types": "./dist/grin.d.ts",
  "exports": {
    ".": {
      "import": "./dist/grin.js",
      "require": "./dist/grin.cjs",
      "types": "./dist/grin.d.ts"
    },
    "./player": {
      "import": "./dist/grin-player.js",
      "require": "./dist/grin-player.cjs",
      "types": "./dist/grin-player.d.ts"
    }
  },
  "files": [
    "dist",
    "README.md",
    "LICENSE"
  ],
  "sideEffects": [
    "./dist/grin-player.js",
    "./dist/grin-player.cjs"
  ],
  "scripts": {
    "build": "tsc && rollup -c",
    "build:watch": "tsc --watch",
    "test": "vitest run",
    "test:watch": "vitest",
    "lint": "eslint lib/**/*.ts",
    "typecheck": "tsc --noEmit",
    "docs:api": "typedoc",
    "clean": "rm -rf dist",
    "prepublishOnly": "npm run clean && npm run build && npm test"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "typescript": "^5.3.0",
    "eslint": "^8.56.0",
    "@typescript-eslint/parser": "^6.0.0",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "tsx": "^4.19.2",
    "rollup": "^4.24.0",
    "@rollup/plugin-node-resolve": "^15.2.3",
    "@rollup/plugin-commonjs": "^25.0.8",
    "vitest": "^1.6.0",
    "typedoc": "^0.25.13"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "browserslist": [
    "defaults",
    "not IE 11",
    "not op_mini all"
  ]
}

#####/web/README.md#####
# GRIN Web Library

The GRIN web package provides a JavaScript/TypeScript implementation of the GRIN
(Graphic Readdressable Indexed Nodes) format, including helpers for decoding,
rendering, and animation playback.

## Install

```bash
npm install @grin-format/web
```

## Build

```bash
npm run build
```

## Publish

```bash
npm publish --access public
```

## Development Notes

- Generated artifacts live in `dist/`.
- Run `npm test` before publishing.

#####/web/rollup.config.mjs#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import resolve from "@rollup/plugin-node-resolve";
import commonjs from "@rollup/plugin-commonjs";

const plugins = [resolve(), commonjs()];

export default [
  {
    input: "dist/index.js",
    output: [
      { file: "dist/grin.js", format: "es", sourcemap: true },
      { file: "dist/grin.cjs", format: "cjs", sourcemap: true, exports: "named" },
      { file: "dist/grin.umd.js", format: "umd", name: "Grin", sourcemap: true },
    ],
    plugins,
  },
  {
    input: "dist/player.js",
    output: [
      { file: "dist/grin-player.js", format: "es", sourcemap: true },
      { file: "dist/grin-player.cjs", format: "cjs", sourcemap: true, exports: "named" },
    ],
    plugins,
  },
];

#####/web/tests/endianness.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import {
  readUint16LE,
  readUint32LE,
  readUint64LE,
  writeUint16LE,
  writeUint32LE,
  writeUint64LE,
} from "../lib/endianness";

test("endianness helpers enforce little-endian interpretation", () => {
  const buffer = new ArrayBuffer(4);
  const view = new DataView(buffer);
  view.setUint32(0, 0x12345678, false); // big-endian encoding
  const bytes = new Uint8Array(buffer);
  assert.equal(readUint32LE(bytes, 0), 0x78563412);
});

test("writeUint16LE writes expected bytes", () => {
  assert.deepEqual(writeUint16LE(0x1234), new Uint8Array([0x34, 0x12]));
});

test("writeUint32LE writes expected bytes", () => {
  assert.deepEqual(writeUint32LE(0x78563412), new Uint8Array([0x12, 0x34, 0x56, 0x78]));
});

test("writeUint64LE writes expected bytes", () => {
  assert.deepEqual(
    writeUint64LE(0x0807060504030201n),
    new Uint8Array([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08])
  );
});

test("readUint16LE reads expected value", () => {
  assert.equal(readUint16LE(new Uint8Array([0x34, 0x12]), 0), 0x1234);
});

test("readUint64LE reads expected value", () => {
  assert.equal(
    readUint64LE(new Uint8Array([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]), 0),
    0x0807060504030201n
  );
});

#####/web/tests/format-roundtrip.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import { GrinHeader } from "../lib/grin-header";
import { GrinPixel } from "../lib/grin-pixel";
import { GrinRule } from "../lib/grin-rule";
import { HEADER_SIZE_BYTES, RULES_BLOCK_SIZE } from "../lib/format";

function buildRulesBlock(): Uint8Array {
  const block = new Uint8Array(RULES_BLOCK_SIZE);
  for (let i = 0; i < block.length; i += 1) {
    block[i] = (i * 7) & 0xff;
  }
  return block;
}

test("GrinHeader serialize/deserialize round-trip", () => {
  const rulesBlock = buildRulesBlock();
  const pixelDataLength = BigInt(2 * 3 * 5);
  const fileLength = BigInt(HEADER_SIZE_BYTES) + pixelDataLength;
  const header = new GrinHeader({
    width: 2,
    height: 3,
    tickMicros: 1234,
    ruleCount: 2,
    opcodeSetId: 0,
    flags: 0,
    pixelDataLength,
    fileLength,
    pixelDataOffset: BigInt(HEADER_SIZE_BYTES),
    reservedA: 0n,
    reservedB: 0n,
    rulesBlock,
  });

  const bytes = header.serialize();
  const parsed = GrinHeader.deserialize(bytes);

  assert.deepEqual(parsed.magic, header.magic);
  assert.equal(parsed.versionMajor, header.versionMajor);
  assert.equal(parsed.versionMinor, header.versionMinor);
  assert.equal(parsed.headerSize, header.headerSize);
  assert.equal(parsed.width, header.width);
  assert.equal(parsed.height, header.height);
  assert.equal(parsed.tickMicros, header.tickMicros);
  assert.equal(parsed.ruleCount, header.ruleCount);
  assert.equal(parsed.opcodeSetId, header.opcodeSetId);
  assert.equal(parsed.flags, header.flags);
  assert.equal(parsed.pixelDataLength, header.pixelDataLength);
  assert.equal(parsed.fileLength, header.fileLength);
  assert.equal(parsed.pixelDataOffset, header.pixelDataOffset);
  assert.equal(parsed.reservedA, header.reservedA);
  assert.equal(parsed.reservedB, header.reservedB);
  assert.deepEqual(parsed.rulesBlock, header.rulesBlock);
});

test("GrinPixel serialize/deserialize round-trip", () => {
  const pixel = new GrinPixel(12, 34, 56, 78, 0x8f);
  const bytes = pixel.toBytes();
  const parsed = GrinPixel.fromBytes(bytes);

  assert.equal(parsed.r, pixel.r);
  assert.equal(parsed.g, pixel.g);
  assert.equal(parsed.b, pixel.b);
  assert.equal(parsed.a, pixel.a);
  assert.equal(parsed.c, pixel.c);
});

test("GrinRule serialize/deserialize round-trip", () => {
  const rule = new GrinRule(0x00ff, 0x05, 0xaa);
  const bytes = rule.serialize();
  const parsed = GrinRule.deserialize(bytes);

  assert.equal(parsed.groupMask, rule.groupMask);
  assert.equal(parsed.opcode, rule.opcode);
  assert.equal(parsed.timing, rule.timing);
});

#####/web/tests/fuzz.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import { GrinHeader } from "../lib/grin-header";
import { GrinFile } from "../lib/grin-file";
import { GrinPixel } from "../lib/grin-pixel";
import { GrinRule } from "../lib/grin-rule";
import { readRulesBlock } from "../lib/grin-io";
import { HEADER_SIZE_BYTES, RULES_BLOCK_SIZE } from "../lib/format";

function rng(seed: number): () => number {
  let value = seed >>> 0;
  return () => {
    value = (1664525 * value + 1013904223) >>> 0;
    return value;
  };
}

function randomBytes(count: number, next: () => number): Uint8Array {
  const bytes = new Uint8Array(count);
  for (let i = 0; i < bytes.length; i += 1) {
    bytes[i] = next() & 0xff;
  }
  return bytes;
}

test("header fuzzing produces validation output without throwing", () => {
  const next = rng(0xdeadbeef);
  for (let i = 0; i < 50; i += 1) {
    const bytes = randomBytes(HEADER_SIZE_BYTES, next);
    const header = GrinHeader.deserialize(bytes);
    const result = header.validate();
    assert.equal(typeof result.ok, "boolean");
  }
});

test("pixel data fuzzing fails gracefully", () => {
  const next = rng(0x1234);
  for (let i = 0; i < 20; i += 1) {
    const header = new GrinHeader({ width: 2, height: 2, tickMicros: 0, ruleCount: 0, opcodeSetId: 0 });
    const pixels = [
      new GrinPixel(1, 2, 3, 4, 0),
      new GrinPixel(5, 6, 7, 8, 0),
      new GrinPixel(9, 10, 11, 12, 0),
      new GrinPixel(13, 14, 15, 16, 0),
    ];
    const file = new GrinFile(header, pixels, []);
    const bytes = file.toBytes();
    const truncate = (next() % 6) + 1;
    const sliced = bytes.subarray(0, bytes.length - truncate);

    try {
      GrinFile.load(sliced);
      assert.fail("Expected truncation to throw");
    } catch (error) {
      const message = error instanceof Error ? error.message : String(error);
      assert.ok(message.length > 0);
    }
  }
});

test("rules fuzzing rejects invalid opcodes with clear errors", () => {
  const next = rng(0x9876);
  for (let i = 0; i < 20; i += 1) {
    const rulesBlock = randomBytes(RULES_BLOCK_SIZE, next);
    const ruleCount = (next() % 5) + 1;
    try {
      readRulesBlock(rulesBlock, ruleCount, 0);
    } catch (error) {
      const message = error instanceof Error ? error.message : String(error);
      assert.ok(message.length > 0);
    }
  }
});

#####/web/tests/integration.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import { GrinFile } from "../lib/grin-file";
import { GrinHeader } from "../lib/grin-header";
import { GrinPixel } from "../lib/grin-pixel";
import { GrinRule } from "../lib/grin-rule";
import { GrinPlayer } from "../lib/grin-player";
import { TestTickScheduler } from "../lib/tick-scheduler";
import { BaseOpcodeId } from "../lib/opcodes";
import { validateGrinFile } from "../lib/validation";
import { parseGrinBytes } from "../../tools/lib/grin.js";

const TIMING_SQUARE_PERIOD_2 = 0x01;

function createSampleFile(): GrinFile {
  const header = new GrinHeader({ width: 1, height: 1, tickMicros: 1, ruleCount: 1, opcodeSetId: 0 });
  const pixel = new GrinPixel(10, 20, 30, 255, 0);
  const rule = new GrinRule(0x0001, BaseOpcodeId.INVERT, TIMING_SQUARE_PERIOD_2);
  return new GrinFile(header, [pixel], [rule]);
}

test("full load -> validate -> play -> render cycle", () => {
  const scheduler = new TestTickScheduler();
  const player = new GrinPlayer(() => scheduler);
  const file = createSampleFile();

  const validation = validateGrinFile(file, "permissive");
  assert.equal(validation.ok, true);

  const bytes = file.toBytes();
  const loaded = GrinFile.load(bytes);
  player.load(loaded);
  player.play();
  scheduler.advance(1);

  const output = player.getCurrentFrame().rgbaData;
  assert.deepEqual(Array.from(output.slice(0, 4)), [245, 235, 225, 255]);
});

test("cross-platform compatibility with CLI parser", () => {
  const file = createSampleFile();
  const bytes = file.toBytes();
  const parsed = parseGrinBytes(bytes);
  assert.equal(parsed.header.width, 1);
  assert.equal(parsed.header.height, 1);
  assert.equal(parsed.rules.length, 1);
  assert.equal(parsed.pixels.length, 1);
});

#####/web/tests/opcodes.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import { GrinPixel } from "../lib/grin-pixel";
import {
  FadeInOpcode,
  FadeOutOpcode,
  InvertOpcode,
  LockOpcode,
  NopOpcode,
  PulseOpcode,
  RotateHueOpcode,
  ShiftAOpcode,
  ShiftBOpcode,
  ShiftGOpcode,
  ShiftROpcode,
  ToggleLockOpcode,
  UnlockOpcode,
} from "../lib/opcodes";
import { OpcodeRegistry } from "../lib/opcode-registry";

const TIMING_SQUARE_PERIOD_2 = 0x01;
const TIMING_SAW_PERIOD_2 = 0x31;
const BASE_OPCODES = [
  new NopOpcode(),
  new FadeInOpcode(),
  new FadeOutOpcode(),
  new PulseOpcode(),
  new ShiftROpcode(),
  new ShiftGOpcode(),
  new ShiftBOpcode(),
  new ShiftAOpcode(),
  new InvertOpcode(),
  new RotateHueOpcode(),
  new LockOpcode(),
  new UnlockOpcode(),
  new ToggleLockOpcode(),
];

test("NopOpcode leaves pixel unchanged", () => {
  const pixel = new GrinPixel(10, 20, 30, 40, 0);
  new NopOpcode().apply(pixel, 1, TIMING_SQUARE_PERIOD_2);
  assert.deepEqual(pixel.toBytes(), new Uint8Array([10, 20, 30, 40, 0]));
});

test("FadeInOpcode can zero alpha on low wave", () => {
  const pixel = new GrinPixel(10, 20, 30, 200, 0);
  new FadeInOpcode().apply(pixel, 0, TIMING_SQUARE_PERIOD_2);
  assert.equal(pixel.a, 0);
});

test("FadeOutOpcode can zero alpha on high wave", () => {
  const pixel = new GrinPixel(10, 20, 30, 200, 0);
  new FadeOutOpcode().apply(pixel, 1, TIMING_SQUARE_PERIOD_2);
  assert.equal(pixel.a, 0);
});

test("PulseOpcode scales alpha with waveform", () => {
  const pixel = new GrinPixel(10, 20, 30, 200, 0);
  new PulseOpcode().apply(pixel, 1, TIMING_SQUARE_PERIOD_2);
  assert.equal(pixel.a, 200);
});

test("Shift opcodes shift channels according to waveform", () => {
  const rPixel = new GrinPixel(10, 20, 30, 40, 0);
  const gPixel = new GrinPixel(10, 20, 30, 40, 0);
  const bPixel = new GrinPixel(10, 20, 30, 40, 0);
  const aPixel = new GrinPixel(10, 20, 30, 40, 0);

  new ShiftROpcode().apply(rPixel, 1, TIMING_SQUARE_PERIOD_2);
  new ShiftGOpcode().apply(gPixel, 0, TIMING_SQUARE_PERIOD_2);
  new ShiftBOpcode().apply(bPixel, 1, TIMING_SQUARE_PERIOD_2);
  new ShiftAOpcode().apply(aPixel, 0, TIMING_SQUARE_PERIOD_2);

  assert.equal(rPixel.r, 255);
  assert.equal(gPixel.g, 0);
  assert.equal(bPixel.b, 255);
  assert.equal(aPixel.a, 0);
});

test("InvertOpcode flips RGB channels", () => {
  const pixel = new GrinPixel(10, 20, 30, 200, 0);
  new InvertOpcode().apply(pixel, 0, 0);
  assert.deepEqual(pixel.toBytes(), new Uint8Array([245, 235, 225, 200, 0]));
});

test("RotateHueOpcode rotates hue by waveform", () => {
  const pixel = new GrinPixel(255, 0, 0, 255, 0);
  new RotateHueOpcode().apply(pixel, 1, TIMING_SAW_PERIOD_2);
  assert.deepEqual(pixel.toBytes(), new Uint8Array([0, 255, 255, 255, 0]));
});

test("Lock opcodes mutate lock bit", () => {
  const pixel = new GrinPixel(10, 20, 30, 40, 0);
  new LockOpcode().apply(pixel, 0, 0);
  assert.equal(pixel.c & 0x80, 0x80);

  new UnlockOpcode().apply(pixel, 0, 0);
  assert.equal(pixel.c & 0x80, 0);

  new ToggleLockOpcode().apply(pixel, 0, 0);
  assert.equal(pixel.c & 0x80, 0x80);
});

test("OpcodeRegistry returns base opcodes", () => {
  const registry = OpcodeRegistry.getInstance();
  assert.equal(registry.isValidOpcode(0, 0x00), true);
  assert.equal(registry.getOpcode(0, 0x00).getName(), "NOP");
});

test("Base opcodes report statelessness", () => {
  BASE_OPCODES.forEach((opcode) => {
    assert.equal(opcode.requiresState(), false);
  });
});

test("Base opcode CPU cost stays within declared bounds", () => {
  BASE_OPCODES.forEach((opcode) => {
    assert.equal(opcode.getMaxCpuCost() <= 3, true);
  });
});

test("Base opcodes are deterministic per call", () => {
  const tick = 3;
  const timing = TIMING_SAW_PERIOD_2;
  BASE_OPCODES.forEach((opcode) => {
    const pixelA = new GrinPixel(10, 20, 30, 200, 0);
    const pixelB = new GrinPixel(10, 20, 30, 200, 0);
    opcode.apply(pixelA, tick, timing);
    opcode.apply(pixelB, tick, timing);
    assert.deepEqual(pixelA.toBytes(), pixelB.toBytes());
  });
});

#####/web/tests/playback.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import { CONTROL_BYTE_MASKS } from "../lib/format";
import { GrinFile } from "../lib/grin-file";
import { GrinHeader } from "../lib/grin-header";
import { GrinPixel } from "../lib/grin-pixel";
import { GrinRule } from "../lib/grin-rule";
import { GrinPlayer } from "../lib/grin-player";
import { TestTickScheduler } from "../lib/tick-scheduler";
import { BaseOpcodeId } from "../lib/opcodes";

const TIMING_SQUARE_PERIOD_2 = 0x01;

function buildFile(pixels: GrinPixel[], rules: GrinRule[], width: number, height: number): GrinFile {
  const header = new GrinHeader({
    width,
    height,
    tickMicros: 1,
    ruleCount: rules.length,
    opcodeSetId: 0,
  });
  return new GrinFile(header, pixels, rules);
}

test("tick advancement follows scheduler ticks", () => {
  const scheduler = new TestTickScheduler();
  const player = new GrinPlayer(() => scheduler);
  const file = buildFile([new GrinPixel(1, 2, 3, 4, 0)], [], 1, 1);

  player.load(file);
  player.play();
  scheduler.advance(3);

  assert.equal(player.getCurrentTick(), 3);
});

test("rule activation follows timing evaluation", () => {
  const scheduler = new TestTickScheduler();
  const player = new GrinPlayer(() => scheduler);
  const pixel = new GrinPixel(10, 20, 30, 255, 0);
  const rule = new GrinRule(0x0001, BaseOpcodeId.INVERT, TIMING_SQUARE_PERIOD_2);
  const file = buildFile([pixel], [rule], 1, 1);

  player.load(file);
  player.play();
  scheduler.advance(1);

  const output = player.getCurrentFrame().rgbaData;
  assert.deepEqual(Array.from(output.slice(0, 4)), [245, 235, 225, 255]);
});

test("locked pixels ignore active rules", () => {
  const scheduler = new TestTickScheduler();
  const player = new GrinPlayer(() => scheduler);
  const locked = CONTROL_BYTE_MASKS.LOCK;
  const pixel = new GrinPixel(10, 20, 30, 255, locked);
  const rule = new GrinRule(0x0001, BaseOpcodeId.INVERT, TIMING_SQUARE_PERIOD_2);
  const file = buildFile([pixel], [rule], 1, 1);

  player.load(file);
  player.play();
  scheduler.advance(1);

  const output = player.getCurrentFrame().rgbaData;
  assert.deepEqual(Array.from(output.slice(0, 4)), [10, 20, 30, 255]);
});

test("group targeting applies only to matching pixels", () => {
  const scheduler = new TestTickScheduler();
  const player = new GrinPlayer(() => scheduler);
  const pixelA = new GrinPixel(10, 20, 30, 255, 0); // group 0
  const pixelB = new GrinPixel(40, 50, 60, 255, 1); // group 1
  const rule = new GrinRule(0x0001, BaseOpcodeId.INVERT, TIMING_SQUARE_PERIOD_2);
  const file = buildFile([pixelA, pixelB], [rule], 2, 1);

  player.load(file);
  player.play();
  scheduler.advance(1);

  const output = player.getCurrentFrame().rgbaData;
  assert.deepEqual(Array.from(output.slice(0, 4)), [245, 235, 225, 255]);
  assert.deepEqual(Array.from(output.slice(4, 8)), [40, 50, 60, 255]);
});

test("display buffer updates do not mutate source pixels", () => {
  const scheduler = new TestTickScheduler();
  const player = new GrinPlayer(() => scheduler);
  const pixel = new GrinPixel(10, 20, 30, 255, 0);
  const file = buildFile([pixel], [], 1, 1);

  player.load(file);
  player.play();
  scheduler.advance(1);

  const output = player.getCurrentFrame().rgbaData;
  output[0] = 0;
  output[1] = 0;
  output[2] = 0;

  assert.equal(file.pixels[0]?.r, 10);
  assert.equal(file.pixels[0]?.g, 20);
  assert.equal(file.pixels[0]?.b, 30);
});

#####/web/tests/reference.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import { GrinFile } from "../lib/grin-file";
import { GrinHeader } from "../lib/grin-header";
import { GrinPixel } from "../lib/grin-pixel";
import { HEADER_SIZE_BYTES } from "../lib/format";

function buildReferenceBytes(): Uint8Array {
  const bytes = new Uint8Array(HEADER_SIZE_BYTES + 5);
  bytes.set([0x47, 0x52, 0x49, 0x4e], 0); // MAGIC
  bytes[4] = 0x00;
  bytes[5] = 0x00;
  bytes[6] = 0x80;
  bytes[7] = 0x00;
  bytes[8] = 0x01;
  bytes[12] = 0x01;
  bytes[24] = 0x05;
  bytes[32] = 0x85;
  bytes[40] = 0x80;
  bytes[HEADER_SIZE_BYTES] = 1;
  bytes[HEADER_SIZE_BYTES + 1] = 2;
  bytes[HEADER_SIZE_BYTES + 2] = 3;
  bytes[HEADER_SIZE_BYTES + 3] = 4;
  bytes[HEADER_SIZE_BYTES + 4] = 0;
  return bytes;
}

test("JavaScript file serialization matches reference bytes", () => {
  const header = new GrinHeader({
    width: 1,
    height: 1,
    tickMicros: 0,
    ruleCount: 0,
    opcodeSetId: 0,
    fileLength: BigInt(HEADER_SIZE_BYTES + 5),
  });
  const pixel = new GrinPixel(1, 2, 3, 4, 0);
  const file = new GrinFile(header, [pixel], []);

  const bytes = file.toBytes();
  const expected = buildReferenceBytes();
  assert.deepEqual(bytes, expected);
});

#####/web/tests/timing.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import { TimingInterpreter } from "../lib/timing";

const TIMING_SQUARE_PERIOD_2 = 0x01;
const TIMING_TRIANGLE_PERIOD_2 = 0x11;
const TIMING_SINE_PERIOD_2 = 0x21;
const TIMING_SAW_PERIOD_2 = 0x31;
const TIMING_SQUARE_PHASE_2 = 0x41;

test("TimingInterpreter exposes waveform metadata", () => {
  assert.equal(TimingInterpreter.getPeriod(TIMING_SQUARE_PERIOD_2), 2);
  assert.equal(TimingInterpreter.getWaveform(TIMING_SQUARE_PERIOD_2), "square");
  assert.equal(TimingInterpreter.getWaveform(TIMING_TRIANGLE_PERIOD_2), "triangle");
  assert.equal(TimingInterpreter.getWaveform(TIMING_SINE_PERIOD_2), "sine");
  assert.equal(TimingInterpreter.getWaveform(TIMING_SAW_PERIOD_2), "sawtooth");
  assert.equal(TimingInterpreter.getPhaseOffset(TIMING_SQUARE_PHASE_2), 1);
});

test("TimingInterpreter evaluates square waves on period boundaries", () => {
  assert.equal(TimingInterpreter.evaluate(TIMING_SQUARE_PERIOD_2, 0), 0);
  assert.equal(TimingInterpreter.evaluate(TIMING_SQUARE_PERIOD_2, 1), 1);
  assert.equal(TimingInterpreter.evaluate(TIMING_SQUARE_PERIOD_2, 2), 0);
});

test("TimingInterpreter evaluates triangle waves symmetrically", () => {
  const value = TimingInterpreter.evaluate(TIMING_TRIANGLE_PERIOD_2, 1);
  assert.equal(value, 1);
});

#####/web/tests/validation-boundaries.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import {
  validateDimensions,
  validateHeaderSize,
  validateMagic,
  validatePixelDataLength,
  validateReservedFields,
  validateRuleCount,
} from "../lib/validation";
import { HEADER_SIZE_BYTES, MAGIC_BYTES, MAX_RULE_COUNT, PIXEL_SIZE_BYTES } from "../lib/format";


test("validateHeaderSize accepts 128 and rejects other sizes", () => {
  assert.equal(validateHeaderSize(HEADER_SIZE_BYTES).ok, true);
  assert.equal(validateHeaderSize(127).ok, false);
});

test("validateMagic accepts correct magic and rejects mismatch", () => {
  assert.equal(validateMagic(MAGIC_BYTES).ok, true);
  assert.equal(validateMagic(new Uint8Array([0, 1, 2, 3])).ok, false);
});

test("validateDimensions handles boundary values", () => {
  assert.equal(validateDimensions(0, 0).ok, true);
  assert.equal(validateDimensions(1, 1).ok, true);
  assert.equal(validateDimensions(0xffffffff, 0xffffffff).ok, true);
  assert.equal(validateDimensions(0x1_0000_0000, 1).ok, false);
  assert.equal(validateDimensions(-1, 1).ok, false);
});

test("validateRuleCount enforces 0-16", () => {
  assert.equal(validateRuleCount(0).ok, true);
  assert.equal(validateRuleCount(MAX_RULE_COUNT).ok, true);
  assert.equal(validateRuleCount(MAX_RULE_COUNT + 1).ok, false);
});

test("validatePixelDataLength checks exact pixel byte length", () => {
  const expected = BigInt(PIXEL_SIZE_BYTES);
  assert.equal(validatePixelDataLength(expected, 1, 1).ok, true);
  assert.equal(validatePixelDataLength(expected - 1n, 1, 1).ok, false);
  assert.equal(validatePixelDataLength(expected + 1n, 1, 1).ok, false);
});

test("validateReservedFields warns when reserved fields are non-zero", () => {
  const clean = validateReservedFields(0n, 0n, 0);
  assert.equal(clean.ok, true);
  assert.equal(clean.warnings.length, 0);

  const warned = validateReservedFields(1n, 0n, 0);
  assert.equal(warned.ok, true);
  assert.equal(warned.warnings.length, 1);
});

#####/web/tests/validation.test.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { test } from "vitest";
import assert from "node:assert/strict";
import { GrinHeader } from "../lib/grin-header";
import { GrinPixel } from "../lib/grin-pixel";
import { GrinFile } from "../lib/grin-file";
import {
  validateControlByte,
  validateGrinFile,
  validateMagic,
  validateOpcode,
  validateVersion,
} from "../lib/validation";
import { MAGIC_BYTES } from "../lib/format";

function createMinimalFile(options: { flags?: number; controlByte?: number } = {}): GrinFile {
  const header = new GrinHeader({
    width: 1,
    height: 1,
    tickMicros: 0,
    ruleCount: 0,
    opcodeSetId: 0,
    flags: options.flags ?? 0,
  });
  const pixel = new GrinPixel(10, 20, 30, 200, options.controlByte ?? 0);
  return new GrinFile(header, [pixel], []);
}

test("validateMagic accepts GRIN and rejects invalid magic", () => {
  assert.equal(validateMagic(MAGIC_BYTES).ok, true);
  assert.equal(validateMagic(new Uint8Array([0, 0, 0, 0])).ok, false);
});

test("validateVersion warns on unexpected version", () => {
  const result = validateVersion(1, 0);
  assert.equal(result.ok, true);
  assert.equal(result.warnings.length, 1);
});

test("validateControlByte flags reserved bits", () => {
  const result = validateControlByte(0x70);
  assert.equal(result.ok, true);
  assert.equal(result.warnings.length, 1);
});

test("validateOpcode rejects unknown base opcode", () => {
  const result = validateOpcode(0xff, 0);
  assert.equal(result.ok, false);
});

test("validateGrinFile strict mode rejects warnings", () => {
  const file = createMinimalFile({ flags: 1 });
  const strictResult = validateGrinFile(file, "strict");
  assert.equal(strictResult.ok, false);

  const permissiveResult = validateGrinFile(file, "permissive");
  assert.equal(permissiveResult.ok, true);
});

test("validateGrinFile passes for minimal valid file", () => {
  const file = createMinimalFile();
  const result = validateGrinFile(file, "permissive");
  assert.equal(result.ok, true);
  assert.equal(result.errors.length, 0);
});

#####/web/tsconfig.json#####
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "alwaysStrict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./lib",
    "removeComments": false,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "skipLibCheck": true
  },
  "include": ["lib/**/*.ts"],
  "exclude": ["node_modules", "dist", "tests"]
}

#####/web/typedoc.json#####
{
  "entryPoints": ["lib/index.ts", "lib/player.ts"],
  "tsconfig": "tsconfig.json",
  "out": "../docs/api/web",
  "readme": "none",
  "includeVersion": true,
  "excludePrivate": true,
  "excludeInternal": true,
  "skipErrorChecking": true
}

#####/web/vitest.config.ts#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    environment: "node",
    include: ["tests/**/*.test.ts"],
  },
});

#####/CHANGELOG.md#####
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [0.1.0] - 2025-01-01
### Added
- Core binary format constants, header, pixel, and rule structures for GRIN files.
- Web TypeScript implementation with reader/writer, playback, validation, and demo assets.
- Android/Kotlin implementation with validation, playback, and demo app.
- CLI tooling for encoding, decoding, inspecting, and validating `.grin` files.
- Reference samples, tests, and documentation covering format details and usage.

#####/LICENSE#####
MIT License

Copyright (c) 2025 GRIN Project Contributors

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

#####/NOTICE#####
GRIN (Graphic Readdressable Indexed Nodes)

This product includes software developed by the GRIN Project Contributors.

Third-party dependencies are redistributed under their respective licenses.
See package manifests (e.g., web/package.json, tools/package.json) for
dependency lists and consult the dependencies' license files for attribution
requirements.

#####/web/embed/grin-embed.js#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
const FALLBACK_LIB_URL =
  "https://cdn.jsdelivr.net/gh/quantumbraid/grin@main/web/dist/grin-player.js";

function toBoolean(value) {
  if (value === undefined || value === null) {
    return false;
  }
  if (value === "" || value === "true" || value === "1") {
    return true;
  }
  return false;
}

function normalizeElements(list) {
  return list.filter((element) => element.tagName.toLowerCase() !== "script");
}

function getScriptElement() {
  if (document.currentScript) {
    return document.currentScript;
  }
  const scripts = document.querySelectorAll("script[type='module']");
  const currentUrl = new URL(import.meta.url, document.baseURI).href;
  for (const script of scripts) {
    if (!script.src) {
      continue;
    }
    const scriptUrl = new URL(script.src, document.baseURI).href;
    if (scriptUrl === currentUrl) {
      return script;
    }
  }
  return null;
}

function getScriptEmbed(script) {
  if (!script) {
    return null;
  }
  const src = script.dataset.grinSrc;
  if (!src) {
    return null;
  }
  const placeholder = document.createElement("div");
  placeholder.dataset.grinSrc = src;
  if (script.dataset.grinAutoplay !== undefined) {
    placeholder.dataset.grinAutoplay = script.dataset.grinAutoplay;
  }
  if (script.dataset.grinPlaybackrate !== undefined) {
    placeholder.dataset.grinPlaybackrate = script.dataset.grinPlaybackrate;
  }
  script.insertAdjacentElement("afterend", placeholder);
  return placeholder;
}

function mountPlayer(target) {
  const src = target.dataset.grinSrc;
  if (!src) {
    return;
  }

  const autoplay = toBoolean(target.dataset.grinAutoplay);
  const playbackrate = target.dataset.grinPlaybackrate;

  let player;
  if (target.tagName.toLowerCase() === "grin-player") {
    player = target;
  } else {
    player = document.createElement("grin-player");
    target.appendChild(player);
  }

  player.setAttribute("src", src);
  if (autoplay) {
    player.setAttribute("autoplay", "");
  }
  if (playbackrate) {
    player.setAttribute("playbackrate", playbackrate);
  }
}

function loadViewer(libUrl) {
  const hasPlayer =
    typeof customElements !== "undefined" && customElements.get("grin-player");
  if (hasPlayer) {
    return Promise.resolve();
  }
  return import(libUrl);
}

function resolveDefaultLibUrl(script) {
  const baseUrl = script?.src || import.meta.url;
  if (baseUrl) {
    try {
      return new URL("../dist/grin-player.js", baseUrl).toString();
    } catch (error) {
      return FALLBACK_LIB_URL;
    }
  }
  return FALLBACK_LIB_URL;
}

function init() {
  const script = getScriptElement();
  const libUrl = script?.dataset.grinLib || resolveDefaultLibUrl(script);

  const elements = normalizeElements(
    Array.from(document.querySelectorAll("[data-grin-src]"))
  );
  const scriptEmbed = getScriptEmbed(script);
  if (scriptEmbed) {
    elements.push(scriptEmbed);
  }
  if (elements.length === 0) {
    return;
  }

  loadViewer(libUrl)
    .then(() => {
      elements.forEach((element) => mountPlayer(element));
    })
    .catch((error) => {
      console.error("GRIN embed failed to load viewer:", error);
    });
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}

#####/android/demo/src/main/kotlin/io/grin/demo/GridCameraActivity.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.Manifest
import android.content.pm.PackageManager
import android.os.Bundle
import android.widget.Toast
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AppCompatActivity
import androidx.camera.core.CameraSelector
import androidx.camera.core.ImageAnalysis
import androidx.camera.lifecycle.ProcessCameraProvider
import androidx.core.content.ContextCompat
import io.grin.demo.databinding.ActivityGridCameraBinding
import java.util.concurrent.ExecutorService
import java.util.concurrent.Executors

// Displays the live, posterized camera preview with a grid overlay.
class GridCameraActivity : AppCompatActivity() {
    private lateinit var binding: ActivityGridCameraBinding
    private lateinit var cameraExecutor: ExecutorService

    private val permissionRequest =
        registerForActivityResult(ActivityResultContracts.RequestPermission()) { granted ->
            if (granted) {
                startCamera()
            } else {
                Toast.makeText(this, getString(R.string.camera_permission_denied), Toast.LENGTH_LONG).show()
                finish()
            }
        }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityGridCameraBinding.inflate(layoutInflater)
        setContentView(binding.root)

        cameraExecutor = Executors.newSingleThreadExecutor()

        binding.closeButton.setOnClickListener {
            // Return to the main demo screen.
            finish()
        }

        if (hasCameraPermission()) {
            startCamera()
        } else {
            permissionRequest.launch(Manifest.permission.CAMERA)
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        // Shut down the camera executor to release resources.
        cameraExecutor.shutdown()
    }

    private fun hasCameraPermission(): Boolean {
        return ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA) ==
            PackageManager.PERMISSION_GRANTED
    }

    private fun startCamera() {
        val cameraProviderFuture = ProcessCameraProvider.getInstance(this)
        cameraProviderFuture.addListener(
            {
                val cameraProvider = cameraProviderFuture.get()
                bindAnalysisUseCase(cameraProvider)
            },
            ContextCompat.getMainExecutor(this)
        )
    }

    private fun bindAnalysisUseCase(cameraProvider: ProcessCameraProvider) {
        cameraProvider.unbindAll()
        val palette = PosterizedPalette.defaultPalette()
        val performanceConfig = PosterizationPerformanceConfig(
            targetFps = 30,
            fallbackFps = 24,
            slowdownThresholdMs = 42,
            fallbackGridScale = 0.75f,
            fallbackPaletteSize = 12
        )
        val analyzer = PosterizedCameraAnalyzer(
            baseGridCols = 48,
            baseGridRows = 64,
            palette = palette,
            performanceConfig = performanceConfig
        ) { frame ->
            runOnUiThread {
                // Update the preview image and overlay metadata on the main thread.
                binding.posterizedPreview.setImageBitmap(frame.bitmap)
                binding.gridOverlay.updateGrid(
                    frame.gridCols,
                    frame.gridRows,
                    frame.paletteIndices,
                    frame.paletteLabels
                )
                binding.performanceText.text = getString(
                    R.string.camera_performance_format,
                    frame.gridCols,
                    frame.gridRows,
                    frame.paletteSize
                )
            }
        }

        val analysis = ImageAnalysis.Builder()
            .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)
            .build()
            .also { it.setAnalyzer(cameraExecutor, analyzer) }

        val cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA
        try {
            cameraProvider.bindToLifecycle(this, cameraSelector, analysis)
        } catch (exception: Exception) {
            Toast.makeText(this, getString(R.string.camera_start_failed), Toast.LENGTH_LONG).show()
        }
    }
}
#####/android/demo/src/main/kotlin/io/grin/demo/GridOverlayView.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.content.Context
import android.graphics.Canvas
import android.graphics.Color
import android.graphics.Paint
import android.util.AttributeSet
import android.view.View

// Draws grid lines and per-cell channel labels over the posterized preview.
class GridOverlayView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : View(context, attrs, defStyleAttr) {
    private val gridPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {
        color = Color.WHITE
        style = Paint.Style.STROKE
        strokeWidth = 1f
    }
    private val textPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {
        color = Color.WHITE
        textSize = 18f
        textAlign = Paint.Align.LEFT
    }

    private var gridCols: Int = 0
    private var gridRows: Int = 0
    private var paletteIndices: IntArray = IntArray(0)
    private var paletteLabels: List<String> = emptyList()

    // Updates the grid metadata and invalidates the overlay for a new frame.
    fun updateGrid(
        cols: Int,
        rows: Int,
        indices: IntArray,
        labels: List<String>
    ) {
        gridCols = cols
        gridRows = rows
        paletteIndices = indices
        paletteLabels = labels
        invalidate()
    }

    override fun onDraw(canvas: Canvas) {
        super.onDraw(canvas)
        if (gridCols <= 0 || gridRows <= 0) {
            return
        }
        val cellWidth = width.toFloat() / gridCols.toFloat()
        val cellHeight = height.toFloat() / gridRows.toFloat()
        drawGridLines(canvas, cellWidth, cellHeight)
        drawLabels(canvas, cellWidth, cellHeight)
    }

    private fun drawGridLines(canvas: Canvas, cellWidth: Float, cellHeight: Float) {
        for (col in 0..gridCols) {
            val x = col * cellWidth
            canvas.drawLine(x, 0f, x, height.toFloat(), gridPaint)
        }
        for (row in 0..gridRows) {
            val y = row * cellHeight
            canvas.drawLine(0f, y, width.toFloat(), y, gridPaint)
        }
    }

    private fun drawLabels(canvas: Canvas, cellWidth: Float, cellHeight: Float) {
        // Skip text if cells are too small to stay readable.
        if (cellWidth < 20f || cellHeight < 20f || paletteLabels.isEmpty()) {
            return
        }
        val maxLabelIndex = paletteLabels.size
        for (row in 0 until gridRows) {
            val y = row * cellHeight + textPaint.textSize
            for (col in 0 until gridCols) {
                val index = row * gridCols + col
                val paletteIndex = if (index < paletteIndices.size) paletteIndices[index] else 0
                val label = paletteLabels[paletteIndex % maxLabelIndex]
                val x = col * cellWidth + 4f
                canvas.drawText(label, x, y, textPaint)
            }
        }
    }
}
#####/android/demo/src/main/kotlin/io/grin/demo/PosterizedCameraAnalyzer.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.graphics.Bitmap
import android.graphics.Color
import androidx.camera.core.ImageAnalysis
import androidx.camera.core.ImageProxy
import kotlin.math.roundToInt
import kotlin.math.sqrt

// Holds a posterized frame and grid metadata for UI rendering.
data class PosterizedFrame(
    val bitmap: Bitmap,
    val gridCols: Int,
    val gridRows: Int,
    val paletteIndices: IntArray,
    val paletteLabels: List<String>,
    val paletteSize: Int
)

// Encapsulates performance targets and fallback behavior for posterization.
data class PosterizationPerformanceConfig(
    val targetFps: Int,
    val fallbackFps: Int,
    val slowdownThresholdMs: Long,
    val fallbackGridScale: Float,
    val fallbackPaletteSize: Int
)

// Analyzer that converts camera frames into posterized, grid-aligned bitmaps.
class PosterizedCameraAnalyzer(
    private val baseGridCols: Int,
    private val baseGridRows: Int,
    private val palette: PosterizedPalette,
    private val performanceConfig: PosterizationPerformanceConfig,
    private val onFrame: (PosterizedFrame) -> Unit
) : ImageAnalysis.Analyzer {
    private var lastFrameTimestampNs: Long = 0L
    private var useFallbackSettings: Boolean = false

    override fun analyze(image: ImageProxy) {
        val timestampNs = image.imageInfo.timestamp
        val activeTargetFps = if (useFallbackSettings) {
            performanceConfig.fallbackFps
        } else {
            performanceConfig.targetFps
        }
        val frameIntervalNs = 1_000_000_000L / activeTargetFps
        if (timestampNs - lastFrameTimestampNs < frameIntervalNs) {
            // Throttle analysis to the target FPS to avoid overloading the CPU.
            image.close()
            return
        }
        lastFrameTimestampNs = timestampNs

        val startTimeMs = System.currentTimeMillis()
        val effectiveGridCols = if (useFallbackSettings) {
            (baseGridCols * performanceConfig.fallbackGridScale).roundToInt().coerceAtLeast(8)
        } else {
            baseGridCols
        }
        val effectiveGridRows = if (useFallbackSettings) {
            (baseGridRows * performanceConfig.fallbackGridScale).roundToInt().coerceAtLeast(8)
        } else {
            baseGridRows
        }
        val effectivePalette = if (useFallbackSettings) {
            palette.clampSize(performanceConfig.fallbackPaletteSize)
        } else {
            palette
        }

        val frame = buildPosterizedFrame(image, effectiveGridCols, effectiveGridRows, effectivePalette)
        val elapsedMs = System.currentTimeMillis() - startTimeMs
        useFallbackSettings = elapsedMs > performanceConfig.slowdownThresholdMs
        onFrame(frame)
        image.close()
    }

    private fun buildPosterizedFrame(
        image: ImageProxy,
        gridCols: Int,
        gridRows: Int,
        palette: PosterizedPalette
    ): PosterizedFrame {
        val crop = computeCenterCrop(image.width, image.height, gridCols, gridRows)
        val bitmap = Bitmap.createBitmap(gridCols, gridRows, Bitmap.Config.ARGB_8888)
        val paletteIndices = IntArray(gridCols * gridRows)

        for (row in 0 until gridRows) {
            val sourceY = crop.top + ((row + 0.5f) * crop.height / gridRows).roundToInt()
            for (col in 0 until gridCols) {
                val sourceX = crop.left + ((col + 0.5f) * crop.width / gridCols).roundToInt()
                val rgb = readRgbFromYuv(image, sourceX, sourceY)
                val paletteIndex = findNearestPaletteIndex(rgb, palette.colors)
                bitmap.setPixel(col, row, palette.colors[paletteIndex])
                paletteIndices[row * gridCols + col] = paletteIndex
            }
        }

        return PosterizedFrame(
            bitmap = bitmap,
            gridCols = gridCols,
            gridRows = gridRows,
            paletteIndices = paletteIndices,
            paletteLabels = palette.labels,
            paletteSize = palette.colors.size
        )
    }

    private fun computeCenterCrop(
        imageWidth: Int,
        imageHeight: Int,
        gridCols: Int,
        gridRows: Int
    ): CropRect {
        val targetAspect = gridCols.toFloat() / gridRows.toFloat()
        val sourceAspect = imageWidth.toFloat() / imageHeight.toFloat()
        return if (sourceAspect > targetAspect) {
            val cropWidth = (imageHeight * targetAspect).roundToInt()
            val offsetX = ((imageWidth - cropWidth) / 2f).roundToInt()
            CropRect(offsetX, 0, cropWidth, imageHeight)
        } else {
            val cropHeight = (imageWidth / targetAspect).roundToInt()
            val offsetY = ((imageHeight - cropHeight) / 2f).roundToInt()
            CropRect(0, offsetY, imageWidth, cropHeight)
        }
    }

    private fun readRgbFromYuv(image: ImageProxy, x: Int, y: Int): Int {
        // Convert a single YUV_420_888 pixel to RGB using the standard formula.
        val yPlane = image.planes[0]
        val uPlane = image.planes[1]
        val vPlane = image.planes[2]
        val clampedX = x.coerceIn(0, image.width - 1)
        val clampedY = y.coerceIn(0, image.height - 1)
        val yIndex = yPlane.rowStride * clampedY + yPlane.pixelStride * clampedX
        val uvX = clampedX / 2
        val uvY = clampedY / 2
        val uIndex = uPlane.rowStride * uvY + uPlane.pixelStride * uvX
        val vIndex = vPlane.rowStride * uvY + vPlane.pixelStride * uvX

        val yValue = yPlane.buffer.get(yIndex).toInt() and 0xFF
        val uValue = (uPlane.buffer.get(uIndex).toInt() and 0xFF) - 128
        val vValue = (vPlane.buffer.get(vIndex).toInt() and 0xFF) - 128

        val r = clampColorChannel(yValue + (1.402f * vValue).roundToInt())
        val g = clampColorChannel(yValue - (0.344f * uValue).roundToInt() - (0.714f * vValue).roundToInt())
        val b = clampColorChannel(yValue + (1.772f * uValue).roundToInt())
        return Color.rgb(r, g, b)
    }

    private fun clampColorChannel(value: Int): Int {
        return value.coerceIn(0, 255)
    }

    private fun findNearestPaletteIndex(rgb: Int, palette: IntArray): Int {
        // Find the palette entry with the smallest Euclidean distance in RGB space.
        val red = Color.red(rgb)
        val green = Color.green(rgb)
        val blue = Color.blue(rgb)
        var bestIndex = 0
        var bestDistance = Double.MAX_VALUE
        for (index in palette.indices) {
            val paletteColor = palette[index]
            val distance = colorDistance(
                red,
                green,
                blue,
                Color.red(paletteColor),
                Color.green(paletteColor),
                Color.blue(paletteColor)
            )
            if (distance < bestDistance) {
                bestDistance = distance
                bestIndex = index
            }
        }
        return bestIndex
    }

    private fun colorDistance(
        red: Int,
        green: Int,
        blue: Int,
        paletteRed: Int,
        paletteGreen: Int,
        paletteBlue: Int
    ): Double {
        val redDelta = (red - paletteRed).toDouble()
        val greenDelta = (green - paletteGreen).toDouble()
        val blueDelta = (blue - paletteBlue).toDouble()
        return sqrt(redDelta * redDelta + greenDelta * greenDelta + blueDelta * blueDelta)
    }

    // Stores crop origin and dimensions for the grid-aligned sampling area.
    private data class CropRect(val left: Int, val top: Int, val width: Int, val height: Int)
}
#####/android/demo/src/main/kotlin/io/grin/demo/PosterizedPalette.kt#####
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.graphics.Color

// Defines posterization palettes and label helpers for the grid camera preview.
data class PosterizedPalette(
    val colors: IntArray,
    val labels: List<String>
) {
    // Limits palette size to the available labels.
    fun clampSize(size: Int): PosterizedPalette {
        val clamped = size.coerceIn(1, colors.size)
        return PosterizedPalette(colors.copyOf(clamped), labels)
    }

    companion object {
        // Returns the default 14-color palette with hex channel labels.
        fun defaultPalette(): PosterizedPalette {
            val paletteColors = intArrayOf(
                Color.rgb(0x00, 0x00, 0x00),
                Color.rgb(0x1E, 0x1E, 0x1E),
                Color.rgb(0x4F, 0x4F, 0x4F),
                Color.rgb(0x7F, 0x7F, 0x7F),
                Color.rgb(0xB2, 0xB2, 0xB2),
                Color.rgb(0xE0, 0xE0, 0xE0),
                Color.rgb(0xFF, 0xFF, 0xFF),
                Color.rgb(0xD9, 0x32, 0x32),
                Color.rgb(0xF2, 0x7C, 0x2A),
                Color.rgb(0xF2, 0xC2, 0x2A),
                Color.rgb(0x6E, 0xD9, 0x32),
                Color.rgb(0x2A, 0xC2, 0xF2),
                Color.rgb(0x2A, 0x7C, 0xF2),
                Color.rgb(0x8C, 0x2A, 0xF2)
            )
            val labels = (0..15).map { index -> index.toString(16).uppercase() }
            return PosterizedPalette(paletteColors, labels)
        }
    }
}
#####/android/demo/src/main/res/layout/activity_grid_camera.xml#####
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/gridCameraRoot"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <TextView
        android:id="@+id/previewTitle"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="@string/grid_camera_title"
        android:textStyle="bold" />

    <FrameLayout
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_marginTop="8dp"
        android:layout_weight="1">

        <ImageView
            android:id="@+id/posterizedPreview"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="@android:color/black"
            android:scaleType="fitCenter" />

        <io.grin.demo.GridOverlayView
            android:id="@+id/gridOverlay"
            android:layout_width="match_parent"
            android:layout_height="match_parent" />
    </FrameLayout>

    <TextView
        android:id="@+id/performanceText"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="@string/camera_performance_default" />

    <Button
        android:id="@+id/closeButton"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="@string/close" />
</LinearLayout>

SOURCE DUMP
(Only project source files; dependency code omitted.)

---
FILE: android/demo/src/main/kotlin/io/grin/demo/PosterizedCameraAnalyzer.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.graphics.Bitmap
import android.graphics.Color
import androidx.camera.core.ImageAnalysis
import androidx.camera.core.ImageProxy
import kotlin.math.roundToInt
import kotlin.math.sqrt

// Holds a posterized frame and grid metadata for UI rendering.
data class PosterizedFrame(
    val bitmap: Bitmap,
    val gridCols: Int,
    val gridRows: Int,
    val paletteIndices: IntArray,
    val paletteLabels: List<String>,
    val paletteSize: Int,
    val paletteHistogram: IntArray,
    val paletteColors: IntArray
)

// Encapsulates performance targets and fallback behavior for posterization.
data class PosterizationPerformanceConfig(
    val targetFps: Int,
    val fallbackFps: Int,
    val slowdownThresholdMs: Long,
    val fallbackGridScale: Float,
    val fallbackPaletteSize: Int
)

// Analyzer that converts camera frames into posterized, grid-aligned bitmaps.
class PosterizedCameraAnalyzer(
    private val baseGridCols: Int,
    private val baseGridRows: Int,
    private val palette: PosterizedPalette,
    private val performanceConfig: PosterizationPerformanceConfig,
    private val onFrame: (PosterizedFrame) -> Unit
) : ImageAnalysis.Analyzer {
    private var lastFrameTimestampNs: Long = 0L
    private var useFallbackSettings: Boolean = false

    override fun analyze(image: ImageProxy) {
        val timestampNs = image.imageInfo.timestamp
        val activeTargetFps = if (useFallbackSettings) {
            performanceConfig.fallbackFps
        } else {
            performanceConfig.targetFps
        }
        val frameIntervalNs = 1_000_000_000L / activeTargetFps
        if (timestampNs - lastFrameTimestampNs < frameIntervalNs) {
            // Throttle analysis to the target FPS to avoid overloading the CPU.
            image.close()
            return
        }
        lastFrameTimestampNs = timestampNs

        val startTimeMs = System.currentTimeMillis()
        val effectiveGridCols = if (useFallbackSettings) {
            (baseGridCols * performanceConfig.fallbackGridScale).roundToInt().coerceAtLeast(8)
        } else {
            baseGridCols
        }
        val effectiveGridRows = if (useFallbackSettings) {
            (baseGridRows * performanceConfig.fallbackGridScale).roundToInt().coerceAtLeast(8)
        } else {
            baseGridRows
        }
        val effectivePalette = if (useFallbackSettings) {
            palette.clampSize(performanceConfig.fallbackPaletteSize)
        } else {
            palette
        }

        val frame = buildPosterizedFrame(image, effectiveGridCols, effectiveGridRows, effectivePalette)
        val elapsedMs = System.currentTimeMillis() - startTimeMs
        useFallbackSettings = elapsedMs > performanceConfig.slowdownThresholdMs
        onFrame(frame)
        image.close()
    }

    private fun buildPosterizedFrame(
        image: ImageProxy,
        gridCols: Int,
        gridRows: Int,
        palette: PosterizedPalette
    ): PosterizedFrame {
        val crop = computeCenterCrop(image.width, image.height, gridCols, gridRows)
        val bitmap = Bitmap.createBitmap(gridCols, gridRows, Bitmap.Config.ARGB_8888)
        val paletteIndices = IntArray(gridCols * gridRows)
        // Track per-bin counts for channel assignment and gallery metadata.
        val histogram = IntArray(palette.colors.size)

        for (row in 0 until gridRows) {
            val sourceY = crop.top + ((row + 0.5f) * crop.height / gridRows).roundToInt()
            for (col in 0 until gridCols) {
                val sourceX = crop.left + ((col + 0.5f) * crop.width / gridCols).roundToInt()
                val rgb = readRgbFromYuv(image, sourceX, sourceY)
                val paletteIndex = findNearestPaletteIndex(rgb, palette.colors)
                bitmap.setPixel(col, row, palette.colors[paletteIndex])
                paletteIndices[row * gridCols + col] = paletteIndex
                histogram[paletteIndex] += 1
            }
        }

        return PosterizedFrame(
            bitmap = bitmap,
            gridCols = gridCols,
            gridRows = gridRows,
            paletteIndices = paletteIndices,
            paletteLabels = palette.labels,
            paletteSize = palette.colors.size,
            paletteHistogram = histogram,
            paletteColors = palette.colors.copyOf()
        )
    }

    private fun computeCenterCrop(
        imageWidth: Int,
        imageHeight: Int,
        gridCols: Int,
        gridRows: Int
    ): CropRect {
        val targetAspect = gridCols.toFloat() / gridRows.toFloat()
        val sourceAspect = imageWidth.toFloat() / imageHeight.toFloat()
        return if (sourceAspect > targetAspect) {
            val cropWidth = (imageHeight * targetAspect).roundToInt()
            val offsetX = ((imageWidth - cropWidth) / 2f).roundToInt()
            CropRect(offsetX, 0, cropWidth, imageHeight)
        } else {
            val cropHeight = (imageWidth / targetAspect).roundToInt()
            val offsetY = ((imageHeight - cropHeight) / 2f).roundToInt()
            CropRect(0, offsetY, imageWidth, cropHeight)
        }
    }

    private fun readRgbFromYuv(image: ImageProxy, x: Int, y: Int): Int {
        // Convert a single YUV_420_888 pixel to RGB using the standard formula.
        val yPlane = image.planes[0]
        val uPlane = image.planes[1]
        val vPlane = image.planes[2]
        val clampedX = x.coerceIn(0, image.width - 1)
        val clampedY = y.coerceIn(0, image.height - 1)
        val yIndex = yPlane.rowStride * clampedY + yPlane.pixelStride * clampedX
        val uvX = clampedX / 2
        val uvY = clampedY / 2
        val uIndex = uPlane.rowStride * uvY + uPlane.pixelStride * uvX
        val vIndex = vPlane.rowStride * uvY + vPlane.pixelStride * uvX

        val yValue = yPlane.buffer.get(yIndex).toInt() and 0xFF
        val uValue = (uPlane.buffer.get(uIndex).toInt() and 0xFF) - 128
        val vValue = (vPlane.buffer.get(vIndex).toInt() and 0xFF) - 128

        val r = clampColorChannel(yValue + (1.402f * vValue).roundToInt())
        val g = clampColorChannel(yValue - (0.344f * uValue).roundToInt() - (0.714f * vValue).roundToInt())
        val b = clampColorChannel(yValue + (1.772f * uValue).roundToInt())
        return Color.rgb(r, g, b)
    }

    private fun clampColorChannel(value: Int): Int {
        return value.coerceIn(0, 255)
    }

    private fun findNearestPaletteIndex(rgb: Int, palette: IntArray): Int {
        // Find the palette entry with the smallest Euclidean distance in RGB space.
        val red = Color.red(rgb)
        val green = Color.green(rgb)
        val blue = Color.blue(rgb)
        var bestIndex = 0
        var bestDistance = Double.MAX_VALUE
        for (index in palette.indices) {
            val paletteColor = palette[index]
            val distance = colorDistance(
                red,
                green,
                blue,
                Color.red(paletteColor),
                Color.green(paletteColor),
                Color.blue(paletteColor)
            )
            if (distance < bestDistance) {
                bestDistance = distance
                bestIndex = index
            }
        }
        return bestIndex
    }

    private fun colorDistance(
        red: Int,
        green: Int,
        blue: Int,
        paletteRed: Int,
        paletteGreen: Int,
        paletteBlue: Int
    ): Double {
        val redDelta = (red - paletteRed).toDouble()
        val greenDelta = (green - paletteGreen).toDouble()
        val blueDelta = (blue - paletteBlue).toDouble()
        return sqrt(redDelta * redDelta + greenDelta * greenDelta + blueDelta * blueDelta)
    }

    // Stores crop origin and dimensions for the grid-aligned sampling area.
    private data class CropRect(val left: Int, val top: Int, val width: Int, val height: Int)
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/GridCameraActivity.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.Manifest
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Bundle
import android.widget.Toast
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AppCompatActivity
import androidx.camera.core.CameraSelector
import androidx.camera.core.ImageAnalysis
import androidx.camera.lifecycle.ProcessCameraProvider
import androidx.core.content.ContextCompat
import io.grin.demo.databinding.ActivityGridCameraBinding
import java.util.concurrent.ExecutorService
import java.util.concurrent.Executors

// Displays the live, posterized camera preview with a grid overlay.
class GridCameraActivity : AppCompatActivity() {
    private lateinit var binding: ActivityGridCameraBinding
    private lateinit var cameraExecutor: ExecutorService
    private var latestFrame: PosterizedFrame? = null

    private val permissionRequest =
        registerForActivityResult(ActivityResultContracts.RequestPermission()) { granted ->
            if (granted) {
                startCamera()
            } else {
                Toast.makeText(this, getString(R.string.camera_permission_denied), Toast.LENGTH_LONG).show()
                finish()
            }
        }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityGridCameraBinding.inflate(layoutInflater)
        setContentView(binding.root)

        cameraExecutor = Executors.newSingleThreadExecutor()

        binding.closeButton.setOnClickListener {
            // Return to the main demo screen.
            finish()
        }
        binding.captureButton.setOnClickListener {
            // Freeze the most recent posterized frame for review.
            val frame = latestFrame
            if (frame != null) {
                CaptureBuffer.frame = frame
                startActivity(Intent(this, CaptureReviewActivity::class.java))
            } else {
                Toast.makeText(this, getString(R.string.capture_no_frame), Toast.LENGTH_SHORT).show()
            }
        }

        if (hasCameraPermission()) {
            startCamera()
        } else {
            permissionRequest.launch(Manifest.permission.CAMERA)
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        // Shut down the camera executor to release resources.
        cameraExecutor.shutdown()
    }

    private fun hasCameraPermission(): Boolean {
        return ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA) ==
            PackageManager.PERMISSION_GRANTED
    }

    private fun startCamera() {
        val cameraProviderFuture = ProcessCameraProvider.getInstance(this)
        cameraProviderFuture.addListener(
            {
                val cameraProvider = cameraProviderFuture.get()
                bindAnalysisUseCase(cameraProvider)
            },
            ContextCompat.getMainExecutor(this)
        )
    }

    private fun bindAnalysisUseCase(cameraProvider: ProcessCameraProvider) {
        cameraProvider.unbindAll()
        val palette = PosterizedPalette.defaultPalette()
        val performanceConfig = PosterizationPerformanceConfig(
            targetFps = 30,
            fallbackFps = 24,
            slowdownThresholdMs = 42,
            fallbackGridScale = 0.75f,
            fallbackPaletteSize = 12
        )
        val analyzer = PosterizedCameraAnalyzer(
            baseGridCols = 48,
            baseGridRows = 64,
            palette = palette,
            performanceConfig = performanceConfig
        ) { frame ->
            runOnUiThread {
                // Update the preview image and overlay metadata on the main thread.
                binding.posterizedPreview.setImageBitmap(frame.bitmap)
                binding.gridOverlay.updateGrid(
                    frame.gridCols,
                    frame.gridRows,
                    frame.paletteIndices,
                    frame.paletteLabels
                )
                binding.performanceText.text = getString(
                    R.string.camera_performance_format,
                    frame.gridCols,
                    frame.gridRows,
                    frame.paletteSize
                )
                // Cache the latest frame for capture review.
                latestFrame = frame
            }
        }

        val analysis = ImageAnalysis.Builder()
            .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)
            .build()
            .also { it.setAnalyzer(cameraExecutor, analyzer) }

        val cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA
        try {
            cameraProvider.bindToLifecycle(this, cameraSelector, analysis)
        } catch (exception: Exception) {
            Toast.makeText(this, getString(R.string.camera_start_failed), Toast.LENGTH_LONG).show()
        }
    }
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/MainActivity.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.SeekBar
import android.widget.Toast
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AppCompatActivity
import io.grin.demo.databinding.ActivityMainBinding
import io.grin.lib.GrinFile
import io.grin.lib.GrinUriLoader

class MainActivity : AppCompatActivity() {
    private lateinit var binding: ActivityMainBinding

    private val filePicker =
        registerForActivityResult(ActivityResultContracts.OpenDocument()) { uri ->
            if (uri != null) {
                contentResolver.takePersistableUriPermission(
                    uri,
                    Intent.FLAG_GRANT_READ_URI_PERMISSION
                )
                loadUri(uri)
            }
        }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        binding.loadButton.setOnClickListener {
            filePicker.launch(arrayOf("application/octet-stream"))
        }
        binding.cameraButton.setOnClickListener {
            // Launch the grid camera preview workflow.
            startActivity(Intent(this, GridCameraActivity::class.java))
        }
        binding.galleryButton.setOnClickListener {
            // Open the capture gallery grid.
            startActivity(Intent(this, GalleryActivity::class.java))
        }
        binding.playButton.setOnClickListener { binding.grinView.play() }
        binding.pauseButton.setOnClickListener { binding.grinView.pause() }
        binding.stopButton.setOnClickListener { binding.grinView.stop() }

        binding.seekBar.setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
            override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                if (fromUser) {
                    binding.grinView.seek(progress.toLong())
                }
            }

            override fun onStartTrackingTouch(seekBar: SeekBar?) {}
            override fun onStopTrackingTouch(seekBar: SeekBar?) {}
        })

        setupSampleList()

        intent?.data?.let { loadUri(it) }
    }

    override fun onNewIntent(intent: Intent?) {
        super.onNewIntent(intent)
        intent?.data?.let { loadUri(it) }
    }

    private fun setupSampleList() {
        val samples = assets.list("samples")?.sorted() ?: emptyList()
        if (samples.isEmpty()) {
            binding.samplesTitle.text = getString(R.string.no_samples)
            return
        }
        val adapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, samples)
        binding.samplesList.adapter = adapter
        binding.samplesList.setOnItemClickListener { _, _, position, _ ->
            val assetName = samples[position]
            val file = GrinUriLoader.fromAsset(this, "samples/$assetName")
            loadFile(file)
        }
    }

    private fun loadUri(uri: Uri) {
        try {
            val file = GrinUriLoader.load(this, uri)
            loadFile(file)
        } catch (exception: Exception) {
            Toast.makeText(this, getString(R.string.error_loading), Toast.LENGTH_LONG).show()
        }
    }

    private fun loadFile(file: GrinFile) {
        binding.grinView.load(file)
        binding.metadataText.text = buildMetadata(file)
    }

    private fun buildMetadata(file: GrinFile): String {
        val header = file.header
        val dimensions = getString(R.string.dimensions_format, header.width.toInt(), header.height.toInt())
        val rules = getString(R.string.rule_count_format, header.ruleCount)
        val tickRate = getString(R.string.tick_rate_format, header.tickMicros.toInt())
        return listOf(dimensions, rules, tickRate).joinToString(separator = "\n")
    }
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/CaptureBuffer.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

// Holds the most recent posterized frame for the capture review workflow.
object CaptureBuffer {
    var frame: PosterizedFrame? = null
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/CaptureReviewActivity.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.content.Intent
import android.os.Bundle
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import io.grin.demo.databinding.ActivityCaptureReviewBinding

// Displays the frozen posterized frame and actions to accept or retake.
class CaptureReviewActivity : AppCompatActivity() {
    private lateinit var binding: ActivityCaptureReviewBinding

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityCaptureReviewBinding.inflate(layoutInflater)
        setContentView(binding.root)

        val frame = CaptureBuffer.frame
        if (frame == null) {
            Toast.makeText(this, getString(R.string.capture_no_frame), Toast.LENGTH_SHORT).show()
            finish()
            return
        }

        binding.previewImage.setImageBitmap(frame.bitmap)
        binding.gridOverlay.updateGrid(
            frame.gridCols,
            frame.gridRows,
            frame.paletteIndices,
            frame.paletteLabels
        )
        binding.captureMetadata.text = getString(
            R.string.capture_metadata_format,
            frame.gridCols,
            frame.gridRows,
            frame.paletteSize
        )

        binding.retakeButton.setOnClickListener {
            // Return to the camera preview without saving.
            finish()
        }
        binding.acceptButton.setOnClickListener {
            // Persist the capture and open the gallery.
            val asset = GrinAssetStore(this).createAssetFromFrame(frame, DEFAULT_TICK_MICROS)
            CaptureBuffer.frame = null
            startActivity(Intent(this, GalleryActivity::class.java).putExtra(EXTRA_ASSET_ID, asset.id))
            finish()
        }
        binding.editButton.setOnClickListener {
            // Persist the capture and jump directly into the editor.
            val asset = GrinAssetStore(this).createAssetFromFrame(frame, DEFAULT_TICK_MICROS)
            CaptureBuffer.frame = null
            startActivity(Intent(this, EditorActivity::class.java).putExtra(EXTRA_ASSET_ID, asset.id))
            finish()
        }
    }

    companion object {
        // Use the preview cadence for initial tick micros.
        private const val DEFAULT_TICK_MICROS = 33_333L
    }
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/ChannelLabels.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

// Helper for converting channel indices to hexadecimal labels and back.
object ChannelLabels {
    val labels: List<String> = (0..15).map { index -> index.toString(16).uppercase() }

    fun labelFor(channelId: Int): String {
        // Clamp to 0-15 so UI labels remain valid.
        return labels[channelId.coerceIn(0, 15)]
    }

    fun indexOf(label: String): Int {
        // Normalize input to uppercase hex for consistent lookups.
        val normalized = label.trim().uppercase()
        return labels.indexOf(normalized).coerceAtLeast(0)
    }
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/GalleryActivity.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.content.Intent
import android.os.Bundle
import androidx.appcompat.app.AppCompatActivity
import androidx.recyclerview.widget.GridLayoutManager
import androidx.recyclerview.widget.RecyclerView
import io.grin.demo.databinding.ActivityGalleryBinding

// Displays a grid of captured GRIN assets with lazy paging.
class GalleryActivity : AppCompatActivity() {
    private lateinit var binding: ActivityGalleryBinding
    private lateinit var adapter: GalleryAdapter
    private lateinit var store: GrinAssetStore

    private val allAssets: MutableList<GrinAssetMetadata> = mutableListOf()
    private val loadedAssets: MutableList<GrinAssetMetadata> = mutableListOf()
    private var pageIndex = 0

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityGalleryBinding.inflate(layoutInflater)
        setContentView(binding.root)

        store = GrinAssetStore(this)
        adapter = GalleryAdapter(store) { asset ->
            startActivity(Intent(this, EditorActivity::class.java).putExtra(EXTRA_ASSET_ID, asset.id))
        }

        binding.galleryRecycler.layoutManager = GridLayoutManager(this, 2)
        binding.galleryRecycler.adapter = adapter
        binding.galleryRecycler.addOnScrollListener(object : RecyclerView.OnScrollListener() {
            override fun onScrolled(recyclerView: RecyclerView, dx: Int, dy: Int) {
                super.onScrolled(recyclerView, dx, dy)
                if (dy > 0) {
                    val layoutManager = recyclerView.layoutManager as? GridLayoutManager ?: return
                    val lastVisible = layoutManager.findLastVisibleItemPosition()
                    if (lastVisible >= loadedAssets.size - 4) {
                        loadNextPage()
                    }
                }
            }
        })

        binding.captureNewButton.setOnClickListener {
            startActivity(Intent(this, GridCameraActivity::class.java))
        }
        binding.backButton.setOnClickListener {
            finish()
        }

        refreshAssets()
    }

    override fun onResume() {
        super.onResume()
        // Refresh the gallery list to reflect any edits or exports.
        refreshAssets()
    }

    private fun refreshAssets() {
        // Reload metadata from disk and reset paging.
        allAssets.clear()
        allAssets.addAll(store.loadAllMetadata())
        loadedAssets.clear()
        pageIndex = 0
        adapter.setItems(emptyList())
        binding.emptyState.visibility = if (allAssets.isEmpty()) android.view.View.VISIBLE else android.view.View.GONE
        loadNextPage()
    }

    private fun loadNextPage() {
        // Append the next page of gallery assets.
        val start = pageIndex * PAGE_SIZE
        if (start >= allAssets.size) {
            return
        }
        val end = (start + PAGE_SIZE).coerceAtMost(allAssets.size)
        val nextPage = allAssets.subList(start, end)
        if (pageIndex == 0) {
            adapter.setItems(nextPage)
        } else {
            adapter.appendItems(nextPage)
        }
        loadedAssets.addAll(nextPage)
        pageIndex += 1
    }

    companion object {
        // Keep page size small to simulate lazy loading and caching.
        private const val PAGE_SIZE = 20
    }
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/GalleryAdapter.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.graphics.Bitmap
import android.util.LruCache
import android.view.LayoutInflater
import android.view.ViewGroup
import androidx.recyclerview.widget.RecyclerView
import io.grin.demo.databinding.ItemGalleryAssetBinding

// Adapter that renders posterized thumbnails in a grid for the gallery screen.
class GalleryAdapter(
    private val store: GrinAssetStore,
    private val onItemSelected: (GrinAssetMetadata) -> Unit
) : RecyclerView.Adapter<GalleryAdapter.GalleryViewHolder>() {

    private val assets: MutableList<GrinAssetMetadata> = mutableListOf()
    private val thumbnailCache = object : LruCache<String, Bitmap>(32) {}

    fun setItems(items: List<GrinAssetMetadata>) {
        // Replace the adapter contents with a new list of assets.
        assets.clear()
        assets.addAll(items)
        notifyDataSetChanged()
    }

    fun appendItems(items: List<GrinAssetMetadata>) {
        // Append assets when paging additional results.
        val start = assets.size
        assets.addAll(items)
        notifyItemRangeInserted(start, items.size)
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): GalleryViewHolder {
        val binding = ItemGalleryAssetBinding.inflate(LayoutInflater.from(parent.context), parent, false)
        return GalleryViewHolder(binding)
    }

    override fun onBindViewHolder(holder: GalleryViewHolder, position: Int) {
        val asset = assets[position]
        holder.bind(asset)
    }

    override fun getItemCount(): Int = assets.size

    inner class GalleryViewHolder(private val binding: ItemGalleryAssetBinding) : RecyclerView.ViewHolder(binding.root) {
        fun bind(asset: GrinAssetMetadata) {
            // Load cached thumbnail, falling back to disk.
            val cached = thumbnailCache.get(asset.id)
            val thumbnail = cached ?: store.loadThumbnailBitmap(asset)
            if (thumbnail != null && cached == null) {
                thumbnailCache.put(asset.id, thumbnail)
            }
            binding.thumbnail.setImageBitmap(thumbnail)
            binding.assetMetadata.text = itemView.context.getString(
                R.string.gallery_asset_metadata,
                asset.width,
                asset.height,
                asset.paletteBins
            )
            binding.root.setOnClickListener {
                onItemSelected(asset)
            }
        }
    }
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/GrinAssetModels.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import org.json.JSONArray
import org.json.JSONObject

// Represents editable channel metadata for a single GRIN channel.
data class ChannelSetting(
    val channelId: Int,
    var frequency: Int,
    var intonation: Int,
    var transparency: Int
)

// Captures persisted metadata for a GRIN/GRIM asset pair.
data class GrinAssetMetadata(
    val id: String,
    val createdAt: Long,
    var lastEditedAt: Long,
    val width: Int,
    val height: Int,
    val gridCols: Int,
    val gridRows: Int,
    val paletteBins: Int,
    var tickMicros: Long,
    var ruleCount: Int,
    val channelMap: List<Int>,
    val channelOrder: List<Int>,
    val paletteHistogram: List<Int>,
    val previewPath: String,
    val thumbnailPath: String,
    val grinPath: String,
    val grimPath: String,
    var channelSettings: List<ChannelSetting>
) {
    fun toJson(): JSONObject {
        // Serialize metadata to JSON for disk persistence and gallery indexing.
        val json = JSONObject()
        json.put("id", id)
        json.put("createdAt", createdAt)
        json.put("lastEditedAt", lastEditedAt)
        json.put("width", width)
        json.put("height", height)
        json.put("gridCols", gridCols)
        json.put("gridRows", gridRows)
        json.put("paletteBins", paletteBins)
        json.put("tickMicros", tickMicros)
        json.put("ruleCount", ruleCount)
        json.put("previewPath", previewPath)
        json.put("thumbnailPath", thumbnailPath)
        json.put("grinPath", grinPath)
        json.put("grimPath", grimPath)
        json.put("channelMap", JSONArray(channelMap))
        json.put("channelOrder", JSONArray(channelOrder))
        json.put("paletteHistogram", JSONArray(paletteHistogram))

        val settingsArray = JSONArray()
        channelSettings.forEach { setting ->
            val settingJson = JSONObject()
            settingJson.put("channelId", setting.channelId)
            settingJson.put("frequency", setting.frequency)
            settingJson.put("intonation", setting.intonation)
            settingJson.put("transparency", setting.transparency)
            settingsArray.put(settingJson)
        }
        json.put("channelSettings", settingsArray)
        return json
    }

    companion object {
        fun fromJson(json: JSONObject): GrinAssetMetadata {
            // Deserialize metadata from JSON stored on disk.
            val channelMap = json.getJSONArray("channelMap").toIntList()
            val channelOrder = json.getJSONArray("channelOrder").toIntList()
            val histogram = json.getJSONArray("paletteHistogram").toIntList()
            val settings = json.getJSONArray("channelSettings").toChannelSettings()
            return GrinAssetMetadata(
                id = json.getString("id"),
                createdAt = json.getLong("createdAt"),
                lastEditedAt = json.getLong("lastEditedAt"),
                width = json.getInt("width"),
                height = json.getInt("height"),
                gridCols = json.getInt("gridCols"),
                gridRows = json.getInt("gridRows"),
                paletteBins = json.getInt("paletteBins"),
                tickMicros = json.getLong("tickMicros"),
                ruleCount = json.getInt("ruleCount"),
                channelMap = channelMap,
                channelOrder = channelOrder,
                paletteHistogram = histogram,
                previewPath = json.getString("previewPath"),
                thumbnailPath = json.getString("thumbnailPath"),
                grinPath = json.getString("grinPath"),
                grimPath = json.getString("grimPath"),
                channelSettings = settings
            )
        }
    }
}

private fun JSONArray.toIntList(): List<Int> {
    // Parse a JSON array into a list of integers.
    val list = mutableListOf<Int>()
    for (index in 0 until length()) {
        list.add(getInt(index))
    }
    return list
}

private fun JSONArray.toChannelSettings(): List<ChannelSetting> {
    // Parse channel settings from a JSON array.
    val list = mutableListOf<ChannelSetting>()
    for (index in 0 until length()) {
        val item = getJSONObject(index)
        list.add(
            ChannelSetting(
                channelId = item.getInt("channelId"),
                frequency = item.getInt("frequency"),
                intonation = item.getInt("intonation"),
                transparency = item.getInt("transparency")
            )
        )
    }
    return list
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/GrinAssetStore.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.content.Context
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.graphics.Color
import android.util.Log
import io.grin.lib.BaseOpcodes
import io.grin.lib.GrinFile
import io.grin.lib.GrinFormat
import io.grin.lib.GrinHeader
import io.grin.lib.GrinPixel
import io.grin.lib.GrinRule
import java.io.File
import java.util.UUID
import kotlin.math.roundToInt

// Handles disk persistence for GRIM/GRIN assets, previews, and metadata JSON.
class GrinAssetStore(private val context: Context) {
    private val baseDir = File(context.filesDir, "grin_gallery")
    private val metadataDir = File(baseDir, "metadata")
    private val previewDir = File(baseDir, "preview")
    private val thumbnailDir = File(baseDir, "thumbnails")
    private val grinDir = File(baseDir, "grin")
    private val grimDir = File(baseDir, "grim")
    private val exportDir = File(baseDir, "exports")

    init {
        // Ensure storage directories exist before any writes.
        listOf(metadataDir, previewDir, thumbnailDir, grinDir, grimDir, exportDir).forEach { dir ->
            if (!dir.exists()) {
                dir.mkdirs()
            }
        }
    }

    fun createAssetFromFrame(frame: PosterizedFrame, tickMicros: Long): GrinAssetMetadata {
        // Build channel mapping and histogram from the captured frame.
        val assignment = assignBinsToChannels(frame.paletteHistogram, frame.paletteColors)
        val channelMap = assignment.channelMap
        val channelOrder = assignment.channelOrder
        val channelSettings = buildDefaultChannelSettings(channelOrder)
        val pixels = buildGrinPixels(frame, channelMap)
        val rules = buildRules(channelSettings, assignment.activeChannels)

        val header = buildHeader(
            width = frame.gridCols,
            height = frame.gridRows,
            tickMicros = tickMicros,
            ruleCount = rules.size
        )
        val grinFile = GrinFile(header, pixels, rules)

        val id = UUID.randomUUID().toString()
        val previewPath = File(previewDir, "$id.png").absolutePath
        val thumbnailPath = File(thumbnailDir, "$id.png").absolutePath
        val grinPath = File(grinDir, "$id.grin").absolutePath
        val grimPath = File(grimDir, "$id.grim").absolutePath

        // Save preview and thumbnail to disk for the gallery grid.
        writeBitmap(frame.bitmap, previewPath)
        writeBitmap(Bitmap.createScaledBitmap(frame.bitmap, 192, 256, true), thumbnailPath)

        // Persist both GRIN and GRIM payloads.
        grinFile.save(grinPath)
        grinFile.save(grimPath)

        val timestamp = System.currentTimeMillis()
        val metadata = GrinAssetMetadata(
            id = id,
            createdAt = timestamp,
            lastEditedAt = timestamp,
            width = frame.gridCols,
            height = frame.gridRows,
            gridCols = frame.gridCols,
            gridRows = frame.gridRows,
            paletteBins = frame.paletteSize,
            tickMicros = tickMicros,
            ruleCount = rules.size,
            channelMap = channelMap,
            channelOrder = channelOrder,
            paletteHistogram = frame.paletteHistogram.toList(),
            previewPath = previewPath,
            thumbnailPath = thumbnailPath,
            grinPath = grinPath,
            grimPath = grimPath,
            channelSettings = channelSettings
        )

        // Log capture metadata for gallery indexing and debugging.
        Log.i(
            "GrinCapture",
            "Captured ${metadata.width}x${metadata.height} bins=${metadata.paletteBins} at=${metadata.createdAt}"
        )

        saveMetadata(metadata)
        return metadata
    }

    fun saveMetadata(metadata: GrinAssetMetadata) {
        // Write the metadata JSON to disk for persistence across sessions.
        val file = File(metadataDir, "${metadata.id}.json")
        file.writeText(metadata.toJson().toString())
    }

    fun loadAllMetadata(): List<GrinAssetMetadata> {
        // Load metadata entries sorted by most recent capture first.
        if (!metadataDir.exists()) {
            return emptyList()
        }
        return metadataDir.listFiles { file -> file.extension == "json" }
            ?.mapNotNull { file ->
                runCatching {
                    GrinAssetMetadata.fromJson(org.json.JSONObject(file.readText()))
                }.getOrNull()
            }
            ?.sortedByDescending { it.createdAt }
            ?: emptyList()
    }

    fun loadMetadata(id: String): GrinAssetMetadata? {
        // Read a single metadata record by ID.
        val file = File(metadataDir, "$id.json")
        if (!file.exists()) {
            return null
        }
        return GrinAssetMetadata.fromJson(org.json.JSONObject(file.readText()))
    }

    fun loadPreviewBitmap(metadata: GrinAssetMetadata): Bitmap? {
        // Load a preview bitmap from disk for gallery or editor use.
        val file = File(metadata.previewPath)
        return if (file.exists()) BitmapFactory.decodeFile(file.absolutePath) else null
    }

    fun loadThumbnailBitmap(metadata: GrinAssetMetadata): Bitmap? {
        // Load cached thumbnails for the gallery grid.
        val file = File(metadata.thumbnailPath)
        return if (file.exists()) BitmapFactory.decodeFile(file.absolutePath) else null
    }

    fun loadGrinFile(metadata: GrinAssetMetadata): GrinFile? {
        // Load the GRIN payload for editor previews and exports.
        val file = File(metadata.grinPath)
        return if (file.exists()) GrinFile.load(file.absolutePath) else null
    }

    fun exportPng(bitmap: Bitmap, fileName: String): File {
        // Write a PNG snapshot to the export directory.
        val output = File(exportDir, fileName)
        writeBitmap(bitmap, output.absolutePath)
        return output
    }

    fun exportGif(fileName: String, frames: List<Bitmap>, delayMs: Int): File {
        // Encode a looping GIF from preview frames.
        val output = File(exportDir, fileName)
        GifEncoder().encode(frames, delayMs, output)
        return output
    }

    fun exportGrinAndGrim(metadata: GrinAssetMetadata, grinFile: GrinFile, baseName: String): Pair<File, File> {
        // Persist updated GRIN and GRIM files to the export directory.
        val grinOutput = File(exportDir, \"$baseName.grin\")
        val grimOutput = File(exportDir, \"$baseName.grim\")
        grinFile.save(grinOutput.absolutePath)
        grinFile.save(grimOutput.absolutePath)
        metadata.tickMicros = grinFile.header.tickMicros
        metadata.ruleCount = grinFile.header.ruleCount
        metadata.lastEditedAt = System.currentTimeMillis()
        saveMetadata(metadata)
        return Pair(grinOutput, grimOutput)
    }

    fun updateAssetMetadata(metadata: GrinAssetMetadata, settings: List<ChannelSetting>, preview: Bitmap?) {
        // Persist channel overrides and updated previews back to disk.
        metadata.channelSettings = settings
        metadata.lastEditedAt = System.currentTimeMillis()
        if (preview != null) {
            writeBitmap(preview, metadata.previewPath)
            writeBitmap(Bitmap.createScaledBitmap(preview, 192, 256, true), metadata.thumbnailPath)
        }
        saveMetadata(metadata)
    }

    fun buildUpdatedGrinFile(metadata: GrinAssetMetadata, baseFile: GrinFile, settings: List<ChannelSetting>): GrinFile {
        // Apply channel overrides to the rule block while keeping pixel data intact.
        val activeChannels = metadata.channelOrder.distinct()
        val rules = buildRules(settings, activeChannels)
        val header = buildHeader(
            width = metadata.width,
            height = metadata.height,
            tickMicros = metadata.tickMicros,
            ruleCount = rules.size
        )
        return GrinFile(header, baseFile.pixels, rules)
    }

    private fun writeBitmap(bitmap: Bitmap, path: String) {
        // Write an ARGB_8888 bitmap as a PNG file.
        File(path).outputStream().use { output ->
            bitmap.compress(Bitmap.CompressFormat.PNG, 100, output)
        }
    }

    private fun assignBinsToChannels(histogram: IntArray, paletteColors: IntArray): ChannelAssignment {
        // Assign palette bins to channel IDs using a stable frequency-first sort.
        val bins = histogram.indices.map { index ->
            PaletteBin(
                index = index,
                count = histogram[index],
                luminance = computeLuminance(paletteColors[index])
            )
        }
        val sortedBins = bins.sortedWith(
            compareByDescending<PaletteBin> { it.count }
                .thenBy { it.luminance }
                .thenBy { it.index }
        )

        val channelMap = IntArray(histogram.size)
        val channelOrder = mutableListOf<Int>()
        sortedBins.forEachIndexed { position, bin ->
            val channelId = position.coerceIn(0, 15)
            channelMap[bin.index] = channelId
            channelOrder.add(channelId)
        }
        val activeChannels = channelOrder.distinct()
        return ChannelAssignment(channelMap.toList(), channelOrder, activeChannels)
    }

    private fun buildDefaultChannelSettings(channelOrder: List<Int>): List<ChannelSetting> {
        // Initialize channel settings for every channel with defaults.
        val settings = mutableListOf<ChannelSetting>()
        for (channelId in 0..15) {
            settings.add(
                ChannelSetting(
                    channelId = channelId,
                    frequency = 50,
                    intonation = 50,
                    transparency = 100
                )
            )
        }
        // Keep the most frequent channel slightly emphasized.
        val defaultChannel = channelOrder.firstOrNull() ?: 0
        settings.firstOrNull { it.channelId == defaultChannel }?.frequency = 60
        return settings
    }

    private fun buildGrinPixels(frame: PosterizedFrame, channelMap: List<Int>): List<GrinPixel> {
        // Convert the posterized preview into GRIN pixels with group IDs.
        val pixels = mutableListOf<GrinPixel>()
        for (index in frame.paletteIndices.indices) {
            val paletteIndex = frame.paletteIndices[index]
            val color = frame.paletteColors[paletteIndex]
            val channelId = channelMap[paletteIndex]
            val pixel = GrinPixel(
                r = Color.red(color),
                g = Color.green(color),
                b = Color.blue(color),
                a = Color.alpha(color),
                c = 0
            )
            pixel.setGroupId(channelId)
            pixels.add(pixel)
        }
        return pixels
    }

    private fun buildRules(settings: List<ChannelSetting>, activeChannels: List<Int>): List<GrinRule> {
        // Build rule entries for each active channel using the current settings.
        val rules = mutableListOf<GrinRule>()
        activeChannels.forEach { channelId ->
            val setting = settings.firstOrNull { it.channelId == channelId }
            if (setting != null) {
                val timing = mapFrequencyToTiming(setting.frequency)
                val opcode = mapIntonationToOpcode(setting.intonation)
                val groupMask = 1 shl (channelId and 0x0F)
                rules.add(GrinRule(groupMask, opcode, timing))
            }
        }
        return rules
    }

    private fun mapFrequencyToTiming(frequency: Int): Int {
        // Map 0-100 slider values to an 8-bit timing value.
        val clamped = frequency.coerceIn(0, 100)
        return (clamped / 100.0 * 255).roundToInt().coerceIn(0, 255)
    }

    private fun mapIntonationToOpcode(intonation: Int): Int {
        // Map intonation to a GRIN opcode bucket for header persistence.
        return when {
            intonation >= 70 -> BaseOpcodes.ROTATE_HUE
            intonation >= 55 -> BaseOpcodes.SHIFT_R
            intonation <= 30 -> BaseOpcodes.SHIFT_B
            else -> BaseOpcodes.NOP
        }
    }

    private fun computeLuminance(color: Int): Double {
        // Compute luminance for stable bin ordering.
        val red = Color.red(color).toDouble()
        val green = Color.green(color).toDouble()
        val blue = Color.blue(color).toDouble()
        return 0.2126 * red + 0.7152 * green + 0.0722 * blue
    }

    private fun buildHeader(width: Int, height: Int, tickMicros: Long, ruleCount: Int): GrinHeader {
        // Compose a GRIN header with correct lengths for saving.
        val pixelDataLength = width.toLong() * height.toLong() * GrinFormat.PIXEL_SIZE_BYTES.toLong()
        val fileLength = GrinFormat.HEADER_SIZE_BYTES.toLong() + pixelDataLength
        return GrinHeader(
            magic = GrinFormat.MAGIC_BYTES,
            versionMajor = GrinFormat.VERSION_MAJOR,
            versionMinor = GrinFormat.VERSION_MINOR,
            headerSize = GrinFormat.HEADER_SIZE_BYTES,
            width = width.toLong(),
            height = height.toLong(),
            tickMicros = tickMicros,
            ruleCount = ruleCount,
            opcodeSetId = 0,
            flags = 0,
            pixelDataLength = pixelDataLength,
            fileLength = fileLength,
            pixelDataOffset = GrinFormat.HEADER_SIZE_BYTES.toLong(),
            reservedA = 0,
            reservedB = 0,
            rulesBlock = ByteArray(GrinFormat.RULES_BLOCK_SIZE)
        )
    }

    private data class ChannelAssignment(
        val channelMap: List<Int>,
        val channelOrder: List<Int>,
        val activeChannels: List<Int>
    )

    private data class PaletteBin(
        val index: Int,
        val count: Int,
        val luminance: Double
    )
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/GrinPreviewRenderer.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.graphics.Bitmap
import android.graphics.Color
import io.grin.lib.GrinFile
import io.grin.lib.GrinPixel
import kotlin.math.PI
import kotlin.math.sin

// Renders preview bitmaps from GRIN files with channel settings applied.
class GrinPreviewRenderer {
    fun renderPreview(grinFile: GrinFile, settings: List<ChannelSetting>, focusedChannelId: Int?): Bitmap {
        // Render a static preview with the latest slider settings applied.
        return renderFrame(grinFile, settings, focusedChannelId, frameIndex = 0, frameCount = 1)
    }

    fun renderFrame(
        grinFile: GrinFile,
        settings: List<ChannelSetting>,
        focusedChannelId: Int?,
        frameIndex: Int,
        frameCount: Int
    ): Bitmap {
        // Render a single frame with optional frequency-based modulation.
        val width = grinFile.header.width.toInt()
        val height = grinFile.header.height.toInt()
        val bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888)

        val settingsByChannel = settings.associateBy { it.channelId }
        grinFile.pixels.forEachIndexed { index, pixel ->
            val channelId = pixel.getGroupId()
            val setting = settingsByChannel[channelId]
            val shouldApply = focusedChannelId == null || focusedChannelId == channelId
            val color = if (setting != null && shouldApply) {
                applySetting(pixel, setting, frameIndex, frameCount)
            } else {
                Color.argb(pixel.a, pixel.r, pixel.g, pixel.b)
            }
            val x = index % width
            val y = index / width
            bitmap.setPixel(x, y, color)
        }
        return bitmap
    }

    private fun applySetting(pixel: GrinPixel, setting: ChannelSetting, frameIndex: Int, frameCount: Int): Int {
        // Apply intonation (RGB bias) and transparency modulation to a pixel.
        val intonationDelta = ((setting.intonation - 50) * 2).coerceIn(-100, 100)
        val red = (pixel.r + intonationDelta).coerceIn(0, 255)
        val green = (pixel.g + intonationDelta).coerceIn(0, 255)
        val blue = (pixel.b + intonationDelta).coerceIn(0, 255)

        val alphaScale = setting.transparency.coerceIn(0, 100) / 100.0
        val frequencyScale = setting.frequency.coerceIn(0, 100) / 100.0
        val phase = 2 * PI * frameIndex / frameCount * (0.5 + frequencyScale)
        val pulse = 0.5 + 0.5 * sin(phase)
        val alpha = (pixel.a * alphaScale * pulse).coerceIn(0.0, 255.0).toInt()

        return Color.argb(alpha, red, green, blue)
    }
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/GifEncoder.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.graphics.Bitmap
import android.graphics.Color
import java.io.File
import java.io.OutputStream
import kotlin.math.ceil
import kotlin.math.log2
import kotlin.math.max

// Encodes a list of ARGB_8888 frames into a looping GIF.
class GifEncoder {
    fun encode(frames: List<Bitmap>, delayMs: Int, output: File) {
        require(frames.isNotEmpty()) { "GIF export requires at least one frame" }
        val width = frames.first().width
        val height = frames.first().height
        frames.forEach { frame ->
            require(frame.width == width && frame.height == height) {
                "All GIF frames must share the same dimensions"
            }
        }

        val palette = buildPalette(frames.first())
        val paletteSize = nextPowerOfTwo(max(2, palette.colors.size))
        val colorDepth = max(2, ceil(log2(paletteSize.toDouble())).toInt())
        val globalColorTable = buildColorTable(palette.colors, paletteSize)

        output.outputStream().use { stream ->
            writeHeader(stream)
            writeLogicalScreenDescriptor(stream, width, height, colorDepth)
            stream.write(globalColorTable)
            writeLoopExtension(stream)

            frames.forEach { frame ->
                val pixels = mapPixelsToPalette(frame, palette)
                writeGraphicsControlExtension(stream, delayMs)
                writeImageDescriptor(stream, width, height)
                GifLzwEncoder(width, height, pixels, colorDepth).encode(stream)
            }

            stream.write(0x3B) // GIF trailer.
        }
    }

    private fun buildPalette(bitmap: Bitmap): PaletteResult {
        // Build a stable palette ordered by frequency for posterized frames.
        val counts = linkedMapOf<Int, Int>()
        for (y in 0 until bitmap.height) {
            for (x in 0 until bitmap.width) {
                val color = bitmap.getPixel(x, y)
                counts[color] = (counts[color] ?: 0) + 1
            }
        }
        val sortedColors = counts.entries
            .sortedWith(compareByDescending<Map.Entry<Int, Int>> { it.value }.thenBy { it.key })
            .map { it.key }
        require(sortedColors.size <= 256) { "GIF palette exceeds 256 colors" }
        val mapping = sortedColors.mapIndexed { index, color -> color to index }.toMap()
        return PaletteResult(sortedColors, mapping)
    }

    private fun buildColorTable(colors: List<Int>, size: Int): ByteArray {
        // Build the RGB color table padded to a power-of-two length.
        val table = ByteArray(size * 3)
        colors.forEachIndexed { index, color ->
            table[index * 3] = Color.red(color).toByte()
            table[index * 3 + 1] = Color.green(color).toByte()
            table[index * 3 + 2] = Color.blue(color).toByte()
        }
        return table
    }

    private fun mapPixelsToPalette(bitmap: Bitmap, palette: PaletteResult): ByteArray {
        // Convert ARGB pixels to palette indices for LZW encoding.
        val pixels = ByteArray(bitmap.width * bitmap.height)
        var offset = 0
        for (y in 0 until bitmap.height) {
            for (x in 0 until bitmap.width) {
                val color = bitmap.getPixel(x, y)
                pixels[offset] = (palette.colorToIndex[color] ?: 0).toByte()
                offset += 1
            }
        }
        return pixels
    }

    private fun writeHeader(stream: OutputStream) {
        // Write the GIF header signature.
        stream.write("GIF89a".toByteArray())
    }

    private fun writeLogicalScreenDescriptor(stream: OutputStream, width: Int, height: Int, colorDepth: Int) {
        // Define global palette usage and canvas size.
        writeShort(stream, width)
        writeShort(stream, height)
        val packed = 0x80 or ((colorDepth - 1) shl 4) or (colorDepth - 1)
        stream.write(packed)
        stream.write(0) // Background color index.
        stream.write(0) // Pixel aspect ratio.
    }

    private fun writeLoopExtension(stream: OutputStream) {
        // Enable infinite looping for playback.
        stream.write(0x21)
        stream.write(0xFF)
        stream.write(0x0B)
        stream.write("NETSCAPE2.0".toByteArray())
        stream.write(0x03)
        stream.write(0x01)
        writeShort(stream, 0)
        stream.write(0x00)
    }

    private fun writeGraphicsControlExtension(stream: OutputStream, delayMs: Int) {
        // Configure per-frame delay and disposal.
        stream.write(0x21)
        stream.write(0xF9)
        stream.write(0x04)
        stream.write(0x00)
        writeShort(stream, (delayMs / 10).coerceAtLeast(1))
        stream.write(0x00) // Transparent index.
        stream.write(0x00)
    }

    private fun writeImageDescriptor(stream: OutputStream, width: Int, height: Int) {
        // Describe the image frame and use the global color table.
        stream.write(0x2C)
        writeShort(stream, 0)
        writeShort(stream, 0)
        writeShort(stream, width)
        writeShort(stream, height)
        stream.write(0x00)
    }

    private fun writeShort(stream: OutputStream, value: Int) {
        // Write a 16-bit little-endian value.
        stream.write(value and 0xFF)
        stream.write((value shr 8) and 0xFF)
    }

    private fun nextPowerOfTwo(value: Int): Int {
        // Compute the next power-of-two size for the GIF color table.
        var result = 1
        while (result < value) {
            result = result shl 1
        }
        return result
    }

    private data class PaletteResult(
        val colors: List<Int>,
        val colorToIndex: Map<Int, Int>
    )
}

// Minimal LZW encoder for GIF palette indices.
private class GifLzwEncoder(
    private val width: Int,
    private val height: Int,
    private val pixels: ByteArray,
    private val colorDepth: Int
) {
    private val initCodeSize = max(2, colorDepth)
    private val clearCode = 1 shl initCodeSize
    private val eofCode = clearCode + 1
    private var remaining = width * height
    private var pixelIndex = 0
    private var curAccum = 0
    private var curBits = 0
    private var aCount = 0
    private val accum = ByteArray(256)

    fun encode(output: OutputStream) {
        // Write initial code size for the image data.
        output.write(initCodeSize)
        compress(output)
        output.write(0x00)
    }

    private fun compress(output: OutputStream) {
        // Perform GIF LZW compression using a hash table.
        val hsize = 5003
        val htab = IntArray(hsize) { -1 }
        val codetab = IntArray(hsize)
        var freeEnt = eofCode + 1
        var nBits = initCodeSize + 1
        var maxCode = (1 shl nBits) - 1
        val maxMaxCode = 1 shl 12
        val clearFlag = BooleanArray(1)

        outputCode(clearCode, output, nBits, maxCode, clearFlag)

        var ent = nextPixel()
        while (true) {
            val c = nextPixel()
            if (c == -1) {
                break
            }
            val fcode = (c shl 12) + ent
            var i = (c shl 8) xor ent
            if (htab[i] == fcode) {
                ent = codetab[i]
                continue
            } else if (htab[i] >= 0) {
                val disp = hsize - i
                if (i == 0) {
                    i = 1
                }
                while (true) {
                    i -= disp
                    if (i < 0) {
                        i += hsize
                    }
                    if (htab[i] == fcode) {
                        ent = codetab[i]
                        break
                    }
                    if (htab[i] < 0) {
                        break
                    }
                }
                if (htab[i] == fcode) {
                    continue
                }
            }

            outputCode(ent, output, nBits, maxCode, clearFlag)
            ent = c
            if (freeEnt < maxMaxCode) {
                codetab[i] = freeEnt
                htab[i] = fcode
                freeEnt += 1
            } else {
                clearFlag[0] = true
                outputCode(clearCode, output, nBits, maxCode, clearFlag)
                htab.fill(-1)
                freeEnt = eofCode + 1
            }

            if (freeEnt > maxCode && !clearFlag[0]) {
                nBits += 1
                if (nBits == 12) {
                    maxCode = maxMaxCode - 1
                } else {
                    maxCode = (1 shl nBits) - 1
                }
            }
        }

        outputCode(ent, output, nBits, maxCode, clearFlag)
        outputCode(eofCode, output, nBits, maxCode, clearFlag)
    }

    private fun nextPixel(): Int {
        // Read the next palette index from the pixel stream.
        if (remaining == 0) {
            return -1
        }
        remaining -= 1
        val value = pixels[pixelIndex].toInt() and 0xFF
        pixelIndex += 1
        return value
    }

    private fun outputCode(code: Int, output: OutputStream, nBits: Int, maxCode: Int, clearFlag: BooleanArray) {
        // Buffer and output variable-length codes as GIF sub-blocks.
        if (clearFlag[0]) {
            curAccum = 0
            curBits = 0
            clearFlag[0] = false
        }
        curAccum = curAccum or (code shl curBits)
        curBits += nBits
        while (curBits >= 8) {
            charOut(curAccum and 0xFF, output)
            curAccum = curAccum shr 8
            curBits -= 8
        }
        if (code == eofCode) {
            // Flush trailing bits on EOF.
            while (curBits > 0) {
                charOut(curAccum and 0xFF, output)
                curAccum = curAccum shr 8
                curBits -= 8
            }
            flush(output)
        }
    }

    private fun charOut(value: Int, output: OutputStream) {
        // Write encoded bytes into the current sub-block.
        accum[aCount] = value.toByte()
        aCount += 1
        if (aCount >= 254) {
            flush(output)
        }
    }

    private fun flush(output: OutputStream) {
        // Flush the current sub-block to the output stream.
        if (aCount > 0) {
            output.write(aCount)
            output.write(accum, 0, aCount)
            aCount = 0
        }
    }
}

---
FILE: android/demo/src/main/kotlin/io/grin/demo/NavigationConstants.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

// Shared intent extras for navigation between demo screens.
const val EXTRA_ASSET_ID = "io.grin.demo.extra.ASSET_ID"

---
FILE: android/demo/src/main/kotlin/io/grin/demo/EditorActivity.kt
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package io.grin.demo

import android.os.Bundle
import android.widget.AdapterView
import android.widget.ArrayAdapter
import android.widget.SeekBar
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import io.grin.demo.databinding.ActivityEditorBinding
import io.grin.lib.GrinFile

// Editor for adjusting channel metadata and exporting assets.
class EditorActivity : AppCompatActivity() {
    private lateinit var binding: ActivityEditorBinding
    private lateinit var store: GrinAssetStore
    private lateinit var metadata: GrinAssetMetadata
    private lateinit var grinFile: GrinFile
    private val renderer = GrinPreviewRenderer()

    private var currentSettings: MutableList<ChannelSetting> = mutableListOf()
    private var originalSettings: List<ChannelSetting> = emptyList()
    private var selectedChannelId = 0
    private var isUpdatingSliders = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityEditorBinding.inflate(layoutInflater)
        setContentView(binding.root)

        store = GrinAssetStore(this)
        val assetId = intent.getStringExtra(EXTRA_ASSET_ID)
        if (assetId == null) {
            Toast.makeText(this, getString(R.string.editor_missing_asset), Toast.LENGTH_SHORT).show()
            finish()
            return
        }

        val loadedMetadata = store.loadMetadata(assetId)
        val loadedFile = loadedMetadata?.let { store.loadGrinFile(it) }
        if (loadedMetadata == null || loadedFile == null) {
            Toast.makeText(this, getString(R.string.editor_missing_asset), Toast.LENGTH_SHORT).show()
            finish()
            return
        }

        metadata = loadedMetadata
        grinFile = loadedFile
        originalSettings = metadata.channelSettings.map { it.copy() }
        currentSettings = metadata.channelSettings.map { it.copy() }.toMutableList()

        setupChannelSpinner()
        setupSeekBars()
        updatePreview()

        binding.applyButton.setOnClickListener {
            applyEdits()
        }
        binding.revertButton.setOnClickListener {
            revertEdits()
        }
        binding.exportPngButton.setOnClickListener {
            exportPng()
        }
        binding.exportGifButton.setOnClickListener {
            exportGif()
        }
        binding.exportGrinButton.setOnClickListener {
            exportGrin()
        }
        binding.backButton.setOnClickListener {
            finish()
        }
    }

    private fun setupChannelSpinner() {
        // Populate the channel selector with hex labels.
        val adapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, ChannelLabels.labels)
        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
        binding.channelSpinner.adapter = adapter

        val defaultChannel = metadata.channelOrder.firstOrNull() ?: 0
        binding.channelSpinner.setSelection(defaultChannel)
        selectedChannelId = defaultChannel
        binding.channelSpinner.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {
            override fun onItemSelected(parent: AdapterView<*>?, view: android.view.View?, position: Int, id: Long) {
                selectedChannelId = position
                updateSliderValues()
                updatePreview()
            }

            override fun onNothingSelected(parent: AdapterView<*>?) {}
        }
    }

    private fun setupSeekBars() {
        // Attach change listeners for live preview updates.
        binding.frequencySeek.setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
            override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                if (!isUpdatingSliders) {
                    updateSetting { it.frequency = progress }
                }
            }

            override fun onStartTrackingTouch(seekBar: SeekBar?) {}
            override fun onStopTrackingTouch(seekBar: SeekBar?) {}
        })
        binding.intonationSeek.setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
            override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                if (!isUpdatingSliders) {
                    updateSetting { it.intonation = progress }
                }
            }

            override fun onStartTrackingTouch(seekBar: SeekBar?) {}
            override fun onStopTrackingTouch(seekBar: SeekBar?) {}
        })
        binding.transparencySeek.setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
            override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                if (!isUpdatingSliders) {
                    updateSetting { it.transparency = progress }
                }
            }

            override fun onStartTrackingTouch(seekBar: SeekBar?) {}
            override fun onStopTrackingTouch(seekBar: SeekBar?) {}
        })

        updateSliderValues()
    }

    private fun updateSetting(update: (ChannelSetting) -> Unit) {
        // Apply slider updates to the selected channel and refresh preview.
        val setting = currentSettings.firstOrNull { it.channelId == selectedChannelId }
        if (setting != null) {
            update(setting)
            updatePreview()
        }
    }

    private fun updateSliderValues() {
        // Synchronize slider positions with the selected channel settings.
        val setting = currentSettings.firstOrNull { it.channelId == selectedChannelId } ?: return
        isUpdatingSliders = true
        binding.frequencySeek.progress = setting.frequency
        binding.intonationSeek.progress = setting.intonation
        binding.transparencySeek.progress = setting.transparency
        isUpdatingSliders = false
    }

    private fun updatePreview() {
        // Render a live preview using the current slider settings.
        val preview = renderer.renderPreview(grinFile, currentSettings, selectedChannelId)
        binding.editorPreview.setImageBitmap(preview)
    }

    private fun applyEdits() {
        // Persist updated channel overrides and GRIN rules.
        val updatedFile = store.buildUpdatedGrinFile(metadata, grinFile, currentSettings)
        grinFile = updatedFile
        updatedFile.save(metadata.grinPath)
        updatedFile.save(metadata.grimPath)
        val preview = renderer.renderPreview(grinFile, currentSettings, null)
        store.updateAssetMetadata(metadata, currentSettings.map { it.copy() }, preview)
        originalSettings = currentSettings.map { it.copy() }
        Toast.makeText(this, getString(R.string.editor_applied), Toast.LENGTH_SHORT).show()
    }

    private fun revertEdits() {
        // Restore channel settings to the last applied state.
        currentSettings = originalSettings.map { it.copy() }.toMutableList()
        updateSliderValues()
        updatePreview()
    }

    private fun exportPng() {
        // Export a PNG snapshot of the current GRIN preview.
        val snapshot = renderer.renderPreview(grinFile, currentSettings, null)
        store.exportPng(snapshot, "${metadata.id}_snapshot.png")
        Toast.makeText(this, getString(R.string.export_complete), Toast.LENGTH_SHORT).show()
    }

    private fun exportGif() {
        // Render a short loop derived from the GRIN playback cadence.
        val frames = mutableListOf<android.graphics.Bitmap>()
        val frameCount = 12
        for (index in 0 until frameCount) {
            frames.add(renderer.renderFrame(grinFile, currentSettings, null, index, frameCount))
        }
        val delayMs = (metadata.tickMicros / 1000L).toInt().coerceAtLeast(50)
        store.exportGif("${metadata.id}_loop.gif", frames, delayMs)
        Toast.makeText(this, getString(R.string.export_complete), Toast.LENGTH_SHORT).show()
    }

    private fun exportGrin() {
        // Export the updated GRIN payload with current header settings.
        val updatedFile = store.buildUpdatedGrinFile(metadata, grinFile, currentSettings)
        store.exportGrinAndGrim(metadata, updatedFile, "${metadata.id}_updated")
        Toast.makeText(this, getString(R.string.export_complete), Toast.LENGTH_SHORT).show()
    }
}

---
FILE: android/demo/src/main/res/layout/activity_grid_camera.xml
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/gridCameraRoot"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <TextView
        android:id="@+id/previewTitle"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="@string/grid_camera_title"
        android:textStyle="bold" />

    <FrameLayout
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_marginTop="8dp"
        android:layout_weight="1">

        <ImageView
            android:id="@+id/posterizedPreview"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="@android:color/black"
            android:scaleType="fitCenter" />

        <io.grin.demo.GridOverlayView
            android:id="@+id/gridOverlay"
            android:layout_width="match_parent"
            android:layout_height="match_parent" />
    </FrameLayout>

    <TextView
        android:id="@+id/performanceText"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="@string/camera_performance_default" />

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:gravity="center_horizontal"
        android:orientation="horizontal">

        <Button
            android:id="@+id/captureButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/capture" />

        <Button
            android:id="@+id/closeButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/close" />
    </LinearLayout>
</LinearLayout>

---
FILE: android/demo/src/main/res/layout/activity_main.xml
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/root"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <io.grin.lib.GrinView
        android:id="@+id/grinView"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:background="#000000" />

    <TextView
        android:id="@+id/metadataText"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:paddingTop="8dp"
        android:text="@string/file_info_title" />

    <SeekBar
        android:id="@+id/seekBar"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:max="1000" />

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:gravity="center_horizontal"
        android:orientation="horizontal">

        <Button
            android:id="@+id/loadButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/load_file" />

        <Button
            android:id="@+id/cameraButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/open_camera" />

        <Button
            android:id="@+id/galleryButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/open_gallery" />

        <Button
            android:id="@+id/playButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/play" />

        <Button
            android:id="@+id/pauseButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/pause" />

        <Button
            android:id="@+id/stopButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/stop" />
    </LinearLayout>

    <TextView
        android:id="@+id/samplesTitle"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="12dp"
        android:text="@string/samples_title"
        android:textStyle="bold" />

    <ListView
        android:id="@+id/samplesList"
        android:layout_width="match_parent"
        android:layout_height="120dp"
        android:layout_marginTop="4dp"
        android:dividerHeight="1dp" />
</LinearLayout>

---
FILE: android/demo/src/main/res/layout/activity_capture_review.xml
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/captureReviewRoot"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <TextView
        android:id="@+id/captureReviewTitle"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="@string/capture_review_title"
        android:textStyle="bold" />

    <FrameLayout
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_marginTop="8dp"
        android:layout_weight="1">

        <ImageView
            android:id="@+id/previewImage"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="@android:color/black"
            android:scaleType="fitCenter" />

        <io.grin.demo.GridOverlayView
            android:id="@+id/gridOverlay"
            android:layout_width="match_parent"
            android:layout_height="match_parent" />
    </FrameLayout>

    <TextView
        android:id="@+id/captureMetadata"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="@string/capture_metadata_default" />

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:gravity="center_horizontal"
        android:orientation="horizontal">

        <Button
            android:id="@+id/retakeButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/retake" />

        <Button
            android:id="@+id/editButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/open_editor" />

        <Button
            android:id="@+id/acceptButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/accept" />
    </LinearLayout>
</LinearLayout>

---
FILE: android/demo/src/main/res/layout/activity_gallery.xml
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/galleryRoot"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <TextView
        android:id="@+id/galleryTitle"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="@string/gallery_title"
        android:textStyle="bold" />

    <TextView
        android:id="@+id/emptyState"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="@string/gallery_empty_state" />

    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/galleryRecycler"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_marginTop="8dp"
        android:layout_weight="1" />

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:gravity="center_horizontal"
        android:orientation="horizontal">

        <Button
            android:id="@+id/captureNewButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/capture_new" />

        <Button
            android:id="@+id/backButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:text="@string/back" />
    </LinearLayout>
</LinearLayout>

---
FILE: android/demo/src/main/res/layout/activity_editor.xml
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/editorScrollRoot"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <LinearLayout
        android:id="@+id/editorRoot"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:padding="16dp">

        <TextView
            android:id="@+id/editorTitle"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="@string/editor_title"
            android:textStyle="bold" />

        <ImageView
            android:id="@+id/editorPreview"
            android:layout_width="match_parent"
            android:layout_height="240dp"
            android:layout_marginTop="8dp"
            android:background="@android:color/black"
            android:scaleType="fitCenter" />

        <TextView
            android:id="@+id/channelLabel"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="12dp"
            android:text="@string/channel_selector" />

        <Spinner
            android:id="@+id/channelSpinner"
            android:layout_width="match_parent"
            android:layout_height="wrap_content" />

        <TextView
            android:id="@+id/frequencyLabel"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="12dp"
            android:text="@string/channel_frequency" />

        <SeekBar
            android:id="@+id/frequencySeek"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:max="100" />

        <TextView
            android:id="@+id/intonationLabel"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="8dp"
            android:text="@string/channel_intonation" />

        <SeekBar
            android:id="@+id/intonationSeek"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:max="100" />

        <TextView
            android:id="@+id/transparencyLabel"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="8dp"
            android:text="@string/channel_transparency" />

        <SeekBar
            android:id="@+id/transparencySeek"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:max="100" />

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="12dp"
            android:gravity="center_horizontal"
            android:orientation="horizontal">

            <Button
                android:id="@+id/applyButton"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/apply" />

            <Button
                android:id="@+id/revertButton"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_marginStart="8dp"
                android:text="@string/revert" />
        </LinearLayout>

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="8dp"
            android:gravity="center_horizontal"
            android:orientation="horizontal">

            <Button
                android:id="@+id/exportPngButton"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/export_png" />

            <Button
                android:id="@+id/exportGifButton"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_marginStart="8dp"
                android:text="@string/export_gif" />

            <Button
                android:id="@+id/exportGrinButton"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_marginStart="8dp"
                android:text="@string/export_grin" />
        </LinearLayout>

        <Button
            android:id="@+id/backButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginTop="8dp"
            android:text="@string/back" />
    </LinearLayout>
</ScrollView>

---
FILE: android/demo/src/main/res/layout/item_gallery_asset.xml
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/galleryItemRoot"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical"
    android:padding="8dp">

    <ImageView
        android:id="@+id/thumbnail"
        android:layout_width="match_parent"
        android:layout_height="160dp"
        android:background="@android:color/black"
        android:contentDescription="@string/gallery_thumbnail"
        android:scaleType="centerCrop" />

    <TextView
        android:id="@+id/assetMetadata"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="4dp"
        android:text="@string/gallery_asset_metadata_default"
        android:textSize="12sp" />
</LinearLayout>

---
FILE: android/demo/src/main/res/values/strings.xml
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<resources>
    <string name="app_name">GRIN Demo</string>
    <string name="description">Graphic Readdressable Indexed Nodes - Demo</string>
    
    <!-- UI Strings -->
    <string name="load_file">Load .grin File</string>
    <string name="open_camera">Open Grid Camera</string>
    <string name="open_gallery">Open Gallery</string>
    <string name="play">Play</string>
    <string name="pause">Pause</string>
    <string name="stop">Stop</string>
    <string name="samples_title">Sample Files</string>
    <string name="no_samples">No samples found</string>
    
    <!-- File info -->
    <string name="file_info_title">File Information</string>
    <string name="dimensions_format">Dimensions: %1$d × %2$d</string>
    <string name="rule_count_format">Rules: %1$d</string>
    <string name="tick_rate_format">Tick Rate: %1$d µs</string>

    <!-- Grid camera -->
    <string name="grid_camera_title">Grid Camera Preview</string>
    <string name="camera_performance_default">Grid: -- × -- · Palette: --</string>
    <string name="camera_performance_format">Grid: %1$d × %2$d · Palette: %3$d</string>
    <string name="close">Close</string>
    <string name="capture">Capture</string>
    <string name="capture_review_title">Capture Review</string>
    <string name="capture_metadata_default">Grid: -- × -- · Bins: --</string>
    <string name="capture_metadata_format">Grid: %1$d × %2$d · Bins: %3$d</string>
    <string name="retake">Retake</string>
    <string name="accept">Accept</string>
    <string name="open_editor">Open Editor</string>
    <string name="capture_no_frame">No frame available to capture.</string>

    <!-- Gallery -->
    <string name="gallery_title">Gallery</string>
    <string name="gallery_empty_state">No captures yet. Use the grid camera to add assets.</string>
    <string name="gallery_thumbnail">Gallery thumbnail</string>
    <string name="gallery_asset_metadata_default">-- × -- · Bins: --</string>
    <string name="gallery_asset_metadata">%1$d × %2$d · Bins: %3$d</string>
    <string name="capture_new">Capture New</string>
    <string name="back">Back</string>

    <!-- Editor -->
    <string name="editor_title">Channel Editor</string>
    <string name="channel_selector">Channel</string>
    <string name="channel_frequency">Frequency</string>
    <string name="channel_intonation">Color Intonation</string>
    <string name="channel_transparency">Transparency</string>
    <string name="apply">Apply</string>
    <string name="revert">Revert</string>
    <string name="export_png">Export PNG</string>
    <string name="export_gif">Export GIF</string>
    <string name="export_grin">Export GRIN</string>
    <string name="editor_missing_asset">Unable to load selected capture.</string>
    <string name="editor_applied">Edits applied.</string>
    <string name="export_complete">Export complete.</string>
    
    <!-- Errors -->
    <string name="error_invalid_file">Invalid GRIN file</string>
    <string name="error_file_not_found">File not found</string>
    <string name="error_loading">Error loading file</string>
    <string name="camera_permission_denied">Camera permission denied.</string>
    <string name="camera_start_failed">Unable to start camera preview.</string>
</resources>

---
FILE: android/demo/src/main/AndroidManifest.xml
<?xml version="1.0" encoding="utf-8"?>

<!--
  MIT License

  Copyright (c) 2025 GRIN Project Contributors

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<!--
  GRIN Demo Application Manifest
  Demonstrates .grin file loading and playback
-->
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <!-- Camera permission required for the grid preview pipeline. -->
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-feature android:name="android.hardware.camera" android:required="false" />

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.GrinDemo">

        <provider
            android:name="io.grin.lib.GrinContentProvider"
            android:authorities="${applicationId}.grin"
            android:exported="false"
            android:grantUriPermissions="true" />
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="@string/app_name"
            android:theme="@style/Theme.GrinDemo">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
            
            <!-- Handle .grin and .grn file opens -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:mimeType="application/octet-stream" />
                <data android:pathPattern=".*\\.grin" />
                <data android:pathPattern=".*\\.grn" />
            </intent-filter>
        </activity>

        <activity
            android:name=".GridCameraActivity"
            android:exported="false"
            android:label="@string/grid_camera_title"
            android:theme="@style/Theme.GrinDemo" />

        <activity
            android:name=".CaptureReviewActivity"
            android:exported="false"
            android:label="@string/capture_review_title"
            android:theme="@style/Theme.GrinDemo" />

        <activity
            android:name=".GalleryActivity"
            android:exported="false"
            android:label="@string/gallery_title"
            android:theme="@style/Theme.GrinDemo" />

        <activity
            android:name=".EditorActivity"
            android:exported="false"
            android:label="@string/editor_title"
            android:theme="@style/Theme.GrinDemo" />
    </application>

</manifest>

---
FILE: android/demo/build.gradle.kts
/*
 * MIT License
 *
 * Copyright (c) 2025 GRIN Project Contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
// GRIN Android Demo Application
// Demonstrates GRIN file loading, validation, and playback

plugins {
    id("com.android.application")
    kotlin("android")
}

android {
    namespace = "io.grin.demo"
    compileSdk = 34

    defaultConfig {
        applicationId = "io.grin.demo"
        minSdk = 21  // Match library minimum
        targetSdk = 34
        versionCode = 1
        versionName = "0.1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = true
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
        debug {
            isDebuggable = true
        }
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = "1.8"
    }

    buildFeatures {
        viewBinding = true
    }
}

dependencies {
    // GRIN library
    implementation(project(":lib"))
    
    // AndroidX core - stable, minimal
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("androidx.activity:activity-ktx:1.8.2")
    
    // Material Design for demo UI
    implementation("com.google.android.material:material:1.11.0")
    
    // ConstraintLayout for demo layouts
    implementation("androidx.constraintlayout:constraintlayout:2.1.4")
    
    // Lifecycle for demo
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.7.0")
    implementation("androidx.recyclerview:recyclerview:1.3.2")

    // CameraX for grid camera preview
    implementation("androidx.camera:camera-core:1.3.2")
    implementation("androidx.camera:camera-camera2:1.3.2")
    implementation("androidx.camera:camera-lifecycle:1.3.2")
    
    // Testing
    testImplementation("junit:junit:4.13.2")
    androidTestImplementation("androidx.test.ext:junit:1.1.5")
    androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
}

---
FILE: docs/android-grid-camera-ux.md
# Android Grid Camera + Gallery UX & Data Model

## UX Flow Overview

### Screen Map
1. **Camera Preview**
   - Live posterized preview with grid overlay.
   - Primary actions: capture, toggle grid, palette view, settings.
2. **Capture Review**
   - Frozen posterized frame with channel mapping summary.
   - Actions: accept (save GRIM/GRIN), retake, open editor.
3. **Gallery Grid**
   - Posterized thumbnails in a grid, with quick metadata badges (resolution, palette size).
   - Actions: open editor, export, delete, share.
4. **Editor**
   - Channel selector (0-9/A-F) plus sliders for frequency, color intonation, transparency.
   - Actions: apply, revert, export, back to gallery.

### Navigation Rules
- Camera Preview is the default entry point.
- Capture Review is modal; accepting moves to Gallery and allows immediate Editor open.
- Gallery is the primary browsing surface; Editor is a detail view scoped to one capture.

## Data Model

### Entities
- **CaptureSession**
  - `id` (UUID)
  - `createdAt` (epoch millis)
  - `width`, `height`
  - `gridCols`, `gridRows`
  - `paletteBins` (12-14)
  - `sourceUri` (raw capture or temp buffer)
- **GrinAsset**
  - `id` (UUID)
  - `fileUri` (GRIM/GRIN output path)
  - `previewUri` (posterized PNG)
  - `width`, `height`
  - `tickMicros`
  - `ruleCount`
  - `channelMap` (ordered list of channel assignments)
  - `paletteHistogram` (bin -> count)
  - `createdAt`, `lastEditedAt`
- **ChannelSetting**
  - `channelId` (0-15)
  - `frequency`
  - `intonation`
  - `alpha`

### Storage Plan
- Persist `GrinAsset` and `ChannelSetting` metadata in Room (SQLite).
- Store GRIM/GRIN payloads and preview PNGs in app-scoped storage with stable file names.
- Cache derived thumbnails; invalidate on edit export.

### Demo Implementation Notes
- The demo app persists `GrinAsset` metadata as JSON files under app-scoped storage.
- Preview PNGs, thumbnails, and GRIM/GRIN payloads are stored in sibling folders for fast gallery paging.
- Editor exports write PNG, GIF, and updated GRIN payloads into an app-scoped `exports` directory.

## Posterization & Channel Mapping

### Palette Handling
- Target 12-14 color bins per capture; bins built from a posterization LUT.
- For high-variance scenes, allow adaptive bin count within the 12-14 range.
- Persist ordered palette bins for consistent channel mapping across edits/exports.

### Preview Pipeline Targets
- Aim for 30fps on mid-tier devices, with headroom for 60fps on flagship devices.
- If analysis latency exceeds ~40ms, drop to a fallback profile (75% grid resolution, 12 bins).
- Use CPU posterization with nearest-palette matching; keep frames capped by analysis FPS.

### Channel Mapping Rules
- Assign bins to channels 0-9/A-F using stable sort by frequency, then luminance.
- Keep a deterministic mapping table in `channelMap` to guarantee replayability.
- Provide editor overrides that reassign channels without re-running posterization.

## GRIM/GRIN Metadata Updates
- Update `TickMicros` based on capture preview cadence (e.g., 33_333 for 30fps).
- Set `RuleCount` to the number of active channels.
- Write channel metadata into rule block entries (group mask + opcode + timing) to reflect editor settings.
- Ensure header `PixelDataLength` and `FileLength` reflect generated payload sizes.

## Export Options

### GRIM/GRIN
- Persist updated header settings, channel map, and rules for playback parity.

### PNG Snapshot
- Export an ARGB_8888 bitmap with alpha preserved from the posterized preview.

### GIF Loop
- Render 12-15 frames from GRIN playback at fixed tick intervals.
- Package as a looping GIF with consistent palette ordering.
